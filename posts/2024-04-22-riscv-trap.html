<!DOCTYPE html>
<html class="js-focus-visible" data-a11y-animated-images="system" data-a11y-link-underlines="true" data-color-mode="auto" data-dark-theme="dark" data-js-focus-visible="" data-light-theme="light" data-turbo-loaded="" lang="en"><head><style type="text/css">.turbo-progress-bar {
  position: fixed;
  display: block;
  top: 0;
  left: 0;
  height: 3px;
  background: #0076ff;
  z-index: 2147483647;
  transition:
    width 300ms ease-out,
    opacity 150ms 150ms ease-in;
  transform: translate3d(0, 0, 0);
}
</style>
<meta charset="utf-8"/>
<link href="https://github.githubassets.com" rel="dns-prefetch"/>
<link href="https://avatars.githubusercontent.com" rel="dns-prefetch"/>
<link href="https://github-cloud.s3.amazonaws.com" rel="dns-prefetch"/>
<link href="https://user-images.githubusercontent.com/" rel="dns-prefetch"/>
<link crossorigin="" href="https://github.githubassets.com" rel="preconnect"/>
<link href="https://avatars.githubusercontent.com" rel="preconnect"/>
<link crossorigin="anonymous" href="https://github.githubassets.com/assets/light-c59dc71e3a4c.css" media="all" rel="stylesheet"/><link crossorigin="anonymous" href="https://github.githubassets.com/assets/light_high_contrast-4bf0cb726930.css" media="all" rel="stylesheet"/><link crossorigin="anonymous" href="https://github.githubassets.com/assets/dark-89751e879f8b.css" media="all" rel="stylesheet"/><link crossorigin="anonymous" href="https://github.githubassets.com/assets/dark_high_contrast-67c7180a598a.css" media="all" rel="stylesheet"/><link crossorigin="anonymous" data-color-theme="light" data-href="https://github.githubassets.com/assets/light-c59dc71e3a4c.css" media="all" rel="stylesheet"/><link crossorigin="anonymous" data-color-theme="light_high_contrast" data-href="https://github.githubassets.com/assets/light_high_contrast-4bf0cb726930.css" media="all" rel="stylesheet"/><link crossorigin="anonymous" data-color-theme="light_colorblind" data-href="https://github.githubassets.com/assets/light_colorblind-6060e905eb78.css" media="all" rel="stylesheet"/><link crossorigin="anonymous" data-color-theme="light_colorblind_high_contrast" data-href="https://github.githubassets.com/assets/light_colorblind_high_contrast-04e818620b9c.css" media="all" rel="stylesheet"/><link crossorigin="anonymous" data-color-theme="light_tritanopia" data-href="https://github.githubassets.com/assets/light_tritanopia-ae65df249e0f.css" media="all" rel="stylesheet"/><link crossorigin="anonymous" data-color-theme="light_tritanopia_high_contrast" data-href="https://github.githubassets.com/assets/light_tritanopia_high_contrast-fdadc12a1ec2.css" media="all" rel="stylesheet"/><link crossorigin="anonymous" data-color-theme="dark" data-href="https://github.githubassets.com/assets/dark-89751e879f8b.css" media="all" rel="stylesheet"/><link crossorigin="anonymous" data-color-theme="dark_high_contrast" data-href="https://github.githubassets.com/assets/dark_high_contrast-67c7180a598a.css" media="all" rel="stylesheet"/><link crossorigin="anonymous" data-color-theme="dark_colorblind" data-href="https://github.githubassets.com/assets/dark_colorblind-4277e18a7c75.css" media="all" rel="stylesheet"/><link crossorigin="anonymous" data-color-theme="dark_colorblind_high_contrast" data-href="https://github.githubassets.com/assets/dark_colorblind_high_contrast-2e33ed61bc8c.css" media="all" rel="stylesheet"/><link crossorigin="anonymous" data-color-theme="dark_tritanopia" data-href="https://github.githubassets.com/assets/dark_tritanopia-48d44d87614d.css" media="all" rel="stylesheet"/><link crossorigin="anonymous" data-color-theme="dark_tritanopia_high_contrast" data-href="https://github.githubassets.com/assets/dark_tritanopia_high_contrast-6adcb5080302.css" media="all" rel="stylesheet"/><link crossorigin="anonymous" data-color-theme="dark_dimmed" data-href="https://github.githubassets.com/assets/dark_dimmed-250cee4c1ea8.css" media="all" rel="stylesheet"/><link crossorigin="anonymous" data-color-theme="dark_dimmed_high_contrast" data-href="https://github.githubassets.com/assets/dark_dimmed_high_contrast-e3802beb8c06.css" media="all" rel="stylesheet"/>
<link crossorigin="anonymous" href="https://github.githubassets.com/assets/primer-primitives-225433424a87.css" media="all" rel="stylesheet"/>
<link crossorigin="anonymous" href="https://github.githubassets.com/assets/primer-b8b91660c29d.css" media="all" rel="stylesheet"/>
<link crossorigin="anonymous" href="https://github.githubassets.com/assets/global-86fb66cfa45a.css" media="all" rel="stylesheet"/>
<link crossorigin="anonymous" href="https://github.githubassets.com/assets/github-40ec46d90f23.css" media="all" rel="stylesheet"/>
<link crossorigin="anonymous" href="https://github.githubassets.com/assets/repository-197a21528ff0.css" media="all" rel="stylesheet"/>
<link crossorigin="anonymous" href="https://github.githubassets.com/assets/code-177d21388df8.css" media="all" rel="stylesheet"/>
<script id="client-env" type="application/json">{"locale":"en","featureFlags":["alternate_user_config_repo","api_insights_show_missing_data_banner","autocomplete_use_dom_input_range","codespaces_prebuild_region_target_update","contentful_lp_flex_features_actions","contentful_lp_flex_features_code_review","contentful_lp_flex_features_code_search","contentful_lp_flex_features_codespaces","contentful_lp_flex_features_discussions","contentful_lp_flex_features_issues","contentful_lp_footnotes","copilot_chat_attach_multiple_images","copilot_chat_custom_instructions","copilot_chat_repo_custom_instructions_preview","copilot_chat_vision_in_claude","copilot_chat_wholearea_dd","copilot_custom_copilots_feature_preview","copilot_custom_copilots_org_owned","copilot_custom_copilots_redesign","copilot_custom_copilots_visibility","copilot_duplicate_thread","copilot_f2p_marketing_cta","copilot_free_to_paid_telem","copilot_ftp_settings_upgrade","copilot_header_button_to_immersive","copilot_immersive_draft_issue_metadata_location","copilot_immersive_draft_issue_template_required","copilot_immersive_issue_preview","copilot_new_immersive_references_ui","copilot_no_floating_button","copilot_read_shared_conversation","copilot_showcase_icebreakers","copilot_task_oriented_assistive_prompts","copilot_topics_as_references","copilot_ui_refs","copilot_workbench_iterate_panel","copilot_workbench_preview_analytics","copilot_workbench_refresh_on_wsod","copilot_workbench_user_limits","direct_to_salesforce","dotcom_chat_client_side_skills","ghost_pilot_confidence_truncation_25","ghost_pilot_confidence_truncation_40","insert_before_patch","issues_react_blur_item_picker_on_close","issues_react_create_milestone","issues_react_prohibit_title_fallback","issues_react_remove_placeholders","lifecycle_label_name_updates","link_contact_sales_swp_marketo","marketing_pages_search_explore_provider","memex_mwl_filter_field_delimiter","nonreporting_relay_graphql_status_codes","primer_react_css_modules_ga","primer_react_select_panel_with_modern_action_list","remove_child_patch","report_hydro_web_vitals","sample_network_conn_type","send_app_type_header","site_homepage_contentful","site_msbuild_hide_integrations","site_msbuild_launch","site_msbuild_webgl_hero","spark_commit_on_default_branch","swp_enterprise_contact_form","use_copilot_avatar","use_paginated_repo_picker_cost_center_form","viewscreen_sandbox"]}</script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/wp-runtime-7ec44d86e5dd.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/vendors-node_modules_oddbird_popover-polyfill_dist_popover-fn_js-81211bd82278.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/vendors-node_modules_github_mini-throttle_dist_index_js-node_modules_stacktrace-parser_dist_s-1d3d52-4be8ffe9a34a.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/ui_packages_failbot_failbot_ts-3f3eb0fe798c.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/environment-1d165312d5cd.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/vendors-node_modules_primer_behaviors_dist_esm_index_mjs-0dbb79f97f8f.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/vendors-node_modules_github_selector-observer_dist_index_esm_js-f690fd9ae3d5.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/vendors-node_modules_github_relative-time-element_dist_index_js-fd884d19bf73.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/vendors-node_modules_github_text-expander-element_dist_index_js-b4ed7224d804.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/vendors-node_modules_github_auto-complete-element_dist_index_js-node_modules_github_catalyst_-8e9f78-a90ac05d2469.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/vendors-node_modules_github_filter-input-element_dist_index_js-node_modules_github_remote-inp-b5f1d7-a1760ffda83d.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/vendors-node_modules_github_markdown-toolbar-element_dist_index_js-ceef33f593fa.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/vendors-node_modules_github_file-attachment-element_dist_index_js-node_modules_primer_view-co-f03a40-7aa390a76d76.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/github-elements-2006cfc2d0c7.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/element-registry-b74f2c54cc94.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/vendors-node_modules_braintree_browser-detection_dist_browser-detection_js-node_modules_githu-bb80ec-72267f4e3ff9.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/vendors-node_modules_lit-html_lit-html_js-be8cb88f481b.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/vendors-node_modules_morphdom_dist_morphdom-esm_js-0c08218c7d5f.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/vendors-node_modules_github_turbo_dist_turbo_es2017-esm_js-a03ee12d659a.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/vendors-node_modules_github_remote-form_dist_index_js-node_modules_delegated-events_dist_inde-893f9f-b6294cf703b7.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/vendors-node_modules_color-convert_index_js-e3180fe3bcb3.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/vendors-node_modules_github_quote-selection_dist_index_js-node_modules_github_session-resume_-b02a44-2dfe7ee0c022.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/ui_packages_updatable-content_updatable-content_ts-f4e60782b52d.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/app_assets_modules_github_behaviors_task-list_ts-app_assets_modules_github_sso_ts-ui_packages-900dde-c84fbefd392e.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/app_assets_modules_github_sticky-scroll-into-view_ts-3e000c5d31a9.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/app_assets_modules_github_behaviors_ajax-error_ts-app_assets_modules_github_behaviors_include-d0d0a6-9dc4ed803189.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/app_assets_modules_github_behaviors_commenting_edit_ts-app_assets_modules_github_behaviors_ht-83c235-ce8979e4f922.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/behaviors-2eb5c025e200.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/vendors-node_modules_delegated-events_dist_index_js-node_modules_github_catalyst_lib_index_js-ea8eaa-ae0dbe787ad8.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/notifications-global-7f3748c0d76b.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/vendors-node_modules_github_mini-throttle_dist_index_js-node_modules_github_catalyst_lib_inde-dbbea9-4adcaf6c1c40.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/code-menu-7cd84ed05e00.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/primer-react-93a37a6984ad.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/react-core-895d1d63cc59.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/react-lib-80430c87778a.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/octicons-react-cf2f2ab8dab4.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/vendors-node_modules_emotion_is-prop-valid_dist_emotion-is-prop-valid_esm_js-node_modules_emo-b1c483-30bc59af3a76.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/vendors-node_modules_github_catalyst_lib_index_js-node_modules_primer_live-region-element_dis-b2aea6-22827f205bdc.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/vendors-node_modules_dompurify_dist_purify_es_mjs-dd1d3ea6a436.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/vendors-node_modules_lodash-es__Stack_js-node_modules_lodash-es__Uint8Array_js-node_modules_l-4faaa6-4a736fde5c2f.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/vendors-node_modules_lodash-es_isEqual_js-92a85ab8c568.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/vendors-node_modules_tanstack_react-virtual_dist_esm_index_js-0b672975e32f.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/vendors-node_modules_focus-visible_dist_focus-visible_js-node_modules_github_hydro-analytics--e21ffd-3c9d2ac3e1ad.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/vendors-node_modules_fzy_js_index_js-node_modules_react-reverse-portal_dist_web_index_js-node-835def-0b59ac4d95fa.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/ui_packages_document-metadata_document-metadata_ts-ui_packages_history_history_ts-ui_packages-417c81-50b9bb07478c.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/ui_packages_paths_index_ts-e63bddbe6b3d.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/ui_packages_ref-selector_RefSelector_tsx-de5e05cf88ec.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/ui_packages_commit-attribution_index_ts-ui_packages_commit-checks-status_index_ts-ui_packages-762eaa-b9321ed019f0.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/ui_packages_app-uuid_app-uuid_ts-ui_packages_repos-file-tree-view_repos-file-tree-view_ts-5f5101384bd6.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/ui_packages_hydro-analytics_hydro-analytics_ts-ui_packages_use-client-value_use-client-value_-6f712e-d59b35038b54.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/ui_packages_code-view-shared_hooks_use-canonical-object_ts-ui_packages_code-view-shared_hooks-7b64b1-7bd792a20726.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/app_assets_modules_github_blob-anchor_ts-ui_packages_code-nav_code-nav_ts-ui_packages_filter--8253c1-91468a3354f9.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/react-code-view-b87fe0e0d386.js" type="application/javascript"></script>
<link crossorigin="anonymous" href="https://github.githubassets.com/assets/primer-react.0d51b59bedb82338176b.module.css" media="all" rel="stylesheet"/>
<link crossorigin="anonymous" href="https://github.githubassets.com/assets/react-code-view.dbb65fc03567484939f4.module.css" media="all" rel="stylesheet"/>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/notifications-subscriptions-menu-289430569e8f.js" type="application/javascript"></script>
<link crossorigin="anonymous" href="https://github.githubassets.com/assets/primer-react.0d51b59bedb82338176b.module.css" media="all" rel="stylesheet"/>
<link crossorigin="anonymous" href="https://github.githubassets.com/assets/notifications-subscriptions-menu.e5e6e593370c808590a5.module.css" media="all" rel="stylesheet"/>
<title>2024-04-22-riscv-trap</title>
<meta content="/:user_id/:repository/blob/*name(/*path)" data-turbo-transient="" name="route-pattern"/>
<meta content="blob" data-turbo-transient="" name="route-controller"/>
<meta content="show" data-turbo-transient="" name="route-action"/>
<meta content="v2:ce725979-15c4-01a2-36a2-e3d7ac33ceed" name="fetch-nonce"/>
<meta content="f3abb0cc802f3d7b95fc8762b94bdcb13bf39634c40c357301c4aa1d67a256fb" name="current-catalog-service-hash"/>
<meta content="0400:24EE22:3975A8E:4CB1273:683B05A0" data-pjax-transient="true" name="request-id"/><meta content="4f305155eace893ef73bef894f5906518ee4abcc0236bff19c7b5e5f8b2c4276" data-pjax-transient="true" name="html-safe-nonce"/><meta content="eyJyZWZlcnJlciI6IiIsInJlcXVlc3RfaWQiOiIwNDAwOjI0RUUyMjozOTc1QThFOjRDQjEyNzM6NjgzQjA1QTAiLCJ2aXNpdG9yX2lkIjoiODEzMTQ1NDA3MTkyMDU5MjI4OCIsInJlZ2lvbl9lZGdlIjoiaWFkIiwicmVnaW9uX3JlbmRlciI6ImlhZCJ9" data-pjax-transient="true" name="visitor-payload"/><meta content="0fc1a452709d63c457747e09dfa27e5874b79447bd6b97bee0b998771f3e5454" data-pjax-transient="true" name="visitor-hmac"/>
<meta content="repository:952181622" data-turbo-transient="" name="hovercard-subject-tag"/>
<meta content="repository,source-code,file-tree,copilot" data-turbo-transient="true" name="github-keyboard-shortcuts"/>
<meta data-turbo-transient="" name="selected-link" value="repo_source"/>
<link href="https://github.githubassets.com/" rel="assets"/>
<meta content="Apib7-x98H0j5cPqHWwSMm6dNU4GmODRoqxLiDzdx9I" name="google-site-verification"/>
<meta content="https://collector.github.com/github/collect" name="octolytics-url"/>
<meta content="/&lt;user-name&gt;/&lt;repo-name&gt;/blob/show" data-turbo-transient="true" name="analytics-location"/>
<meta content="" name="user-login"/>
<meta content="width=device-width" name="viewport"/>
<meta content="Contribute to BigBrotherJu/bigbrotherju.github.io development by creating an account on GitHub." name="description"/>
<link href="/opensearch.xml" rel="search" title="GitHub" type="application/opensearchdescription+xml"/>
<link href="https://github.com/fluidicon.png" rel="fluid-icon" title="GitHub"/>
<meta content="1401488693436528" property="fb:app_id"/>
<meta content="app-id=1477376905, app-argument=https://github.com/BigBrotherJu/bigbrotherju.github.io/blob/main/posts/2024-04-22-riscv-trap.md" name="apple-itunes-app"/>
<meta content="https://opengraph.githubassets.com/27bda34c3a7a5de48dd70a3c1f4eb8b3338070a846c9a088fce4088032c3aa7f/BigBrotherJu/bigbrotherju.github.io" name="twitter:image"/><meta content="@github" name="twitter:site"/><meta content="summary_large_image" name="twitter:card"/><meta content="bigbrotherju.github.io/posts/2024-04-22-riscv-trap.md at main · BigBrotherJu/bigbrotherju.github.io" name="twitter:title"/><meta content="Contribute to BigBrotherJu/bigbrotherju.github.io development by creating an account on GitHub." name="twitter:description"/>
<meta content="https://opengraph.githubassets.com/27bda34c3a7a5de48dd70a3c1f4eb8b3338070a846c9a088fce4088032c3aa7f/BigBrotherJu/bigbrotherju.github.io" property="og:image"/><meta content="Contribute to BigBrotherJu/bigbrotherju.github.io development by creating an account on GitHub." property="og:image:alt"/><meta content="1200" property="og:image:width"/><meta content="600" property="og:image:height"/><meta content="GitHub" property="og:site_name"/><meta content="object" property="og:type"/><meta content="bigbrotherju.github.io/posts/2024-04-22-riscv-trap.md at main · BigBrotherJu/bigbrotherju.github.io" property="og:title"/><meta content="https://github.com/BigBrotherJu/bigbrotherju.github.io/blob/main/posts/2024-04-22-riscv-trap.md" property="og:url"/><meta content="Contribute to BigBrotherJu/bigbrotherju.github.io development by creating an account on GitHub." property="og:description"/>
<meta content="github.com" name="hostname"/>
<meta content="github.com" name="expected-hostname"/>
<meta content="a395d02300df43d75dae709c993016a57e19ccf2d32f9be9e01e89324abdea7c" data-turbo-track="reload" http-equiv="x-pjax-version"/>
<meta content="352e51c42d5f5727a7c545752bf34d1f83f40219e7036c6959817149a51651bc" data-turbo-track="reload" http-equiv="x-pjax-csp-version"/>
<meta content="02d9e07ab26b5dabaf7d534d0383e70b6c0a9da345ead93ff8c4634f89ac61a8" data-turbo-track="reload" http-equiv="x-pjax-css-version"/>
<meta content="b7b75513cea9df94a7e33fa9756237aa090b4d22061095c8b2433d8a11be6cc3" data-turbo-track="reload" http-equiv="x-pjax-js-version"/>
<meta content="no-preview" data-turbo-transient="" name="turbo-cache-control"/>
<meta content="no-cache" data-turbo-transient="" name="turbo-cache-control"/>
<meta data-hydrostats="publish"/>
<meta content="github.com/BigBrotherJu/bigbrotherju.github.io git https://github.com/BigBrotherJu/bigbrotherju.github.io.git" name="go-import"/>
<meta content="47515692" name="octolytics-dimension-user_id"/><meta content="BigBrotherJu" name="octolytics-dimension-user_login"/><meta content="952181622" name="octolytics-dimension-repository_id"/><meta content="BigBrotherJu/bigbrotherju.github.io" name="octolytics-dimension-repository_nwo"/><meta content="true" name="octolytics-dimension-repository_public"/><meta content="false" name="octolytics-dimension-repository_is_fork"/><meta content="952181622" name="octolytics-dimension-repository_network_root_id"/><meta content="BigBrotherJu/bigbrotherju.github.io" name="octolytics-dimension-repository_network_root_nwo"/>
<meta content="logged-out env-production page-responsive" name="turbo-body-classes"/>
<meta content="https://api.github.com/_private/browser/stats" name="browser-stats-url"/>
<meta content="https://api.github.com/_private/browser/errors" name="browser-errors-url"/>
<meta content="e2c53cbf4dcc7d37109b8f92f84d03961cbff778" name="release"/>
<link color="#000000" href="https://github.githubassets.com/assets/pinned-octocat-093da3e6fa40.svg" rel="mask-icon"/>
<link class="js-site-favicon" href="https://github.githubassets.com/favicons/favicon.png" rel="alternate icon" type="image/png"/>
<link class="js-site-favicon" data-base-href="https://github.githubassets.com/favicons/favicon" href="https://github.githubassets.com/favicons/favicon.svg" rel="icon" type="image/svg+xml"/>
<meta content="#1e2327" name="theme-color"/>
<meta content="light dark" name="color-scheme"/>
<link crossorigin="use-credentials" href="/manifest.json" rel="manifest"/>
<style data-styled="active" data-styled-version="5.3.11"></style><style id="ms-consent-banner-main-styles">.w8hcgFksdo30C8w-bygqu{color:#000}.ydkKdaztSS0AeHWIeIHsQ a{color:#0067B8}.erL690_8JwUW-R4bJRcfl{background-color:#EBEBEB;border:none;color:#000}.erL690_8JwUW-R4bJRcfl:enabled:hover{color:#000;background-color:#DBDBDB;box-shadow:0px 4px 10px rgba(0,0,0,0.25);border:none}.erL690_8JwUW-R4bJRcfl:enabled:focus{background-color:#DBDBDB;box-shadow:0px 4px 10px rgba(0,0,0,0.25);border:2px solid #000}.erL690_8JwUW-R4bJRcfl:disabled{opacity:1;color:rgba(0,0,0,0.2);background-color:rgba(0,0,0,0.2);border:none}._1zNQOqxpBFSokeCLGi_hGr{border:none;background-color:#0067B8;color:#fff}._1zNQOqxpBFSokeCLGi_hGr:enabled:hover{color:#fff;background-color:#0067B8;box-shadow:0px 4px 10px rgba(0,0,0,0.25);border:none}._1zNQOqxpBFSokeCLGi_hGr:enabled:focus{background-color:#0067B8;box-shadow:0px 4px 10px rgba(0,0,0,0.25);border:2px solid #000}._1zNQOqxpBFSokeCLGi_hGr:disabled{opacity:1;color:rgba(0,0,0,0.2);background-color:rgba(0,120,215,0.2);border:none}._23tra1HsiiP6cT-Cka-ycB{position:relative;display:flex;z-index:9999;width:100%;background-color:#F2F2F2;justify-content:space-between;text-align:left}div[dir="rtl"]._23tra1HsiiP6cT-Cka-ycB{text-align:right}._1Upc2NjY8AlDn177YoVj0y{margin:0;padding-left:5%;padding-top:8px;padding-bottom:8px}div[dir="rtl"] ._1Upc2NjY8AlDn177YoVj0y{margin:0;padding:8px 5% 8px 0;float:none}._23tra1HsiiP6cT-Cka-ycB svg{fill:none;max-width:none;max-height:none}._1V_hlU-7jdtPiooHMu89BB{display:table-cell;padding:12px;width:24px;height:24px;font-family:Segoe UI, SegoeUI, Arial, sans-serif;font-style:normal;font-weight:normal;font-size:24px;line-height:0}.f6QKJD7fhSbnJLarTL-W-{display:table-cell;vertical-align:middle;padding:0;font-family:Segoe UI, SegoeUI, Arial, sans-serif;font-style:normal;font-weight:normal;font-size:13px;line-height:16px}.f6QKJD7fhSbnJLarTL-W- a{text-decoration:underline}._2j0fmugLb1FgYz6KPuB91w{display:inline-block;margin-left:5%;margin-right:5%;min-width:40%;min-width:calc((150px + 3 * 4px) * 2 + 150px);min-width:-webkit-fit-content;min-width:-moz-fit-content;min-width:fit-content;align-self:center;position:relative}._1XuCi2WhiqeWRUVp3pnFG3{margin:4px;padding:5px;min-width:150px;min-height:36px;vertical-align:top;cursor:pointer;font-family:Segoe UI, SegoeUI, Arial, sans-serif;font-style:normal;font-weight:normal;font-size:15px;line-height:20px;text-align:center}._1XuCi2WhiqeWRUVp3pnFG3:focus{box-sizing:border-box}._1XuCi2WhiqeWRUVp3pnFG3:disabled{cursor:not-allowed}._2bvsb3ubApyZ0UGoQA9O9T{display:block;position:fixed;z-index:10000;top:0;left:0;width:100%;height:100%;background-color:rgba(255,255,255,0.6);overflow:auto;text-align:left}div[dir="rtl"]._2bvsb3ubApyZ0UGoQA9O9T{text-align:right}div[dir="rtl"] ._2bvsb3ubApyZ0UGoQA9O9T{left:auto;right:0}.AFsJE948muYyzCMktdzuk{position:relative;top:8%;margin-bottom:40px;margin-left:auto;margin-right:auto;box-sizing:border-box;width:640px;background-color:#fff;border:1px solid #0067B8}._3kWyBRbW_dgnMiEyx06Fu4{float:right;z-index:1;margin:2px;padding:12px;border:none;cursor:pointer;font-family:Segoe UI, SegoeUI, Arial, sans-serif;font-style:normal;font-weight:normal;font-size:13px;line-height:13px;display:flex;align-items:center;text-align:center;color:#666;background-color:#fff}div[dir="rtl"] ._3kWyBRbW_dgnMiEyx06Fu4{margin:2px;padding:12px;float:left}.uCYvKvHXrhjNgflv1VqdD{position:static;margin-top:36px;margin-left:36px;margin-right:36px}._17pX1m9O_W--iZbDt3Ta5r{margin-top:0;margin-bottom:12px;font-family:Segoe UI, SegoeUI, Arial, sans-serif;font-style:normal;font-weight:600;font-size:20px;line-height:24px;text-transform:none}._1kBkHQ1V1wu3kl-YcLgUr6{height:446px;overflow:auto}._20_nXDf6uFs9Q6wxRXG-I-{margin-top:0;font-family:Segoe UI, SegoeUI, Arial, sans-serif;font-style:normal;font-weight:normal;font-size:15px;line-height:20px}._20_nXDf6uFs9Q6wxRXG-I- a{text-decoration:underline}dl._2a0NH_GDQEQe5Ynfo7suVH{margin-top:36px;margin-bottom:0;padding:0;list-style:none;text-transform:none}dt._3j_LCPv7fyXv3A8FIXVwZ4{margin-top:20px;float:none;font-family:Segoe UI, SegoeUI, Arial, sans-serif;font-style:normal;font-weight:600;font-size:18px;line-height:24px;list-style:none}.k-vxTGFbdq1aOZB2HHpjh{margin:0;padding:0;border:none}._2Bucyy75c_ogoU1g-liB5R{margin:0;padding:0;border-bottom:none;font-family:Segoe UI, SegoeUI, Arial, sans-serif;font-style:normal;font-weight:600;font-size:18px;line-height:24px;text-transform:none}._63gwfzV8dclrsl2cfd90r{display:inline-block;margin-top:0;margin-bottom:13px;font-family:Segoe UI, SegoeUI, Arial, sans-serif;font-style:normal;font-weight:normal;font-size:15px;line-height:20px}._1l8wM_4mRYGz3Iu7l3BZR7{display:block}._2UE03QS02aZGkslegN_F-i{display:inline-block;position:relative;left:5px;margin-bottom:13px;margin-right:34px;padding:3px}div[dir="rtl"] ._2UE03QS02aZGkslegN_F-i{margin:0 0 13px 34px;padding:3px;float:none}div[dir="rtl"] ._2UE03QS02aZGkslegN_F-i{left:auto;right:5px}._23tra1HsiiP6cT-Cka-ycB *::before,._2bvsb3ubApyZ0UGoQA9O9T *::before,._23tra1HsiiP6cT-Cka-ycB *::after,._2bvsb3ubApyZ0UGoQA9O9T *::after{box-sizing:inherit}._1HSFn0HzGo6w4ADApV8-c4{outline:2px solid rgba(0,0,0,0.8)}input[type="radio"]._1dp8Vp5m3HwAqGx8qBmFV2{display:inline-block;position:relative;margin-top:0;margin-left:0;margin-right:0;height:0;width:0;border-radius:0;cursor:pointer;outline:none;box-sizing:border-box;-webkit-appearance:none;-moz-appearance:none;appearance:none}input[type="radio"]._1dp8Vp5m3HwAqGx8qBmFV2+label::before{display:block;position:absolute;top:5px;left:3px;height:19px;width:19px;content:"";border-radius:50%;border:1px solid #000;background-color:#fff}div[dir="rtl"] input[type="radio"]._1dp8Vp5m3HwAqGx8qBmFV2+label::before{left:auto;right:3px}input[type="radio"]._1dp8Vp5m3HwAqGx8qBmFV2:not(:disabled)+label:hover::before{border:1px solid #0067B8}input[type="radio"]._1dp8Vp5m3HwAqGx8qBmFV2:not(:disabled)+label:hover::after{display:block;position:absolute;top:10px;left:8px;height:9px;width:9px;content:"";border-radius:50%;background-color:rgba(0,0,0,0.8)}div[dir="rtl"] input[type="radio"]._1dp8Vp5m3HwAqGx8qBmFV2:not(:disabled)+label:hover::after{left:auto;right:8px}input[type="radio"]._1dp8Vp5m3HwAqGx8qBmFV2:not(:disabled)+label:focus::before{border:1px solid #0067B8}input[type="radio"]._1dp8Vp5m3HwAqGx8qBmFV2:not(:disabled)+label:focus::after{display:block;position:absolute;top:10px;left:8px;height:9px;width:9px;content:"";border-radius:50%;background-color:#000}div[dir="rtl"] input[type="radio"]._1dp8Vp5m3HwAqGx8qBmFV2:not(:disabled)+label:focus::after{left:auto;right:8px}input[type="radio"]._1dp8Vp5m3HwAqGx8qBmFV2:checked+label::after{display:block;position:absolute;top:10px;left:8px;height:9px;width:9px;content:"";border-radius:50%;background-color:#000}div[dir="rtl"] input[type="radio"]._1dp8Vp5m3HwAqGx8qBmFV2:checked+label::after{left:auto;right:8px}input[type="radio"]._1dp8Vp5m3HwAqGx8qBmFV2:disabled+label{cursor:not-allowed}input[type="radio"]._1dp8Vp5m3HwAqGx8qBmFV2:disabled+label::before{border:1px solid rgba(0,0,0,0.2);background-color:rgba(0,0,0,0.2)}._3RJzeL3l9Rl_lAQEm6VwdX{display:block;position:static;float:right;margin-top:0;margin-bottom:0;margin-left:19px;margin-right:0;padding-top:0;padding-bottom:0;padding-left:8px;padding-right:0;width:80%;width:calc(100% - 19px);font-family:Segoe UI, SegoeUI, Arial, sans-serif;font-style:normal;font-weight:normal;font-size:15px;line-height:20px;text-transform:none;cursor:pointer;box-sizing:border-box}div[dir="rtl"] ._3RJzeL3l9Rl_lAQEm6VwdX{margin:0 19px 0 0;padding:0 8px 0 0;float:left}.nohp3sIG12ZBhzcMnPala{margin-top:20px;margin-bottom:48px}._2uhaEsmeotZ3P-M0AXo2kF{padding:0;width:278px;height:36px;cursor:pointer;font-family:Segoe UI, SegoeUI, Arial, sans-serif;font-style:normal;font-weight:normal;font-size:15px;line-height:20px;text-align:center}._2uhaEsmeotZ3P-M0AXo2kF:focus{box-sizing:border-box}._2uhaEsmeotZ3P-M0AXo2kF:disabled{cursor:not-allowed}._3tOu1FJ59c_xz_PmI1lKV5{float:right;padding:0;width:278px;height:36px;cursor:pointer;font-family:Segoe UI, SegoeUI, Arial, sans-serif;font-style:normal;font-weight:normal;font-size:15px;line-height:20px;text-align:center}._3tOu1FJ59c_xz_PmI1lKV5:focus{box-sizing:border-box}._3tOu1FJ59c_xz_PmI1lKV5:disabled{cursor:not-allowed}div[dir="rtl"] ._3tOu1FJ59c_xz_PmI1lKV5{margin:0;padding:0;float:left}@media only screen and (max-width: 768px){._2j0fmugLb1FgYz6KPuB91w,._1Upc2NjY8AlDn177YoVj0y{padding-top:8px;padding-bottom:12px;padding-left:3.75%;padding-right:3.75%;margin:0;width:92.5%}._23tra1HsiiP6cT-Cka-ycB{display:block}._1XuCi2WhiqeWRUVp3pnFG3{margin-bottom:8px;margin-left:0;margin-right:0;width:100%}._2bvsb3ubApyZ0UGoQA9O9T{overflow:hidden}.AFsJE948muYyzCMktdzuk{top:1.8%;width:93.33%;height:96.4%;overflow:hidden}.uCYvKvHXrhjNgflv1VqdD{margin-top:24px;margin-left:24px;margin-right:24px;height:100%}._1kBkHQ1V1wu3kl-YcLgUr6{height:62%;height:calc(100% - 188px);min-height:50%}._2uhaEsmeotZ3P-M0AXo2kF{width:100%}._3tOu1FJ59c_xz_PmI1lKV5{margin-bottom:12px;margin-left:0;width:100%}div[dir="rtl"] ._3tOu1FJ59c_xz_PmI1lKV5{margin:0 0 12px 0;padding:0;float:none}}@media only screen and (max-width: 768px) and (orientation: landscape), only screen and (max-height: 260px), only screen and (max-width: 340px){.AFsJE948muYyzCMktdzuk{overflow:auto}}@media only screen and (max-height: 260px), only screen and (max-width: 340px){._1XuCi2WhiqeWRUVp3pnFG3{min-width:0}._3kWyBRbW_dgnMiEyx06Fu4{padding:3%}.uCYvKvHXrhjNgflv1VqdD{margin-top:3%;margin-left:3%;margin-right:3%}._17pX1m9O_W--iZbDt3Ta5r{margin-bottom:3%}._1kBkHQ1V1wu3kl-YcLgUr6{height:calc(79% - 64px)}.nohp3sIG12ZBhzcMnPala{margin-top:5%;margin-bottom:10%}._3tOu1FJ59c_xz_PmI1lKV5{margin-bottom:3%}div[dir="rtl"] ._3tOu1FJ59c_xz_PmI1lKV5{margin:0 0 3% 0;padding:0;float:none}}
</style><style id="ms-consent-banner-theme-styles" type="text/css">._23tra1HsiiP6cT-Cka-ycB {
            background-color: #24292f !important;
        }.w8hcgFksdo30C8w-bygqu {
            color: #ffffff !important;
        }.ydkKdaztSS0AeHWIeIHsQ a {
            color: #d8b9ff !important;
        }._2bvsb3ubApyZ0UGoQA9O9T {
            background-color: rgba(23, 23, 23, 0.8) !important;
        }.AFsJE948muYyzCMktdzuk {
            background-color: #24292f !important;
            border: 1px solid #d8b9ff !important;
        }._3kWyBRbW_dgnMiEyx06Fu4 {
            color: #d8b9ff !important;
            background-color: #24292f !important;
        }._1zNQOqxpBFSokeCLGi_hGr {
            border: 1px solid #ffffff !important;
            background-color: #ffffff !important;
            color: #1f2328 !important;
        }._1zNQOqxpBFSokeCLGi_hGr:enabled:hover {
            color: #1f2328 !important;
            background-color: #d8b9ff !important;
            box-shadow: none !important;
            border: 1px solid transparent !important;
        }._1zNQOqxpBFSokeCLGi_hGr:enabled:focus {
            background-color: #d8b9ff !important;
            box-shadow: none !important;
            border: 2px solid #ffffff !important;
        }._1zNQOqxpBFSokeCLGi_hGr:disabled {
            opacity: 0.5 !important;
            color: #1f2328 !important;
            background-color: #ffffff !important;
            border: 1px solid transparent !important;
        }.erL690_8JwUW-R4bJRcfl {
            border: 1px solid #eaeef2 !important;
            background-color: #32383f !important;
            color: #ffffff !important;
        }.erL690_8JwUW-R4bJRcfl:enabled:hover {
            color: #ffffff !important;
            background-color: #24292f !important;
            box-shadow: none !important;
            border: 1px solid #ffffff !important;
        }.erL690_8JwUW-R4bJRcfl:enabled:focus {
            background-color: #24292f !important;
            box-shadow: none !important;
            border: 2px solid #6e7781 !important;
        }.erL690_8JwUW-R4bJRcfl:disabled {
            opacity: 0.5 !important;
            color: #ffffff !important;
            background-color: #424a53 !important;
            border: 1px solid #6e7781 !important;
        }input[type="radio"]._1dp8Vp5m3HwAqGx8qBmFV2 + label::before {
            border: 1px solid #d8b9ff !important;
            background-color: #24292f !important;
        }._1HSFn0HzGo6w4ADApV8-c4 {
            outline: 2px solid #ffffff !important;
        }input[type="radio"]._1dp8Vp5m3HwAqGx8qBmFV2:checked + label::after {
            background-color: #d8b9ff !important;
        }input[type="radio"]._1dp8Vp5m3HwAqGx8qBmFV2 + label:hover::before {
            border: 1px solid #ffffff !important;
        }input[type="radio"]._1dp8Vp5m3HwAqGx8qBmFV2 + label:hover::after {
            background-color: #ffffff !important;
        }input[type="radio"]._1dp8Vp5m3HwAqGx8qBmFV2 + label:focus::before {
            border: 1px solid #ffffff !important;
        }input[type="radio"]._1dp8Vp5m3HwAqGx8qBmFV2 + label:focus::after {
            background-color: #d8b9ff !important;
        }input[type="radio"]._1dp8Vp5m3HwAqGx8qBmFV2:disabled + label::before {
            border: 1px solid rgba(227, 227, 227, 0.2) !important;
            background-color: rgba(227, 227, 227, 0.2) !important;
        }</style></head>
<body class="logged-out env-production page-responsive" style="overflow-wrap: break-word; --dialog-scrollgutter: 0px;"><div class="Box-sc-g0xbh4-0 eoaCFS js-snippet-clipboard-copy-unpositioned undefined" data-hpc="true" style="padding: 32px"><article class="markdown-body entry-content container-lg" itemprop="text"><markdown-accessiblity-table data-catalyst=""><table>
<thead>
<tr>
<th>title</th>
<th>date</th>
<th>categories</th>
<th>tags</th>
</tr>
</thead>
<tbody>
<tr>
<td><div dir="auto">RISC-V Trap</div></td>
<td><div dir="auto">2024-04-22 17:30:00 +0800</div></td>
<td><div dir="auto"><table>
<tbody>
<tr>
<td><div dir="auto">RISC-V</div></td>
</tr>
</tbody>
</table>
</div></td>
<td><div dir="auto"><table>
<tbody>
<tr>
<td><div dir="auto">embedded systems</div></td>
<td><div dir="auto">risc-v</div></td>
</tr>
</tbody>
</table>
</div></td>
</tr>
</tbody>
</table></markdown-accessiblity-table>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto" tabindex="-1">Trap</h2><a aria-label="Permalink: Trap" class="anchor" href="#trap" id="user-content-trap"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">在 ISA 语境下，trap 包括异常和中断。</p>
<p dir="auto">在 OS 语境下，trap 包括异常、系统调用（其实也是一种异常）、中断。</p>
<ul dir="auto">
<li>
<p dir="auto">Exception</p>
<p dir="auto">We use the term <strong>exception</strong> to refer to an unusual condition occurring at run time associated with an instruction in the current RISC-V hart.</p>
</li>
<li>
<p dir="auto">Interrupt</p>
<p dir="auto">We use the term <strong>interrupt</strong> to refer to an external <strong>asynchronous</strong> event that may cause a RISC-V hart to experience an <strong>unexpected</strong> transfer of control.</p>
</li>
<li>
<p dir="auto">Trap</p>
<p dir="auto">We use the term <strong>trap</strong> to refer to the transfer of control to a trap handler caused by either an exception or an interrupt.</p>
</li>
<li>
<p dir="auto">Trap 处理总流程</p>
<ul dir="auto">
<li>什么条件下 trap 进什么 mode</li>
<li>进入 trap 时的 CPU 操作</li>
<li>进入 trap 以后的软件操作</li>
<li>退出 trap 时的 CPU 操作</li>
</ul>
</li>
<li>
<p dir="auto">进入和退出 trap 时的 CPU 操作</p>
<ul dir="auto">
<li>
<p dir="auto"><code>mstatus</code> 的一部分就是 <code>sstatus</code></p>
<p dir="auto">A restricted view of <code>mstatus</code> appears as the <code>sstatus</code> register in the S-level ISA.</p>
<p dir="auto">The <code>sstatus</code> register is a subset of the <code>mstatus</code> register.</p>
</li>
<li>
<p dir="auto">读写 <code>sstatus</code> 等于读写 <code>mstatus</code></p>
<p dir="auto">In a straightforward implementation, reading or writing any field in <code>sstatus</code> is equivalent to reading or writing the homonymous field in <code>mstatus</code>.</p>
</li>
<li>
<p dir="auto">发生 trap</p>
<p dir="auto">When a trap is taken from privilege mode y into privilege mode x, xPIE is set to the value of xIE; xIE is set to 0; and xPP is set to y.</p>
<p dir="auto">从 y 进入 x，xPIE = xIE、xIE = 0、xPP = y。</p>
<p dir="auto">另外，xepc = pc、xcause xtavl 更新、pc = xtvec。</p>
</li>
<li>
<p dir="auto">从 trap 返回</p>
<p dir="auto">When executing an xRET instruction, supposing xPP holds the value y, xIE is set to xPIE; the privilege mode is changed to y; xPIE is set to 1; and xPP is set to the least-privileged supported mode (U if U-mode is implemented, else M).</p>
<p dir="auto">执行 xRET，xIE = xPIE，特权级 = xPP、xPIE = 1、xPP = U。</p>
<p dir="auto">另外，xRET 使 pc = xepc。</p>
<p dir="auto">MRET：MIE = MPIE，特权级 = MPP、MPIE = 1、MPP = U、pc = mepc。</p>
<p dir="auto">SRET：SIE = SPIE，特权级 = SPP、SPIE = 1、SPP = U、pc = sepc。</p>
</li>
</ul>
</li>
<li>
<p dir="auto">什么条件下 trap 进什么 mode</p>
<p dir="auto">下面讨论。</p>
<p dir="auto">如果同时出现 exception 和 interrupt，先处理谁 RISC-V 文档没有规定。老版本是有的，后来不知道为什么删了。</p>
</li>
</ul>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto" tabindex="-1">Delegation</h2><a aria-label="Permalink: Delegation" class="anchor" href="#delegation" id="user-content-delegation"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<ul dir="auto">
<li>
<p dir="auto">首先，如果不使用代理，所有 trap 都会进入 m mode 处理</p>
<p dir="auto">By default, all traps at any privilege level are handled in machine mode, though a machine-mode handler can redirect traps back to the appropriate level with the MRET instruction (Section 3.3.2).</p>
</li>
<li>
<p dir="auto">代理就是进入 s mode 处理，但是不可能进入 u mode</p>
<p dir="auto">To increase performance, implementations can provide individual read/write bits within <code>medeleg</code> and <code>mideleg</code> to indicate that certain exceptions and interrupts should be processed directly by a lower privilege level.</p>
<p dir="auto">In systems with S-mode, the <code>medeleg</code> and <code>mideleg</code> registers must exist, and setting a bit in <code>medeleg</code> or <code>mideleg</code> will delegate the corresponding trap, when occurring in S-mode or U-mode, to the S-mode trap handler.</p>
</li>
<li>
<p dir="auto">代理的用处</p>
<ul dir="auto">
<li>在 S 态发生异常或中断时，可以直接在 S 态处理</li>
<li>在 U 态发生异常或中断时，不用升到 M 态，升到 S 态就可以</li>
</ul>
</li>
<li>
<p dir="auto">Contents of registers</p>
<p dir="auto">For exceptions that cannot occur in less privileged modes, the corresponding <code>medeleg</code> bits should be read-only zero. In particular, <code>medeleg</code>[11] (ecall from m-mode) is read-only zero.</p>
<p dir="auto"><code>mideleg</code> 实际上只有 3 位可以读写，对应 SEI STI SSI。</p>
</li>
<li>
<p dir="auto">处理 trap 时特权级不会降低，只会不变或者升高</p>
<p dir="auto">Traps never transition from a more-privileged mode to a less-privileged mode.</p>
<p dir="auto">For example, if M-mode has delegated illegal instruction exceptions to S-mode, and M-mode software later executes an illegal instruction, the trap is taken in M-mode, rather than being delegated to S-mode.</p>
<p dir="auto">By contrast, traps may be taken horizontally. Using the same example, if M-mode has delegated illegal instruction exceptions to S-mode, and S-mode software later executes an illegal instruction, the trap is taken in S-mode.</p>
</li>
<li>
<p dir="auto">什么条件下 trap 进什么 mode（异常）</p>
<p dir="auto">对某一个异常，如果它没被代理，不管处理器现在是 u/s/m，发生异常以后，都会进入 m-mode。</p>
<p dir="auto">对某一个异常，如果它被代理了，就意味着发生异常以后会进入 s-mode。</p>
<p dir="auto">如果处理器现在是 m，发生异常以后，代理无效，进入 m-mode。</p>
<p dir="auto">如果处理器现在是 s，发生异常以后，代理有效，进入 s-mode。</p>
<p dir="auto">如果处理器现在是 u，发生异常以后，代理有效，进入 s-mode。</p>
<p dir="auto">如果发生多个异常，根据异常优先级进行处理。</p>
</li>
<li>
<p dir="auto">什么条件下 trap 进什么 mode（中断）</p>
<p dir="auto">什么条件下 trap 进什么 mode（中断）实际上分成两部分，包括中断硬件和 CPU。</p>
<p dir="auto">可以被代理的中断实际上只有 SEI STI SSI，下面讨论。</p>
</li>
</ul>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto" tabindex="-1">中断类型</h2><a aria-label="Permalink: 中断类型" class="anchor" href="#中断类型" id="user-content-中断类型"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<ul dir="auto">
<li>
<p dir="auto">External interrupt</p>
</li>
<li>
<p dir="auto">Timer interrupt</p>
</li>
<li>
<p dir="auto">Software interrupt</p>
<p dir="auto">Software interrupts are most useful for interprocessor communication in multi-hart systems, as harts may write each other’s <code>MSIP</code> bits to effect interprocessor interrupts. (SiFive Doc)</p>
</li>
</ul>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto" tabindex="-1">中断硬件</h2><a aria-label="Permalink: 中断硬件" class="anchor" href="#中断硬件" id="user-content-中断硬件"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto" tabindex="-1">基本中断硬件</h3><a aria-label="Permalink: 基本中断硬件" class="anchor" href="#基本中断硬件" id="user-content-基本中断硬件"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">市面上的 SOC 大多只实现了 PLIC 和 CLINT。</p>
<ul dir="auto">
<li>
<p dir="auto">Platform-Level Interrupt Controller (PLIC)</p>
<p dir="auto"><a href="https://github.com/riscv/riscv-plic-spec">https://github.com/riscv/riscv-plic-spec</a></p>
<p dir="auto">最早由 SiFive 提出并实现，现在已经被标准化。</p>
<p dir="auto">产生 s-mode m-mode external interrupt。</p>
</li>
<li>
<p dir="auto">Core-Local Interruptor (CLINT)</p>
<p dir="auto"><a href="https://www.sifive.com/documentation" rel="nofollow">https://www.sifive.com/documentation</a></p>
<p dir="auto">最早由 SiFive 提出并实现，CLINT 文档包含在 SiFive SOC 文档中。RISC-V 官方没有文档。</p>
<p dir="auto">产生 m-mode timer interrupt 和 m-mode software interrpt。</p>
</li>
</ul>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto" tabindex="-1">高级中断硬件</h3><a aria-label="Permalink: 高级中断硬件" class="anchor" href="#高级中断硬件" id="user-content-高级中断硬件"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">这些高级中断硬件还没有硬件实现。</p>
<ul dir="auto">
<li>
<p dir="auto">Core-Local Interrupt Controller (CLIC)</p>
<p dir="auto"><a href="https://github.com/riscv/riscv-fast-interrupt">https://github.com/riscv/riscv-fast-interrupt</a></p>
<p dir="auto">只负责 local interrupt。</p>
</li>
<li>
<p dir="auto">Advanced Interrupt Architecture (AIA)</p>
<p dir="auto"><a href="https://github.com/riscv/riscv-aia">https://github.com/riscv/riscv-aia</a></p>
<p dir="auto">MSI 好像是 PCIE 引入的概念。</p>
<p dir="auto">– Extended Local Interrupts (AIA CSRs)
– Incoming Message Signaled Interrupt Controller (IMSIC)
– Advanced Platform Level Interrupt Controller (APLIC)</p>
</li>
<li>
<p dir="auto">Advanced Core-Local Interruptor (ACLINT)</p>
<p dir="auto"><a href="https://github.com/riscv/riscv-aclint">https://github.com/riscv/riscv-aclint</a></p>
<p dir="auto">ACLINT 兼容 CLINT。</p>
</li>
</ul>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto" tabindex="-1">PLIC</h3><a aria-label="Permalink: PLIC" class="anchor" href="#plic" id="user-content-plic"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<ul dir="auto">
<li>
<p dir="auto">中断仲裁（什么条件下 trap 进什么 mode）</p>
<p dir="auto">满足下面条件的中断源会参与中断仲裁：</p>
<ul dir="auto">
<li>中断源的 IP 为 1（中断源发生电平中断或脉冲中断会将 IP 置 1）</li>
<li>中断源的优先级 PRIO 大于 0</li>
<li>中断源的 MIE/SIE 寄存器打开</li>
</ul>
<p dir="auto">仲裁时先看优先级，高的优先；如果优先级一样，中断号小的优先。</p>
<p dir="auto">仲裁结果是中断号。</p>
</li>
<li>
<p dir="auto">Interrupt notification（什么条件下 trap 进什么 mode）</p>
<p dir="auto">Interrupt notifications generated by the PLIC appear in the meip/seip bits of the mip/sip registers for M/S modes respectively.</p>
<p dir="auto">当仲裁结果的优先级大于 MTH/STH 寄存器时，会向中断目标发送中断提醒，即将 mip sip 中的 MEIP SEIP 置 1。</p>
<p dir="auto">如果 PLIC 向同一个 hart 的不同特权级都发送中断提醒，那么 mip 的 MEIP SEIP 都会置 1。如果 SEIP 被代理，sip 中的 SEIP 也会置 1；如果 SEIP 不被代理，sip 中的 SEIP 是 0。</p>
</li>
<li>
<p dir="auto">中断 claim（进入 trap 以后的软件操作）</p>
<p dir="auto">中断目标读 MCLAIM/SCLAIM 寄存器，读出仲裁结果的中断号。然后 PLIC 将该中断源的 IP 置 0，且在中断处理完成之前屏蔽该中断源的后续采样。</p>
<p dir="auto">在 claim 以后，如果存在其他中断，xEIP 位可能还会是 1。</p>
<p dir="auto">xEIP 位为 0 时也可以 claim。</p>
</li>
<li>
<p dir="auto">中断 completion（进入 trap 以后的软件操作）</p>
<p dir="auto">中断目标将中断号写入 MCLAIM/SCLAIM 寄存器。（该写操作不会更新 CLAIM 寄存器。）然后 PLIC 解除中断号对应的中断源采样屏蔽，结束整个中断处理过程。</p>
<p dir="auto">The PLIC does not check whether the completion ID is the same as the last claim ID for that target.</p>
</li>
</ul>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto" tabindex="-1">CLINT</h3><a aria-label="Permalink: CLINT" class="anchor" href="#clint" id="user-content-clint"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">RISC-V 文档只提到了 <code>mtime</code> 和 <code>mtimecmp</code>，关于 <code>msip</code>，只在说明 <code>mip.MSIP</code> 时说可以通过写 mmio 寄存器来更新 <code>mip.MSIP</code>，具体没说这个 mmio 寄存器是什么。</p>
<ul dir="auto">
<li>
<p dir="auto"><code>msip</code> register (memory-mapped, 1 for each hart)</p>
<p dir="auto">Machine-mode <strong>software interrupts</strong> are generated by writing to the memory-mapped control register <code>msip</code>. (SiFive Doc)</p>
<p dir="auto">The least significant bit of <code>msip</code> register is reflected in the <code>MSIP</code> bit of the <code>mip</code> CSR. (SiFive Doc)</p>
</li>
<li>
<p dir="auto"><code>mtimecmp</code> register (memory-mapped, 1 for each hart)</p>
<p dir="auto">A machine timer interrupt becomes pending whenever <code>mtime</code> contains a value greater than or equal to <code>mtimecmp</code>, treating the values as unsigned integers.</p>
<p dir="auto">The timer interrupt is reflected in the <code>MTIP</code> bit of the <code>mip</code> register. (SiFive Doc)</p>
<p dir="auto">Writes to <code>mtime</code> and <code>mtimecmp</code> are guaranteed to be reflected in <code>MTIP</code> eventually, but not necessarily immediately.</p>
</li>
<li>
<p dir="auto"><code>mtime</code> register (memory-mapped, 1 for each platform)</p>
</li>
</ul>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto" tabindex="-1">CPU 的中断支持</h2><a aria-label="Permalink: CPU 的中断支持" class="anchor" href="#cpu-的中断支持" id="user-content-cpu-的中断支持"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<ul dir="auto">
<li>
<p dir="auto">单个中断进入 m-mode 的条件</p>
<p dir="auto">An interrupt i will trap to M-mode (causing the privilege mode to change to M-mode) if all of the following are true:</p>
<ol dir="auto">
<li>either the current privilege mode is M and the <code>MIE</code> bit in the <code>mstatus</code> register is set, or the current privilege mode has less privilege than M-mode;</li>
<li>bit i is set in both <code>mip</code> and <code>mie</code>;</li>
<li>if register <code>mideleg</code> exists, bit i is not set in <code>mideleg</code>.</li>
</ol>
</li>
<li>
<p dir="auto">单个中断进入 s-mode 的条件</p>
<p dir="auto">An interrupt i will trap to S-mode if both of the following are true:</p>
<ol dir="auto">
<li>either the current privilege mode is S and the <code>SIE</code> bit in the <code>sstatus</code> register is set, or the current privilege mode has less privilege than S-mode; and</li>
<li>bit i is set in both <code>sip</code> and <code>sie</code>.</li>
</ol>
</li>
<li>
<p dir="auto">当有中断可以 trap 进 m，也有中断可以 trap 进 s</p>
<p dir="auto">Interrupts to M-mode take priority over any interrupts to lower privilege modes.</p>
<p dir="auto">Interrupts to S-mode take priority over any interrupts to lower privilege modes.</p>
</li>
<li>
<p dir="auto">多个 trap 进 m 的中断仲裁</p>
<p dir="auto">Multiple simultaneous interrupts destined for M-mode are handled in the following decreasing priority order: MEI, MSI, MTI, SEI, SSI, STI.</p>
</li>
<li>
<p dir="auto">多个 trap 进 s 的中断仲裁</p>
<p dir="auto">Multiple simultaneous interrupts destined for supervisor mode are handled in the following decreasing priority order: SEI, SSI, STI.</p>
</li>
<li>
<p dir="auto">什么条件下 trap 进什么 mode</p>
<p dir="auto">外部中断硬件在这一步中起的作用是将 mip sip 中的位进行设置。</p>
<p dir="auto">然后 <strong>CPU 首先根据 mip sip 中的位判断对应的单个中断什么条件下 trap 进什么 mode</strong>。如果存在 trap 进 m 的中断，也存在 trap 进 s 的中断，m 优先级高。然后再进行同一模式中断的仲裁，仲裁出一个中断。</p>
</li>
</ul>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto" tabindex="-1"><code>mip</code></h3><a aria-label="Permalink: mip" class="anchor" href="#mip" id="user-content-mip"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<ul dir="auto">
<li>
<p dir="auto">How to set/clear <code>mip</code> bit</p>
<p dir="auto">Each individual bit in register <code>mip</code> may be writable or may be read-only.</p>
<p dir="auto">When bit i in <code>mip</code> is writable, a pending interrupt i can be cleared by writing 0 to this bit.</p>
<p dir="auto">If interrupt i can become pending but bit i in <code>mip</code> is read-only, the implementation must provide some other mechanism for clearing the pending interrupt.</p>
</li>
<li>
<p dir="auto"><code>mip</code> bit <code>MEIP</code> read-only</p>
<p dir="auto"><code>MEIP</code> is read-only in <code>mip</code>, and is set and cleared by a platform-specific interrupt controller.</p>
</li>
<li>
<p dir="auto"><code>mip</code> bit <code>MTIP</code> read-only</p>
<p dir="auto"><code>MTIP</code> is read-only in <code>mip</code>, and is cleared by writing to the memory-mapped machine-mode timer compare register.</p>
</li>
<li>
<p dir="auto"><code>mip</code> bit <code>MSIP</code> read-only</p>
<p dir="auto"><code>MSIP</code> is read-only in <code>mip</code>, and is written by accesses to memory-mapped control registers.</p>
</li>
<li>
<p dir="auto"><code>mip</code> bit <code>SEIP</code> writable</p>
<p dir="auto"><code>SEIP</code> is writable in <code>mip</code>, and may be written by M-mode software to indicate to S-mode that an external interrupt is pending.</p>
<p dir="auto">Additionally, the platform-level interrupt controller may generate supervisor-level external interrupts.</p>
<p dir="auto">Supervisor-level external interrupts are made pending based on the logical-OR of the software-writable <code>SEIP</code> bit and the signal from the external interrupt controller.</p>
<p dir="auto">When <code>mip</code> is read with a CSR instruction, the value of the <code>SEIP</code> bit returned in the rd destination register is the logical-OR of the software-writable bit and the interrupt signal from the interrupt controller, but the signal from the interrupt controller is not used to calculate the value written to <code>SEIP</code>.</p>
<p dir="auto">Only the software-writable <code>SEIP</code> bit participates in the read-modify-write sequence of a CSRRS or CSRRC instruction.</p>
</li>
<li>
<p dir="auto"><code>mip</code> bit <code>STIP</code> writable</p>
<p dir="auto"><code>STIP</code> is writable in <code>mip</code>, and may be written by M-mode software to deliver timer interrupts to S-mode.</p>
</li>
<li>
<p dir="auto"><code>mip</code> bit <code>SSIP</code> writable</p>
<p dir="auto"><code>SSIP</code> is writable in <code>mip</code> and may also be set to 1 by a platform-specific interrupt controller.</p>
</li>
</ul>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto" tabindex="-1"><code>sip</code></h3><a aria-label="Permalink: sip" class="anchor" href="#sip" id="user-content-sip"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<ul dir="auto">
<li>
<p dir="auto">SEI STI SSI 只有被代理了能在 <code>sip</code> <code>sie</code> 中有效</p>
<p dir="auto">Restricted views of the <code>mip</code> and <code>mie</code> registers appear as the <code>sip</code> and <code>sie</code> registers for supervisor level.</p>
<p dir="auto">If an interrupt is delegated to S-mode by setting a bit in the <code>mideleg</code> register, it becomes visible in the <code>sip</code> register and is maskable using the <code>sie</code> register.</p>
<p dir="auto">Otherwise, the corresponding bits in <code>sip</code> and <code>sie</code> are read-only zero.</p>
</li>
<li>
<p dir="auto">读写 sip sie 中的位就是读写 mip mie 中的位</p>
<p dir="auto">The <code>sip</code> and <code>sie</code> registers are subsets of the <code>mip</code> and <code>mie</code> registers. Reading any implemented field, or writing any writable field, of <code>sip</code>/<code>sie</code> effects a read or write of the homonymous field of <code>mip</code>/<code>mie</code>.</p>
</li>
<li>
<p dir="auto">How to set/clear <code>sip</code> bit</p>
<p dir="auto">Each individual bit in register <code>sip</code> may be writable or may be read-only.</p>
<p dir="auto">When bit i in <code>sip</code> is writable, a pending interrupt i can be cleared by writing 0 to this bit.</p>
<p dir="auto">If interrupt i can become pending but bit i in <code>sip</code> is read-only, the implementation must provide some other mechanism for clearing the pending interrupt (which may involve a call to the execution environment).</p>
</li>
<li>
<p dir="auto"><code>sip</code> bit <code>SEIP</code> read-only</p>
<p dir="auto">If implemented, <code>SEIP</code> is read-only in <code>sip</code>, and is set and cleared by the execution environment, typically through a platform-specific interrupt controller.</p>
</li>
<li>
<p dir="auto"><code>sip</code> bit <code>STIP</code> read-only</p>
<p dir="auto">If implemented, <code>STIP</code> is read-only in <code>sip</code>, and is set and cleared by the execution environment.</p>
</li>
<li>
<p dir="auto"><code>sip</code> bit <code>SSIP</code> writable</p>
<p dir="auto">If implemented, <code>SSIP</code> is writable in <code>sip</code> and may also be set to 1 by a platform-specific interrupt controller.</p>
</li>
</ul>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto" tabindex="-1">单个中断什么条件下 trap 进什么 mode</h3><a aria-label="Permalink: 单个中断什么条件下 trap 进什么 mode" class="anchor" href="#单个中断什么条件下-trap-进什么-mode" id="user-content-单个中断什么条件下-trap-进什么-mode"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<ul dir="auto">
<li>
<p dir="auto">几个重要信息</p>
<ol dir="auto">
<li>中断进入 m mode 的条件</li>
<li>中断进入 s mode 的条件</li>
<li>SEI STI SSI 只有被代理了能在 <code>sip</code> <code>sie</code> 中有效</li>
</ol>
</li>
<li>
<p dir="auto">中断处理汇总</p>
<p dir="auto"><a href="https://github.com/BigBrotherJu/bigbrotherju.github.io/blob/main/assets/img/interrupt-summary.png" rel="noopener noreferrer" target="_blank"><img alt="interrupt-summary" src="https://github.com/BigBrotherJu/bigbrotherju.github.io/raw/main/assets/img/interrupt-summary.png" style="max-width: 100%;"/></a></p>
<ul dir="auto">
<li>
<p dir="auto">处理器 u，中断 m</p>
<p dir="auto">m 态中断不能被代理。</p>
<p dir="auto">根据信息 1，如果满足下列条件，trap 进 m-mode：</p>
<ol dir="auto">
<li>此时处理器为 u，不关心 mstatus 的 MIE</li>
<li>mip mie 相应的位需要为 1，MEIP MTIP MSIP 都是 read-only，由 PLIC CLINT set clear</li>
<li>m 态中断不能被代理</li>
</ol>
</li>
<li>
<p dir="auto">处理器 u，中断 s</p>
<p dir="auto">s 态中断可以被代理。</p>
<p dir="auto">如果没被代理，根据信息 1，如果满足下列条件，trap 进 m-mode：</p>
<ol dir="auto">
<li>此时处理器为 u，不关心 mstatus 的 MIE</li>
<li>mip mie 相应的位需要为 1，SEIP STIP SSIP 都是 writable，SEIP 也可以由 PLIC set clear</li>
<li>s 态中断没有被代理</li>
</ol>
<p dir="auto">如果被代理，根据信息 1 第 3 条，不能进 m-mode。根据信息 2，如果满足下列条件，trap 进 s-mode：</p>
<ol dir="auto">
<li>此时处理器为 u，不关心 sstatus 的 SIE</li>
<li>根据信息 3，此时中断已经被代理，sip sie 中可以看到 mip mie 的 SEI STI SSI，只要相应的位为 1 就可以</li>
</ol>
</li>
<li>
<p dir="auto">处理器 s，中断 m</p>
<p dir="auto">根据信息 1，如果满足下列条件，trap 进 m-mode：</p>
<ol dir="auto">
<li>此时处理器为 s，不关心 mstatus 的 MIE</li>
<li>mip mie 相应的位需要为 1，MEIP MTIP MSIP 都是 read-only，由 PLIC CLINT set clear</li>
<li>m 态中断不能被代理</li>
</ol>
</li>
<li>
<p dir="auto">处理器 s，中断 s</p>
<p dir="auto">如果中断没被代理，根据信息 1，如果满足下列条件，trap 进 m-mode：</p>
<ol dir="auto">
<li>此时处理器为 s，不关心 mstatus 的 MIE</li>
<li>mip mie 相应的位需要为 1，SEIP STIP SSIP 都是 writable，SEIP 也可以由 PLIC set clear</li>
<li>s 态中断没有被代理</li>
</ol>
<p dir="auto">如果中断被代理，根据信息 1 第 3 条，不能进 m-mode。根据信息 2，如果满足下列条件，trap 进 s-mode：</p>
<ol dir="auto">
<li>此时处理器为 s，需要 sstatus 的 SIE 为 1</li>
<li>根据信息 3，此时中断已经被代理，sip sie 中可以看到 mip mie 的 SEI STI SSI，只要相应的位为 1 就可以</li>
</ol>
</li>
<li>
<p dir="auto">处理器 m，中断 m</p>
<p dir="auto">根据信息 1，如果满足下列条件，trap 进 m-mode：</p>
<ol dir="auto">
<li>此时处理器为 m，需要 mstatus 的 MIE 为 1</li>
<li>mip mie 相应的位需要为 1，MEIP MTIP MSIP 都是 read-only，由 PLIC CLINT set clear</li>
<li>m 态中断不能被代理</li>
</ol>
</li>
<li>
<p dir="auto">处理器 m，中断 s</p>
<p dir="auto">如果中断没被代理，根据信息 1，如果满足下列条件，trap 进 m-mode：</p>
<ol dir="auto">
<li>此时处理器为 m，需要 mstatus 的 MIE 为 1</li>
<li>mip mie 相应的位需要为 1，SEIP STIP SSIP 都是 writable，SEIP 也可以由 PLIC set clear</li>
<li>s 态中断没有被代理</li>
</ol>
<p dir="auto">如果中断被代理，根据信息 1 第 3 条，不能进 m-mode。根据信息 2，不满足条件 1 （处理器特权级小于等于 s），所以也不能 trap 进 s-mode。</p>
<p dir="auto">所以这种情况下，中断不被响应。</p>
<p dir="auto">RISC-V 特权级文档 medeleg mideleg 部分有举例子。</p>
</li>
</ul>
</li>
</ul>
</article></div>

<div aria-atomic="true" aria-live="polite" class="sr-only mt-n1" id="js-global-screen-reader-notice"></div>
<div aria-atomic="true" aria-live="assertive" class="sr-only mt-n1" id="js-global-screen-reader-notice-assertive"></div>
<div aria-live="assertive" class="sr-only mt-n1" data-testid="screenReaderAnnouncement" id="screenReaderAnnouncementDiv" role="alert"> </div></body></html>