<!DOCTYPE html>
<html class="js-focus-visible" data-a11y-animated-images="system" data-a11y-link-underlines="true" data-color-mode="auto" data-dark-theme="dark" data-js-focus-visible="" data-light-theme="light" data-turbo-loaded="" lang="en"><head><style type="text/css">.turbo-progress-bar {
  position: fixed;
  display: block;
  top: 0;
  left: 0;
  height: 3px;
  background: #0076ff;
  z-index: 2147483647;
  transition:
    width 300ms ease-out,
    opacity 150ms 150ms ease-in;
  transform: translate3d(0, 0, 0);
}
</style>
<meta charset="utf-8"/>
<link href="https://github.githubassets.com" rel="dns-prefetch"/>
<link href="https://avatars.githubusercontent.com" rel="dns-prefetch"/>
<link href="https://github-cloud.s3.amazonaws.com" rel="dns-prefetch"/>
<link href="https://user-images.githubusercontent.com/" rel="dns-prefetch"/>
<link crossorigin="" href="https://github.githubassets.com" rel="preconnect"/>
<link href="https://avatars.githubusercontent.com" rel="preconnect"/>
<link crossorigin="anonymous" href="https://github.githubassets.com/assets/light-8e973f836952.css" media="all" rel="stylesheet"/><link crossorigin="anonymous" href="https://github.githubassets.com/assets/light_high_contrast-34b642d57214.css" media="all" rel="stylesheet"/><link crossorigin="anonymous" href="https://github.githubassets.com/assets/dark-4bce7af39e21.css" media="all" rel="stylesheet"/><link crossorigin="anonymous" href="https://github.githubassets.com/assets/dark_high_contrast-ad512d3e2f3b.css" media="all" rel="stylesheet"/><link crossorigin="anonymous" data-color-theme="light" data-href="https://github.githubassets.com/assets/light-8e973f836952.css" media="all" rel="stylesheet"/><link crossorigin="anonymous" data-color-theme="light_high_contrast" data-href="https://github.githubassets.com/assets/light_high_contrast-34b642d57214.css" media="all" rel="stylesheet"/><link crossorigin="anonymous" data-color-theme="light_colorblind" data-href="https://github.githubassets.com/assets/light_colorblind-54be93e666a7.css" media="all" rel="stylesheet"/><link crossorigin="anonymous" data-color-theme="light_colorblind_high_contrast" data-href="https://github.githubassets.com/assets/light_colorblind_high_contrast-8ae7edf5489c.css" media="all" rel="stylesheet"/><link crossorigin="anonymous" data-color-theme="light_tritanopia" data-href="https://github.githubassets.com/assets/light_tritanopia-84d50df427c0.css" media="all" rel="stylesheet"/><link crossorigin="anonymous" data-color-theme="light_tritanopia_high_contrast" data-href="https://github.githubassets.com/assets/light_tritanopia_high_contrast-a80873375146.css" media="all" rel="stylesheet"/><link crossorigin="anonymous" data-color-theme="dark" data-href="https://github.githubassets.com/assets/dark-4bce7af39e21.css" media="all" rel="stylesheet"/><link crossorigin="anonymous" data-color-theme="dark_high_contrast" data-href="https://github.githubassets.com/assets/dark_high_contrast-ad512d3e2f3b.css" media="all" rel="stylesheet"/><link crossorigin="anonymous" data-color-theme="dark_colorblind" data-href="https://github.githubassets.com/assets/dark_colorblind-d152d6cd6879.css" media="all" rel="stylesheet"/><link crossorigin="anonymous" data-color-theme="dark_colorblind_high_contrast" data-href="https://github.githubassets.com/assets/dark_colorblind_high_contrast-fa4060c1a9da.css" media="all" rel="stylesheet"/><link crossorigin="anonymous" data-color-theme="dark_tritanopia" data-href="https://github.githubassets.com/assets/dark_tritanopia-d7bad0fb00bb.css" media="all" rel="stylesheet"/><link crossorigin="anonymous" data-color-theme="dark_tritanopia_high_contrast" data-href="https://github.githubassets.com/assets/dark_tritanopia_high_contrast-4a0107c0f60c.css" media="all" rel="stylesheet"/><link crossorigin="anonymous" data-color-theme="dark_dimmed" data-href="https://github.githubassets.com/assets/dark_dimmed-045e6b6ac094.css" media="all" rel="stylesheet"/><link crossorigin="anonymous" data-color-theme="dark_dimmed_high_contrast" data-href="https://github.githubassets.com/assets/dark_dimmed_high_contrast-5de537db5e79.css" media="all" rel="stylesheet"/>
<style type="text/css">
    :root {
      --tab-size-preference: 4;
    }

    pre, code {
      tab-size: var(--tab-size-preference);
    }
  </style>
<link crossorigin="anonymous" href="https://github.githubassets.com/assets/primer-primitives-c37d781e2da5.css" media="all" rel="stylesheet"/>
<link crossorigin="anonymous" href="https://github.githubassets.com/assets/primer-efa08b71f947.css" media="all" rel="stylesheet"/>
<link crossorigin="anonymous" href="https://github.githubassets.com/assets/global-6dcb16809e76.css" media="all" rel="stylesheet"/>
<link crossorigin="anonymous" href="https://github.githubassets.com/assets/github-f86c648606b5.css" media="all" rel="stylesheet"/>
<link crossorigin="anonymous" href="https://github.githubassets.com/assets/repository-5d735668c600.css" media="all" rel="stylesheet"/>
<link crossorigin="anonymous" href="https://github.githubassets.com/assets/code-9c9b8dc61e74.css" media="all" rel="stylesheet"/>
<script id="client-env" type="application/json">{"locale":"en","featureFlags":["a11y_status_checks_ruleset","actions_custom_images_public_preview_visibility","actions_custom_images_storage_billing_ui_visibility","actions_enable_snapshot_keyword","actions_image_version_event","alternate_user_config_repo","api_insights_show_missing_data_banner","arianotify_comprehensive_migration","arianotify_partial_migration","client_version_header","codespaces_prebuild_region_target_update","contentful_lp_footnotes","copilot_agent_cli_public_preview","copilot_agent_task_list_v2","copilot_agent_tasks_btn_code_nav","copilot_agent_tasks_btn_code_view","copilot_agent_tasks_btn_code_view_lines","copilot_agent_tasks_btn_repo","copilot_api_agentic_issue_marshal_yaml","copilot_api_draft_issue_reference_with_project_id","copilot_api_draft_issues_with_dependencies","copilot_api_github_draft_update_issue_skill","copilot_chat_agents_empty_state","copilot_chat_attach_multiple_images","copilot_chat_file_redirect","copilot_chat_input_commands","copilot_chat_opening_thread_switch","copilot_chat_reduce_quota_checks","copilot_chat_search_bar_redirect","copilot_chat_selection_attachments","copilot_chat_vision_in_claude","copilot_chat_vision_preview_gate","copilot_coding_agent_task_response","copilot_custom_copilots","copilot_custom_copilots_feature_preview","copilot_dashboard_input_new_submit","copilot_duplicate_thread","copilot_extensions_hide_in_dotcom_chat","copilot_extensions_removal_on_marketplace","copilot_features_raycast_logo","copilot_file_block_ref_matching","copilot_ftp_hyperspace_upgrade_prompt","copilot_immersive_generate_thread_name_async","copilot_immersive_issues_readonly_viewer","copilot_immersive_issues_show_relationships","copilot_immersive_job_result_preview","copilot_immersive_structured_model_picker","copilot_immersive_task_hyperlinking","copilot_immersive_task_within_chat_thread","copilot_org_policy_page_focus_mode","copilot_security_alert_assignee_options","copilot_share_active_subthread","copilot_spaces_as_attachments","copilot_spaces_code_view","copilot_spaces_ga","copilot_spaces_individual_policies_ga","copilot_spaces_public_access_to_user_owned_spaces","copilot_spaces_read_access_to_user_owned_spaces","copilot_spaces_report_abuse","copilot_spark_empty_state","copilot_spark_loading_webgl","copilot_spark_progressive_error_handling","copilot_spark_use_billing_headers","copilot_stable_conversation_view","copilot_swe_agent_progress_commands","copilot_swe_agent_use_subagents","copilot_workbench_agent_seed_tool","copilot_workbench_agent_user_edit_awareness","copilot_workbench_cache","copilot_workbench_preview_analytics","copilot_workbench_use_single_prompt","dashboard_universe_2025_feedback_dialog","direct_to_salesforce","disable_turbo_visit","dom_node_counts","dotcom_chat_client_side_skills","enterprise_ai_controls","failbot_report_error_react_apps_on_page","fetch_graphql_improved_error_serialization","ghost_pilot_confidence_truncation_25","ghost_pilot_confidence_truncation_40","global_search_multi_orgs","hyperspace_2025_logged_out_batch_1","hyperspace_nudges_universe25","hyperspace_nudges_universe25_post_event","initial_per_page_pagination_updates","issue_fields_report_usage","issues_expanded_file_types","issues_lazy_load_comment_box_suggestions","issues_react_bots_timeline_pagination","issues_react_prohibit_title_fallback","issues_report_sidebar_interactions","issues_sticky_sidebar","issues_title_flex_header_fix","item_picker_assignee_tsq_migration","item_picker_project_tsq_migration","lifecycle_label_name_updates","link_contact_sales_swp_marketo","marketing_pages_search_explore_provider","mcp_registry_install","mcp_registry_oss_v0_1_api","memex_default_issue_create_repository","memex_grouped_by_edit_route","memex_mwl_filter_field_delimiter","mission_control_use_body_html","new_traffic_page_banner","open_agent_session_in_vscode_insiders","open_agent_session_in_vscode_stable","primer_react_segmented_control_tooltip","projects_assignee_max_limit","react_fetch_graphql_ignore_expected_errors","record_sso_banner_metrics","repos_insights_remove_new_url","ruleset_deletion_confirmation","sample_network_conn_type","scheduled_reminders_updated_limits","site_features_copilot_universe","site_homepage_collaborate_video","site_homepage_contentful","site_homepage_eyebrow_banner","site_homepage_universe_animations","site_msbuild_webgl_hero","spark_fix_rename","spark_force_push_after_checkout","spark_improve_image_upload","spark_kv_encocoded_keys","spark_show_data_access_on_publish","spark_sync_repository_after_iteration","spark_use_agent_status","swe_agent_member_requests","viewscreen_sandbox","webp_support","workbench_store_readonly"],"copilotApiOverrideUrl":"https://api.githubcopilot.com"}</script>
<script crossorigin="anonymous" src="https://github.githubassets.com/assets/high-contrast-cookie-1a011967750c.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/wp-runtime-fa265ed7fc6d.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/913-ca2305638c53.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/6488-de87864e6818.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/environment-122ed792f7a3.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/11683-aa3d1ebe6648.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/43784-4652ae97a661.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/4712-809eac2badf7.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/81028-5b8c5e07a4fa.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/74911-6a311b93ee8e.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/91853-b5d2e5602241.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/78143-31968346cf4c.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/52430-c46e2de36eb2.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/github-elements-5b3e77949adb.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/element-registry-65cabb5684bf.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/28546-ee41c9313871.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/17688-a9e16fb5ed13.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/2869-a4ba8f17edb3.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/70191-5122bf27bf3e.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/7332-5ea4ccf72018.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/3561-d56ebea34f95.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/19037-69d630e73af8.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/51519-b4d929bb1e46.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/67310-00ed42590310.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/96384-750ef5263abe.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/19718-676a65610616.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/behaviors-108608b0bccd.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/48011-1f20a5c80dd7.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/notifications-global-eb21f5b0029d.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/31615-236504c8966f.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/code-menu-67717e88b7e6.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/primer-react-e4ebdadc89a4.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/react-lib-760965ba27bb.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/react-core-0f12feb3af13.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/octicons-react-a215e6ee021a.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/12979-6037a19d779b.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/48775-3cc79d2cd30e.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/42892-341e79a04903.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/23832-db66abd83e08.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/99418-9d4961969e0d.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/33915-05ba9b3edc31.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/96537-8e29101f7d81.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/51220-ec5733320b36.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/32219-236f5281aec8.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/59579-2ea999aac712.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/62029-a6360a734229.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/25407-0068d683d953.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/40771-0ffdf56b673a.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/66990-bcc3e84258a5.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/29665-96a2ad6dd82d.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/6623-ff0ff52cb37f.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/19976-d9a685a90a0d.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/3774-6fb5a6174da6.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/18406-d78d6d501fcd.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/36584-61e8176018bd.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/29806-7c403c1af2af.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/react-code-view-91799e320ffd.js" type="application/javascript"></script>
<link crossorigin="anonymous" href="https://github.githubassets.com/assets/primer-react.e4b5d4e7d539fcc3f287.module.css" media="all" rel="stylesheet"/>
<link crossorigin="anonymous" href="https://github.githubassets.com/assets/react-code-view.5fabe269aba9949ea13c.module.css" media="all" rel="stylesheet"/>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/25873-19b3275e0432.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/notifications-subscriptions-menu-28d0ba308e99.js" type="application/javascript"></script>
<link crossorigin="anonymous" href="https://github.githubassets.com/assets/primer-react.e4b5d4e7d539fcc3f287.module.css" media="all" rel="stylesheet"/>
<link crossorigin="anonymous" href="https://github.githubassets.com/assets/notifications-subscriptions-menu.933100a30c03fd4e8ae4.module.css" media="all" rel="stylesheet"/>
<title>2025-08-12-linux-driver</title>
<meta content="/:user_id/:repository/blob/*name(/*path)" data-turbo-transient="" name="route-pattern"/>
<meta content="blob" data-turbo-transient="" name="route-controller"/>
<meta content="show" data-turbo-transient="" name="route-action"/>
<meta content="v2:a6ba7641-d558-6302-8b5d-204e3097b5f1" name="fetch-nonce"/>
<meta content="f3abb0cc802f3d7b95fc8762b94bdcb13bf39634c40c357301c4aa1d67a256fb" name="current-catalog-service-hash"/>
<meta content="5C20:36239F:16464:1F21A:6930620D" data-pjax-transient="true" name="request-id"/><meta content="cf98eab0721178a5eeaa4175ccc0e5aab5b391e46bbdd1a6a0e557d3c2eaa49f" data-pjax-transient="true" name="html-safe-nonce"/><meta content="eyJyZWZlcnJlciI6IiIsInJlcXVlc3RfaWQiOiI1QzIwOjM2MjM5RjoxNjQ2NDoxRjIxQTo2OTMwNjIwRCIsInZpc2l0b3JfaWQiOiI3MjIzODY2NDUwODA2NTk1OTIxIiwicmVnaW9uX2VkZ2UiOiJpYWQiLCJyZWdpb25fcmVuZGVyIjoiaWFkIn0=" data-pjax-transient="true" name="visitor-payload"/><meta content="c8a7be06a8739bbd23854449ddabb997db3eecb98e606aa1a39a9c55daa25254" data-pjax-transient="true" name="visitor-hmac"/>
<meta content="repository:952181622" data-turbo-transient="" name="hovercard-subject-tag"/>
<meta content="repository,source-code,file-tree,copilot" data-turbo-transient="true" name="github-keyboard-shortcuts"/>
<meta data-turbo-transient="" name="selected-link" value="repo_source"/>
<link href="https://github.githubassets.com/" rel="assets"/>
<meta content="Apib7-x98H0j5cPqHWwSMm6dNU4GmODRoqxLiDzdx9I" name="google-site-verification"/>
<meta content="https://collector.github.com/github/collect" name="octolytics-url"/>
<meta content="/&lt;user-name&gt;/&lt;repo-name&gt;/blob/show" data-turbo-transient="true" name="analytics-location"/>
<meta content="" name="user-login"/>
<meta content="width=device-width" name="viewport"/>
<meta content="Contribute to BigBrotherJu/bigbrotherju.github.io development by creating an account on GitHub." name="description"/>
<link href="/opensearch.xml" rel="search" title="GitHub" type="application/opensearchdescription+xml"/>
<link href="https://github.com/fluidicon.png" rel="fluid-icon" title="GitHub"/>
<meta content="1401488693436528" property="fb:app_id"/>
<meta content="app-id=1477376905, app-argument=https://github.com/BigBrotherJu/bigbrotherju.github.io/blob/main/posts/2025-08-12-linux-driver.md" name="apple-itunes-app"/>
<meta content="https://opengraph.githubassets.com/45ffaf596aa509c7a4b8e36ba7ac37ac776802b6f6f4762bd66273f1ff4b4657/BigBrotherJu/bigbrotherju.github.io" name="twitter:image"/><meta content="@github" name="twitter:site"/><meta content="summary_large_image" name="twitter:card"/><meta content="bigbrotherju.github.io/posts/2025-08-12-linux-driver.md at main · BigBrotherJu/bigbrotherju.github.io" name="twitter:title"/><meta content="Contribute to BigBrotherJu/bigbrotherju.github.io development by creating an account on GitHub." name="twitter:description"/>
<meta content="https://opengraph.githubassets.com/45ffaf596aa509c7a4b8e36ba7ac37ac776802b6f6f4762bd66273f1ff4b4657/BigBrotherJu/bigbrotherju.github.io" property="og:image"/><meta content="Contribute to BigBrotherJu/bigbrotherju.github.io development by creating an account on GitHub." property="og:image:alt"/><meta content="1200" property="og:image:width"/><meta content="600" property="og:image:height"/><meta content="GitHub" property="og:site_name"/><meta content="object" property="og:type"/><meta content="bigbrotherju.github.io/posts/2025-08-12-linux-driver.md at main · BigBrotherJu/bigbrotherju.github.io" property="og:title"/><meta content="https://github.com/BigBrotherJu/bigbrotherju.github.io/blob/main/posts/2025-08-12-linux-driver.md" property="og:url"/><meta content="Contribute to BigBrotherJu/bigbrotherju.github.io development by creating an account on GitHub." property="og:description"/>
<meta content="github.com" name="hostname"/>
<meta content="github.com" name="expected-hostname"/>
<meta content="c9ff1b45c419f3e117376324ff5f6f1a2a3ac72c2459902cad3276222657b8d0" data-turbo-track="reload" http-equiv="x-pjax-version"/>
<meta content="21a43568025709b66240454fc92d4f09335a96863f8ab1c46b4a07f6a5b67102" data-turbo-track="reload" http-equiv="x-pjax-csp-version"/>
<meta content="8487fec39c8c06b815832ce80ebd89387f6b3bac9b5498b820bc97b9a51ed30a" data-turbo-track="reload" http-equiv="x-pjax-css-version"/>
<meta content="a9965f91431c822c99b26414a18f83cbc69ad19fb58cc5d4b82847201189c105" data-turbo-track="reload" http-equiv="x-pjax-js-version"/>
<meta content="no-preview" data-turbo-transient="" name="turbo-cache-control"/>
<meta content="no-cache" data-turbo-transient="" name="turbo-cache-control"/>
<meta data-hydrostats="publish"/>
<meta content="github.com/BigBrotherJu/bigbrotherju.github.io git https://github.com/BigBrotherJu/bigbrotherju.github.io.git" name="go-import"/>
<meta content="47515692" name="octolytics-dimension-user_id"/><meta content="BigBrotherJu" name="octolytics-dimension-user_login"/><meta content="952181622" name="octolytics-dimension-repository_id"/><meta content="BigBrotherJu/bigbrotherju.github.io" name="octolytics-dimension-repository_nwo"/><meta content="true" name="octolytics-dimension-repository_public"/><meta content="false" name="octolytics-dimension-repository_is_fork"/><meta content="952181622" name="octolytics-dimension-repository_network_root_id"/><meta content="BigBrotherJu/bigbrotherju.github.io" name="octolytics-dimension-repository_network_root_nwo"/>
<meta content="logged-out env-production page-responsive" name="turbo-body-classes"/>
<meta content="false" name="disable-turbo"/>
<meta content="https://api.github.com/_private/browser/stats" name="browser-stats-url"/>
<meta content="https://api.github.com/_private/browser/errors" name="browser-errors-url"/>
<meta content="5279b5b8eefa35b00f8ebaac9dcd6dad040aacea" name="release"/>
<meta content="canary-2" name="ui-target"/>
<link color="#000000" href="https://github.githubassets.com/assets/pinned-octocat-093da3e6fa40.svg" rel="mask-icon"/>
<link class="js-site-favicon" href="https://github.githubassets.com/favicons/favicon.png" rel="alternate icon" type="image/png"/>
<link class="js-site-favicon" data-base-href="https://github.githubassets.com/favicons/favicon" href="https://github.githubassets.com/favicons/favicon.svg" rel="icon" type="image/svg+xml"/>
<meta content="#1e2327" name="theme-color"/>
<meta content="light dark" name="color-scheme"/>
<link crossorigin="use-credentials" href="/manifest.json" rel="manifest"/>
<link crossorigin="anonymous" href="https://github.githubassets.com/assets/14814.29aaeaafa90f007c6f61.module.css" rel="stylesheet" type="text/css"/><link crossorigin="anonymous" href="https://github.githubassets.com/assets/7275.8284bdfe1ee4804a58c1.module.css" rel="stylesheet" type="text/css"/><style data-styled="active" data-styled-version="5.3.11"></style><link crossorigin="anonymous" href="https://github.githubassets.com/assets/67216.753d458774a2f782559b.module.css" rel="stylesheet" type="text/css"/><style id="ms-consent-banner-main-styles">.w8hcgFksdo30C8w-bygqu{color:#000}.ydkKdaztSS0AeHWIeIHsQ a{color:#0067B8}.erL690_8JwUW-R4bJRcfl{background-color:#EBEBEB;border:none;color:#000}.erL690_8JwUW-R4bJRcfl:enabled:hover{color:#000;background-color:#DBDBDB;box-shadow:0px 4px 10px rgba(0,0,0,0.25);border:none}.erL690_8JwUW-R4bJRcfl:enabled:focus{background-color:#DBDBDB;box-shadow:0px 4px 10px rgba(0,0,0,0.25);border:2px solid #000}.erL690_8JwUW-R4bJRcfl:disabled{opacity:1;color:rgba(0,0,0,0.2);background-color:rgba(0,0,0,0.2);border:none}._1zNQOqxpBFSokeCLGi_hGr{border:none;background-color:#0067B8;color:#fff}._1zNQOqxpBFSokeCLGi_hGr:enabled:hover{color:#fff;background-color:#0067B8;box-shadow:0px 4px 10px rgba(0,0,0,0.25);border:none}._1zNQOqxpBFSokeCLGi_hGr:enabled:focus{background-color:#0067B8;box-shadow:0px 4px 10px rgba(0,0,0,0.25);border:2px solid #000}._1zNQOqxpBFSokeCLGi_hGr:disabled{opacity:1;color:rgba(0,0,0,0.2);background-color:rgba(0,120,215,0.2);border:none}._23tra1HsiiP6cT-Cka-ycB{position:relative;display:flex;z-index:9999;width:100%;background-color:#F2F2F2;justify-content:space-between;text-align:left}div[dir="rtl"]._23tra1HsiiP6cT-Cka-ycB{text-align:right}._1Upc2NjY8AlDn177YoVj0y{margin:0;padding-left:5%;padding-top:8px;padding-bottom:8px}div[dir="rtl"] ._1Upc2NjY8AlDn177YoVj0y{margin:0;padding:8px 5% 8px 0;float:none}._23tra1HsiiP6cT-Cka-ycB svg{fill:none;max-width:none;max-height:none}._1V_hlU-7jdtPiooHMu89BB{display:table-cell;padding:12px;width:24px;height:24px;font-family:Segoe UI, SegoeUI, Arial, sans-serif;font-style:normal;font-weight:normal;font-size:24px;line-height:0}.f6QKJD7fhSbnJLarTL-W-{display:table-cell;vertical-align:middle;padding:0;font-family:Segoe UI, SegoeUI, Arial, sans-serif;font-style:normal;font-weight:normal;font-size:13px;line-height:16px}.f6QKJD7fhSbnJLarTL-W- a{text-decoration:underline}._2j0fmugLb1FgYz6KPuB91w{display:inline-block;margin-left:5%;margin-right:5%;min-width:40%;min-width:calc((150px + 3 * 4px) * 2 + 150px);min-width:-webkit-fit-content;min-width:-moz-fit-content;min-width:fit-content;align-self:center;position:relative}._1XuCi2WhiqeWRUVp3pnFG3{margin:4px;padding:5px;min-width:150px;min-height:36px;vertical-align:top;cursor:pointer;font-family:Segoe UI, SegoeUI, Arial, sans-serif;font-style:normal;font-weight:normal;font-size:15px;line-height:20px;text-align:center}._1XuCi2WhiqeWRUVp3pnFG3:focus{box-sizing:border-box}._1XuCi2WhiqeWRUVp3pnFG3:disabled{cursor:not-allowed}._2bvsb3ubApyZ0UGoQA9O9T{display:block;position:fixed;z-index:10000;top:0;left:0;width:100%;height:100%;background-color:rgba(255,255,255,0.6);overflow:auto;text-align:left}div[dir="rtl"]._2bvsb3ubApyZ0UGoQA9O9T{text-align:right}div[dir="rtl"] ._2bvsb3ubApyZ0UGoQA9O9T{left:auto;right:0}.AFsJE948muYyzCMktdzuk{position:relative;top:8%;margin-bottom:40px;margin-left:auto;margin-right:auto;box-sizing:border-box;width:640px;background-color:#fff;border:1px solid #0067B8}._3kWyBRbW_dgnMiEyx06Fu4{float:right;z-index:1;margin:2px;padding:12px;border:none;cursor:pointer;font-family:Segoe UI, SegoeUI, Arial, sans-serif;font-style:normal;font-weight:normal;font-size:13px;line-height:13px;display:flex;align-items:center;text-align:center;color:#666;background-color:#fff}div[dir="rtl"] ._3kWyBRbW_dgnMiEyx06Fu4{margin:2px;padding:12px;float:left}.uCYvKvHXrhjNgflv1VqdD{position:static;margin-top:36px;margin-left:36px;margin-right:36px}._17pX1m9O_W--iZbDt3Ta5r{margin-top:0;margin-bottom:12px;font-family:Segoe UI, SegoeUI, Arial, sans-serif;font-style:normal;font-weight:600;font-size:20px;line-height:24px;text-transform:none}._1kBkHQ1V1wu3kl-YcLgUr6{height:446px;overflow:auto}._20_nXDf6uFs9Q6wxRXG-I-{margin-top:0;font-family:Segoe UI, SegoeUI, Arial, sans-serif;font-style:normal;font-weight:normal;font-size:15px;line-height:20px}._20_nXDf6uFs9Q6wxRXG-I- a{text-decoration:underline}dl._2a0NH_GDQEQe5Ynfo7suVH{margin-top:36px;margin-bottom:0;padding:0;list-style:none;text-transform:none}dt._3j_LCPv7fyXv3A8FIXVwZ4{margin-top:20px;float:none;font-family:Segoe UI, SegoeUI, Arial, sans-serif;font-style:normal;font-weight:600;font-size:18px;line-height:24px;list-style:none}.k-vxTGFbdq1aOZB2HHpjh{margin:0;padding:0;border:none}._2Bucyy75c_ogoU1g-liB5R{margin:0;padding:0;border-bottom:none;font-family:Segoe UI, SegoeUI, Arial, sans-serif;font-style:normal;font-weight:600;font-size:18px;line-height:24px;text-transform:none}._63gwfzV8dclrsl2cfd90r{display:inline-block;margin-top:0;margin-bottom:13px;font-family:Segoe UI, SegoeUI, Arial, sans-serif;font-style:normal;font-weight:normal;font-size:15px;line-height:20px}._1l8wM_4mRYGz3Iu7l3BZR7{display:block}._2UE03QS02aZGkslegN_F-i{display:inline-block;position:relative;left:5px;margin-bottom:13px;margin-right:34px;padding:3px}div[dir="rtl"] ._2UE03QS02aZGkslegN_F-i{margin:0 0 13px 34px;padding:3px;float:none}div[dir="rtl"] ._2UE03QS02aZGkslegN_F-i{left:auto;right:5px}._23tra1HsiiP6cT-Cka-ycB *::before,._2bvsb3ubApyZ0UGoQA9O9T *::before,._23tra1HsiiP6cT-Cka-ycB *::after,._2bvsb3ubApyZ0UGoQA9O9T *::after{box-sizing:inherit}._1HSFn0HzGo6w4ADApV8-c4{outline:2px solid rgba(0,0,0,0.8)}input[type="radio"]._1dp8Vp5m3HwAqGx8qBmFV2{display:inline-block;position:relative;margin-top:0;margin-left:0;margin-right:0;height:0;width:0;border-radius:0;cursor:pointer;outline:none;box-sizing:border-box;-webkit-appearance:none;-moz-appearance:none;appearance:none}input[type="radio"]._1dp8Vp5m3HwAqGx8qBmFV2+label::before{display:block;position:absolute;top:5px;left:3px;height:19px;width:19px;content:"";border-radius:50%;border:1px solid #000;background-color:#fff}div[dir="rtl"] input[type="radio"]._1dp8Vp5m3HwAqGx8qBmFV2+label::before{left:auto;right:3px}input[type="radio"]._1dp8Vp5m3HwAqGx8qBmFV2:not(:disabled)+label:hover::before{border:1px solid #0067B8}input[type="radio"]._1dp8Vp5m3HwAqGx8qBmFV2:not(:disabled)+label:hover::after{display:block;position:absolute;top:10px;left:8px;height:9px;width:9px;content:"";border-radius:50%;background-color:rgba(0,0,0,0.8)}div[dir="rtl"] input[type="radio"]._1dp8Vp5m3HwAqGx8qBmFV2:not(:disabled)+label:hover::after{left:auto;right:8px}input[type="radio"]._1dp8Vp5m3HwAqGx8qBmFV2:not(:disabled)+label:focus::before{border:1px solid #0067B8}input[type="radio"]._1dp8Vp5m3HwAqGx8qBmFV2:not(:disabled)+label:focus::after{display:block;position:absolute;top:10px;left:8px;height:9px;width:9px;content:"";border-radius:50%;background-color:#000}div[dir="rtl"] input[type="radio"]._1dp8Vp5m3HwAqGx8qBmFV2:not(:disabled)+label:focus::after{left:auto;right:8px}input[type="radio"]._1dp8Vp5m3HwAqGx8qBmFV2:checked+label::after{display:block;position:absolute;top:10px;left:8px;height:9px;width:9px;content:"";border-radius:50%;background-color:#000}div[dir="rtl"] input[type="radio"]._1dp8Vp5m3HwAqGx8qBmFV2:checked+label::after{left:auto;right:8px}input[type="radio"]._1dp8Vp5m3HwAqGx8qBmFV2:disabled+label{cursor:not-allowed}input[type="radio"]._1dp8Vp5m3HwAqGx8qBmFV2:disabled+label::before{border:1px solid rgba(0,0,0,0.2);background-color:rgba(0,0,0,0.2)}._3RJzeL3l9Rl_lAQEm6VwdX{display:block;position:static;float:right;margin-top:0;margin-bottom:0;margin-left:19px;margin-right:0;padding-top:0;padding-bottom:0;padding-left:8px;padding-right:0;width:80%;width:calc(100% - 19px);font-family:Segoe UI, SegoeUI, Arial, sans-serif;font-style:normal;font-weight:normal;font-size:15px;line-height:20px;text-transform:none;cursor:pointer;box-sizing:border-box}div[dir="rtl"] ._3RJzeL3l9Rl_lAQEm6VwdX{margin:0 19px 0 0;padding:0 8px 0 0;float:left}.nohp3sIG12ZBhzcMnPala{margin-top:20px;margin-bottom:48px}._2uhaEsmeotZ3P-M0AXo2kF{padding:0;width:278px;height:36px;cursor:pointer;font-family:Segoe UI, SegoeUI, Arial, sans-serif;font-style:normal;font-weight:normal;font-size:15px;line-height:20px;text-align:center}._2uhaEsmeotZ3P-M0AXo2kF:focus{box-sizing:border-box}._2uhaEsmeotZ3P-M0AXo2kF:disabled{cursor:not-allowed}._3tOu1FJ59c_xz_PmI1lKV5{float:right;padding:0;width:278px;height:36px;cursor:pointer;font-family:Segoe UI, SegoeUI, Arial, sans-serif;font-style:normal;font-weight:normal;font-size:15px;line-height:20px;text-align:center}._3tOu1FJ59c_xz_PmI1lKV5:focus{box-sizing:border-box}._3tOu1FJ59c_xz_PmI1lKV5:disabled{cursor:not-allowed}div[dir="rtl"] ._3tOu1FJ59c_xz_PmI1lKV5{margin:0;padding:0;float:left}@media only screen and (max-width: 768px){._2j0fmugLb1FgYz6KPuB91w,._1Upc2NjY8AlDn177YoVj0y{padding-top:8px;padding-bottom:12px;padding-left:3.75%;padding-right:3.75%;margin:0;width:92.5%}._23tra1HsiiP6cT-Cka-ycB{display:block}._1XuCi2WhiqeWRUVp3pnFG3{margin-bottom:8px;margin-left:0;margin-right:0;width:100%}._2bvsb3ubApyZ0UGoQA9O9T{overflow:hidden}.AFsJE948muYyzCMktdzuk{top:1.8%;width:93.33%;height:96.4%;overflow:hidden}.uCYvKvHXrhjNgflv1VqdD{margin-top:24px;margin-left:24px;margin-right:24px;height:100%}._1kBkHQ1V1wu3kl-YcLgUr6{height:62%;height:calc(100% - 188px);min-height:50%}._2uhaEsmeotZ3P-M0AXo2kF{width:100%}._3tOu1FJ59c_xz_PmI1lKV5{margin-bottom:12px;margin-left:0;width:100%}div[dir="rtl"] ._3tOu1FJ59c_xz_PmI1lKV5{margin:0 0 12px 0;padding:0;float:none}}@media only screen and (max-width: 768px) and (orientation: landscape), only screen and (max-height: 260px), only screen and (max-width: 340px){.AFsJE948muYyzCMktdzuk{overflow:auto}}@media only screen and (max-height: 260px), only screen and (max-width: 340px){._1XuCi2WhiqeWRUVp3pnFG3{min-width:0}._3kWyBRbW_dgnMiEyx06Fu4{padding:3%}.uCYvKvHXrhjNgflv1VqdD{margin-top:3%;margin-left:3%;margin-right:3%}._17pX1m9O_W--iZbDt3Ta5r{margin-bottom:3%}._1kBkHQ1V1wu3kl-YcLgUr6{height:calc(79% - 64px)}.nohp3sIG12ZBhzcMnPala{margin-top:5%;margin-bottom:10%}._3tOu1FJ59c_xz_PmI1lKV5{margin-bottom:3%}div[dir="rtl"] ._3tOu1FJ59c_xz_PmI1lKV5{margin:0 0 3% 0;padding:0;float:none}}
</style><style id="ms-consent-banner-theme-styles" type="text/css">._23tra1HsiiP6cT-Cka-ycB {
            background-color: #24292f !important;
        }.w8hcgFksdo30C8w-bygqu {
            color: #ffffff !important;
        }.ydkKdaztSS0AeHWIeIHsQ a {
            color: #d8b9ff !important;
        }._2bvsb3ubApyZ0UGoQA9O9T {
            background-color: rgba(23, 23, 23, 0.8) !important;
        }.AFsJE948muYyzCMktdzuk {
            background-color: #24292f !important;
            border: 1px solid #d8b9ff !important;
        }._3kWyBRbW_dgnMiEyx06Fu4 {
            color: #d8b9ff !important;
            background-color: #24292f !important;
        }._1zNQOqxpBFSokeCLGi_hGr {
            border: 1px solid #ffffff !important;
            background-color: #ffffff !important;
            color: #1f2328 !important;
        }._1zNQOqxpBFSokeCLGi_hGr:enabled:hover {
            color: #1f2328 !important;
            background-color: #d8b9ff !important;
            box-shadow: none !important;
            border: 1px solid transparent !important;
        }._1zNQOqxpBFSokeCLGi_hGr:enabled:focus {
            background-color: #d8b9ff !important;
            box-shadow: none !important;
            border: 2px solid #ffffff !important;
        }._1zNQOqxpBFSokeCLGi_hGr:disabled {
            opacity: 0.5 !important;
            color: #1f2328 !important;
            background-color: #ffffff !important;
            border: 1px solid transparent !important;
        }.erL690_8JwUW-R4bJRcfl {
            border: 1px solid #eaeef2 !important;
            background-color: #32383f !important;
            color: #ffffff !important;
        }.erL690_8JwUW-R4bJRcfl:enabled:hover {
            color: #ffffff !important;
            background-color: #24292f !important;
            box-shadow: none !important;
            border: 1px solid #ffffff !important;
        }.erL690_8JwUW-R4bJRcfl:enabled:focus {
            background-color: #24292f !important;
            box-shadow: none !important;
            border: 2px solid #6e7781 !important;
        }.erL690_8JwUW-R4bJRcfl:disabled {
            opacity: 0.5 !important;
            color: #ffffff !important;
            background-color: #424a53 !important;
            border: 1px solid #6e7781 !important;
        }input[type="radio"]._1dp8Vp5m3HwAqGx8qBmFV2 + label::before {
            border: 1px solid #d8b9ff !important;
            background-color: #24292f !important;
        }._1HSFn0HzGo6w4ADApV8-c4 {
            outline: 2px solid #ffffff !important;
        }input[type="radio"]._1dp8Vp5m3HwAqGx8qBmFV2:checked + label::after {
            background-color: #d8b9ff !important;
        }input[type="radio"]._1dp8Vp5m3HwAqGx8qBmFV2 + label:hover::before {
            border: 1px solid #ffffff !important;
        }input[type="radio"]._1dp8Vp5m3HwAqGx8qBmFV2 + label:hover::after {
            background-color: #ffffff !important;
        }input[type="radio"]._1dp8Vp5m3HwAqGx8qBmFV2 + label:focus::before {
            border: 1px solid #ffffff !important;
        }input[type="radio"]._1dp8Vp5m3HwAqGx8qBmFV2 + label:focus::after {
            background-color: #d8b9ff !important;
        }input[type="radio"]._1dp8Vp5m3HwAqGx8qBmFV2:disabled + label::before {
            border: 1px solid rgba(227, 227, 227, 0.2) !important;
            background-color: rgba(227, 227, 227, 0.2) !important;
        }</style></head>
<body class="logged-out env-production page-responsive" style="overflow-wrap: break-word; --dialog-scrollgutter: 0px;"><div class="Box-sc-62in7e-0 lhfNqO js-snippet-clipboard-copy-unpositioned undefined" data-hpc="true" style="padding: 32px"><article class="markdown-body entry-content container-lg" itemprop="text"><div class="markdown-heading" dir="auto"><h1 class="heading-element" dir="auto" tabindex="-1">Linux Driver Notes</h1><a aria-label="Permalink: Linux Driver Notes" class="anchor" href="#linux-driver-notes" id="user-content-linux-driver-notes"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">v6.16-rc3</p>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto" tabindex="-1">Device Tree</h2><a aria-label="Permalink: Device Tree" class="anchor" href="#device-tree" id="user-content-device-tree"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto" tabindex="-1">Get Device Tree Information in Linux</h3><a aria-label="Permalink: Get Device Tree Information in Linux" class="anchor" href="#get-device-tree-information-in-linux" id="user-content-get-device-tree-information-in-linux"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><code>/sys/firmware/fdt</code> 是 DTB；<code>/sys/firmware/devicetree</code> 以目录结构程现 dtb 文件, 根节点对应 base 目录, 每一个节点对应一个目录, 每一个属性对应一个文件。</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto"><pre class="notranslate"><code>$ ls /sys/firmware/
devicetree fdt
</code></pre><div class="zeroclipboard-container">
<clipboard-copy aria-label="Copy" class="ClipboardButton btn btn-invisible js-clipboard-copy m-2 p-0 d-flex flex-justify-center flex-items-center" data-copy-feedback="Copied!" data-tooltip-direction="w" role="button" tabindex="0" value="$ ls /sys/firmware/
devicetree fdt">
<svg aria-hidden="true" class="octicon octicon-copy js-clipboard-copy-icon" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path>
</svg>
<svg aria-hidden="true" class="octicon octicon-check js-clipboard-check-icon color-fg-success d-none" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"></path>
</svg>
</clipboard-copy>
</div></div>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto" tabindex="-1">Platform Device</h2><a aria-label="Permalink: Platform Device" class="anchor" href="#platform-device" id="user-content-platform-device"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto" tabindex="-1"><code>struct platform_device</code>/<code>struct platform_driver</code></h3><a aria-label="Permalink: struct platform_device/struct platform_driver" class="anchor" href="#struct-platform_devicestruct-platform_driver" id="user-content-struct-platform_devicestruct-platform_driver"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<div class="highlight highlight-source-c notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-c">// include/linux/platform_device.h</span>

<span class="pl-k">struct</span> <span class="pl-smi">platform_device</span> {
	<span class="pl-k">const</span> <span class="pl-smi">char</span>	<span class="pl-c1">*</span><span class="pl-c1">name</span>;
	<span class="pl-smi">int</span>		<span class="pl-c1">id</span>;
	<span class="pl-smi">bool</span>		<span class="pl-c1">id_auto</span>;
	<span class="pl-k">struct</span> <span class="pl-smi">device</span>	<span class="pl-c1">dev</span>;
	<span class="pl-smi">u64</span>		<span class="pl-c1">platform_dma_mask</span>;
	<span class="pl-k">struct</span> <span class="pl-smi">device_dma_parameters</span> <span class="pl-c1">dma_parms</span>;
	<span class="pl-smi">u32</span>		<span class="pl-c1">num_resources</span>;
	<span class="pl-k">struct</span> <span class="pl-smi">resource</span>	<span class="pl-c1">*</span><span class="pl-c1">resource</span>;

	<span class="pl-k">const</span> <span class="pl-k">struct</span> <span class="pl-smi">platform_device_id</span>	<span class="pl-c1">*</span><span class="pl-c1">id_entry</span>;
	<span class="pl-c">/*</span>
<span class="pl-c">	 * Driver name to force a match.  Do not set directly, because core</span>
<span class="pl-c">	 * frees it.  Use driver_set_override() to set or clear it.</span>
<span class="pl-c">	 */</span>
	<span class="pl-k">const</span> <span class="pl-smi">char</span> <span class="pl-c1">*</span><span class="pl-c1">driver_override</span>;

	<span class="pl-c">/* MFD cell pointer */</span>
	<span class="pl-k">struct</span> <span class="pl-smi">mfd_cell</span> <span class="pl-c1">*</span><span class="pl-c1">mfd_cell</span>;

	<span class="pl-c">/* arch specific additions */</span>
	<span class="pl-k">struct</span> <span class="pl-smi">pdev_archdata</span>	<span class="pl-c1">archdata</span>;
};

<span class="pl-k">struct</span> <span class="pl-smi">platform_driver</span> {
	<span class="pl-smi">int</span> (<span class="pl-c1">*</span><span class="pl-c1">probe</span>)(<span class="pl-k">struct</span> <span class="pl-smi">platform_device</span> <span class="pl-c1">*</span>);
	<span class="pl-smi">void</span> (<span class="pl-c1">*</span><span class="pl-c1">remove</span>)(<span class="pl-k">struct</span> <span class="pl-smi">platform_device</span> <span class="pl-c1">*</span>);
	<span class="pl-smi">void</span> (<span class="pl-c1">*</span><span class="pl-c1">shutdown</span>)(<span class="pl-k">struct</span> <span class="pl-smi">platform_device</span> <span class="pl-c1">*</span>);
	<span class="pl-smi">int</span> (<span class="pl-c1">*</span><span class="pl-c1">suspend</span>)(<span class="pl-k">struct</span> <span class="pl-smi">platform_device</span> <span class="pl-c1">*</span>, <span class="pl-smi">pm_message_t</span> <span class="pl-s1">state</span>);
	<span class="pl-smi">int</span> (<span class="pl-c1">*</span><span class="pl-c1">resume</span>)(<span class="pl-k">struct</span> <span class="pl-smi">platform_device</span> <span class="pl-c1">*</span>);
	<span class="pl-k">struct</span> <span class="pl-smi">device_driver</span> <span class="pl-c1">driver</span>;
	<span class="pl-k">const</span> <span class="pl-k">struct</span> <span class="pl-smi">platform_device_id</span> <span class="pl-c1">*</span><span class="pl-c1">id_table</span>;
	<span class="pl-smi">bool</span> <span class="pl-c1">prevent_deferred_probe</span>;
	<span class="pl-c">/*</span>
<span class="pl-c">	 * For most device drivers, no need to care about this flag as long as</span>
<span class="pl-c">	 * all DMAs are handled through the kernel DMA API. For some special</span>
<span class="pl-c">	 * ones, for example VFIO drivers, they know how to manage the DMA</span>
<span class="pl-c">	 * themselves and set this flag so that the IOMMU layer will allow them</span>
<span class="pl-c">	 * to setup and manage their own I/O address space.</span>
<span class="pl-c">	 */</span>
	<span class="pl-smi">bool</span> <span class="pl-c1">driver_managed_dma</span>;
};</pre><div class="zeroclipboard-container">
<clipboard-copy aria-label="Copy" class="ClipboardButton btn btn-invisible js-clipboard-copy m-2 p-0 d-flex flex-justify-center flex-items-center" data-copy-feedback="Copied!" data-tooltip-direction="w" role="button" tabindex="0" value="// include/linux/platform_device.h

struct platform_device {
	const char	*name;
	int		id;
	bool		id_auto;
	struct device	dev;
	u64		platform_dma_mask;
	struct device_dma_parameters dma_parms;
	u32		num_resources;
	struct resource	*resource;

	const struct platform_device_id	*id_entry;
	/*
	 * Driver name to force a match.  Do not set directly, because core
	 * frees it.  Use driver_set_override() to set or clear it.
	 */
	const char *driver_override;

	/* MFD cell pointer */
	struct mfd_cell *mfd_cell;

	/* arch specific additions */
	struct pdev_archdata	archdata;
};

struct platform_driver {
	int (*probe)(struct platform_device *);
	void (*remove)(struct platform_device *);
	void (*shutdown)(struct platform_device *);
	int (*suspend)(struct platform_device *, pm_message_t state);
	int (*resume)(struct platform_device *);
	struct device_driver driver;
	const struct platform_device_id *id_table;
	bool prevent_deferred_probe;
	/*
	 * For most device drivers, no need to care about this flag as long as
	 * all DMAs are handled through the kernel DMA API. For some special
	 * ones, for example VFIO drivers, they know how to manage the DMA
	 * themselves and set this flag so that the IOMMU layer will allow them
	 * to setup and manage their own I/O address space.
	 */
	bool driver_managed_dma;
};">
<svg aria-hidden="true" class="octicon octicon-copy js-clipboard-copy-icon" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path>
</svg>
<svg aria-hidden="true" class="octicon octicon-check js-clipboard-check-icon color-fg-success d-none" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"></path>
</svg>
</clipboard-copy>
</div></div>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto" tabindex="-1">Get Platform Device Information in Linux</h3><a aria-label="Permalink: Get Platform Device Information in Linux" class="anchor" href="#get-platform-device-information-in-linux" id="user-content-get-platform-device-information-in-linux"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><code>/sys/devices/platform</code> 含有注册进内核的所有 platform_device。</p>
<p dir="auto">一个设备对应一个目录，进入某个目录后，如果它有 driver 子目录，表示这个 platform_device 跟某个 platform_driver 配对了。</p>
<p dir="auto">比如下面的结果中，平台设备 <code>ff8a0000.i2s</code> 已经跟平台驱动 <code>rockchip-i2s</code> 配对了：</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto"><pre class="notranslate"><code>[/sys/devices/platform/ff8a0000.i2s]# ls driver -ld
lrwxrwxrwx 1 root root 0 Jan 18 16:28 driver -&gt; ../../../bus/platform/drivers/rockchip-i2s
</code></pre><div class="zeroclipboard-container">
<clipboard-copy aria-label="Copy" class="ClipboardButton btn btn-invisible js-clipboard-copy m-2 p-0 d-flex flex-justify-center flex-items-center" data-copy-feedback="Copied!" data-tooltip-direction="w" role="button" tabindex="0" value="[/sys/devices/platform/ff8a0000.i2s]# ls driver -ld
lrwxrwxrwx 1 root root 0 Jan 18 16:28 driver -&gt; ../../../bus/platform/drivers/rockchip-i2s">
<svg aria-hidden="true" class="octicon octicon-copy js-clipboard-copy-icon" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path>
</svg>
<svg aria-hidden="true" class="octicon octicon-check js-clipboard-check-icon color-fg-success d-none" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"></path>
</svg>
</clipboard-copy>
</div></div>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto" tabindex="-1">Get Platform Driver Information in Linux</h3><a aria-label="Permalink: Get Platform Driver Information in Linux" class="anchor" href="#get-platform-driver-information-in-linux" id="user-content-get-platform-driver-information-in-linux"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><code>/sys/bus/platform/drivers</code> 含有注册进内核的所有 platform_driver。</p>
<p dir="auto">一个 driver 对应一个目录，进入某个目录后，如果它有配对的设备，可以直接看到。</p>
<p dir="auto">比如下面的结果中，平台驱动 <code>rockchip-i2s</code> 跟 2 个平台设备 <code>ff890000.i2s</code> <code>ff8a0000.i2s</code> 配对了：</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto"><pre class="notranslate"><code>[/sys/bus/platform/drivers/rockhip-i2s]# ls
bind ff890000.i2s ff8a0000.i2s uevent unbind
</code></pre><div class="zeroclipboard-container">
<clipboard-copy aria-label="Copy" class="ClipboardButton btn btn-invisible js-clipboard-copy m-2 p-0 d-flex flex-justify-center flex-items-center" data-copy-feedback="Copied!" data-tooltip-direction="w" role="button" tabindex="0" value="[/sys/bus/platform/drivers/rockhip-i2s]# ls
bind ff890000.i2s ff8a0000.i2s uevent unbind">
<svg aria-hidden="true" class="octicon octicon-copy js-clipboard-copy-icon" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path>
</svg>
<svg aria-hidden="true" class="octicon octicon-check js-clipboard-check-icon color-fg-success d-none" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"></path>
</svg>
</clipboard-copy>
</div></div>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto" tabindex="-1">Conversion from DTB to <code>struct platform_device</code></h3><a aria-label="Permalink: Conversion from DTB to struct platform_device" class="anchor" href="#conversion-from-dtb-to-struct-platform_device" id="user-content-conversion-from-dtb-to-struct-platform_device"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<ol dir="auto">
<li>内核解析 dtb 文件，把每一个节点都转换为 device_node 结构体；</li>
<li>对于某些 device_node 结构体，会被转换为 platform_device 结构体。</li>
</ol>
<div class="markdown-heading" dir="auto"><h4 class="heading-element" dir="auto" tabindex="-1">Step 1: unflatten_device_tree()</h4><a aria-label="Permalink: Step 1: unflatten_device_tree()" class="anchor" href="#step-1-unflatten_device_tree" id="user-content-step-1-unflatten_device_tree"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">It takes the raw, flat binary DTB provided by the bootloader and converts it into a live, in-memory tree of <code>struct device_node</code> objects.</p>
<p dir="auto">At this point, no <code>platform_devices</code> exist yet; the kernel just has a direct representation of the DTB data.</p>
<p dir="auto">另一篇文章已经讨论过。</p>
<p dir="auto">根节点被保存在全局变量 <code>of_root</code> 中，从 <code>of_root</code> 开始可以访问到任意节点。</p>
<div class="markdown-heading" dir="auto"><h4 class="heading-element" dir="auto" tabindex="-1">Step 2: of_platform_default_populate_init()</h4><a aria-label="Permalink: Step 2: of_platform_default_populate_init()" class="anchor" href="#step-2-of_platform_default_populate_init" id="user-content-step-2-of_platform_default_populate_init"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<ul dir="auto">
<li>调用链</li>
</ul>
<p dir="auto">需要注意的是，<code>of_platform_default_populate_init()</code> 是 arch_initcall，大部分 platform driver 的 init 函数是 device_initcall。所以在 <code>of_platform_default_populate_init()</code> 执行的时候，platform bus 上没有 driver，<code>__device_attach()</code> 中的对每个 driver 调用 <code>__device_attach_driver()</code> 无法实现。所以下面的调用链只能执行到 <code>__device_attach()</code>。</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto"><pre class="notranslate"><code>of_platform_default_populate_init
    of_platform_default_populate
        of_platform_populate
            of_platform_bus_create // 对设备树里每个可以成为 platform dev 的设备，调用 ...pdata
                of_platform_device_create_pdata
                    of_device_alloc  // （代码不在下面）分配，初始化 platform device
                    of_device_add    // 把 platform device 注册到内核中
                        device_add
                            bus_add_device    // （代码不在下面）把 device 放入全局链表
                            bus_probe_device  // 找到对应的 driver 调用 probe 函数
                                device_initial_probe
                                    __device_attach // 对每个 driver 调用 __device_attach_driver
                                        __device_attach_driver
                                            driver_match_device(drv, dev) // 判断drv dev是否匹配
                                                platform_match
                                            driver_probe_device(drv, dev) // （代码不在下面）如果匹配，调用 probe
</code></pre><div class="zeroclipboard-container">
<clipboard-copy aria-label="Copy" class="ClipboardButton btn btn-invisible js-clipboard-copy m-2 p-0 d-flex flex-justify-center flex-items-center" data-copy-feedback="Copied!" data-tooltip-direction="w" role="button" tabindex="0" value="of_platform_default_populate_init
    of_platform_default_populate
        of_platform_populate
            of_platform_bus_create // 对设备树里每个可以成为 platform dev 的设备，调用 ...pdata
                of_platform_device_create_pdata
                    of_device_alloc  // （代码不在下面）分配，初始化 platform device
                    of_device_add    // 把 platform device 注册到内核中
                        device_add
                            bus_add_device    // （代码不在下面）把 device 放入全局链表
                            bus_probe_device  // 找到对应的 driver 调用 probe 函数
                                device_initial_probe
                                    __device_attach // 对每个 driver 调用 __device_attach_driver
                                        __device_attach_driver
                                            driver_match_device(drv, dev) // 判断drv dev是否匹配
                                                platform_match
                                            driver_probe_device(drv, dev) // （代码不在下面）如果匹配，调用 probe">
<svg aria-hidden="true" class="octicon octicon-copy js-clipboard-copy-icon" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path>
</svg>
<svg aria-hidden="true" class="octicon octicon-check js-clipboard-check-icon color-fg-success d-none" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"></path>
</svg>
</clipboard-copy>
</div></div>
<hr/>
<ul dir="auto">
<li>哪些 device_node 结构体会被转换为 platform_device 结构体？</li>
</ul>
<p dir="auto">主要看 <code>of_platform_bus_create()</code>。</p>
<p dir="auto">总结起来，遍历根节点的所有子节点。如果子节点有 compatible 属性，先创建 <code>struct platform_device</code>。然后把子节点的 compatible 属性值和 <code>"simple-bus", "simple-mfd", "isa", "arm,amba-bus"</code> 比较。如果匹配上了，那么把上述过程递归执行；如果匹配不上，不进行别的操作。</p>
<p dir="auto">比如以下的节点中： <code>/mytest</code> 会被转换为 platform_device; 它的子节点 <code>/mytest/mytest@0</code> 也会被转换为 platform_device，因为该节点的父节点兼容 <code>"simple-bus"</code>。</p>
<p dir="auto"><code>/i2c</code> 节点一般表示 i2c 控制器, 它会被转换为 platform_device, 在内核中有对应的 platform_driver; <code>/i2c/at24c02</code> 节点不会被转换为 platform_device, 它被如何处理完全由父节点的 platform_driver 决定, 一般是被创建为一个 i2c_client。</p>
<p dir="auto">类似的也有 <code>/spi</code> 节点, 它一般也是用来表示 SPI 控制器, 它会被转换为 platform_device, 在内核中有对应的 platform_driver; <code>/spi/flash@0</code> 节点不会被转换为 platform_device, 它被如何处理完全由父节点的 platform_driver 决定, 一般是被创建为一个 spi_device。</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto"><pre class="notranslate"><code>/{
	mytest {
		compatile = "mytest", "simple-bus";
		mytest@0 {
			compatile = "mytest_0";
		};
	};

	i2c {
		compatile = "samsung,i2c";
		at24c02 {
			compatile = "at24c02";
		};
	};

	spi {
		compatile = "samsung,spi";
		flash@0 {
			compatible = "winbond,w25q32dw";
			spi-max-frequency = &lt;25000000&gt;;
			reg = &lt;0&gt;;
		};
	};
};
</code></pre><div class="zeroclipboard-container">
<clipboard-copy aria-label="Copy" class="ClipboardButton btn btn-invisible js-clipboard-copy m-2 p-0 d-flex flex-justify-center flex-items-center" data-copy-feedback="Copied!" data-tooltip-direction="w" role="button" tabindex="0" value='/{
	mytest {
		compatile = "mytest", "simple-bus";
		mytest@0 {
			compatile = "mytest_0";
		};
	};

	i2c {
		compatile = "samsung,i2c";
		at24c02 {
			compatile = "at24c02";
		};
	};

	spi {
		compatile = "samsung,spi";
		flash@0 {
			compatible = "winbond,w25q32dw";
			spi-max-frequency = &lt;25000000&gt;;
			reg = &lt;0&gt;;
		};
	};
};'>
<svg aria-hidden="true" class="octicon octicon-copy js-clipboard-copy-icon" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path>
</svg>
<svg aria-hidden="true" class="octicon octicon-check js-clipboard-check-icon color-fg-success d-none" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"></path>
</svg>
</clipboard-copy>
</div></div>
<hr/>
<ul dir="auto">
<li>device_node 结构体如何被转换为 platform_device 结构体？</li>
</ul>
<p dir="auto">主要看 <code>of_device_alloc()</code>。</p>
<p dir="auto">总结起来：</p>
<ul dir="auto">
<li>
<p dir="auto">platform_device 中含有 resource 数组, 它来自 device_node 的 reg, interrupts 属性;</p>
</li>
<li>
<p dir="auto">platform_device.dev.of_node 指向 device_node, 可以通过它获得其他属性</p>
</li>
</ul>
<hr/>
<ul dir="auto">
<li>生成的 platform_device 存在哪里？</li>
</ul>
<p dir="auto">主要看 <code>bus_add_device()</code>。</p>
<p dir="auto"><code>device_add()</code> adds the device to the list of devices managed by its bus type (platform_bus_type).</p>
<p dir="auto">the platform_device structures are "saved" by being added to a global list within the platform_bus_type structure.</p>
<hr/>
<ul dir="auto">
<li>没有转换为 platform_device 的节点，如何使用？</li>
</ul>
<p dir="auto">任意驱动程序里，都可以用函数直接访问设备树。</p>
<div class="markdown-heading" dir="auto"><h5 class="heading-element" dir="auto" tabindex="-1">of_platform_default_populate_init()</h5><a aria-label="Permalink: of_platform_default_populate_init()" class="anchor" href="#of_platform_default_populate_init" id="user-content-of_platform_default_populate_init"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><code>of_platform_default_populate_init</code> is registered with <code>arch_initcall_sync</code>. <code>arch_initcall_sync</code> registers the function <code>of_platform_default_populate_init</code> to be run as part of the <code>arch_initcall</code> sequence, which happens after core subsystems are ready but before most device drivers are probed.</p>
<div class="highlight highlight-source-c notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-c">// drivers/of/platform.c</span>

<span class="pl-k">static</span> <span class="pl-smi">int</span> <span class="pl-s1">__init</span> <span class="pl-en">of_platform_default_populate_init</span>(<span class="pl-smi">void</span>)
{
	<span class="pl-k">struct</span> <span class="pl-smi">device_node</span> <span class="pl-c1">*</span><span class="pl-s1">node</span>;

	<span class="pl-en">device_links_supplier_sync_state_pause</span>();

	<span class="pl-k">if</span> (<span class="pl-en">IS_ENABLED</span>(<span class="pl-c1">CONFIG_PPC</span>)) {
		...
	} <span class="pl-k">else</span> {
		<span class="pl-c">/*</span>
<span class="pl-c">		 * Handle certain compatibles explicitly, since we don't want to create</span>
<span class="pl-c">		 * platform_devices for every node in /reserved-memory with a</span>
<span class="pl-c">		 * "compatible",</span>
<span class="pl-c">		 */</span>
		<span class="pl-c">// 先处理这些 reserved memory region</span>
		<span class="pl-en">for_each_matching_node</span>(<span class="pl-s1">node</span>, <span class="pl-s1">reserved_mem_matches</span>)
			<span class="pl-en">of_platform_device_create</span>(<span class="pl-s1">node</span>, <span class="pl-c1">NULL</span>, <span class="pl-c1">NULL</span>);

		<span class="pl-c">// This part looks for a top-level /firmware node.</span>
		<span class="pl-c">// If it exists, it calls of_platform_populate on it.</span>
		<span class="pl-c">// This recursively creates platform devices for all</span>
		<span class="pl-c">// children under the /firmware node, which is a standard</span>
		<span class="pl-c">// way to group firmware-related devices like EFI or OP-TEE.</span>
		<span class="pl-s1">node</span> <span class="pl-c1">=</span> <span class="pl-en">of_find_node_by_path</span>(<span class="pl-s">"/firmware"</span>);
		<span class="pl-k">if</span> (<span class="pl-s1">node</span>) {
			<span class="pl-en">of_platform_populate</span>(<span class="pl-s1">node</span>, <span class="pl-c1">NULL</span>, <span class="pl-c1">NULL</span>, <span class="pl-c1">NULL</span>);
			<span class="pl-en">of_node_put</span>(<span class="pl-s1">node</span>);
		}

		<span class="pl-c">// 如果 /chosen node 里有 simple-framebuffer，进行处理</span>
		<span class="pl-s1">node</span> <span class="pl-c1">=</span> <span class="pl-en">of_get_compatible_child</span>(<span class="pl-s1">of_chosen</span>, <span class="pl-s">"simple-framebuffer"</span>);
		<span class="pl-k">if</span> (<span class="pl-s1">node</span>) {
			<span class="pl-c">/*</span>
<span class="pl-c">			 * Since a "simple-framebuffer" device is already added</span>
<span class="pl-c">			 * here, disable the Generic System Framebuffers (sysfb)</span>
<span class="pl-c">			 * to prevent it from registering another device for the</span>
<span class="pl-c">			 * system framebuffer later (e.g: using the screen_info</span>
<span class="pl-c">			 * data that may had been filled as well).</span>
<span class="pl-c">			 *</span>
<span class="pl-c">			 * This can happen for example on DT systems that do EFI</span>
<span class="pl-c">			 * booting and may provide a GOP handle to the EFI stub.</span>
<span class="pl-c">			 */</span>
			<span class="pl-en">sysfb_disable</span>(<span class="pl-c1">NULL</span>);
			<span class="pl-en">of_platform_device_create</span>(<span class="pl-s1">node</span>, <span class="pl-c1">NULL</span>, <span class="pl-c1">NULL</span>);
			<span class="pl-en">of_node_put</span>(<span class="pl-s1">node</span>);
		}

		<span class="pl-c">// 最重要的一步</span>
		<span class="pl-c">/* Populate everything else. */</span>
		<span class="pl-en">of_platform_default_populate</span>(<span class="pl-c1">NULL</span>, <span class="pl-c1">NULL</span>, <span class="pl-c1">NULL</span>);
	}

	<span class="pl-k">return</span> <span class="pl-c1">0</span>;
}
<span class="pl-en">arch_initcall_sync</span>(<span class="pl-s1">of_platform_default_populate_init</span>);</pre><div class="zeroclipboard-container">
<clipboard-copy aria-label="Copy" class="ClipboardButton btn btn-invisible js-clipboard-copy m-2 p-0 d-flex flex-justify-center flex-items-center" data-copy-feedback="Copied!" data-tooltip-direction="w" role="button" tabindex="0" value="// drivers/of/platform.c

static int __init of_platform_default_populate_init(void)
{
	struct device_node *node;

	device_links_supplier_sync_state_pause();

	if (IS_ENABLED(CONFIG_PPC)) {
		...
	} else {
		/*
		 * Handle certain compatibles explicitly, since we don't want to create
		 * platform_devices for every node in /reserved-memory with a
		 * &quot;compatible&quot;,
		 */
		// 先处理这些 reserved memory region
		for_each_matching_node(node, reserved_mem_matches)
			of_platform_device_create(node, NULL, NULL);

		// This part looks for a top-level /firmware node.
		// If it exists, it calls of_platform_populate on it.
		// This recursively creates platform devices for all
		// children under the /firmware node, which is a standard
		// way to group firmware-related devices like EFI or OP-TEE.
		node = of_find_node_by_path(&quot;/firmware&quot;);
		if (node) {
			of_platform_populate(node, NULL, NULL, NULL);
			of_node_put(node);
		}

		// 如果 /chosen node 里有 simple-framebuffer，进行处理
		node = of_get_compatible_child(of_chosen, &quot;simple-framebuffer&quot;);
		if (node) {
			/*
			 * Since a &quot;simple-framebuffer&quot; device is already added
			 * here, disable the Generic System Framebuffers (sysfb)
			 * to prevent it from registering another device for the
			 * system framebuffer later (e.g: using the screen_info
			 * data that may had been filled as well).
			 *
			 * This can happen for example on DT systems that do EFI
			 * booting and may provide a GOP handle to the EFI stub.
			 */
			sysfb_disable(NULL);
			of_platform_device_create(node, NULL, NULL);
			of_node_put(node);
		}

		// 最重要的一步
		/* Populate everything else. */
		of_platform_default_populate(NULL, NULL, NULL);
	}

	return 0;
}
arch_initcall_sync(of_platform_default_populate_init);">
<svg aria-hidden="true" class="octicon octicon-copy js-clipboard-copy-icon" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path>
</svg>
<svg aria-hidden="true" class="octicon octicon-check js-clipboard-check-icon color-fg-success d-none" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"></path>
</svg>
</clipboard-copy>
</div></div>
<div class="markdown-heading" dir="auto"><h5 class="heading-element" dir="auto" tabindex="-1">辅助函数：of_platform_default_populate()/of_platform_populate()</h5><a aria-label="Permalink: 辅助函数：of_platform_default_populate()/of_platform_populate()" class="anchor" href="#辅助函数of_platform_default_populateof_platform_populate" id="user-content-辅助函数of_platform_default_populateof_platform_populate"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<div class="highlight highlight-source-c notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-c">// drivers/of/platform.c</span>
<span class="pl-c">// 参数都是 NULL</span>
<span class="pl-smi">int</span> <span class="pl-en">of_platform_default_populate</span>(<span class="pl-k">struct</span> <span class="pl-smi">device_node</span> <span class="pl-c1">*</span><span class="pl-s1">root</span>,
				 <span class="pl-k">const</span> <span class="pl-k">struct</span> <span class="pl-smi">of_dev_auxdata</span> <span class="pl-c1">*</span><span class="pl-s1">lookup</span>,
				 <span class="pl-k">struct</span> <span class="pl-smi">device</span> <span class="pl-c1">*</span><span class="pl-s1">parent</span>)
{
	<span class="pl-k">static</span> <span class="pl-k">const</span> <span class="pl-k">struct</span> <span class="pl-smi">of_device_id</span> <span class="pl-s1">match_table</span>[] <span class="pl-c1">=</span> {
		{ .<span class="pl-c1">compatible</span> <span class="pl-c1">=</span> <span class="pl-s">"simple-bus"</span>, },
		{ .<span class="pl-c1">compatible</span> <span class="pl-c1">=</span> <span class="pl-s">"simple-mfd"</span>, },
		{ .<span class="pl-c1">compatible</span> <span class="pl-c1">=</span> <span class="pl-s">"isa"</span>, },
<span class="pl-k">#ifdef</span> <span class="pl-c1">CONFIG_ARM_AMBA</span>
		{ .<span class="pl-c1">compatible</span> <span class="pl-c1">=</span> <span class="pl-s">"arm,amba-bus"</span>, },
<span class="pl-k">#endif</span> <span class="pl-c">/* CONFIG_ARM_AMBA */</span>
		{} <span class="pl-c">/* Empty terminated list */</span>
	};

	<span class="pl-k">return</span> <span class="pl-en">of_platform_populate</span>(<span class="pl-s1">root</span>, <span class="pl-s1">match_table</span>, <span class="pl-s1">lookup</span>, <span class="pl-s1">parent</span>);
}
<span class="pl-en">EXPORT_SYMBOL_GPL</span>(<span class="pl-s1">of_platform_default_populate</span>);

<span class="pl-c">// drivers/of/platform.c</span>
<span class="pl-c">// 除了 matches，其他参数都是 NULL</span>
<span class="pl-smi">int</span> <span class="pl-en">of_platform_populate</span>(<span class="pl-k">struct</span> <span class="pl-smi">device_node</span> <span class="pl-c1">*</span><span class="pl-s1">root</span>,
			<span class="pl-k">const</span> <span class="pl-k">struct</span> <span class="pl-smi">of_device_id</span> <span class="pl-c1">*</span><span class="pl-s1">matches</span>,
			<span class="pl-k">const</span> <span class="pl-k">struct</span> <span class="pl-smi">of_dev_auxdata</span> <span class="pl-c1">*</span><span class="pl-s1">lookup</span>,
			<span class="pl-k">struct</span> <span class="pl-smi">device</span> <span class="pl-c1">*</span><span class="pl-s1">parent</span>)
{
	<span class="pl-smi">int</span> <span class="pl-s1">rc</span> <span class="pl-c1">=</span> <span class="pl-c1">0</span>;

	<span class="pl-c">// If the caller provided a root node, it uses that.</span>
	<span class="pl-c">// Otherwise, it finds the root of the entire device tree, /.</span>
	<span class="pl-c">// It also properly increments the reference count of the node.</span>
	<span class="pl-s1">root</span> <span class="pl-c1">=</span> <span class="pl-s1">root</span> ? <span class="pl-en">of_node_get</span>(<span class="pl-s1">root</span>) : <span class="pl-en">of_find_node_by_path</span>(<span class="pl-s">"/"</span>);
	<span class="pl-k">if</span> (!<span class="pl-s1">root</span>)
		<span class="pl-k">return</span> <span class="pl-c1">-</span><span class="pl-c1">EINVAL</span>;

	<span class="pl-en">pr_debug</span>(<span class="pl-s">"%s()\n"</span>, <span class="pl-s1">__func__</span>);
	<span class="pl-en">pr_debug</span>(<span class="pl-s">" starting at: %pOF\n"</span>, <span class="pl-s1">root</span>);

	<span class="pl-en">device_links_supplier_sync_state_pause</span>();
	<span class="pl-c">// It iterates through every direct child of the root node.</span>
	<span class="pl-en">for_each_child_of_node_scoped</span>(<span class="pl-s1">root</span>, <span class="pl-s1">child</span>) {
		<span class="pl-c">// It creates a platform_device for the child node.</span>

		<span class="pl-c">// If the child node itself matches one of the matches</span>
		<span class="pl-c">// (i.e., it's a bus like "simple-bus"),</span>
		<span class="pl-c">// of_platform_bus_create will then recursively call itself</span>
		<span class="pl-c">// on all of that child's children.</span>

		<span class="pl-c">// The true argument enforces a strict rule: a node will</span>
		<span class="pl-c">// only be turned into a device if it has a</span>
		<span class="pl-c">// compatible property.</span>
		<span class="pl-s1">rc</span> <span class="pl-c1">=</span> <span class="pl-en">of_platform_bus_create</span>(<span class="pl-s1">child</span>, <span class="pl-s1">matches</span>, <span class="pl-s1">lookup</span>, <span class="pl-s1">parent</span>, true);
		<span class="pl-k">if</span> (<span class="pl-s1">rc</span>)
			<span class="pl-k">break</span>;
	}
	<span class="pl-en">device_links_supplier_sync_state_resume</span>();

	<span class="pl-c">// After successfully creating devices for all its children,</span>
	<span class="pl-c">// it sets a flag on the root node. This marks it as "populated"</span>
	<span class="pl-c">// to prevent it from being processed again and to help with</span>
	<span class="pl-c">// device removal later.</span>
	<span class="pl-en">of_node_set_flag</span>(<span class="pl-s1">root</span>, <span class="pl-c1">OF_POPULATED_BUS</span>);

	<span class="pl-en">of_node_put</span>(<span class="pl-s1">root</span>);
	<span class="pl-k">return</span> <span class="pl-s1">rc</span>;
}
<span class="pl-en">EXPORT_SYMBOL_GPL</span>(<span class="pl-s1">of_platform_populate</span>);</pre><div class="zeroclipboard-container">
<clipboard-copy aria-label="Copy" class="ClipboardButton btn btn-invisible js-clipboard-copy m-2 p-0 d-flex flex-justify-center flex-items-center" data-copy-feedback="Copied!" data-tooltip-direction="w" role="button" tabindex="0" value="// drivers/of/platform.c
// 参数都是 NULL
int of_platform_default_populate(struct device_node *root,
				 const struct of_dev_auxdata *lookup,
				 struct device *parent)
{
	static const struct of_device_id match_table[] = {
		{ .compatible = &quot;simple-bus&quot;, },
		{ .compatible = &quot;simple-mfd&quot;, },
		{ .compatible = &quot;isa&quot;, },
#ifdef CONFIG_ARM_AMBA
		{ .compatible = &quot;arm,amba-bus&quot;, },
#endif /* CONFIG_ARM_AMBA */
		{} /* Empty terminated list */
	};

	return of_platform_populate(root, match_table, lookup, parent);
}
EXPORT_SYMBOL_GPL(of_platform_default_populate);

// drivers/of/platform.c
// 除了 matches，其他参数都是 NULL
int of_platform_populate(struct device_node *root,
			const struct of_device_id *matches,
			const struct of_dev_auxdata *lookup,
			struct device *parent)
{
	int rc = 0;

	// If the caller provided a root node, it uses that.
	// Otherwise, it finds the root of the entire device tree, /.
	// It also properly increments the reference count of the node.
	root = root ? of_node_get(root) : of_find_node_by_path(&quot;/&quot;);
	if (!root)
		return -EINVAL;

	pr_debug(&quot;%s()\n&quot;, __func__);
	pr_debug(&quot; starting at: %pOF\n&quot;, root);

	device_links_supplier_sync_state_pause();
	// It iterates through every direct child of the root node.
	for_each_child_of_node_scoped(root, child) {
		// It creates a platform_device for the child node.

		// If the child node itself matches one of the matches
		// (i.e., it's a bus like &quot;simple-bus&quot;),
		// of_platform_bus_create will then recursively call itself
		// on all of that child's children.

		// The true argument enforces a strict rule: a node will
		// only be turned into a device if it has a
		// compatible property.
		rc = of_platform_bus_create(child, matches, lookup, parent, true);
		if (rc)
			break;
	}
	device_links_supplier_sync_state_resume();

	// After successfully creating devices for all its children,
	// it sets a flag on the root node. This marks it as &quot;populated&quot;
	// to prevent it from being processed again and to help with
	// device removal later.
	of_node_set_flag(root, OF_POPULATED_BUS);

	of_node_put(root);
	return rc;
}
EXPORT_SYMBOL_GPL(of_platform_populate);">
<svg aria-hidden="true" class="octicon octicon-copy js-clipboard-copy-icon" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path>
</svg>
<svg aria-hidden="true" class="octicon octicon-check js-clipboard-check-icon color-fg-success d-none" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"></path>
</svg>
</clipboard-copy>
</div></div>
<div class="markdown-heading" dir="auto"><h5 class="heading-element" dir="auto" tabindex="-1">辅助函数：of_platform_bus_create()</h5><a aria-label="Permalink: 辅助函数：of_platform_bus_create()" class="anchor" href="#辅助函数of_platform_bus_create" id="user-content-辅助函数of_platform_bus_create"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<div class="highlight highlight-source-c notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-c">// drivers/of/platform.c</span>
<span class="pl-c">// lookup parent 是 NULL，strict 是 true</span>
<span class="pl-k">static</span> <span class="pl-smi">int</span> <span class="pl-en">of_platform_bus_create</span>(<span class="pl-k">struct</span> <span class="pl-smi">device_node</span> <span class="pl-c1">*</span><span class="pl-s1">bus</span>,
				  <span class="pl-k">const</span> <span class="pl-k">struct</span> <span class="pl-smi">of_device_id</span> <span class="pl-c1">*</span><span class="pl-s1">matches</span>,
				  <span class="pl-k">const</span> <span class="pl-k">struct</span> <span class="pl-smi">of_dev_auxdata</span> <span class="pl-c1">*</span><span class="pl-s1">lookup</span>,
				  <span class="pl-k">struct</span> <span class="pl-smi">device</span> <span class="pl-c1">*</span><span class="pl-s1">parent</span>, <span class="pl-smi">bool</span> <span class="pl-s1">strict</span>)
{
	<span class="pl-k">const</span> <span class="pl-k">struct</span> <span class="pl-smi">of_dev_auxdata</span> <span class="pl-c1">*</span><span class="pl-s1">auxdata</span>;
	<span class="pl-k">struct</span> <span class="pl-smi">platform_device</span> <span class="pl-c1">*</span><span class="pl-s1">dev</span>;
	<span class="pl-k">const</span> <span class="pl-smi">char</span> <span class="pl-c1">*</span><span class="pl-s1">bus_id</span> <span class="pl-c1">=</span> <span class="pl-c1">NULL</span>;
	<span class="pl-smi">void</span> <span class="pl-c1">*</span><span class="pl-s1">platform_data</span> <span class="pl-c1">=</span> <span class="pl-c1">NULL</span>;
	<span class="pl-smi">int</span> <span class="pl-s1">rc</span> <span class="pl-c1">=</span> <span class="pl-c1">0</span>;

	<span class="pl-c">/* Make sure it has a compatible property */</span>
	<span class="pl-k">if</span> (<span class="pl-s1">strict</span> <span class="pl-c1">&amp;&amp;</span> (!<span class="pl-en">of_property_present</span>(<span class="pl-s1">bus</span>, <span class="pl-s">"compatible"</span>))) {
		<span class="pl-en">pr_debug</span>(<span class="pl-s">"%s() - skipping %pOF, no compatible prop\n"</span>,
			 <span class="pl-s1">__func__</span>, <span class="pl-s1">bus</span>);
		<span class="pl-k">return</span> <span class="pl-c1">0</span>;
	}

	<span class="pl-c">/* Skip nodes for which we don't want to create devices */</span>
	<span class="pl-k">if</span> (<span class="pl-en">unlikely</span>(<span class="pl-en">of_match_node</span>(<span class="pl-s1">of_skipped_node_table</span>, <span class="pl-s1">bus</span>))) {
		<span class="pl-en">pr_debug</span>(<span class="pl-s">"%s() - skipping %pOF node\n"</span>, <span class="pl-s1">__func__</span>, <span class="pl-s1">bus</span>);
		<span class="pl-k">return</span> <span class="pl-c1">0</span>;
	}

	<span class="pl-k">if</span> (<span class="pl-en">of_node_check_flag</span>(<span class="pl-s1">bus</span>, <span class="pl-c1">OF_POPULATED_BUS</span>)) {
		<span class="pl-en">pr_debug</span>(<span class="pl-s">"%s() - skipping %pOF, already populated\n"</span>,
			<span class="pl-s1">__func__</span>, <span class="pl-s1">bus</span>);
		<span class="pl-k">return</span> <span class="pl-c1">0</span>;
	}

	<span class="pl-s1">auxdata</span> <span class="pl-c1">=</span> <span class="pl-en">of_dev_lookup</span>(<span class="pl-s1">lookup</span>, <span class="pl-s1">bus</span>);
	<span class="pl-k">if</span> (<span class="pl-s1">auxdata</span>) {
		<span class="pl-s1">bus_id</span> <span class="pl-c1">=</span> <span class="pl-s1">auxdata</span><span class="pl-c1">-&gt;</span><span class="pl-c1">name</span>;
		<span class="pl-s1">platform_data</span> <span class="pl-c1">=</span> <span class="pl-s1">auxdata</span><span class="pl-c1">-&gt;</span><span class="pl-c1">platform_data</span>;
	}

	<span class="pl-k">if</span> (<span class="pl-en">of_device_is_compatible</span>(<span class="pl-s1">bus</span>, <span class="pl-s">"arm,primecell"</span>)) {
		<span class="pl-c">/*</span>
<span class="pl-c">		 * Don't return an error here to keep compatibility with older</span>
<span class="pl-c">		 * device tree files.</span>
<span class="pl-c">		 */</span>
		<span class="pl-en">of_amba_device_create</span>(<span class="pl-s1">bus</span>, <span class="pl-s1">bus_id</span>, <span class="pl-s1">platform_data</span>, <span class="pl-s1">parent</span>);
		<span class="pl-k">return</span> <span class="pl-c1">0</span>;
	}

	<span class="pl-s1">dev</span> <span class="pl-c1">=</span> <span class="pl-en">of_platform_device_create_pdata</span>(<span class="pl-s1">bus</span>, <span class="pl-s1">bus_id</span>, <span class="pl-s1">platform_data</span>, <span class="pl-s1">parent</span>);
	<span class="pl-c">// - device create 失败，返回 0</span>
	<span class="pl-c">// - device create 成功，bus 匹配 match_table 失败，返回 0</span>
	<span class="pl-c">// - device create 成功，bus 匹配 match_table 成功，</span>
	<span class="pl-c">//   继续给 bus 的 child 调用 of_platform_bus_create</span>
	<span class="pl-k">if</span> (!<span class="pl-s1">dev</span> <span class="pl-c1">||</span> !<span class="pl-en">of_match_node</span>(<span class="pl-s1">matches</span>, <span class="pl-s1">bus</span>))
		<span class="pl-k">return</span> <span class="pl-c1">0</span>;

	<span class="pl-en">for_each_child_of_node_scoped</span>(<span class="pl-s1">bus</span>, <span class="pl-s1">child</span>) {
		<span class="pl-en">pr_debug</span>(<span class="pl-s">"   create child: %pOF\n"</span>, <span class="pl-s1">child</span>);
		<span class="pl-s1">rc</span> <span class="pl-c1">=</span> <span class="pl-en">of_platform_bus_create</span>(<span class="pl-s1">child</span>, <span class="pl-s1">matches</span>, <span class="pl-s1">lookup</span>, <span class="pl-c1">&amp;</span><span class="pl-s1">dev</span><span class="pl-c1">-&gt;</span><span class="pl-c1">dev</span>, <span class="pl-s1">strict</span>);
		<span class="pl-k">if</span> (<span class="pl-s1">rc</span>)
			<span class="pl-k">break</span>;
	}
	<span class="pl-en">of_node_set_flag</span>(<span class="pl-s1">bus</span>, <span class="pl-c1">OF_POPULATED_BUS</span>);
	<span class="pl-k">return</span> <span class="pl-s1">rc</span>;
}</pre><div class="zeroclipboard-container">
<clipboard-copy aria-label="Copy" class="ClipboardButton btn btn-invisible js-clipboard-copy m-2 p-0 d-flex flex-justify-center flex-items-center" data-copy-feedback="Copied!" data-tooltip-direction="w" role="button" tabindex="0" value="// drivers/of/platform.c
// lookup parent 是 NULL，strict 是 true
static int of_platform_bus_create(struct device_node *bus,
				  const struct of_device_id *matches,
				  const struct of_dev_auxdata *lookup,
				  struct device *parent, bool strict)
{
	const struct of_dev_auxdata *auxdata;
	struct platform_device *dev;
	const char *bus_id = NULL;
	void *platform_data = NULL;
	int rc = 0;

	/* Make sure it has a compatible property */
	if (strict &amp;&amp; (!of_property_present(bus, &quot;compatible&quot;))) {
		pr_debug(&quot;%s() - skipping %pOF, no compatible prop\n&quot;,
			 __func__, bus);
		return 0;
	}

	/* Skip nodes for which we don't want to create devices */
	if (unlikely(of_match_node(of_skipped_node_table, bus))) {
		pr_debug(&quot;%s() - skipping %pOF node\n&quot;, __func__, bus);
		return 0;
	}

	if (of_node_check_flag(bus, OF_POPULATED_BUS)) {
		pr_debug(&quot;%s() - skipping %pOF, already populated\n&quot;,
			__func__, bus);
		return 0;
	}

	auxdata = of_dev_lookup(lookup, bus);
	if (auxdata) {
		bus_id = auxdata-&gt;name;
		platform_data = auxdata-&gt;platform_data;
	}

	if (of_device_is_compatible(bus, &quot;arm,primecell&quot;)) {
		/*
		 * Don't return an error here to keep compatibility with older
		 * device tree files.
		 */
		of_amba_device_create(bus, bus_id, platform_data, parent);
		return 0;
	}

	dev = of_platform_device_create_pdata(bus, bus_id, platform_data, parent);
	// - device create 失败，返回 0
	// - device create 成功，bus 匹配 match_table 失败，返回 0
	// - device create 成功，bus 匹配 match_table 成功，
	//   继续给 bus 的 child 调用 of_platform_bus_create
	if (!dev || !of_match_node(matches, bus))
		return 0;

	for_each_child_of_node_scoped(bus, child) {
		pr_debug(&quot;   create child: %pOF\n&quot;, child);
		rc = of_platform_bus_create(child, matches, lookup, &amp;dev-&gt;dev, strict);
		if (rc)
			break;
	}
	of_node_set_flag(bus, OF_POPULATED_BUS);
	return rc;
}">
<svg aria-hidden="true" class="octicon octicon-copy js-clipboard-copy-icon" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path>
</svg>
<svg aria-hidden="true" class="octicon octicon-check js-clipboard-check-icon color-fg-success d-none" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"></path>
</svg>
</clipboard-copy>
</div></div>
<div class="markdown-heading" dir="auto"><h5 class="heading-element" dir="auto" tabindex="-1">辅助函数：of_platform_device_create_pdata()</h5><a aria-label="Permalink: 辅助函数：of_platform_device_create_pdata()" class="anchor" href="#辅助函数of_platform_device_create_pdata" id="user-content-辅助函数of_platform_device_create_pdata"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<div class="highlight highlight-source-c notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-c">// drivers/of/platform.c</span>

<span class="pl-k">static</span> <span class="pl-k">struct</span> <span class="pl-smi">platform_device</span> <span class="pl-c1">*</span><span class="pl-en">of_platform_device_create_pdata</span>(
					<span class="pl-k">struct</span> <span class="pl-smi">device_node</span> <span class="pl-c1">*</span><span class="pl-s1">np</span>,
					<span class="pl-k">const</span> <span class="pl-smi">char</span> <span class="pl-c1">*</span><span class="pl-s1">bus_id</span>,
					<span class="pl-smi">void</span> <span class="pl-c1">*</span><span class="pl-s1">platform_data</span>,
					<span class="pl-k">struct</span> <span class="pl-smi">device</span> <span class="pl-c1">*</span><span class="pl-s1">parent</span>)
{
	<span class="pl-k">struct</span> <span class="pl-smi">platform_device</span> <span class="pl-c1">*</span><span class="pl-s1">dev</span>;

	<span class="pl-en">pr_debug</span>(<span class="pl-s">"create platform device: %pOF\n"</span>, <span class="pl-s1">np</span>);

	<span class="pl-k">if</span> (!<span class="pl-en">of_device_is_available</span>(<span class="pl-s1">np</span>) <span class="pl-c1">||</span>
	    <span class="pl-en">of_node_test_and_set_flag</span>(<span class="pl-s1">np</span>, <span class="pl-c1">OF_POPULATED</span>))
		<span class="pl-k">return</span> <span class="pl-c1">NULL</span>;

	<span class="pl-c">// 分配，初始化 platform device</span>
	<span class="pl-c">// platform_device 中含有 resource 数组, 它来自 device_node 的 reg, interrupts 属性;</span>
	<span class="pl-c">// platform_device.dev.of_node 指向 device_node, 可以通过它获得其他属性</span>
	<span class="pl-s1">dev</span> <span class="pl-c1">=</span> <span class="pl-en">of_device_alloc</span>(<span class="pl-s1">np</span>, <span class="pl-s1">bus_id</span>, <span class="pl-s1">parent</span>);
	<span class="pl-k">if</span> (!<span class="pl-s1">dev</span>)
		goto <span class="pl-ent">err_clear_flag</span>;

	<span class="pl-s1">dev</span><span class="pl-c1">-&gt;</span><span class="pl-c1">dev</span>.<span class="pl-c1">coherent_dma_mask</span> <span class="pl-c1">=</span> <span class="pl-en">DMA_BIT_MASK</span>(<span class="pl-c1">32</span>);
	<span class="pl-k">if</span> (!<span class="pl-s1">dev</span><span class="pl-c1">-&gt;</span><span class="pl-c1">dev</span>.<span class="pl-c1">dma_mask</span>)
		<span class="pl-s1">dev</span><span class="pl-c1">-&gt;</span><span class="pl-c1">dev</span>.<span class="pl-c1">dma_mask</span> <span class="pl-c1">=</span> <span class="pl-c1">&amp;</span><span class="pl-s1">dev</span><span class="pl-c1">-&gt;</span><span class="pl-c1">dev</span>.<span class="pl-c1">coherent_dma_mask</span>;
	<span class="pl-s1">dev</span><span class="pl-c1">-&gt;</span><span class="pl-c1">dev</span>.<span class="pl-c1">bus</span> <span class="pl-c1">=</span> <span class="pl-c1">&amp;</span><span class="pl-s1">platform_bus_type</span>;
	<span class="pl-s1">dev</span><span class="pl-c1">-&gt;</span><span class="pl-c1">dev</span>.<span class="pl-c1">platform_data</span> <span class="pl-c1">=</span> <span class="pl-s1">platform_data</span>;
	<span class="pl-en">of_msi_configure</span>(<span class="pl-c1">&amp;</span><span class="pl-s1">dev</span><span class="pl-c1">-&gt;</span><span class="pl-c1">dev</span>, <span class="pl-s1">dev</span><span class="pl-c1">-&gt;</span><span class="pl-c1">dev</span>.<span class="pl-c1">of_node</span>);

	<span class="pl-c">// 把 platform device 注册到内核中</span>
	<span class="pl-k">if</span> (<span class="pl-en">of_device_add</span>(<span class="pl-s1">dev</span>) <span class="pl-c1">!=</span> <span class="pl-c1">0</span>) {
		<span class="pl-en">platform_device_put</span>(<span class="pl-s1">dev</span>);
		goto <span class="pl-ent">err_clear_flag</span>;
	}

	<span class="pl-k">return</span> <span class="pl-s1">dev</span>;

<span class="pl-ent">err_clear_flag</span>:
	<span class="pl-en">of_node_clear_flag</span>(<span class="pl-s1">np</span>, <span class="pl-c1">OF_POPULATED</span>);
	<span class="pl-k">return</span> <span class="pl-c1">NULL</span>;
}</pre><div class="zeroclipboard-container">
<clipboard-copy aria-label="Copy" class="ClipboardButton btn btn-invisible js-clipboard-copy m-2 p-0 d-flex flex-justify-center flex-items-center" data-copy-feedback="Copied!" data-tooltip-direction="w" role="button" tabindex="0" value='// drivers/of/platform.c

static struct platform_device *of_platform_device_create_pdata(
					struct device_node *np,
					const char *bus_id,
					void *platform_data,
					struct device *parent)
{
	struct platform_device *dev;

	pr_debug("create platform device: %pOF\n", np);

	if (!of_device_is_available(np) ||
	    of_node_test_and_set_flag(np, OF_POPULATED))
		return NULL;

	// 分配，初始化 platform device
	// platform_device 中含有 resource 数组, 它来自 device_node 的 reg, interrupts 属性;
	// platform_device.dev.of_node 指向 device_node, 可以通过它获得其他属性
	dev = of_device_alloc(np, bus_id, parent);
	if (!dev)
		goto err_clear_flag;

	dev-&gt;dev.coherent_dma_mask = DMA_BIT_MASK(32);
	if (!dev-&gt;dev.dma_mask)
		dev-&gt;dev.dma_mask = &amp;dev-&gt;dev.coherent_dma_mask;
	dev-&gt;dev.bus = &amp;platform_bus_type;
	dev-&gt;dev.platform_data = platform_data;
	of_msi_configure(&amp;dev-&gt;dev, dev-&gt;dev.of_node);

	// 把 platform device 注册到内核中
	if (of_device_add(dev) != 0) {
		platform_device_put(dev);
		goto err_clear_flag;
	}

	return dev;

err_clear_flag:
	of_node_clear_flag(np, OF_POPULATED);
	return NULL;
}'>
<svg aria-hidden="true" class="octicon octicon-copy js-clipboard-copy-icon" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path>
</svg>
<svg aria-hidden="true" class="octicon octicon-check js-clipboard-check-icon color-fg-success d-none" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"></path>
</svg>
</clipboard-copy>
</div></div>
<div class="markdown-heading" dir="auto"><h5 class="heading-element" dir="auto" tabindex="-1">辅助函数：of_device_add()/device_add()</h5><a aria-label="Permalink: 辅助函数：of_device_add()/device_add()" class="anchor" href="#辅助函数of_device_adddevice_add" id="user-content-辅助函数of_device_adddevice_add"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<div class="highlight highlight-source-c notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-c">// drivers/of/platform.c</span>

<span class="pl-smi">int</span> <span class="pl-en">of_device_add</span>(<span class="pl-k">struct</span> <span class="pl-smi">platform_device</span> <span class="pl-c1">*</span><span class="pl-s1">ofdev</span>)
{
	<span class="pl-en">BUG_ON</span>(<span class="pl-s1">ofdev</span><span class="pl-c1">-&gt;</span><span class="pl-c1">dev</span>.<span class="pl-c1">of_node</span> <span class="pl-c1">==</span> <span class="pl-c1">NULL</span>);

	<span class="pl-c">/* name and id have to be set so that the platform bus doesn't get</span>
<span class="pl-c">	 * confused on matching */</span>
	<span class="pl-s1">ofdev</span><span class="pl-c1">-&gt;</span><span class="pl-c1">name</span> <span class="pl-c1">=</span> <span class="pl-en">dev_name</span>(<span class="pl-c1">&amp;</span><span class="pl-s1">ofdev</span><span class="pl-c1">-&gt;</span><span class="pl-c1">dev</span>);
	<span class="pl-s1">ofdev</span><span class="pl-c1">-&gt;</span><span class="pl-c1">id</span> <span class="pl-c1">=</span> <span class="pl-c1">PLATFORM_DEVID_NONE</span>;

	<span class="pl-c">/*</span>
<span class="pl-c">	 * If this device has not binding numa node in devicetree, that is</span>
<span class="pl-c">	 * of_node_to_nid returns NUMA_NO_NODE. device_add will assume that this</span>
<span class="pl-c">	 * device is on the same node as the parent.</span>
<span class="pl-c">	 */</span>
	<span class="pl-en">set_dev_node</span>(<span class="pl-c1">&amp;</span><span class="pl-s1">ofdev</span><span class="pl-c1">-&gt;</span><span class="pl-c1">dev</span>, <span class="pl-en">of_node_to_nid</span>(<span class="pl-s1">ofdev</span><span class="pl-c1">-&gt;</span><span class="pl-c1">dev</span>.<span class="pl-c1">of_node</span>));

	<span class="pl-k">return</span> <span class="pl-en">device_add</span>(<span class="pl-c1">&amp;</span><span class="pl-s1">ofdev</span><span class="pl-c1">-&gt;</span><span class="pl-c1">dev</span>);
}

<span class="pl-c">// drivers/base/core.c</span>

<span class="pl-smi">int</span> <span class="pl-en">device_add</span>(<span class="pl-k">struct</span> <span class="pl-smi">device</span> <span class="pl-c1">*</span><span class="pl-s1">dev</span>)
{
	...
	<span class="pl-c">// 把 device 放入全局链表</span>
	<span class="pl-s1">error</span> <span class="pl-c1">=</span> <span class="pl-en">bus_add_device</span>(<span class="pl-s1">dev</span>);
	<span class="pl-k">if</span> (<span class="pl-s1">error</span>)
		goto <span class="pl-ent">BusError</span>;
	...
	<span class="pl-c">// 找到对应的 driver 调用 probe 函数</span>
	<span class="pl-en">bus_probe_device</span>(<span class="pl-s1">dev</span>);
	...
}</pre><div class="zeroclipboard-container">
<clipboard-copy aria-label="Copy" class="ClipboardButton btn btn-invisible js-clipboard-copy m-2 p-0 d-flex flex-justify-center flex-items-center" data-copy-feedback="Copied!" data-tooltip-direction="w" role="button" tabindex="0" value="// drivers/of/platform.c

int of_device_add(struct platform_device *ofdev)
{
	BUG_ON(ofdev-&gt;dev.of_node == NULL);

	/* name and id have to be set so that the platform bus doesn't get
	 * confused on matching */
	ofdev-&gt;name = dev_name(&amp;ofdev-&gt;dev);
	ofdev-&gt;id = PLATFORM_DEVID_NONE;

	/*
	 * If this device has not binding numa node in devicetree, that is
	 * of_node_to_nid returns NUMA_NO_NODE. device_add will assume that this
	 * device is on the same node as the parent.
	 */
	set_dev_node(&amp;ofdev-&gt;dev, of_node_to_nid(ofdev-&gt;dev.of_node));

	return device_add(&amp;ofdev-&gt;dev);
}

// drivers/base/core.c

int device_add(struct device *dev)
{
	...
	// 把 device 放入全局链表
	error = bus_add_device(dev);
	if (error)
		goto BusError;
	...
	// 找到对应的 driver 调用 probe 函数
	bus_probe_device(dev);
	...
}">
<svg aria-hidden="true" class="octicon octicon-copy js-clipboard-copy-icon" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path>
</svg>
<svg aria-hidden="true" class="octicon octicon-check js-clipboard-check-icon color-fg-success d-none" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"></path>
</svg>
</clipboard-copy>
</div></div>
<div class="markdown-heading" dir="auto"><h5 class="heading-element" dir="auto" tabindex="-1">辅助函数：bus_probe_device()/device_initial_probe()</h5><a aria-label="Permalink: 辅助函数：bus_probe_device()/device_initial_probe()" class="anchor" href="#辅助函数bus_probe_devicedevice_initial_probe" id="user-content-辅助函数bus_probe_devicedevice_initial_probe"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<div class="highlight highlight-source-c notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-c">// drivers/base/bus.c</span>

<span class="pl-smi">void</span> <span class="pl-en">bus_probe_device</span>(<span class="pl-k">struct</span> <span class="pl-smi">device</span> <span class="pl-c1">*</span><span class="pl-s1">dev</span>)
{
	<span class="pl-k">struct</span> <span class="pl-smi">subsys_private</span> <span class="pl-c1">*</span><span class="pl-s1">sp</span> <span class="pl-c1">=</span> <span class="pl-en">bus_to_subsys</span>(<span class="pl-s1">dev</span><span class="pl-c1">-&gt;</span><span class="pl-c1">bus</span>);
	<span class="pl-k">struct</span> <span class="pl-smi">subsys_interface</span> <span class="pl-c1">*</span><span class="pl-s1">sif</span>;

	<span class="pl-k">if</span> (!<span class="pl-s1">sp</span>)
		<span class="pl-k">return</span>;

	<span class="pl-k">if</span> (<span class="pl-s1">sp</span><span class="pl-c1">-&gt;</span><span class="pl-c1">drivers_autoprobe</span>)
		<span class="pl-en">device_initial_probe</span>(<span class="pl-s1">dev</span>);

	<span class="pl-en">mutex_lock</span>(<span class="pl-c1">&amp;</span><span class="pl-s1">sp</span><span class="pl-c1">-&gt;</span><span class="pl-c1">mutex</span>);
	<span class="pl-en">list_for_each_entry</span>(<span class="pl-s1">sif</span>, <span class="pl-c1">&amp;</span><span class="pl-s1">sp</span><span class="pl-c1">-&gt;</span><span class="pl-c1">interfaces</span>, <span class="pl-s1">node</span>)
		<span class="pl-k">if</span> (<span class="pl-s1">sif</span><span class="pl-c1">-&gt;</span><span class="pl-c1">add_dev</span>)
			<span class="pl-s1">sif</span><span class="pl-c1">-&gt;</span><span class="pl-en">add_dev</span>(<span class="pl-s1">dev</span>, <span class="pl-s1">sif</span>);
	<span class="pl-en">mutex_unlock</span>(<span class="pl-c1">&amp;</span><span class="pl-s1">sp</span><span class="pl-c1">-&gt;</span><span class="pl-c1">mutex</span>);
	<span class="pl-en">subsys_put</span>(<span class="pl-s1">sp</span>);
}

<span class="pl-c">// drivers/base/dd.c</span>

<span class="pl-smi">void</span> <span class="pl-en">device_initial_probe</span>(<span class="pl-k">struct</span> <span class="pl-smi">device</span> <span class="pl-c1">*</span><span class="pl-s1">dev</span>)
{
	<span class="pl-en">__device_attach</span>(<span class="pl-s1">dev</span>, true);
}</pre><div class="zeroclipboard-container">
<clipboard-copy aria-label="Copy" class="ClipboardButton btn btn-invisible js-clipboard-copy m-2 p-0 d-flex flex-justify-center flex-items-center" data-copy-feedback="Copied!" data-tooltip-direction="w" role="button" tabindex="0" value="// drivers/base/bus.c

void bus_probe_device(struct device *dev)
{
	struct subsys_private *sp = bus_to_subsys(dev-&gt;bus);
	struct subsys_interface *sif;

	if (!sp)
		return;

	if (sp-&gt;drivers_autoprobe)
		device_initial_probe(dev);

	mutex_lock(&amp;sp-&gt;mutex);
	list_for_each_entry(sif, &amp;sp-&gt;interfaces, node)
		if (sif-&gt;add_dev)
			sif-&gt;add_dev(dev, sif);
	mutex_unlock(&amp;sp-&gt;mutex);
	subsys_put(sp);
}

// drivers/base/dd.c

void device_initial_probe(struct device *dev)
{
	__device_attach(dev, true);
}">
<svg aria-hidden="true" class="octicon octicon-copy js-clipboard-copy-icon" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path>
</svg>
<svg aria-hidden="true" class="octicon octicon-check js-clipboard-check-icon color-fg-success d-none" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"></path>
</svg>
</clipboard-copy>
</div></div>
<div class="markdown-heading" dir="auto"><h5 class="heading-element" dir="auto" tabindex="-1">辅助函数：__device_attach()</h5><a aria-label="Permalink: 辅助函数：__device_attach()" class="anchor" href="#辅助函数__device_attach" id="user-content-辅助函数__device_attach"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<div class="highlight highlight-source-c notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-c">// drivers/base/dd.c</span>

<span class="pl-k">static</span> <span class="pl-smi">int</span> <span class="pl-en">__device_attach</span>(<span class="pl-k">struct</span> <span class="pl-smi">device</span> <span class="pl-c1">*</span><span class="pl-s1">dev</span>, <span class="pl-smi">bool</span> <span class="pl-s1">allow_async</span>)
{
	<span class="pl-smi">int</span> <span class="pl-s1">ret</span> <span class="pl-c1">=</span> <span class="pl-c1">0</span>;
	<span class="pl-smi">bool</span> <span class="pl-s1">async</span> <span class="pl-c1">=</span> false;

	<span class="pl-en">device_lock</span>(<span class="pl-s1">dev</span>);
	<span class="pl-k">if</span> (<span class="pl-s1">dev</span><span class="pl-c1">-&gt;</span><span class="pl-c1">p</span><span class="pl-c1">-&gt;</span><span class="pl-c1">dead</span>) {
		goto <span class="pl-ent">out_unlock</span>;
	} <span class="pl-k">else</span> <span class="pl-k">if</span> (<span class="pl-s1">dev</span><span class="pl-c1">-&gt;</span><span class="pl-c1">driver</span>) {
		<span class="pl-k">if</span> (<span class="pl-en">device_is_bound</span>(<span class="pl-s1">dev</span>)) {
			<span class="pl-s1">ret</span> <span class="pl-c1">=</span> <span class="pl-c1">1</span>;
			goto <span class="pl-ent">out_unlock</span>;
		}
		<span class="pl-s1">ret</span> <span class="pl-c1">=</span> <span class="pl-en">device_bind_driver</span>(<span class="pl-s1">dev</span>);
		<span class="pl-k">if</span> (<span class="pl-s1">ret</span> <span class="pl-c1">==</span> <span class="pl-c1">0</span>)
			<span class="pl-s1">ret</span> <span class="pl-c1">=</span> <span class="pl-c1">1</span>;
		<span class="pl-k">else</span> {
			<span class="pl-en">device_set_driver</span>(<span class="pl-s1">dev</span>, <span class="pl-c1">NULL</span>);
			<span class="pl-s1">ret</span> <span class="pl-c1">=</span> <span class="pl-c1">0</span>;
		}
	} <span class="pl-k">else</span> {
		<span class="pl-k">struct</span> <span class="pl-smi">device_attach_data</span> <span class="pl-s1">data</span> <span class="pl-c1">=</span> {
			.<span class="pl-c1">dev</span> <span class="pl-c1">=</span> <span class="pl-s1">dev</span>,
			.<span class="pl-c1">check_async</span> <span class="pl-c1">=</span> <span class="pl-s1">allow_async</span>,
			.<span class="pl-c1">want_async</span> <span class="pl-c1">=</span> false,
		};

		<span class="pl-k">if</span> (<span class="pl-s1">dev</span><span class="pl-c1">-&gt;</span><span class="pl-c1">parent</span>)
			<span class="pl-en">pm_runtime_get_sync</span>(<span class="pl-s1">dev</span><span class="pl-c1">-&gt;</span><span class="pl-c1">parent</span>);

		<span class="pl-c">// 对每个 driver 调用 __device_attach_driver</span>
		<span class="pl-s1">ret</span> <span class="pl-c1">=</span> <span class="pl-en">bus_for_each_drv</span>(<span class="pl-s1">dev</span><span class="pl-c1">-&gt;</span><span class="pl-c1">bus</span>, <span class="pl-c1">NULL</span>, <span class="pl-c1">&amp;</span><span class="pl-s1">data</span>,
					<span class="pl-s1">__device_attach_driver</span>);
		<span class="pl-k">if</span> (!<span class="pl-s1">ret</span> <span class="pl-c1">&amp;&amp;</span> <span class="pl-s1">allow_async</span> <span class="pl-c1">&amp;&amp;</span> <span class="pl-s1">data</span>.<span class="pl-c1">have_async</span>) {
			<span class="pl-c">/*</span>
<span class="pl-c">			 * If we could not find appropriate driver</span>
<span class="pl-c">			 * synchronously and we are allowed to do</span>
<span class="pl-c">			 * async probes and there are drivers that</span>
<span class="pl-c">			 * want to probe asynchronously, we'll</span>
<span class="pl-c">			 * try them.</span>
<span class="pl-c">			 */</span>
			<span class="pl-en">dev_dbg</span>(<span class="pl-s1">dev</span>, <span class="pl-s">"scheduling asynchronous probe\n"</span>);
			<span class="pl-en">get_device</span>(<span class="pl-s1">dev</span>);
			<span class="pl-s1">async</span> <span class="pl-c1">=</span> true;
		} <span class="pl-k">else</span> {
			<span class="pl-en">pm_request_idle</span>(<span class="pl-s1">dev</span>);
		}

		<span class="pl-k">if</span> (<span class="pl-s1">dev</span><span class="pl-c1">-&gt;</span><span class="pl-c1">parent</span>)
			<span class="pl-en">pm_runtime_put</span>(<span class="pl-s1">dev</span><span class="pl-c1">-&gt;</span><span class="pl-c1">parent</span>);
	}
<span class="pl-ent">out_unlock</span>:
	<span class="pl-en">device_unlock</span>(<span class="pl-s1">dev</span>);
	<span class="pl-k">if</span> (<span class="pl-s1">async</span>)
		<span class="pl-en">async_schedule_dev</span>(<span class="pl-s1">__device_attach_async_helper</span>, <span class="pl-s1">dev</span>);
	<span class="pl-k">return</span> <span class="pl-s1">ret</span>;
}</pre><div class="zeroclipboard-container">
<clipboard-copy aria-label="Copy" class="ClipboardButton btn btn-invisible js-clipboard-copy m-2 p-0 d-flex flex-justify-center flex-items-center" data-copy-feedback="Copied!" data-tooltip-direction="w" role="button" tabindex="0" value="// drivers/base/dd.c

static int __device_attach(struct device *dev, bool allow_async)
{
	int ret = 0;
	bool async = false;

	device_lock(dev);
	if (dev-&gt;p-&gt;dead) {
		goto out_unlock;
	} else if (dev-&gt;driver) {
		if (device_is_bound(dev)) {
			ret = 1;
			goto out_unlock;
		}
		ret = device_bind_driver(dev);
		if (ret == 0)
			ret = 1;
		else {
			device_set_driver(dev, NULL);
			ret = 0;
		}
	} else {
		struct device_attach_data data = {
			.dev = dev,
			.check_async = allow_async,
			.want_async = false,
		};

		if (dev-&gt;parent)
			pm_runtime_get_sync(dev-&gt;parent);

		// 对每个 driver 调用 __device_attach_driver
		ret = bus_for_each_drv(dev-&gt;bus, NULL, &amp;data,
					__device_attach_driver);
		if (!ret &amp;&amp; allow_async &amp;&amp; data.have_async) {
			/*
			 * If we could not find appropriate driver
			 * synchronously and we are allowed to do
			 * async probes and there are drivers that
			 * want to probe asynchronously, we'll
			 * try them.
			 */
			dev_dbg(dev, &quot;scheduling asynchronous probe\n&quot;);
			get_device(dev);
			async = true;
		} else {
			pm_request_idle(dev);
		}

		if (dev-&gt;parent)
			pm_runtime_put(dev-&gt;parent);
	}
out_unlock:
	device_unlock(dev);
	if (async)
		async_schedule_dev(__device_attach_async_helper, dev);
	return ret;
}">
<svg aria-hidden="true" class="octicon octicon-copy js-clipboard-copy-icon" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path>
</svg>
<svg aria-hidden="true" class="octicon octicon-check js-clipboard-check-icon color-fg-success d-none" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"></path>
</svg>
</clipboard-copy>
</div></div>
<div class="markdown-heading" dir="auto"><h5 class="heading-element" dir="auto" tabindex="-1">辅助函数：__device_attach_driver()/driver_match_device()</h5><a aria-label="Permalink: 辅助函数：__device_attach_driver()/driver_match_device()" class="anchor" href="#辅助函数__device_attach_driverdriver_match_device" id="user-content-辅助函数__device_attach_driverdriver_match_device"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<div class="highlight highlight-source-c notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-c">// drivers/base/dd.c</span>

<span class="pl-k">static</span> <span class="pl-smi">int</span> <span class="pl-en">__device_attach_driver</span>(<span class="pl-k">struct</span> <span class="pl-smi">device_driver</span> <span class="pl-c1">*</span><span class="pl-s1">drv</span>, <span class="pl-smi">void</span> <span class="pl-c1">*</span><span class="pl-s1">_data</span>)
{
	<span class="pl-k">struct</span> <span class="pl-smi">device_attach_data</span> <span class="pl-c1">*</span><span class="pl-s1">data</span> <span class="pl-c1">=</span> <span class="pl-s1">_data</span>;
	<span class="pl-k">struct</span> <span class="pl-smi">device</span> <span class="pl-c1">*</span><span class="pl-s1">dev</span> <span class="pl-c1">=</span> <span class="pl-s1">data</span><span class="pl-c1">-&gt;</span><span class="pl-c1">dev</span>;
	<span class="pl-smi">bool</span> <span class="pl-s1">async_allowed</span>;
	<span class="pl-smi">int</span> <span class="pl-s1">ret</span>;

	<span class="pl-c">// 进行 driver device 匹配</span>
	<span class="pl-s1">ret</span> <span class="pl-c1">=</span> <span class="pl-en">driver_match_device</span>(<span class="pl-s1">drv</span>, <span class="pl-s1">dev</span>);
	<span class="pl-k">if</span> (<span class="pl-s1">ret</span> <span class="pl-c1">==</span> <span class="pl-c1">0</span>) {
		<span class="pl-c">/* no match */</span>
		<span class="pl-k">return</span> <span class="pl-c1">0</span>;
	} <span class="pl-k">else</span> <span class="pl-k">if</span> (<span class="pl-s1">ret</span> <span class="pl-c1">==</span> <span class="pl-c1">-</span><span class="pl-c1">EPROBE_DEFER</span>) {
		<span class="pl-en">dev_dbg</span>(<span class="pl-s1">dev</span>, <span class="pl-s">"Device match requests probe deferral\n"</span>);
		<span class="pl-s1">dev</span><span class="pl-c1">-&gt;</span><span class="pl-c1">can_match</span> <span class="pl-c1">=</span> true;
		<span class="pl-en">driver_deferred_probe_add</span>(<span class="pl-s1">dev</span>);
		<span class="pl-c">/*</span>
<span class="pl-c">		 * Device can't match with a driver right now, so don't attempt</span>
<span class="pl-c">		 * to match or bind with other drivers on the bus.</span>
<span class="pl-c">		 */</span>
		<span class="pl-k">return</span> <span class="pl-s1">ret</span>;
	} <span class="pl-k">else</span> <span class="pl-k">if</span> (<span class="pl-s1">ret</span> <span class="pl-c1">&lt;</span> <span class="pl-c1">0</span>) {
		<span class="pl-en">dev_dbg</span>(<span class="pl-s1">dev</span>, <span class="pl-s">"Bus failed to match device: %d\n"</span>, <span class="pl-s1">ret</span>);
		<span class="pl-k">return</span> <span class="pl-s1">ret</span>;
	} <span class="pl-c">/* ret &gt; 0 means positive match */</span>

	<span class="pl-s1">async_allowed</span> <span class="pl-c1">=</span> <span class="pl-en">driver_allows_async_probing</span>(<span class="pl-s1">drv</span>);

	<span class="pl-k">if</span> (<span class="pl-s1">async_allowed</span>)
		<span class="pl-s1">data</span><span class="pl-c1">-&gt;</span><span class="pl-c1">have_async</span> <span class="pl-c1">=</span> true;

	<span class="pl-k">if</span> (<span class="pl-s1">data</span><span class="pl-c1">-&gt;</span><span class="pl-c1">check_async</span> <span class="pl-c1">&amp;&amp;</span> <span class="pl-s1">async_allowed</span> <span class="pl-c1">!=</span> <span class="pl-s1">data</span><span class="pl-c1">-&gt;</span><span class="pl-c1">want_async</span>)
		<span class="pl-k">return</span> <span class="pl-c1">0</span>;

	<span class="pl-c">/*</span>
<span class="pl-c">	 * Ignore errors returned by -&gt;probe so that the next driver can try</span>
<span class="pl-c">	 * its luck.</span>
<span class="pl-c">	 */</span>
	<span class="pl-c">// 调用 driver 的 probe</span>
	<span class="pl-s1">ret</span> <span class="pl-c1">=</span> <span class="pl-en">driver_probe_device</span>(<span class="pl-s1">drv</span>, <span class="pl-s1">dev</span>);
	<span class="pl-k">if</span> (<span class="pl-s1">ret</span> <span class="pl-c1">&lt;</span> <span class="pl-c1">0</span>)
		<span class="pl-k">return</span> <span class="pl-s1">ret</span>;
	<span class="pl-k">return</span> <span class="pl-s1">ret</span> <span class="pl-c1">==</span> <span class="pl-c1">0</span>;
}

<span class="pl-c">// drivers/base/base.h</span>

<span class="pl-k">static</span> <span class="pl-k">inline</span> <span class="pl-smi">int</span> <span class="pl-en">driver_match_device</span>(<span class="pl-k">const</span> <span class="pl-k">struct</span> <span class="pl-smi">device_driver</span> <span class="pl-c1">*</span><span class="pl-s1">drv</span>,
				      <span class="pl-k">struct</span> <span class="pl-smi">device</span> <span class="pl-c1">*</span><span class="pl-s1">dev</span>)
{
	<span class="pl-c">// platform_bus_type 的 match 是 platform_match</span>
	<span class="pl-k">return</span> <span class="pl-s1">drv</span><span class="pl-c1">-&gt;</span><span class="pl-c1">bus</span><span class="pl-c1">-&gt;</span><span class="pl-c1">match</span> ? <span class="pl-s1">drv</span><span class="pl-c1">-&gt;</span><span class="pl-c1">bus</span><span class="pl-c1">-&gt;</span><span class="pl-en">match</span>(<span class="pl-s1">dev</span>, <span class="pl-s1">drv</span>) : <span class="pl-c1">1</span>;
}</pre><div class="zeroclipboard-container">
<clipboard-copy aria-label="Copy" class="ClipboardButton btn btn-invisible js-clipboard-copy m-2 p-0 d-flex flex-justify-center flex-items-center" data-copy-feedback="Copied!" data-tooltip-direction="w" role="button" tabindex="0" value="// drivers/base/dd.c

static int __device_attach_driver(struct device_driver *drv, void *_data)
{
	struct device_attach_data *data = _data;
	struct device *dev = data-&gt;dev;
	bool async_allowed;
	int ret;

	// 进行 driver device 匹配
	ret = driver_match_device(drv, dev);
	if (ret == 0) {
		/* no match */
		return 0;
	} else if (ret == -EPROBE_DEFER) {
		dev_dbg(dev, &quot;Device match requests probe deferral\n&quot;);
		dev-&gt;can_match = true;
		driver_deferred_probe_add(dev);
		/*
		 * Device can't match with a driver right now, so don't attempt
		 * to match or bind with other drivers on the bus.
		 */
		return ret;
	} else if (ret &lt; 0) {
		dev_dbg(dev, &quot;Bus failed to match device: %d\n&quot;, ret);
		return ret;
	} /* ret &gt; 0 means positive match */

	async_allowed = driver_allows_async_probing(drv);

	if (async_allowed)
		data-&gt;have_async = true;

	if (data-&gt;check_async &amp;&amp; async_allowed != data-&gt;want_async)
		return 0;

	/*
	 * Ignore errors returned by -&gt;probe so that the next driver can try
	 * its luck.
	 */
	// 调用 driver 的 probe
	ret = driver_probe_device(drv, dev);
	if (ret &lt; 0)
		return ret;
	return ret == 0;
}

// drivers/base/base.h

static inline int driver_match_device(const struct device_driver *drv,
				      struct device *dev)
{
	// platform_bus_type 的 match 是 platform_match
	return drv-&gt;bus-&gt;match ? drv-&gt;bus-&gt;match(dev, drv) : 1;
}">
<svg aria-hidden="true" class="octicon octicon-copy js-clipboard-copy-icon" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path>
</svg>
<svg aria-hidden="true" class="octicon octicon-check js-clipboard-check-icon color-fg-success d-none" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"></path>
</svg>
</clipboard-copy>
</div></div>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto" tabindex="-1">Platform Driver</h2><a aria-label="Permalink: Platform Driver" class="anchor" href="#platform-driver" id="user-content-platform-driver"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">一般驱动会有一个 init 函数和一个 <code>struct platform_driver</code> 变量。init 函数中调用 <code>platform_driver_register(&amp;...driver)</code> 注册 <code>struct platform_driver</code> 变量。</p>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto" tabindex="-1">platform_driver_register()</h3><a aria-label="Permalink: platform_driver_register()" class="anchor" href="#platform_driver_register" id="user-content-platform_driver_register"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">如上面所说，在 platform driver 的 init 函数调用 platform_driver_register 注册自己之前，of_platform_default_populate_init() 已经把设备树里的每个 platform device 添加到 platform bus 上。</p>
<p dir="auto">现在每个 platform driver 的 init 函数调用 platform_driver_register 注册自己时，都会对 platform bus 的每个 dev 调用 __driver_attach 进行匹配。如果匹配成功，调用 driver 的 probe 函数。</p>
<p dir="auto">调用链：</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto"><pre class="notranslate"><code>platform_driver_register
    __platform_driver_register
        driver_register
            bus_add_driver    // 把 driver 注册进 platform bus 的全局链表
                driver_attach // 对 platform bus 的每个 dev 调用 __driver_attach
                    __driver_attach
                        driver_match_device(drv, dev) // 判断drv dev是否匹配
                            platform_match
                        driver_probe_device(drv, dev) // 如果匹配，调用 drv probe
</code></pre><div class="zeroclipboard-container">
<clipboard-copy aria-label="Copy" class="ClipboardButton btn btn-invisible js-clipboard-copy m-2 p-0 d-flex flex-justify-center flex-items-center" data-copy-feedback="Copied!" data-tooltip-direction="w" role="button" tabindex="0" value="platform_driver_register
    __platform_driver_register
        driver_register
            bus_add_driver    // 把 driver 注册进 platform bus 的全局链表
                driver_attach // 对 platform bus 的每个 dev 调用 __driver_attach
                    __driver_attach
                        driver_match_device(drv, dev) // 判断drv dev是否匹配
                            platform_match
                        driver_probe_device(drv, dev) // 如果匹配，调用 drv probe">
<svg aria-hidden="true" class="octicon octicon-copy js-clipboard-copy-icon" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path>
</svg>
<svg aria-hidden="true" class="octicon octicon-check js-clipboard-check-icon color-fg-success d-none" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"></path>
</svg>
</clipboard-copy>
</div></div>
<div class="highlight highlight-source-c notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-c">// include/linux/platform_device.h</span>

<span class="pl-k">#define</span> <span class="pl-en">platform_driver_register</span>(<span class="pl-s1">drv</span>) \
	__platform_driver_register(drv, THIS_MODULE)</pre><div class="zeroclipboard-container">
<clipboard-copy aria-label="Copy" class="ClipboardButton btn btn-invisible js-clipboard-copy m-2 p-0 d-flex flex-justify-center flex-items-center" data-copy-feedback="Copied!" data-tooltip-direction="w" role="button" tabindex="0" value="// include/linux/platform_device.h

#define platform_driver_register(drv) \
	__platform_driver_register(drv, THIS_MODULE)">
<svg aria-hidden="true" class="octicon octicon-copy js-clipboard-copy-icon" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path>
</svg>
<svg aria-hidden="true" class="octicon octicon-check js-clipboard-check-icon color-fg-success d-none" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"></path>
</svg>
</clipboard-copy>
</div></div>
<div class="markdown-heading" dir="auto"><h4 class="heading-element" dir="auto" tabindex="-1">辅助函数：__platform_driver_register()</h4><a aria-label="Permalink: 辅助函数：__platform_driver_register()" class="anchor" href="#辅助函数__platform_driver_register" id="user-content-辅助函数__platform_driver_register"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<div class="highlight highlight-source-c notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-c">// drivers/base/platform.c</span>

<span class="pl-smi">int</span> <span class="pl-en">__platform_driver_register</span>(<span class="pl-k">struct</span> <span class="pl-smi">platform_driver</span> <span class="pl-c1">*</span><span class="pl-s1">drv</span>,
				<span class="pl-k">struct</span> <span class="pl-smi">module</span> <span class="pl-c1">*</span><span class="pl-s1">owner</span>)
{
	<span class="pl-s1">drv</span><span class="pl-c1">-&gt;</span><span class="pl-c1">driver</span>.<span class="pl-c1">owner</span> <span class="pl-c1">=</span> <span class="pl-s1">owner</span>;
	<span class="pl-s1">drv</span><span class="pl-c1">-&gt;</span><span class="pl-c1">driver</span>.<span class="pl-c1">bus</span> <span class="pl-c1">=</span> <span class="pl-c1">&amp;</span><span class="pl-s1">platform_bus_type</span>;

	<span class="pl-k">return</span> <span class="pl-en">driver_register</span>(<span class="pl-c1">&amp;</span><span class="pl-s1">drv</span><span class="pl-c1">-&gt;</span><span class="pl-c1">driver</span>);
}</pre><div class="zeroclipboard-container">
<clipboard-copy aria-label="Copy" class="ClipboardButton btn btn-invisible js-clipboard-copy m-2 p-0 d-flex flex-justify-center flex-items-center" data-copy-feedback="Copied!" data-tooltip-direction="w" role="button" tabindex="0" value="// drivers/base/platform.c

int __platform_driver_register(struct platform_driver *drv,
				struct module *owner)
{
	drv-&gt;driver.owner = owner;
	drv-&gt;driver.bus = &amp;platform_bus_type;

	return driver_register(&amp;drv-&gt;driver);
}">
<svg aria-hidden="true" class="octicon octicon-copy js-clipboard-copy-icon" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path>
</svg>
<svg aria-hidden="true" class="octicon octicon-check js-clipboard-check-icon color-fg-success d-none" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"></path>
</svg>
</clipboard-copy>
</div></div>
<div class="markdown-heading" dir="auto"><h4 class="heading-element" dir="auto" tabindex="-1">辅助函数：driver_register()</h4><a aria-label="Permalink: 辅助函数：driver_register()" class="anchor" href="#辅助函数driver_register" id="user-content-辅助函数driver_register"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<div class="highlight highlight-source-c notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-c">// drivers/base/driver.c</span>

<span class="pl-smi">int</span> <span class="pl-en">driver_register</span>(<span class="pl-k">struct</span> <span class="pl-smi">device_driver</span> <span class="pl-c1">*</span><span class="pl-s1">drv</span>)
{
	<span class="pl-smi">int</span> <span class="pl-s1">ret</span>;
	<span class="pl-k">struct</span> <span class="pl-smi">device_driver</span> <span class="pl-c1">*</span><span class="pl-s1">other</span>;

	<span class="pl-k">if</span> (!<span class="pl-en">bus_is_registered</span>(<span class="pl-s1">drv</span><span class="pl-c1">-&gt;</span><span class="pl-c1">bus</span>)) {
		<span class="pl-en">pr_err</span>(<span class="pl-s">"Driver '%s' was unable to register with bus_type '%s' because the bus was not initialized.\n"</span>,
			   <span class="pl-s1">drv</span><span class="pl-c1">-&gt;</span><span class="pl-c1">name</span>, <span class="pl-s1">drv</span><span class="pl-c1">-&gt;</span><span class="pl-c1">bus</span><span class="pl-c1">-&gt;</span><span class="pl-c1">name</span>);
		<span class="pl-k">return</span> <span class="pl-c1">-</span><span class="pl-c1">EINVAL</span>;
	}

	<span class="pl-k">if</span> ((<span class="pl-s1">drv</span><span class="pl-c1">-&gt;</span><span class="pl-c1">bus</span><span class="pl-c1">-&gt;</span><span class="pl-c1">probe</span> <span class="pl-c1">&amp;&amp;</span> <span class="pl-s1">drv</span><span class="pl-c1">-&gt;</span><span class="pl-c1">probe</span>) <span class="pl-c1">||</span>
	    (<span class="pl-s1">drv</span><span class="pl-c1">-&gt;</span><span class="pl-c1">bus</span><span class="pl-c1">-&gt;</span><span class="pl-c1">remove</span> <span class="pl-c1">&amp;&amp;</span> <span class="pl-s1">drv</span><span class="pl-c1">-&gt;</span><span class="pl-c1">remove</span>) <span class="pl-c1">||</span>
	    (<span class="pl-s1">drv</span><span class="pl-c1">-&gt;</span><span class="pl-c1">bus</span><span class="pl-c1">-&gt;</span><span class="pl-c1">shutdown</span> <span class="pl-c1">&amp;&amp;</span> <span class="pl-s1">drv</span><span class="pl-c1">-&gt;</span><span class="pl-c1">shutdown</span>))
		<span class="pl-en">pr_warn</span>(<span class="pl-s">"Driver '%s' needs updating - please use "</span>
			<span class="pl-s">"bus_type methods\n"</span>, <span class="pl-s1">drv</span><span class="pl-c1">-&gt;</span><span class="pl-c1">name</span>);

	<span class="pl-s1">other</span> <span class="pl-c1">=</span> <span class="pl-en">driver_find</span>(<span class="pl-s1">drv</span><span class="pl-c1">-&gt;</span><span class="pl-c1">name</span>, <span class="pl-s1">drv</span><span class="pl-c1">-&gt;</span><span class="pl-c1">bus</span>);
	<span class="pl-k">if</span> (<span class="pl-s1">other</span>) {
		<span class="pl-en">pr_err</span>(<span class="pl-s">"Error: Driver '%s' is already registered, "</span>
			<span class="pl-s">"aborting...\n"</span>, <span class="pl-s1">drv</span><span class="pl-c1">-&gt;</span><span class="pl-c1">name</span>);
		<span class="pl-k">return</span> <span class="pl-c1">-</span><span class="pl-c1">EBUSY</span>;
	}

	<span class="pl-c">// 把 driver 注册进 platform bus 的全局链表</span>
	<span class="pl-s1">ret</span> <span class="pl-c1">=</span> <span class="pl-en">bus_add_driver</span>(<span class="pl-s1">drv</span>);
	<span class="pl-k">if</span> (<span class="pl-s1">ret</span>)
		<span class="pl-k">return</span> <span class="pl-s1">ret</span>;
	<span class="pl-s1">ret</span> <span class="pl-c1">=</span> <span class="pl-en">driver_add_groups</span>(<span class="pl-s1">drv</span>, <span class="pl-s1">drv</span><span class="pl-c1">-&gt;</span><span class="pl-c1">groups</span>);
	<span class="pl-k">if</span> (<span class="pl-s1">ret</span>) {
		<span class="pl-en">bus_remove_driver</span>(<span class="pl-s1">drv</span>);
		<span class="pl-k">return</span> <span class="pl-s1">ret</span>;
	}
	<span class="pl-en">kobject_uevent</span>(<span class="pl-c1">&amp;</span><span class="pl-s1">drv</span><span class="pl-c1">-&gt;</span><span class="pl-c1">p</span><span class="pl-c1">-&gt;</span><span class="pl-c1">kobj</span>, <span class="pl-c1">KOBJ_ADD</span>);
	<span class="pl-en">deferred_probe_extend_timeout</span>();

	<span class="pl-k">return</span> <span class="pl-s1">ret</span>;
}</pre><div class="zeroclipboard-container">
<clipboard-copy aria-label="Copy" class="ClipboardButton btn btn-invisible js-clipboard-copy m-2 p-0 d-flex flex-justify-center flex-items-center" data-copy-feedback="Copied!" data-tooltip-direction="w" role="button" tabindex="0" value="// drivers/base/driver.c

int driver_register(struct device_driver *drv)
{
	int ret;
	struct device_driver *other;

	if (!bus_is_registered(drv-&gt;bus)) {
		pr_err(&quot;Driver '%s' was unable to register with bus_type '%s' because the bus was not initialized.\n&quot;,
			   drv-&gt;name, drv-&gt;bus-&gt;name);
		return -EINVAL;
	}

	if ((drv-&gt;bus-&gt;probe &amp;&amp; drv-&gt;probe) ||
	    (drv-&gt;bus-&gt;remove &amp;&amp; drv-&gt;remove) ||
	    (drv-&gt;bus-&gt;shutdown &amp;&amp; drv-&gt;shutdown))
		pr_warn(&quot;Driver '%s' needs updating - please use &quot;
			&quot;bus_type methods\n&quot;, drv-&gt;name);

	other = driver_find(drv-&gt;name, drv-&gt;bus);
	if (other) {
		pr_err(&quot;Error: Driver '%s' is already registered, &quot;
			&quot;aborting...\n&quot;, drv-&gt;name);
		return -EBUSY;
	}

	// 把 driver 注册进 platform bus 的全局链表
	ret = bus_add_driver(drv);
	if (ret)
		return ret;
	ret = driver_add_groups(drv, drv-&gt;groups);
	if (ret) {
		bus_remove_driver(drv);
		return ret;
	}
	kobject_uevent(&amp;drv-&gt;p-&gt;kobj, KOBJ_ADD);
	deferred_probe_extend_timeout();

	return ret;
}">
<svg aria-hidden="true" class="octicon octicon-copy js-clipboard-copy-icon" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path>
</svg>
<svg aria-hidden="true" class="octicon octicon-check js-clipboard-check-icon color-fg-success d-none" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"></path>
</svg>
</clipboard-copy>
</div></div>
<div class="markdown-heading" dir="auto"><h4 class="heading-element" dir="auto" tabindex="-1">辅助函数：bus_add_driver()</h4><a aria-label="Permalink: 辅助函数：bus_add_driver()" class="anchor" href="#辅助函数bus_add_driver" id="user-content-辅助函数bus_add_driver"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<div class="highlight highlight-source-c notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-c">// drivers/base/bus.c</span>

<span class="pl-smi">int</span> <span class="pl-en">bus_add_driver</span>(<span class="pl-k">struct</span> <span class="pl-smi">device_driver</span> <span class="pl-c1">*</span><span class="pl-s1">drv</span>)
{
	<span class="pl-k">struct</span> <span class="pl-smi">subsys_private</span> <span class="pl-c1">*</span><span class="pl-s1">sp</span> <span class="pl-c1">=</span> <span class="pl-en">bus_to_subsys</span>(<span class="pl-s1">drv</span><span class="pl-c1">-&gt;</span><span class="pl-c1">bus</span>);
	<span class="pl-k">struct</span> <span class="pl-smi">driver_private</span> <span class="pl-c1">*</span><span class="pl-s1">priv</span>;
	<span class="pl-smi">int</span> <span class="pl-s1">error</span> <span class="pl-c1">=</span> <span class="pl-c1">0</span>;

	<span class="pl-k">if</span> (!<span class="pl-s1">sp</span>)
		<span class="pl-k">return</span> <span class="pl-c1">-</span><span class="pl-c1">EINVAL</span>;

	<span class="pl-c">/*</span>
<span class="pl-c">	 * Reference in sp is now incremented and will be dropped when</span>
<span class="pl-c">	 * the driver is removed from the bus</span>
<span class="pl-c">	 */</span>
	<span class="pl-en">pr_debug</span>(<span class="pl-s">"bus: '%s': add driver %s\n"</span>, <span class="pl-s1">sp</span><span class="pl-c1">-&gt;</span><span class="pl-c1">bus</span><span class="pl-c1">-&gt;</span><span class="pl-c1">name</span>, <span class="pl-s1">drv</span><span class="pl-c1">-&gt;</span><span class="pl-c1">name</span>);

	<span class="pl-s1">priv</span> <span class="pl-c1">=</span> <span class="pl-en">kzalloc</span>(<span class="pl-k">sizeof</span>(<span class="pl-c1">*</span><span class="pl-s1">priv</span>), <span class="pl-c1">GFP_KERNEL</span>);
	<span class="pl-k">if</span> (!<span class="pl-s1">priv</span>) {
		<span class="pl-s1">error</span> <span class="pl-c1">=</span> <span class="pl-c1">-</span><span class="pl-c1">ENOMEM</span>;
		goto <span class="pl-ent">out_put_bus</span>;
	}
	<span class="pl-en">klist_init</span>(<span class="pl-c1">&amp;</span><span class="pl-s1">priv</span><span class="pl-c1">-&gt;</span><span class="pl-c1">klist_devices</span>, <span class="pl-c1">NULL</span>, <span class="pl-c1">NULL</span>);
	<span class="pl-s1">priv</span><span class="pl-c1">-&gt;</span><span class="pl-c1">driver</span> <span class="pl-c1">=</span> <span class="pl-s1">drv</span>;
	<span class="pl-s1">drv</span><span class="pl-c1">-&gt;</span><span class="pl-c1">p</span> <span class="pl-c1">=</span> <span class="pl-s1">priv</span>;
	<span class="pl-s1">priv</span><span class="pl-c1">-&gt;</span><span class="pl-c1">kobj</span>.<span class="pl-c1">kset</span> <span class="pl-c1">=</span> <span class="pl-s1">sp</span><span class="pl-c1">-&gt;</span><span class="pl-c1">drivers_kset</span>;
	<span class="pl-s1">error</span> <span class="pl-c1">=</span> <span class="pl-en">kobject_init_and_add</span>(<span class="pl-c1">&amp;</span><span class="pl-s1">priv</span><span class="pl-c1">-&gt;</span><span class="pl-c1">kobj</span>, <span class="pl-c1">&amp;</span><span class="pl-s1">driver_ktype</span>, <span class="pl-c1">NULL</span>,
				     <span class="pl-s">"%s"</span>, <span class="pl-s1">drv</span><span class="pl-c1">-&gt;</span><span class="pl-c1">name</span>);
	<span class="pl-k">if</span> (<span class="pl-s1">error</span>)
		goto <span class="pl-ent">out_unregister</span>;

	<span class="pl-en">klist_add_tail</span>(<span class="pl-c1">&amp;</span><span class="pl-s1">priv</span><span class="pl-c1">-&gt;</span><span class="pl-c1">knode_bus</span>, <span class="pl-c1">&amp;</span><span class="pl-s1">sp</span><span class="pl-c1">-&gt;</span><span class="pl-c1">klist_drivers</span>);
	<span class="pl-k">if</span> (<span class="pl-s1">sp</span><span class="pl-c1">-&gt;</span><span class="pl-c1">drivers_autoprobe</span>) {
		<span class="pl-s1">error</span> <span class="pl-c1">=</span> <span class="pl-en">driver_attach</span>(<span class="pl-s1">drv</span>);
		<span class="pl-k">if</span> (<span class="pl-s1">error</span>)
			goto <span class="pl-ent">out_del_list</span>;
	}
	<span class="pl-s1">error</span> <span class="pl-c1">=</span> <span class="pl-en">module_add_driver</span>(<span class="pl-s1">drv</span><span class="pl-c1">-&gt;</span><span class="pl-c1">owner</span>, <span class="pl-s1">drv</span>);
	<span class="pl-k">if</span> (<span class="pl-s1">error</span>) {
		<span class="pl-en">printk</span>(<span class="pl-c1">KERN_ERR</span> <span class="pl-s">"%s: failed to create module links for %s\n"</span>,
			<span class="pl-s1">__func__</span>, <span class="pl-s1">drv</span><span class="pl-c1">-&gt;</span><span class="pl-c1">name</span>);
		goto <span class="pl-ent">out_detach</span>;
	}

	<span class="pl-s1">error</span> <span class="pl-c1">=</span> <span class="pl-en">driver_create_file</span>(<span class="pl-s1">drv</span>, <span class="pl-c1">&amp;</span><span class="pl-s1">driver_attr_uevent</span>);
	<span class="pl-k">if</span> (<span class="pl-s1">error</span>) {
		<span class="pl-en">printk</span>(<span class="pl-c1">KERN_ERR</span> <span class="pl-s">"%s: uevent attr (%s) failed\n"</span>,
			<span class="pl-s1">__func__</span>, <span class="pl-s1">drv</span><span class="pl-c1">-&gt;</span><span class="pl-c1">name</span>);
	}
	<span class="pl-s1">error</span> <span class="pl-c1">=</span> <span class="pl-en">driver_add_groups</span>(<span class="pl-s1">drv</span>, <span class="pl-s1">sp</span><span class="pl-c1">-&gt;</span><span class="pl-c1">bus</span><span class="pl-c1">-&gt;</span><span class="pl-c1">drv_groups</span>);
	<span class="pl-k">if</span> (<span class="pl-s1">error</span>) {
		<span class="pl-c">/* How the hell do we get out of this pickle? Give up */</span>
		<span class="pl-en">printk</span>(<span class="pl-c1">KERN_ERR</span> <span class="pl-s">"%s: driver_add_groups(%s) failed\n"</span>,
			<span class="pl-s1">__func__</span>, <span class="pl-s1">drv</span><span class="pl-c1">-&gt;</span><span class="pl-c1">name</span>);
	}

	<span class="pl-k">if</span> (!<span class="pl-s1">drv</span><span class="pl-c1">-&gt;</span><span class="pl-c1">suppress_bind_attrs</span>) {
		<span class="pl-s1">error</span> <span class="pl-c1">=</span> <span class="pl-en">add_bind_files</span>(<span class="pl-s1">drv</span>);
		<span class="pl-k">if</span> (<span class="pl-s1">error</span>) {
			<span class="pl-c">/* Ditto */</span>
			<span class="pl-en">printk</span>(<span class="pl-c1">KERN_ERR</span> <span class="pl-s">"%s: add_bind_files(%s) failed\n"</span>,
				<span class="pl-s1">__func__</span>, <span class="pl-s1">drv</span><span class="pl-c1">-&gt;</span><span class="pl-c1">name</span>);
		}
	}

	<span class="pl-k">return</span> <span class="pl-c1">0</span>;

<span class="pl-ent">out_detach</span>:
	<span class="pl-en">driver_detach</span>(<span class="pl-s1">drv</span>);
<span class="pl-ent">out_del_list</span>:
	<span class="pl-en">klist_del</span>(<span class="pl-c1">&amp;</span><span class="pl-s1">priv</span><span class="pl-c1">-&gt;</span><span class="pl-c1">knode_bus</span>);
<span class="pl-ent">out_unregister</span>:
	<span class="pl-en">kobject_put</span>(<span class="pl-c1">&amp;</span><span class="pl-s1">priv</span><span class="pl-c1">-&gt;</span><span class="pl-c1">kobj</span>);
	<span class="pl-c">/* drv-&gt;p is freed in driver_release()  */</span>
	<span class="pl-s1">drv</span><span class="pl-c1">-&gt;</span><span class="pl-c1">p</span> <span class="pl-c1">=</span> <span class="pl-c1">NULL</span>;
<span class="pl-ent">out_put_bus</span>:
	<span class="pl-en">subsys_put</span>(<span class="pl-s1">sp</span>);
	<span class="pl-k">return</span> <span class="pl-s1">error</span>;
}</pre><div class="zeroclipboard-container">
<clipboard-copy aria-label="Copy" class="ClipboardButton btn btn-invisible js-clipboard-copy m-2 p-0 d-flex flex-justify-center flex-items-center" data-copy-feedback="Copied!" data-tooltip-direction="w" role="button" tabindex="0" value="// drivers/base/bus.c

int bus_add_driver(struct device_driver *drv)
{
	struct subsys_private *sp = bus_to_subsys(drv-&gt;bus);
	struct driver_private *priv;
	int error = 0;

	if (!sp)
		return -EINVAL;

	/*
	 * Reference in sp is now incremented and will be dropped when
	 * the driver is removed from the bus
	 */
	pr_debug(&quot;bus: '%s': add driver %s\n&quot;, sp-&gt;bus-&gt;name, drv-&gt;name);

	priv = kzalloc(sizeof(*priv), GFP_KERNEL);
	if (!priv) {
		error = -ENOMEM;
		goto out_put_bus;
	}
	klist_init(&amp;priv-&gt;klist_devices, NULL, NULL);
	priv-&gt;driver = drv;
	drv-&gt;p = priv;
	priv-&gt;kobj.kset = sp-&gt;drivers_kset;
	error = kobject_init_and_add(&amp;priv-&gt;kobj, &amp;driver_ktype, NULL,
				     &quot;%s&quot;, drv-&gt;name);
	if (error)
		goto out_unregister;

	klist_add_tail(&amp;priv-&gt;knode_bus, &amp;sp-&gt;klist_drivers);
	if (sp-&gt;drivers_autoprobe) {
		error = driver_attach(drv);
		if (error)
			goto out_del_list;
	}
	error = module_add_driver(drv-&gt;owner, drv);
	if (error) {
		printk(KERN_ERR &quot;%s: failed to create module links for %s\n&quot;,
			__func__, drv-&gt;name);
		goto out_detach;
	}

	error = driver_create_file(drv, &amp;driver_attr_uevent);
	if (error) {
		printk(KERN_ERR &quot;%s: uevent attr (%s) failed\n&quot;,
			__func__, drv-&gt;name);
	}
	error = driver_add_groups(drv, sp-&gt;bus-&gt;drv_groups);
	if (error) {
		/* How the hell do we get out of this pickle? Give up */
		printk(KERN_ERR &quot;%s: driver_add_groups(%s) failed\n&quot;,
			__func__, drv-&gt;name);
	}

	if (!drv-&gt;suppress_bind_attrs) {
		error = add_bind_files(drv);
		if (error) {
			/* Ditto */
			printk(KERN_ERR &quot;%s: add_bind_files(%s) failed\n&quot;,
				__func__, drv-&gt;name);
		}
	}

	return 0;

out_detach:
	driver_detach(drv);
out_del_list:
	klist_del(&amp;priv-&gt;knode_bus);
out_unregister:
	kobject_put(&amp;priv-&gt;kobj);
	/* drv-&gt;p is freed in driver_release()  */
	drv-&gt;p = NULL;
out_put_bus:
	subsys_put(sp);
	return error;
}">
<svg aria-hidden="true" class="octicon octicon-copy js-clipboard-copy-icon" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path>
</svg>
<svg aria-hidden="true" class="octicon octicon-check js-clipboard-check-icon color-fg-success d-none" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"></path>
</svg>
</clipboard-copy>
</div></div>
<div class="markdown-heading" dir="auto"><h4 class="heading-element" dir="auto" tabindex="-1">辅助函数：driver_attach()</h4><a aria-label="Permalink: 辅助函数：driver_attach()" class="anchor" href="#辅助函数driver_attach" id="user-content-辅助函数driver_attach"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<div class="highlight highlight-source-c notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-c">// drivers/base/dd.c</span>

<span class="pl-smi">int</span> <span class="pl-en">driver_attach</span>(<span class="pl-k">const</span> <span class="pl-k">struct</span> <span class="pl-smi">device_driver</span> <span class="pl-c1">*</span><span class="pl-s1">drv</span>)
{
	<span class="pl-c">/* The (void *) will be put back to const * in __driver_attach() */</span>
	<span class="pl-k">return</span> <span class="pl-en">bus_for_each_dev</span>(<span class="pl-s1">drv</span><span class="pl-c1">-&gt;</span><span class="pl-c1">bus</span>, <span class="pl-c1">NULL</span>, (<span class="pl-smi">void</span> <span class="pl-c1">*</span>)<span class="pl-s1">drv</span>, <span class="pl-s1">__driver_attach</span>);
}</pre><div class="zeroclipboard-container">
<clipboard-copy aria-label="Copy" class="ClipboardButton btn btn-invisible js-clipboard-copy m-2 p-0 d-flex flex-justify-center flex-items-center" data-copy-feedback="Copied!" data-tooltip-direction="w" role="button" tabindex="0" value="// drivers/base/dd.c

int driver_attach(const struct device_driver *drv)
{
	/* The (void *) will be put back to const * in __driver_attach() */
	return bus_for_each_dev(drv-&gt;bus, NULL, (void *)drv, __driver_attach);
}">
<svg aria-hidden="true" class="octicon octicon-copy js-clipboard-copy-icon" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path>
</svg>
<svg aria-hidden="true" class="octicon octicon-check js-clipboard-check-icon color-fg-success d-none" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"></path>
</svg>
</clipboard-copy>
</div></div>
<div class="markdown-heading" dir="auto"><h4 class="heading-element" dir="auto" tabindex="-1">辅助函数：__driver_attach()/driver_match_device()</h4><a aria-label="Permalink: 辅助函数：__driver_attach()/driver_match_device()" class="anchor" href="#辅助函数__driver_attachdriver_match_device" id="user-content-辅助函数__driver_attachdriver_match_device"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<div class="highlight highlight-source-c notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-c">// drivers/base/dd.c</span>

<span class="pl-k">static</span> <span class="pl-smi">int</span> <span class="pl-en">__driver_attach</span>(<span class="pl-k">struct</span> <span class="pl-smi">device</span> <span class="pl-c1">*</span><span class="pl-s1">dev</span>, <span class="pl-smi">void</span> <span class="pl-c1">*</span><span class="pl-s1">data</span>)
{
	<span class="pl-k">const</span> <span class="pl-k">struct</span> <span class="pl-smi">device_driver</span> <span class="pl-c1">*</span><span class="pl-s1">drv</span> <span class="pl-c1">=</span> <span class="pl-s1">data</span>;
	<span class="pl-smi">bool</span> <span class="pl-s1">async</span> <span class="pl-c1">=</span> false;
	<span class="pl-smi">int</span> <span class="pl-s1">ret</span>;

	<span class="pl-c">/*</span>
<span class="pl-c">	 * Lock device and try to bind to it. We drop the error</span>
<span class="pl-c">	 * here and always return 0, because we need to keep trying</span>
<span class="pl-c">	 * to bind to devices and some drivers will return an error</span>
<span class="pl-c">	 * simply if it didn't support the device.</span>
<span class="pl-c">	 *</span>
<span class="pl-c">	 * driver_probe_device() will spit a warning if there</span>
<span class="pl-c">	 * is an error.</span>
<span class="pl-c">	 */</span>

	<span class="pl-s1">ret</span> <span class="pl-c1">=</span> <span class="pl-en">driver_match_device</span>(<span class="pl-s1">drv</span>, <span class="pl-s1">dev</span>);
	<span class="pl-k">if</span> (<span class="pl-s1">ret</span> <span class="pl-c1">==</span> <span class="pl-c1">0</span>) {
		<span class="pl-c">/* no match */</span>
		<span class="pl-k">return</span> <span class="pl-c1">0</span>;
	} <span class="pl-k">else</span> <span class="pl-k">if</span> (<span class="pl-s1">ret</span> <span class="pl-c1">==</span> <span class="pl-c1">-</span><span class="pl-c1">EPROBE_DEFER</span>) {
		<span class="pl-en">dev_dbg</span>(<span class="pl-s1">dev</span>, <span class="pl-s">"Device match requests probe deferral\n"</span>);
		<span class="pl-s1">dev</span><span class="pl-c1">-&gt;</span><span class="pl-c1">can_match</span> <span class="pl-c1">=</span> true;
		<span class="pl-en">driver_deferred_probe_add</span>(<span class="pl-s1">dev</span>);
		<span class="pl-c">/*</span>
<span class="pl-c">		 * Driver could not match with device, but may match with</span>
<span class="pl-c">		 * another device on the bus.</span>
<span class="pl-c">		 */</span>
		<span class="pl-k">return</span> <span class="pl-c1">0</span>;
	} <span class="pl-k">else</span> <span class="pl-k">if</span> (<span class="pl-s1">ret</span> <span class="pl-c1">&lt;</span> <span class="pl-c1">0</span>) {
		<span class="pl-en">dev_dbg</span>(<span class="pl-s1">dev</span>, <span class="pl-s">"Bus failed to match device: %d\n"</span>, <span class="pl-s1">ret</span>);
		<span class="pl-c">/*</span>
<span class="pl-c">		 * Driver could not match with device, but may match with</span>
<span class="pl-c">		 * another device on the bus.</span>
<span class="pl-c">		 */</span>
		<span class="pl-k">return</span> <span class="pl-c1">0</span>;
	} <span class="pl-c">/* ret &gt; 0 means positive match */</span>

	<span class="pl-k">if</span> (<span class="pl-en">driver_allows_async_probing</span>(<span class="pl-s1">drv</span>)) {
		<span class="pl-c">/*</span>
<span class="pl-c">		 * Instead of probing the device synchronously we will</span>
<span class="pl-c">		 * probe it asynchronously to allow for more parallelism.</span>
<span class="pl-c">		 *</span>
<span class="pl-c">		 * We only take the device lock here in order to guarantee</span>
<span class="pl-c">		 * that the dev-&gt;driver and async_driver fields are protected</span>
<span class="pl-c">		 */</span>
		<span class="pl-en">dev_dbg</span>(<span class="pl-s1">dev</span>, <span class="pl-s">"probing driver %s asynchronously\n"</span>, <span class="pl-s1">drv</span><span class="pl-c1">-&gt;</span><span class="pl-c1">name</span>);
		<span class="pl-en">device_lock</span>(<span class="pl-s1">dev</span>);
		<span class="pl-k">if</span> (!<span class="pl-s1">dev</span><span class="pl-c1">-&gt;</span><span class="pl-c1">driver</span> <span class="pl-c1">&amp;&amp;</span> !<span class="pl-s1">dev</span><span class="pl-c1">-&gt;</span><span class="pl-c1">p</span><span class="pl-c1">-&gt;</span><span class="pl-c1">async_driver</span>) {
			<span class="pl-en">get_device</span>(<span class="pl-s1">dev</span>);
			<span class="pl-s1">dev</span><span class="pl-c1">-&gt;</span><span class="pl-c1">p</span><span class="pl-c1">-&gt;</span><span class="pl-c1">async_driver</span> <span class="pl-c1">=</span> <span class="pl-s1">drv</span>;
			<span class="pl-s1">async</span> <span class="pl-c1">=</span> true;
		}
		<span class="pl-en">device_unlock</span>(<span class="pl-s1">dev</span>);
		<span class="pl-k">if</span> (<span class="pl-s1">async</span>)
			<span class="pl-en">async_schedule_dev</span>(<span class="pl-s1">__driver_attach_async_helper</span>, <span class="pl-s1">dev</span>);
		<span class="pl-k">return</span> <span class="pl-c1">0</span>;
	}

	<span class="pl-en">__device_driver_lock</span>(<span class="pl-s1">dev</span>, <span class="pl-s1">dev</span><span class="pl-c1">-&gt;</span><span class="pl-c1">parent</span>);
	<span class="pl-en">driver_probe_device</span>(<span class="pl-s1">drv</span>, <span class="pl-s1">dev</span>);
	<span class="pl-en">__device_driver_unlock</span>(<span class="pl-s1">dev</span>, <span class="pl-s1">dev</span><span class="pl-c1">-&gt;</span><span class="pl-c1">parent</span>);

	<span class="pl-k">return</span> <span class="pl-c1">0</span>;
}

<span class="pl-c">// drivers/base/base.h</span>

<span class="pl-k">static</span> <span class="pl-k">inline</span> <span class="pl-smi">int</span> <span class="pl-en">driver_match_device</span>(<span class="pl-k">const</span> <span class="pl-k">struct</span> <span class="pl-smi">device_driver</span> <span class="pl-c1">*</span><span class="pl-s1">drv</span>,
				      <span class="pl-k">struct</span> <span class="pl-smi">device</span> <span class="pl-c1">*</span><span class="pl-s1">dev</span>)
{
	<span class="pl-k">return</span> <span class="pl-s1">drv</span><span class="pl-c1">-&gt;</span><span class="pl-c1">bus</span><span class="pl-c1">-&gt;</span><span class="pl-c1">match</span> ? <span class="pl-s1">drv</span><span class="pl-c1">-&gt;</span><span class="pl-c1">bus</span><span class="pl-c1">-&gt;</span><span class="pl-en">match</span>(<span class="pl-s1">dev</span>, <span class="pl-s1">drv</span>) : <span class="pl-c1">1</span>;
}</pre><div class="zeroclipboard-container">
<clipboard-copy aria-label="Copy" class="ClipboardButton btn btn-invisible js-clipboard-copy m-2 p-0 d-flex flex-justify-center flex-items-center" data-copy-feedback="Copied!" data-tooltip-direction="w" role="button" tabindex="0" value="// drivers/base/dd.c

static int __driver_attach(struct device *dev, void *data)
{
	const struct device_driver *drv = data;
	bool async = false;
	int ret;

	/*
	 * Lock device and try to bind to it. We drop the error
	 * here and always return 0, because we need to keep trying
	 * to bind to devices and some drivers will return an error
	 * simply if it didn't support the device.
	 *
	 * driver_probe_device() will spit a warning if there
	 * is an error.
	 */

	ret = driver_match_device(drv, dev);
	if (ret == 0) {
		/* no match */
		return 0;
	} else if (ret == -EPROBE_DEFER) {
		dev_dbg(dev, &quot;Device match requests probe deferral\n&quot;);
		dev-&gt;can_match = true;
		driver_deferred_probe_add(dev);
		/*
		 * Driver could not match with device, but may match with
		 * another device on the bus.
		 */
		return 0;
	} else if (ret &lt; 0) {
		dev_dbg(dev, &quot;Bus failed to match device: %d\n&quot;, ret);
		/*
		 * Driver could not match with device, but may match with
		 * another device on the bus.
		 */
		return 0;
	} /* ret &gt; 0 means positive match */

	if (driver_allows_async_probing(drv)) {
		/*
		 * Instead of probing the device synchronously we will
		 * probe it asynchronously to allow for more parallelism.
		 *
		 * We only take the device lock here in order to guarantee
		 * that the dev-&gt;driver and async_driver fields are protected
		 */
		dev_dbg(dev, &quot;probing driver %s asynchronously\n&quot;, drv-&gt;name);
		device_lock(dev);
		if (!dev-&gt;driver &amp;&amp; !dev-&gt;p-&gt;async_driver) {
			get_device(dev);
			dev-&gt;p-&gt;async_driver = drv;
			async = true;
		}
		device_unlock(dev);
		if (async)
			async_schedule_dev(__driver_attach_async_helper, dev);
		return 0;
	}

	__device_driver_lock(dev, dev-&gt;parent);
	driver_probe_device(drv, dev);
	__device_driver_unlock(dev, dev-&gt;parent);

	return 0;
}

// drivers/base/base.h

static inline int driver_match_device(const struct device_driver *drv,
				      struct device *dev)
{
	return drv-&gt;bus-&gt;match ? drv-&gt;bus-&gt;match(dev, drv) : 1;
}">
<svg aria-hidden="true" class="octicon octicon-copy js-clipboard-copy-icon" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path>
</svg>
<svg aria-hidden="true" class="octicon octicon-check js-clipboard-check-icon color-fg-success d-none" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"></path>
</svg>
</clipboard-copy>
</div></div>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto" tabindex="-1">platform_match()</h3><a aria-label="Permalink: platform_match()" class="anchor" href="#platform_match" id="user-content-platform_match"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<div class="highlight highlight-source-c notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-c">// drivers/base/platform.c</span>

<span class="pl-k">const</span> <span class="pl-k">struct</span> <span class="pl-smi">bus_type</span> <span class="pl-s1">platform_bus_type</span> <span class="pl-c1">=</span> {
	.<span class="pl-c1">name</span>		<span class="pl-c1">=</span> <span class="pl-s">"platform"</span>,
	.<span class="pl-c1">dev_groups</span>	<span class="pl-c1">=</span> <span class="pl-s1">platform_dev_groups</span>,
	.<span class="pl-c1">match</span>		<span class="pl-c1">=</span> <span class="pl-s1">platform_match</span>,
	.<span class="pl-c1">uevent</span>		<span class="pl-c1">=</span> <span class="pl-s1">platform_uevent</span>,
	.<span class="pl-c1">probe</span>		<span class="pl-c1">=</span> <span class="pl-s1">platform_probe</span>,
	.<span class="pl-c1">remove</span>		<span class="pl-c1">=</span> <span class="pl-s1">platform_remove</span>,
	.<span class="pl-c1">shutdown</span>	<span class="pl-c1">=</span> <span class="pl-s1">platform_shutdown</span>,
	.<span class="pl-c1">dma_configure</span>	<span class="pl-c1">=</span> <span class="pl-s1">platform_dma_configure</span>,
	.<span class="pl-c1">dma_cleanup</span>	<span class="pl-c1">=</span> <span class="pl-s1">platform_dma_cleanup</span>,
	.<span class="pl-c1">pm</span>		<span class="pl-c1">=</span> <span class="pl-c1">&amp;</span><span class="pl-s1">platform_dev_pm_ops</span>,
};
<span class="pl-en">EXPORT_SYMBOL_GPL</span>(<span class="pl-s1">platform_bus_type</span>);

<span class="pl-c">// drivers/base/platform.c</span>

<span class="pl-k">static</span> <span class="pl-smi">int</span> <span class="pl-en">platform_match</span>(<span class="pl-k">struct</span> <span class="pl-smi">device</span> <span class="pl-c1">*</span><span class="pl-s1">dev</span>, <span class="pl-k">const</span> <span class="pl-k">struct</span> <span class="pl-smi">device_driver</span> <span class="pl-c1">*</span><span class="pl-s1">drv</span>)
{
	<span class="pl-k">struct</span> <span class="pl-smi">platform_device</span> <span class="pl-c1">*</span><span class="pl-s1">pdev</span> <span class="pl-c1">=</span> <span class="pl-en">to_platform_device</span>(<span class="pl-s1">dev</span>);
	<span class="pl-k">struct</span> <span class="pl-smi">platform_driver</span> <span class="pl-c1">*</span><span class="pl-s1">pdrv</span> <span class="pl-c1">=</span> <span class="pl-en">to_platform_driver</span>(<span class="pl-s1">drv</span>);

	<span class="pl-c">/* When driver_override is set, only bind to the matching driver */</span>
	<span class="pl-k">if</span> (<span class="pl-s1">pdev</span><span class="pl-c1">-&gt;</span><span class="pl-c1">driver_override</span>)
		<span class="pl-k">return</span> !<span class="pl-en">strcmp</span>(<span class="pl-s1">pdev</span><span class="pl-c1">-&gt;</span><span class="pl-c1">driver_override</span>, <span class="pl-s1">drv</span><span class="pl-c1">-&gt;</span><span class="pl-c1">name</span>);

	<span class="pl-c">/* Attempt an OF style match first */</span>
	<span class="pl-k">if</span> (<span class="pl-en">of_driver_match_device</span>(<span class="pl-s1">dev</span>, <span class="pl-s1">drv</span>))
		<span class="pl-k">return</span> <span class="pl-c1">1</span>;

	<span class="pl-c">/* Then try ACPI style match */</span>
	<span class="pl-k">if</span> (<span class="pl-en">acpi_driver_match_device</span>(<span class="pl-s1">dev</span>, <span class="pl-s1">drv</span>))
		<span class="pl-k">return</span> <span class="pl-c1">1</span>;

	<span class="pl-c">/* Then try to match against the id table */</span>
	<span class="pl-k">if</span> (<span class="pl-s1">pdrv</span><span class="pl-c1">-&gt;</span><span class="pl-c1">id_table</span>)
		<span class="pl-k">return</span> <span class="pl-en">platform_match_id</span>(<span class="pl-s1">pdrv</span><span class="pl-c1">-&gt;</span><span class="pl-c1">id_table</span>, <span class="pl-s1">pdev</span>) <span class="pl-c1">!=</span> <span class="pl-c1">NULL</span>;

	<span class="pl-c">/* fall-back to driver name match */</span>
	<span class="pl-k">return</span> (<span class="pl-en">strcmp</span>(<span class="pl-s1">pdev</span><span class="pl-c1">-&gt;</span><span class="pl-c1">name</span>, <span class="pl-s1">drv</span><span class="pl-c1">-&gt;</span><span class="pl-c1">name</span>) <span class="pl-c1">==</span> <span class="pl-c1">0</span>);
}</pre><div class="zeroclipboard-container">
<clipboard-copy aria-label="Copy" class="ClipboardButton btn btn-invisible js-clipboard-copy m-2 p-0 d-flex flex-justify-center flex-items-center" data-copy-feedback="Copied!" data-tooltip-direction="w" role="button" tabindex="0" value='// drivers/base/platform.c

const struct bus_type platform_bus_type = {
	.name		= "platform",
	.dev_groups	= platform_dev_groups,
	.match		= platform_match,
	.uevent		= platform_uevent,
	.probe		= platform_probe,
	.remove		= platform_remove,
	.shutdown	= platform_shutdown,
	.dma_configure	= platform_dma_configure,
	.dma_cleanup	= platform_dma_cleanup,
	.pm		= &amp;platform_dev_pm_ops,
};
EXPORT_SYMBOL_GPL(platform_bus_type);

// drivers/base/platform.c

static int platform_match(struct device *dev, const struct device_driver *drv)
{
	struct platform_device *pdev = to_platform_device(dev);
	struct platform_driver *pdrv = to_platform_driver(drv);

	/* When driver_override is set, only bind to the matching driver */
	if (pdev-&gt;driver_override)
		return !strcmp(pdev-&gt;driver_override, drv-&gt;name);

	/* Attempt an OF style match first */
	if (of_driver_match_device(dev, drv))
		return 1;

	/* Then try ACPI style match */
	if (acpi_driver_match_device(dev, drv))
		return 1;

	/* Then try to match against the id table */
	if (pdrv-&gt;id_table)
		return platform_match_id(pdrv-&gt;id_table, pdev) != NULL;

	/* fall-back to driver name match */
	return (strcmp(pdev-&gt;name, drv-&gt;name) == 0);
}'>
<svg aria-hidden="true" class="octicon octicon-copy js-clipboard-copy-icon" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path>
</svg>
<svg aria-hidden="true" class="octicon octicon-check js-clipboard-check-icon color-fg-success d-none" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"></path>
</svg>
</clipboard-copy>
</div></div>
<div class="markdown-heading" dir="auto"><h4 class="heading-element" dir="auto" tabindex="-1">driver_override</h4><a aria-label="Permalink: driver_override" class="anchor" href="#driver_override" id="user-content-driver_override"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">比较 platform_device.driver_override 和 platform_driver.driver.name。</p>
<div class="markdown-heading" dir="auto"><h4 class="heading-element" dir="auto" tabindex="-1">设备树 match</h4><a aria-label="Permalink: 设备树 match" class="anchor" href="#设备树-match" id="user-content-设备树-match"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">比较 platform_device.dev.of_node 和 platform_driver.driver.of_match_table。</p>
<p dir="auto">platform_device.dev.of_node 的类型为 <code>struct device_node *</code>，platform_driver.driver.of_match_table 类型为 <code>struct of_device_id *</code>。</p>
<div class="highlight highlight-source-c notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-c">// include/linux/of.h</span>

<span class="pl-k">struct</span> <span class="pl-smi">device_node</span> {
	<span class="pl-k">const</span> <span class="pl-smi">char</span> <span class="pl-c1">*</span><span class="pl-c1">name</span>;
	<span class="pl-smi">phandle</span> <span class="pl-c1">phandle</span>;
	<span class="pl-k">const</span> <span class="pl-smi">char</span> <span class="pl-c1">*</span><span class="pl-c1">full_name</span>;
	<span class="pl-k">struct</span> <span class="pl-smi">fwnode_handle</span> <span class="pl-c1">fwnode</span>;

	<span class="pl-k">struct</span>	<span class="pl-smi">property</span> <span class="pl-c1">*</span><span class="pl-c1">properties</span>;
	<span class="pl-k">struct</span>	<span class="pl-smi">property</span> <span class="pl-c1">*</span><span class="pl-c1">deadprops</span>;	<span class="pl-c">/* removed properties */</span>
	<span class="pl-k">struct</span>	<span class="pl-smi">device_node</span> <span class="pl-c1">*</span><span class="pl-c1">parent</span>;
	<span class="pl-k">struct</span>	<span class="pl-smi">device_node</span> <span class="pl-c1">*</span><span class="pl-c1">child</span>;
	<span class="pl-k">struct</span>	<span class="pl-smi">device_node</span> <span class="pl-c1">*</span><span class="pl-c1">sibling</span>;
<span class="pl-k">#if</span> defined(<span class="pl-c1">CONFIG_OF_KOBJ</span>)
	<span class="pl-k">struct</span>	<span class="pl-smi">kobject</span> <span class="pl-c1">kobj</span>;
<span class="pl-k">#endif</span>
	<span class="pl-smi">unsigned long</span> <span class="pl-c1">_flags</span>;
	<span class="pl-smi">void</span>	<span class="pl-c1">*</span><span class="pl-c1">data</span>;
};

<span class="pl-c">// include/linux/mod_devicetable.h</span>

<span class="pl-k">struct</span> <span class="pl-smi">of_device_id</span> {
	<span class="pl-smi">char</span>	<span class="pl-c1">name</span>[<span class="pl-c1">32</span>];
	<span class="pl-smi">char</span>	<span class="pl-c1">type</span>[<span class="pl-c1">32</span>];
	<span class="pl-smi">char</span>	<span class="pl-c1">compatible</span>[<span class="pl-c1">128</span>];
	<span class="pl-k">const</span> <span class="pl-smi">void</span> <span class="pl-c1">*</span><span class="pl-c1">data</span>;
};</pre><div class="zeroclipboard-container">
<clipboard-copy aria-label="Copy" class="ClipboardButton btn btn-invisible js-clipboard-copy m-2 p-0 d-flex flex-justify-center flex-items-center" data-copy-feedback="Copied!" data-tooltip-direction="w" role="button" tabindex="0" value="// include/linux/of.h

struct device_node {
	const char *name;
	phandle phandle;
	const char *full_name;
	struct fwnode_handle fwnode;

	struct	property *properties;
	struct	property *deadprops;	/* removed properties */
	struct	device_node *parent;
	struct	device_node *child;
	struct	device_node *sibling;
#if defined(CONFIG_OF_KOBJ)
	struct	kobject kobj;
#endif
	unsigned long _flags;
	void	*data;
};

// include/linux/mod_devicetable.h

struct of_device_id {
	char	name[32];
	char	type[32];
	char	compatible[128];
	const void *data;
};">
<svg aria-hidden="true" class="octicon octicon-copy js-clipboard-copy-icon" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path>
</svg>
<svg aria-hidden="true" class="octicon octicon-check js-clipboard-check-icon color-fg-success d-none" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"></path>
</svg>
</clipboard-copy>
</div></div>
<p dir="auto">具体比较在 <code>__of_device_is_compatible</code> 中发生。总结如下：</p>
<ul dir="auto">
<li>首先，如果 of_match_table 中含有 compatible 值，就跟 dev 的 compatile 属性比较，若一致则成功，否则返回失败；</li>
<li>其次，如果 of_match_table 中含有 type 值，就跟 dev 的 device_type 属性比较，若一致则成功，否则返回失败；</li>
<li>最后，如果 of_match_table 中含有 name 值，就跟 dev 的 name 属性比较，若一致则成功，否则返回失败。</li>
</ul>
<p dir="auto">而设备树中建议不再使用 devcie_type 和 name 属性，所以基本上只使用设备节点的 compatible 属性来寻找匹配的 platform_driver。</p>
<div class="highlight highlight-source-c notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-c">// include/linux/of_device.h</span>

<span class="pl-k">static</span> <span class="pl-k">inline</span> <span class="pl-smi">int</span> <span class="pl-en">of_driver_match_device</span>(<span class="pl-k">struct</span> <span class="pl-smi">device</span> <span class="pl-c1">*</span><span class="pl-s1">dev</span>,
					 <span class="pl-k">const</span> <span class="pl-k">struct</span> <span class="pl-smi">device_driver</span> <span class="pl-c1">*</span><span class="pl-s1">drv</span>)
{
	<span class="pl-k">return</span> <span class="pl-en">of_match_device</span>(<span class="pl-s1">drv</span><span class="pl-c1">-&gt;</span><span class="pl-c1">of_match_table</span>, <span class="pl-s1">dev</span>) <span class="pl-c1">!=</span> <span class="pl-c1">NULL</span>;
}

<span class="pl-c">// drivers/of/device.c</span>

<span class="pl-k">const</span> <span class="pl-k">struct</span> <span class="pl-smi">of_device_id</span> <span class="pl-c1">*</span><span class="pl-en">of_match_device</span>(<span class="pl-k">const</span> <span class="pl-k">struct</span> <span class="pl-smi">of_device_id</span> <span class="pl-c1">*</span><span class="pl-s1">matches</span>,
					   <span class="pl-k">const</span> <span class="pl-k">struct</span> <span class="pl-smi">device</span> <span class="pl-c1">*</span><span class="pl-s1">dev</span>)
{
	<span class="pl-k">if</span> (!<span class="pl-s1">matches</span> <span class="pl-c1">||</span> !<span class="pl-s1">dev</span><span class="pl-c1">-&gt;</span><span class="pl-c1">of_node</span> <span class="pl-c1">||</span> <span class="pl-s1">dev</span><span class="pl-c1">-&gt;</span><span class="pl-c1">of_node_reused</span>)
		<span class="pl-k">return</span> <span class="pl-c1">NULL</span>;
	<span class="pl-k">return</span> <span class="pl-en">of_match_node</span>(<span class="pl-s1">matches</span>, <span class="pl-s1">dev</span><span class="pl-c1">-&gt;</span><span class="pl-c1">of_node</span>);
}

<span class="pl-c">// drivers/of/base.c</span>

<span class="pl-k">const</span> <span class="pl-k">struct</span> <span class="pl-smi">of_device_id</span> <span class="pl-c1">*</span><span class="pl-en">of_match_node</span>(<span class="pl-k">const</span> <span class="pl-k">struct</span> <span class="pl-smi">of_device_id</span> <span class="pl-c1">*</span><span class="pl-s1">matches</span>,
					 <span class="pl-k">const</span> <span class="pl-k">struct</span> <span class="pl-smi">device_node</span> <span class="pl-c1">*</span><span class="pl-s1">node</span>)
{
	<span class="pl-k">const</span> <span class="pl-k">struct</span> <span class="pl-smi">of_device_id</span> <span class="pl-c1">*</span><span class="pl-s1">match</span>;
	<span class="pl-smi">unsigned long</span> <span class="pl-s1">flags</span>;

	<span class="pl-en">raw_spin_lock_irqsave</span>(<span class="pl-c1">&amp;</span><span class="pl-s1">devtree_lock</span>, <span class="pl-s1">flags</span>);
	<span class="pl-s1">match</span> <span class="pl-c1">=</span> <span class="pl-en">__of_match_node</span>(<span class="pl-s1">matches</span>, <span class="pl-s1">node</span>);
	<span class="pl-en">raw_spin_unlock_irqrestore</span>(<span class="pl-c1">&amp;</span><span class="pl-s1">devtree_lock</span>, <span class="pl-s1">flags</span>);
	<span class="pl-k">return</span> <span class="pl-s1">match</span>;
}

<span class="pl-c">// drivers/of/base.c</span>

<span class="pl-k">static</span>
<span class="pl-k">const</span> <span class="pl-k">struct</span> <span class="pl-smi">of_device_id</span> <span class="pl-c1">*</span><span class="pl-en">__of_match_node</span>(<span class="pl-k">const</span> <span class="pl-k">struct</span> <span class="pl-smi">of_device_id</span> <span class="pl-c1">*</span><span class="pl-s1">matches</span>,
					   <span class="pl-k">const</span> <span class="pl-k">struct</span> <span class="pl-smi">device_node</span> <span class="pl-c1">*</span><span class="pl-s1">node</span>)
{
	<span class="pl-k">const</span> <span class="pl-k">struct</span> <span class="pl-smi">of_device_id</span> <span class="pl-c1">*</span><span class="pl-s1">best_match</span> <span class="pl-c1">=</span> <span class="pl-c1">NULL</span>;
	<span class="pl-smi">int</span> <span class="pl-s1">score</span>, <span class="pl-s1">best_score</span> <span class="pl-c1">=</span> <span class="pl-c1">0</span>;

	<span class="pl-k">if</span> (!<span class="pl-s1">matches</span>)
		<span class="pl-k">return</span> <span class="pl-c1">NULL</span>;

	<span class="pl-k">for</span> (; <span class="pl-s1">matches</span><span class="pl-c1">-&gt;</span><span class="pl-c1">name</span>[<span class="pl-c1">0</span>] <span class="pl-c1">||</span> <span class="pl-s1">matches</span><span class="pl-c1">-&gt;</span><span class="pl-c1">type</span>[<span class="pl-c1">0</span>] <span class="pl-c1">||</span> <span class="pl-s1">matches</span><span class="pl-c1">-&gt;</span><span class="pl-c1">compatible</span>[<span class="pl-c1">0</span>]; <span class="pl-s1">matches</span><span class="pl-c1">++</span>) {
		<span class="pl-s1">score</span> <span class="pl-c1">=</span> <span class="pl-en">__of_device_is_compatible</span>(<span class="pl-s1">node</span>, <span class="pl-s1">matches</span><span class="pl-c1">-&gt;</span><span class="pl-c1">compatible</span>,
						  <span class="pl-s1">matches</span><span class="pl-c1">-&gt;</span><span class="pl-c1">type</span>, <span class="pl-s1">matches</span><span class="pl-c1">-&gt;</span><span class="pl-c1">name</span>);
		<span class="pl-k">if</span> (<span class="pl-s1">score</span> <span class="pl-c1">&gt;</span> <span class="pl-s1">best_score</span>) {
			<span class="pl-s1">best_match</span> <span class="pl-c1">=</span> <span class="pl-s1">matches</span>;
			<span class="pl-s1">best_score</span> <span class="pl-c1">=</span> <span class="pl-s1">score</span>;
		}
	}

	<span class="pl-k">return</span> <span class="pl-s1">best_match</span>;
}

<span class="pl-c">// drivers/of/base.c</span>

<span class="pl-k">static</span> <span class="pl-smi">int</span> <span class="pl-en">__of_device_is_compatible</span>(<span class="pl-k">const</span> <span class="pl-k">struct</span> <span class="pl-smi">device_node</span> <span class="pl-c1">*</span><span class="pl-s1">device</span>,
				     <span class="pl-k">const</span> <span class="pl-smi">char</span> <span class="pl-c1">*</span><span class="pl-s1">compat</span>, <span class="pl-k">const</span> <span class="pl-smi">char</span> <span class="pl-c1">*</span><span class="pl-s1">type</span>, <span class="pl-k">const</span> <span class="pl-smi">char</span> <span class="pl-c1">*</span><span class="pl-s1">name</span>)
{
	<span class="pl-k">const</span> <span class="pl-k">struct</span> <span class="pl-smi">property</span> <span class="pl-c1">*</span><span class="pl-s1">prop</span>;
	<span class="pl-k">const</span> <span class="pl-smi">char</span> <span class="pl-c1">*</span><span class="pl-s1">cp</span>;
	<span class="pl-smi">int</span> <span class="pl-s1">index</span> <span class="pl-c1">=</span> <span class="pl-c1">0</span>, <span class="pl-s1">score</span> <span class="pl-c1">=</span> <span class="pl-c1">0</span>;

	<span class="pl-c">/* Compatible match has highest priority */</span>
	<span class="pl-k">if</span> (<span class="pl-s1">compat</span> <span class="pl-c1">&amp;&amp;</span> <span class="pl-s1">compat</span>[<span class="pl-c1">0</span>]) {
		<span class="pl-s1">prop</span> <span class="pl-c1">=</span> <span class="pl-en">__of_find_property</span>(<span class="pl-s1">device</span>, <span class="pl-s">"compatible"</span>, <span class="pl-c1">NULL</span>);
		<span class="pl-k">for</span> (<span class="pl-s1">cp</span> <span class="pl-c1">=</span> <span class="pl-en">of_prop_next_string</span>(<span class="pl-s1">prop</span>, <span class="pl-c1">NULL</span>); <span class="pl-s1">cp</span>;
		     <span class="pl-s1">cp</span> <span class="pl-c1">=</span> <span class="pl-en">of_prop_next_string</span>(<span class="pl-s1">prop</span>, <span class="pl-s1">cp</span>), <span class="pl-s1">index</span><span class="pl-c1">++</span>) {
			<span class="pl-k">if</span> (<span class="pl-en">of_compat_cmp</span>(<span class="pl-s1">cp</span>, <span class="pl-s1">compat</span>, <span class="pl-en">strlen</span>(<span class="pl-s1">compat</span>)) <span class="pl-c1">==</span> <span class="pl-c1">0</span>) {
				<span class="pl-s1">score</span> <span class="pl-c1">=</span> <span class="pl-c1">INT_MAX</span>/<span class="pl-c1">2</span> <span class="pl-c1">-</span> (<span class="pl-s1">index</span> &lt;&lt; <span class="pl-c1">2</span>);
				<span class="pl-k">break</span>;
			}
		}
		<span class="pl-k">if</span> (!<span class="pl-s1">score</span>)
			<span class="pl-k">return</span> <span class="pl-c1">0</span>;
	}

	<span class="pl-c">/* Matching type is better than matching name */</span>
	<span class="pl-k">if</span> (<span class="pl-s1">type</span> <span class="pl-c1">&amp;&amp;</span> <span class="pl-s1">type</span>[<span class="pl-c1">0</span>]) {
		<span class="pl-k">if</span> (!<span class="pl-en">__of_node_is_type</span>(<span class="pl-s1">device</span>, <span class="pl-s1">type</span>))
			<span class="pl-k">return</span> <span class="pl-c1">0</span>;
		<span class="pl-s1">score</span> <span class="pl-c1">+=</span> <span class="pl-c1">2</span>;
	}

	<span class="pl-c">/* Matching name is a bit better than not */</span>
	<span class="pl-k">if</span> (<span class="pl-s1">name</span> <span class="pl-c1">&amp;&amp;</span> <span class="pl-s1">name</span>[<span class="pl-c1">0</span>]) {
		<span class="pl-k">if</span> (!<span class="pl-en">of_node_name_eq</span>(<span class="pl-s1">device</span>, <span class="pl-s1">name</span>))
			<span class="pl-k">return</span> <span class="pl-c1">0</span>;
		<span class="pl-s1">score</span><span class="pl-c1">++</span>;
	}

	<span class="pl-k">return</span> <span class="pl-s1">score</span>;
}</pre><div class="zeroclipboard-container">
<clipboard-copy aria-label="Copy" class="ClipboardButton btn btn-invisible js-clipboard-copy m-2 p-0 d-flex flex-justify-center flex-items-center" data-copy-feedback="Copied!" data-tooltip-direction="w" role="button" tabindex="0" value='// include/linux/of_device.h

static inline int of_driver_match_device(struct device *dev,
					 const struct device_driver *drv)
{
	return of_match_device(drv-&gt;of_match_table, dev) != NULL;
}

// drivers/of/device.c

const struct of_device_id *of_match_device(const struct of_device_id *matches,
					   const struct device *dev)
{
	if (!matches || !dev-&gt;of_node || dev-&gt;of_node_reused)
		return NULL;
	return of_match_node(matches, dev-&gt;of_node);
}

// drivers/of/base.c

const struct of_device_id *of_match_node(const struct of_device_id *matches,
					 const struct device_node *node)
{
	const struct of_device_id *match;
	unsigned long flags;

	raw_spin_lock_irqsave(&amp;devtree_lock, flags);
	match = __of_match_node(matches, node);
	raw_spin_unlock_irqrestore(&amp;devtree_lock, flags);
	return match;
}

// drivers/of/base.c

static
const struct of_device_id *__of_match_node(const struct of_device_id *matches,
					   const struct device_node *node)
{
	const struct of_device_id *best_match = NULL;
	int score, best_score = 0;

	if (!matches)
		return NULL;

	for (; matches-&gt;name[0] || matches-&gt;type[0] || matches-&gt;compatible[0]; matches++) {
		score = __of_device_is_compatible(node, matches-&gt;compatible,
						  matches-&gt;type, matches-&gt;name);
		if (score &gt; best_score) {
			best_match = matches;
			best_score = score;
		}
	}

	return best_match;
}

// drivers/of/base.c

static int __of_device_is_compatible(const struct device_node *device,
				     const char *compat, const char *type, const char *name)
{
	const struct property *prop;
	const char *cp;
	int index = 0, score = 0;

	/* Compatible match has highest priority */
	if (compat &amp;&amp; compat[0]) {
		prop = __of_find_property(device, "compatible", NULL);
		for (cp = of_prop_next_string(prop, NULL); cp;
		     cp = of_prop_next_string(prop, cp), index++) {
			if (of_compat_cmp(cp, compat, strlen(compat)) == 0) {
				score = INT_MAX/2 - (index &lt;&lt; 2);
				break;
			}
		}
		if (!score)
			return 0;
	}

	/* Matching type is better than matching name */
	if (type &amp;&amp; type[0]) {
		if (!__of_node_is_type(device, type))
			return 0;
		score += 2;
	}

	/* Matching name is a bit better than not */
	if (name &amp;&amp; name[0]) {
		if (!of_node_name_eq(device, name))
			return 0;
		score++;
	}

	return score;
}'>
<svg aria-hidden="true" class="octicon octicon-copy js-clipboard-copy-icon" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path>
</svg>
<svg aria-hidden="true" class="octicon octicon-check js-clipboard-check-icon color-fg-success d-none" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"></path>
</svg>
</clipboard-copy>
</div></div>
<div class="markdown-heading" dir="auto"><h4 class="heading-element" dir="auto" tabindex="-1">id_table</h4><a aria-label="Permalink: id_table" class="anchor" href="#id_table" id="user-content-id_table"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">比较 platform_device.name 和 platform_driver.id_table[i].name。</p>
<p dir="auto"><code>platform_driver.id_table</code> 的类型为 <code>struct platform_device_id *</code>，表示该 driver 支持若干个 device。<code>id_table</code> 中列出了各个 device 的 <code>name</code> <code>driver_data</code>，其中的 name 表示该 drv 支持的设备的名字，driver_data 是些提供给该 device 的私有数据。</p>
<div class="highlight highlight-source-c notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-c">// include/linux/mod_devicetable.h</span>

<span class="pl-k">struct</span> <span class="pl-smi">platform_device_id</span> {
	<span class="pl-smi">char</span> <span class="pl-c1">name</span>[<span class="pl-c1">PLATFORM_NAME_SIZE</span>];
	<span class="pl-smi">kernel_ulong_t</span> <span class="pl-c1">driver_data</span>;
};</pre><div class="zeroclipboard-container">
<clipboard-copy aria-label="Copy" class="ClipboardButton btn btn-invisible js-clipboard-copy m-2 p-0 d-flex flex-justify-center flex-items-center" data-copy-feedback="Copied!" data-tooltip-direction="w" role="button" tabindex="0" value="// include/linux/mod_devicetable.h

struct platform_device_id {
	char name[PLATFORM_NAME_SIZE];
	kernel_ulong_t driver_data;
};">
<svg aria-hidden="true" class="octicon octicon-copy js-clipboard-copy-icon" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path>
</svg>
<svg aria-hidden="true" class="octicon octicon-check js-clipboard-check-icon color-fg-success d-none" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"></path>
</svg>
</clipboard-copy>
</div></div>
<div class="highlight highlight-source-c notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-c">// drivers/base/platform.c</span>

<span class="pl-k">static</span> <span class="pl-k">const</span> <span class="pl-k">struct</span> <span class="pl-smi">platform_device_id</span> <span class="pl-c1">*</span><span class="pl-en">platform_match_id</span>(
			<span class="pl-k">const</span> <span class="pl-k">struct</span> <span class="pl-smi">platform_device_id</span> <span class="pl-c1">*</span><span class="pl-s1">id</span>,
			<span class="pl-k">struct</span> <span class="pl-smi">platform_device</span> <span class="pl-c1">*</span><span class="pl-s1">pdev</span>)
{
	<span class="pl-k">while</span> (<span class="pl-s1">id</span><span class="pl-c1">-&gt;</span><span class="pl-c1">name</span>[<span class="pl-c1">0</span>]) {
		<span class="pl-k">if</span> (<span class="pl-en">strcmp</span>(<span class="pl-s1">pdev</span><span class="pl-c1">-&gt;</span><span class="pl-c1">name</span>, <span class="pl-s1">id</span><span class="pl-c1">-&gt;</span><span class="pl-c1">name</span>) <span class="pl-c1">==</span> <span class="pl-c1">0</span>) {
			<span class="pl-s1">pdev</span><span class="pl-c1">-&gt;</span><span class="pl-c1">id_entry</span> <span class="pl-c1">=</span> <span class="pl-s1">id</span>;
			<span class="pl-k">return</span> <span class="pl-s1">id</span>;
		}
		<span class="pl-s1">id</span><span class="pl-c1">++</span>;
	}
	<span class="pl-k">return</span> <span class="pl-c1">NULL</span>;
}</pre><div class="zeroclipboard-container">
<clipboard-copy aria-label="Copy" class="ClipboardButton btn btn-invisible js-clipboard-copy m-2 p-0 d-flex flex-justify-center flex-items-center" data-copy-feedback="Copied!" data-tooltip-direction="w" role="button" tabindex="0" value="// drivers/base/platform.c

static const struct platform_device_id *platform_match_id(
			const struct platform_device_id *id,
			struct platform_device *pdev)
{
	while (id-&gt;name[0]) {
		if (strcmp(pdev-&gt;name, id-&gt;name) == 0) {
			pdev-&gt;id_entry = id;
			return id;
		}
		id++;
	}
	return NULL;
}">
<svg aria-hidden="true" class="octicon octicon-copy js-clipboard-copy-icon" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path>
</svg>
<svg aria-hidden="true" class="octicon octicon-check js-clipboard-check-icon color-fg-success d-none" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"></path>
</svg>
</clipboard-copy>
</div></div>
<div class="markdown-heading" dir="auto"><h4 class="heading-element" dir="auto" tabindex="-1">name</h4><a aria-label="Permalink: name" class="anchor" href="#name" id="user-content-name"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">比较 platform_device.name 和 platform_driver.driver.name。</p>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto" tabindex="-1">中断处理</h2><a aria-label="Permalink: 中断处理" class="anchor" href="#中断处理" id="user-content-中断处理"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto" tabindex="-1">中断处理的几个原则</h3><a aria-label="Permalink: 中断处理的几个原则" class="anchor" href="#中断处理的几个原则" id="user-content-中断处理的几个原则"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">我们可以自己设想一下，对 Linux 这种大型操作系统，如果我们来设计中断处理，应该怎么设计。</p>
<p dir="auto">第一、中断不能嵌套。如果中断可以嵌套，那么中断 B 可以中断中断 A 的处理函数，中断 C 可以中断中断 B 的处理函数。这样到最后，栈会溢出。</p>
<p dir="auto">为了防止这种情况发生，Linux 系统上中断无法嵌套：即当前中断 A 没处理完之前，不会响应另一个中断 B，即使它的优先级更高。</p>
<p dir="auto">第二、中断处理越快越好。</p>
<ul dir="auto">
<li>我们已经说过中断不能嵌套，而线程调度依靠定时器中断。所以在中断处理时，不能进行线程调度，那么：
<ul dir="auto">
<li>在单芯片系统中，如果中断处理很慢，那应用程序在这段时间内就无法执行：系统显得很迟顿</li>
<li>在 SMP 系统中，如果中断处理很慢，那么正在处理这个中断的 CPU 上的其他线程也无法执行</li>
</ul>
</li>
<li>另外，如果中断处理很慢，中断处理的过程中也响应不了其他中断</li>
</ul>
<p dir="auto">所以 Linux 系统上中断处理越快越好。</p>
<p dir="auto">第三、拆分。我们已经说过，中断处理越快越好，但是有时候中断处理就是需要很久，比如对于按键中断，我们需要等待几十毫秒消除机械抖动。这段时间内系统完全不能执行任何其他线程，也响应不了其他中断。</p>
<p dir="auto">如果某个中断就是要做那么多事，我们可以把它拆分成两部分：紧急的、不紧急的。在 handler 函数里只做紧急的事，然后就重新开中断，让系统得以正常运行；那些不紧急的事，以后再处理，处理时是开中断的。这就是中断上半部和中断下半部。</p>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto" tabindex="-1">驱动如何注册上半部处理函数</h3><a aria-label="Permalink: 驱动如何注册上半部处理函数" class="anchor" href="#驱动如何注册上半部处理函数" id="user-content-驱动如何注册上半部处理函数"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<div class="highlight highlight-source-c notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-c">// include/linux/interrupt.h</span>

<span class="pl-k">extern</span> <span class="pl-smi">int</span> <span class="pl-s1">__must_check</span>
<span class="pl-en">request_threaded_irq</span>(<span class="pl-smi">unsigned <span class="pl-smi">int</span></span> <span class="pl-s1">irq</span>, <span class="pl-smi">irq_handler_t</span> <span class="pl-s1">handler</span>,
		     <span class="pl-smi">irq_handler_t</span> <span class="pl-s1">thread_fn</span>,
		     <span class="pl-smi">unsigned long</span> <span class="pl-s1">flags</span>, <span class="pl-k">const</span> <span class="pl-smi">char</span> <span class="pl-c1">*</span><span class="pl-s1">name</span>, <span class="pl-smi">void</span> <span class="pl-c1">*</span><span class="pl-s1">dev</span>);

<span class="pl-c">/**</span>
<span class="pl-c"> * request_irq - Add a handler for an interrupt line</span>
<span class="pl-c"> * @irq:	The interrupt line to allocate</span>
<span class="pl-c"> * @handler:	Function to be called when the IRQ occurs.</span>
<span class="pl-c"> *		Primary handler for threaded interrupts</span>
<span class="pl-c"> *		If NULL, the default primary handler is installed</span>
<span class="pl-c"> * @flags:	Handling flags</span>
<span class="pl-c"> * @name:	Name of the device generating this interrupt</span>
<span class="pl-c"> * @dev:	A cookie passed to the handler function</span>
<span class="pl-c"> *</span>
<span class="pl-c"> * This call allocates an interrupt and establishes a handler; see</span>
<span class="pl-c"> * the documentation for request_threaded_irq() for details.</span>
<span class="pl-c"> */</span>
<span class="pl-k">static</span> <span class="pl-k">inline</span> <span class="pl-smi">int</span> <span class="pl-s1">__must_check</span>
<span class="pl-en">request_irq</span>(<span class="pl-smi">unsigned <span class="pl-smi">int</span></span> <span class="pl-s1">irq</span>, <span class="pl-smi">irq_handler_t</span> <span class="pl-s1">handler</span>, <span class="pl-smi">unsigned long</span> <span class="pl-s1">flags</span>,
	    <span class="pl-k">const</span> <span class="pl-smi">char</span> <span class="pl-c1">*</span><span class="pl-s1">name</span>, <span class="pl-smi">void</span> <span class="pl-c1">*</span><span class="pl-s1">dev</span>)
{
	<span class="pl-k">return</span> <span class="pl-en">request_threaded_irq</span>(<span class="pl-s1">irq</span>, <span class="pl-s1">handler</span>, <span class="pl-c1">NULL</span>, <span class="pl-s1">flags</span> | <span class="pl-c1">IRQF_COND_ONESHOT</span>, <span class="pl-s1">name</span>, <span class="pl-s1">dev</span>);
}</pre><div class="zeroclipboard-container">
<clipboard-copy aria-label="Copy" class="ClipboardButton btn btn-invisible js-clipboard-copy m-2 p-0 d-flex flex-justify-center flex-items-center" data-copy-feedback="Copied!" data-tooltip-direction="w" role="button" tabindex="0" value="// include/linux/interrupt.h

extern int __must_check
request_threaded_irq(unsigned int irq, irq_handler_t handler,
		     irq_handler_t thread_fn,
		     unsigned long flags, const char *name, void *dev);

/**
 * request_irq - Add a handler for an interrupt line
 * @irq:	The interrupt line to allocate
 * @handler:	Function to be called when the IRQ occurs.
 *		Primary handler for threaded interrupts
 *		If NULL, the default primary handler is installed
 * @flags:	Handling flags
 * @name:	Name of the device generating this interrupt
 * @dev:	A cookie passed to the handler function
 *
 * This call allocates an interrupt and establishes a handler; see
 * the documentation for request_threaded_irq() for details.
 */
static inline int __must_check
request_irq(unsigned int irq, irq_handler_t handler, unsigned long flags,
	    const char *name, void *dev)
{
	return request_threaded_irq(irq, handler, NULL, flags | IRQF_COND_ONESHOT, name, dev);
}">
<svg aria-hidden="true" class="octicon octicon-copy js-clipboard-copy-icon" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path>
</svg>
<svg aria-hidden="true" class="octicon octicon-check js-clipboard-check-icon color-fg-success d-none" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"></path>
</svg>
</clipboard-copy>
</div></div>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto" tabindex="-1">中断相关 CONFIG</h3><a aria-label="Permalink: 中断相关 CONFIG" class="anchor" href="#中断相关-config" id="user-content-中断相关-config"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto"><pre class="notranslate" lang="kconfig"><code>### arch/Kconfig

config HAVE_IRQ_EXIT_ON_IRQ_STACK
	bool
	help
	  Architecture doesn't only execute the irq handler on the irq stack
	  but also irq_exit(). This way we can process softirqs on this irq
	  stack instead of switching to a new one when we call __do_softirq()
	  in the end of an hardirq.
	  This spares a stack switch and improves cache usage on softirq
	  processing.

config HAVE_SOFTIRQ_ON_OWN_STACK
	bool
	help
	  Architecture provides a function to run __do_softirq() on a
	  separate stack.

config SOFTIRQ_ON_OWN_STACK
	def_bool HAVE_SOFTIRQ_ON_OWN_STACK &amp;&amp; !PREEMPT_RT

### kernel/irq

# Generic irq_domain hw &lt;--&gt; linux irq number translation
config IRQ_DOMAIN
	bool

# Support forced irq threading
config IRQ_FORCED_THREADING
       bool

config SPARSE_IRQ
	bool "Support sparse irq numbering" if MAY_HAVE_SPARSE_IRQ
	help

	  Sparse irq numbering is useful for distro kernels that want
	  to define a high CONFIG_NR_CPUS value but still want to have
	  low kernel memory footprint on smaller machines.

	  ( Sparse irqs can also be beneficial on NUMA boxes, as they spread
	    out the interrupt descriptors in a more NUMA-friendly way. )

	  If you don't know what to do here, say N.

# 开启以后，可以自由把 handle_arch_irq 设置成架构相关处理函数
config GENERIC_IRQ_MULTI_HANDLER
	bool
	help
	  Allow to specify the low level IRQ handler at run time.
</code></pre><div class="zeroclipboard-container">
<clipboard-copy aria-label="Copy" class="ClipboardButton btn btn-invisible js-clipboard-copy m-2 p-0 d-flex flex-justify-center flex-items-center" data-copy-feedback="Copied!" data-tooltip-direction="w" role="button" tabindex="0" value="### arch/Kconfig

config HAVE_IRQ_EXIT_ON_IRQ_STACK
	bool
	help
	  Architecture doesn't only execute the irq handler on the irq stack
	  but also irq_exit(). This way we can process softirqs on this irq
	  stack instead of switching to a new one when we call __do_softirq()
	  in the end of an hardirq.
	  This spares a stack switch and improves cache usage on softirq
	  processing.

config HAVE_SOFTIRQ_ON_OWN_STACK
	bool
	help
	  Architecture provides a function to run __do_softirq() on a
	  separate stack.

config SOFTIRQ_ON_OWN_STACK
	def_bool HAVE_SOFTIRQ_ON_OWN_STACK &amp;&amp; !PREEMPT_RT

### kernel/irq

# Generic irq_domain hw &lt;--&gt; linux irq number translation
config IRQ_DOMAIN
	bool

# Support forced irq threading
config IRQ_FORCED_THREADING
       bool

config SPARSE_IRQ
	bool &quot;Support sparse irq numbering&quot; if MAY_HAVE_SPARSE_IRQ
	help

	  Sparse irq numbering is useful for distro kernels that want
	  to define a high CONFIG_NR_CPUS value but still want to have
	  low kernel memory footprint on smaller machines.

	  ( Sparse irqs can also be beneficial on NUMA boxes, as they spread
	    out the interrupt descriptors in a more NUMA-friendly way. )

	  If you don't know what to do here, say N.

# 开启以后，可以自由把 handle_arch_irq 设置成架构相关处理函数
config GENERIC_IRQ_MULTI_HANDLER
	bool
	help
	  Allow to specify the low level IRQ handler at run time.">
<svg aria-hidden="true" class="octicon octicon-copy js-clipboard-copy-icon" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path>
</svg>
<svg aria-hidden="true" class="octicon octicon-check js-clipboard-check-icon color-fg-success d-none" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"></path>
</svg>
</clipboard-copy>
</div></div>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto" tabindex="-1">下半部实现方式：软中断 softirq</h2><a aria-label="Permalink: 下半部实现方式：软中断 softirq" class="anchor" href="#下半部实现方式软中断-softirq" id="user-content-下半部实现方式软中断-softirq"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto" tabindex="-1">谁触发、谁执行</h3><a aria-label="Permalink: 谁触发、谁执行" class="anchor" href="#谁触发谁执行" id="user-content-谁触发谁执行"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Linux 的 softirq 机制是与 SMP 密不可分的。为此，整个 softirq 机制的设计与实现中自始自终都贯彻了一个思想：“谁触发，谁执行”（Who marks，Who runs），也即触发软中断的那个 CPU 负责执行它所触发的软中断，而且每个 CPU 都有它自己的软中断触发与控制机制。这个设计思想也使得 softirq 机制充分利用了 SMP 系统的性能和特点。</p>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto" tabindex="-1">软中断种类</h3><a aria-label="Permalink: 软中断种类" class="anchor" href="#软中断种类" id="user-content-软中断种类"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<div class="highlight highlight-source-c notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-c">// include/linux/interrupt.h</span>

<span class="pl-c">/* PLEASE, avoid to allocate new softirqs, if you need not _really_ high</span>
<span class="pl-c">   frequency threaded job scheduling. For almost all the purposes</span>
<span class="pl-c">   tasklets are more than enough. F.e. all serial device BHs et</span>
<span class="pl-c">   al. should be converted to tasklets, not to softirqs.</span>
<span class="pl-c"> */</span>

<span class="pl-k">enum</span>
{
	<span class="pl-c1">HI_SOFTIRQ</span><span class="pl-c1">=</span><span class="pl-c1">0</span>,
	<span class="pl-c1">TIMER_SOFTIRQ</span>,
	<span class="pl-c1">NET_TX_SOFTIRQ</span>,
	<span class="pl-c1">NET_RX_SOFTIRQ</span>,
	<span class="pl-c1">BLOCK_SOFTIRQ</span>,
	<span class="pl-c1">IRQ_POLL_SOFTIRQ</span>,
	<span class="pl-c1">TASKLET_SOFTIRQ</span>,
	<span class="pl-c1">SCHED_SOFTIRQ</span>,
	<span class="pl-c1">HRTIMER_SOFTIRQ</span>,
	<span class="pl-c1">RCU_SOFTIRQ</span>,    <span class="pl-c">/* Preferable RCU should always be the last softirq */</span>

	<span class="pl-c1">NR_SOFTIRQS</span>
};</pre><div class="zeroclipboard-container">
<clipboard-copy aria-label="Copy" class="ClipboardButton btn btn-invisible js-clipboard-copy m-2 p-0 d-flex flex-justify-center flex-items-center" data-copy-feedback="Copied!" data-tooltip-direction="w" role="button" tabindex="0" value="// include/linux/interrupt.h

/* PLEASE, avoid to allocate new softirqs, if you need not _really_ high
   frequency threaded job scheduling. For almost all the purposes
   tasklets are more than enough. F.e. all serial device BHs et
   al. should be converted to tasklets, not to softirqs.
 */

enum
{
	HI_SOFTIRQ=0,
	TIMER_SOFTIRQ,
	NET_TX_SOFTIRQ,
	NET_RX_SOFTIRQ,
	BLOCK_SOFTIRQ,
	IRQ_POLL_SOFTIRQ,
	TASKLET_SOFTIRQ,
	SCHED_SOFTIRQ,
	HRTIMER_SOFTIRQ,
	RCU_SOFTIRQ,    /* Preferable RCU should always be the last softirq */

	NR_SOFTIRQS
};">
<svg aria-hidden="true" class="octicon octicon-copy js-clipboard-copy-icon" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path>
</svg>
<svg aria-hidden="true" class="octicon octicon-check js-clipboard-check-icon color-fg-success d-none" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"></path>
</svg>
</clipboard-copy>
</div></div>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto" tabindex="-1">记录软中断对应的处理函数</h3><a aria-label="Permalink: 记录软中断对应的处理函数" class="anchor" href="#记录软中断对应的处理函数" id="user-content-记录软中断对应的处理函数"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">系统一共定义了 10 个软中断请求描述符。软中断向量 i（0 ≤ i ≤ 9）所对应的软中断请求描述符就是 <code>softirq_vec[i]</code>。</p>
<p dir="auto">这个数组是个系统全局数组，即它被所有的 CPU 所共享。这里需要注意的一点是：每个 CPU 虽然都有它自己的触发和控制机制，并且只执行他自己所触发的软中断请求，但是各个 CPU 所执行的软中断服务例程却是相同的，也即都是执行 <code>softirq_vec</code> 数组中定义的软中断服务函数。</p>
<div class="highlight highlight-source-c notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-c">// include/linux/interrupt.h</span>

<span class="pl-k">struct</span> <span class="pl-smi">softirq_action</span>
{
	<span class="pl-smi">void</span>	(<span class="pl-c1">*</span><span class="pl-c1">action</span>)(<span class="pl-smi">void</span>);
};

<span class="pl-c">// kernel/softirq.c</span>

<span class="pl-k">static</span> <span class="pl-k">struct</span> <span class="pl-smi">softirq_action</span> <span class="pl-s1">softirq_vec</span>[<span class="pl-c1">NR_SOFTIRQS</span>] <span class="pl-smi">__cacheline_aligned_in_smp</span>;</pre><div class="zeroclipboard-container">
<clipboard-copy aria-label="Copy" class="ClipboardButton btn btn-invisible js-clipboard-copy m-2 p-0 d-flex flex-justify-center flex-items-center" data-copy-feedback="Copied!" data-tooltip-direction="w" role="button" tabindex="0" value="// include/linux/interrupt.h

struct softirq_action
{
	void	(*action)(void);
};

// kernel/softirq.c

static struct softirq_action softirq_vec[NR_SOFTIRQS] __cacheline_aligned_in_smp;">
<svg aria-hidden="true" class="octicon octicon-copy js-clipboard-copy-icon" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path>
</svg>
<svg aria-hidden="true" class="octicon octicon-check js-clipboard-check-icon color-fg-success d-none" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"></path>
</svg>
</clipboard-copy>
</div></div>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto" tabindex="-1">记录哪些软中断被触发</h3><a aria-label="Permalink: 记录哪些软中断被触发" class="anchor" href="#记录哪些软中断被触发" id="user-content-记录哪些软中断被触发"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">要实现「谁触发，谁执行」的思想，就必须为每个 CPU 都定义它自己的触发和控制变量。</p>
<p dir="auto"><code>irq_stat</code> 的类型是 <code>struct irq_cpustat_t</code>，<code>__softirq_pending</code> 记录哪些软中断被触发。</p>
<div class="highlight highlight-source-c notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-c">// include/asm-generic/hardirq.h</span>

<span class="pl-k">typedef</span> <span class="pl-k">struct</span> {
	<span class="pl-smi">unsigned <span class="pl-smi">int</span></span> <span class="pl-c1">__softirq_pending</span>;
<span class="pl-k">#ifdef</span> <span class="pl-c1">ARCH_WANTS_NMI_IRQSTAT</span>
	<span class="pl-smi">unsigned <span class="pl-smi">int</span></span> <span class="pl-c1">__nmi_count</span>;
<span class="pl-k">#endif</span>
} <span class="pl-smi">____cacheline_aligned</span> <span class="pl-s1">irq_cpustat_t</span>;

<span class="pl-en">DECLARE_PER_CPU_ALIGNED</span>(<span class="pl-s1">irq_cpustat_t</span>, <span class="pl-s1">irq_stat</span>);

<span class="pl-c">// kernel/softirq.c</span>

<span class="pl-k">#ifndef</span> <span class="pl-s1">__ARCH_IRQ_STAT</span>
<span class="pl-en">DEFINE_PER_CPU_ALIGNED</span>(<span class="pl-s1">irq_cpustat_t</span>, <span class="pl-s1">irq_stat</span>);
<span class="pl-en">EXPORT_PER_CPU_SYMBOL</span>(<span class="pl-s1">irq_stat</span>);
<span class="pl-k">#endif</span></pre><div class="zeroclipboard-container">
<clipboard-copy aria-label="Copy" class="ClipboardButton btn btn-invisible js-clipboard-copy m-2 p-0 d-flex flex-justify-center flex-items-center" data-copy-feedback="Copied!" data-tooltip-direction="w" role="button" tabindex="0" value="// include/asm-generic/hardirq.h

typedef struct {
	unsigned int __softirq_pending;
#ifdef ARCH_WANTS_NMI_IRQSTAT
	unsigned int __nmi_count;
#endif
} ____cacheline_aligned irq_cpustat_t;

DECLARE_PER_CPU_ALIGNED(irq_cpustat_t, irq_stat);

// kernel/softirq.c

#ifndef __ARCH_IRQ_STAT
DEFINE_PER_CPU_ALIGNED(irq_cpustat_t, irq_stat);
EXPORT_PER_CPU_SYMBOL(irq_stat);
#endif">
<svg aria-hidden="true" class="octicon octicon-copy js-clipboard-copy-icon" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path>
</svg>
<svg aria-hidden="true" class="octicon octicon-check js-clipboard-check-icon color-fg-success d-none" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"></path>
</svg>
</clipboard-copy>
</div></div>
<p dir="auto"><code>local_softirq_pending</code> 返回 <code>irq_stat.__softirq_pending</code>，<code>set_softirq_pending</code> 和 <code>or_softirq_pending</code> 对 <code>irq_stat.__softirq_pending</code> 进行更改。</p>
<div class="highlight highlight-source-c notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-c">// include/linux/interrupt.h</span>

<span class="pl-k">#ifndef</span> <span class="pl-s1">local_softirq_pending</span> <span class="pl-c">// RISC-V 没有定义</span>

<span class="pl-k">#ifndef</span> <span class="pl-s1">local_softirq_pending_ref</span>
<span class="pl-k">#define</span> <span class="pl-s1">local_softirq_pending_ref</span> irq_stat.__softirq_pending
<span class="pl-k">#endif</span>

<span class="pl-k">#define</span> <span class="pl-en">local_softirq_pending</span>()	(__this_cpu_read(local_softirq_pending_ref))
<span class="pl-k">#define</span> <span class="pl-en">set_softirq_pending</span>(<span class="pl-s1">x</span>)	(__this_cpu_write(local_softirq_pending_ref, (x)))
<span class="pl-k">#define</span> <span class="pl-en">or_softirq_pending</span>(<span class="pl-s1">x</span>)	(__this_cpu_or(local_softirq_pending_ref, (x)))

<span class="pl-k">#endif</span> <span class="pl-c">/* local_softirq_pending */</span></pre><div class="zeroclipboard-container">
<clipboard-copy aria-label="Copy" class="ClipboardButton btn btn-invisible js-clipboard-copy m-2 p-0 d-flex flex-justify-center flex-items-center" data-copy-feedback="Copied!" data-tooltip-direction="w" role="button" tabindex="0" value="// include/linux/interrupt.h

#ifndef local_softirq_pending // RISC-V 没有定义

#ifndef local_softirq_pending_ref
#define local_softirq_pending_ref irq_stat.__softirq_pending
#endif

#define local_softirq_pending()	(__this_cpu_read(local_softirq_pending_ref))
#define set_softirq_pending(x)	(__this_cpu_write(local_softirq_pending_ref, (x)))
#define or_softirq_pending(x)	(__this_cpu_or(local_softirq_pending_ref, (x)))

#endif /* local_softirq_pending */">
<svg aria-hidden="true" class="octicon octicon-copy js-clipboard-copy-icon" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path>
</svg>
<svg aria-hidden="true" class="octicon octicon-check js-clipboard-check-icon color-fg-success d-none" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"></path>
</svg>
</clipboard-copy>
</div></div>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto" tabindex="-1">如何设置软中断的处理函数和触发软中断</h3><a aria-label="Permalink: 如何设置软中断的处理函数和触发软中断" class="anchor" href="#如何设置软中断的处理函数和触发软中断" id="user-content-如何设置软中断的处理函数和触发软中断"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">一般来说，驱动的编写者不会也不宜直接使用 softirq。基本上都是使用基于 softirq 的 tasklet。</p>
<div class="highlight highlight-source-c notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-c">// include/linux/interrupt.h</span>

<span class="pl-c">// 设置某个软中断对应的服务函数</span>
<span class="pl-k">extern</span> <span class="pl-smi">void</span> <span class="pl-en">open_softirq</span>(<span class="pl-smi">int</span> <span class="pl-s1">nr</span>, <span class="pl-smi">void</span> (<span class="pl-c1">*</span><span class="pl-s1">action</span>)(<span class="pl-smi">void</span>));
<span class="pl-c">// 触发软中断</span>
<span class="pl-k">extern</span> <span class="pl-smi">void</span> <span class="pl-en">raise_softirq</span>(<span class="pl-smi">unsigned <span class="pl-smi">int</span></span> <span class="pl-s1">nr</span>);

<span class="pl-c">// kernel/softirq.c</span>

<span class="pl-smi">void</span> <span class="pl-en">open_softirq</span>(<span class="pl-smi">int</span> <span class="pl-s1">nr</span>, <span class="pl-smi">void</span> (<span class="pl-c1">*</span><span class="pl-s1">action</span>)(<span class="pl-smi">void</span>))
{
	<span class="pl-s1">softirq_vec</span>[<span class="pl-s1">nr</span>].<span class="pl-c1">action</span> <span class="pl-c1">=</span> <span class="pl-s1">action</span>;
}

<span class="pl-smi">void</span> <span class="pl-en">raise_softirq</span>(<span class="pl-smi">unsigned <span class="pl-smi">int</span></span> <span class="pl-s1">nr</span>)
{
	<span class="pl-smi">unsigned long</span> <span class="pl-s1">flags</span>;

	<span class="pl-en">local_irq_save</span>(<span class="pl-s1">flags</span>);
	<span class="pl-en">raise_softirq_irqoff</span>(<span class="pl-s1">nr</span>);
	<span class="pl-en">local_irq_restore</span>(<span class="pl-s1">flags</span>);
}

<span class="pl-smi">void</span> <span class="pl-en">__raise_softirq_irqoff</span>(<span class="pl-smi">unsigned <span class="pl-smi">int</span></span> <span class="pl-s1">nr</span>)
{
	<span class="pl-en">lockdep_assert_irqs_disabled</span>();
	<span class="pl-en">trace_softirq_raise</span>(<span class="pl-s1">nr</span>);
	<span class="pl-en">or_softirq_pending</span>(<span class="pl-c1">1UL</span> &lt;&lt; <span class="pl-s1">nr</span>); <span class="pl-c">// 对 irq_stat.__softirq_pending 进行更改</span>
}</pre><div class="zeroclipboard-container">
<clipboard-copy aria-label="Copy" class="ClipboardButton btn btn-invisible js-clipboard-copy m-2 p-0 d-flex flex-justify-center flex-items-center" data-copy-feedback="Copied!" data-tooltip-direction="w" role="button" tabindex="0" value="// include/linux/interrupt.h

// 设置某个软中断对应的服务函数
extern void open_softirq(int nr, void (*action)(void));
// 触发软中断
extern void raise_softirq(unsigned int nr);

// kernel/softirq.c

void open_softirq(int nr, void (*action)(void))
{
	softirq_vec[nr].action = action;
}

void raise_softirq(unsigned int nr)
{
	unsigned long flags;

	local_irq_save(flags);
	raise_softirq_irqoff(nr);
	local_irq_restore(flags);
}

void __raise_softirq_irqoff(unsigned int nr)
{
	lockdep_assert_irqs_disabled();
	trace_softirq_raise(nr);
	or_softirq_pending(1UL &lt;&lt; nr); // 对 irq_stat.__softirq_pending 进行更改
}">
<svg aria-hidden="true" class="octicon octicon-copy js-clipboard-copy-icon" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path>
</svg>
<svg aria-hidden="true" class="octicon octicon-check js-clipboard-check-icon color-fg-success d-none" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"></path>
</svg>
</clipboard-copy>
</div></div>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto" tabindex="-1">软中断初始化函数 softirq_init()</h3><a aria-label="Permalink: 软中断初始化函数 softirq_init()" class="anchor" href="#软中断初始化函数-softirq_init" id="user-content-软中断初始化函数-softirq_init"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><code>softirq_init</code> 在 <code>start_kernel</code> 中被调用，主要设置 <code>TASKLET_SOFTIRQ</code> <code>HI_SOFTIRQ</code> 这两类软中断的处理函数。</p>
<div class="highlight highlight-source-c notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-c">// kernel/softirq.c</span>

<span class="pl-c">/*</span>
<span class="pl-c"> * Tasklets</span>
<span class="pl-c"> */</span>
<span class="pl-k">struct</span> <span class="pl-smi">tasklet_head</span> {
	<span class="pl-k">struct</span> <span class="pl-smi">tasklet_struct</span> <span class="pl-c1">*</span><span class="pl-c1">head</span>;
	<span class="pl-k">struct</span> <span class="pl-smi">tasklet_struct</span> <span class="pl-c1">*</span><span class="pl-c1">*</span><span class="pl-c1">tail</span>;
};

<span class="pl-k">static</span> <span class="pl-c1">DEFINE_PER_CPU</span>(<span class="pl-k">struct</span> <span class="pl-smi">tasklet_head</span>, <span class="pl-s1">tasklet_vec</span>)<span class="pl-s1"></span>;
<span class="pl-k">static</span> <span class="pl-c1">DEFINE_PER_CPU</span>(<span class="pl-k">struct</span> <span class="pl-smi">tasklet_head</span>, <span class="pl-s1">tasklet_hi_vec</span>)<span class="pl-s1"></span>;

<span class="pl-c">// kernel/softirq.c</span>

<span class="pl-smi">void</span> <span class="pl-s1">__init</span> <span class="pl-en">softirq_init</span>(<span class="pl-smi">void</span>)
{
	<span class="pl-smi">int</span> <span class="pl-s1">cpu</span>;

	<span class="pl-smi">for_each_possible_cpu</span>(<span class="pl-s1">cpu</span>) {
		<span class="pl-en">per_cpu</span>(<span class="pl-s1">tasklet_vec</span>, <span class="pl-s1">cpu</span>).<span class="pl-c1">tail</span> <span class="pl-c1">=</span>
			<span class="pl-c1">&amp;</span><span class="pl-en">per_cpu</span>(<span class="pl-s1">tasklet_vec</span>, <span class="pl-s1">cpu</span>).<span class="pl-c1">head</span>;
		<span class="pl-en">per_cpu</span>(<span class="pl-s1">tasklet_hi_vec</span>, <span class="pl-s1">cpu</span>).<span class="pl-c1">tail</span> <span class="pl-c1">=</span>
			<span class="pl-c1">&amp;</span><span class="pl-en">per_cpu</span>(<span class="pl-s1">tasklet_hi_vec</span>, <span class="pl-s1">cpu</span>).<span class="pl-c1">head</span>;
	}

	<span class="pl-c">// 设置 TASKLET_SOFTIRQ 和 HI_SOFTIRQ 对应的处理函数</span>
	<span class="pl-en">open_softirq</span>(<span class="pl-c1">TASKLET_SOFTIRQ</span>, <span class="pl-s1">tasklet_action</span>);
	<span class="pl-en">open_softirq</span>(<span class="pl-c1">HI_SOFTIRQ</span>, <span class="pl-s1">tasklet_hi_action</span>);
}</pre><div class="zeroclipboard-container">
<clipboard-copy aria-label="Copy" class="ClipboardButton btn btn-invisible js-clipboard-copy m-2 p-0 d-flex flex-justify-center flex-items-center" data-copy-feedback="Copied!" data-tooltip-direction="w" role="button" tabindex="0" value="
// kernel/softirq.c

/*
 * Tasklets
 */
struct tasklet_head {
	struct tasklet_struct *head;
	struct tasklet_struct **tail;
};

static DEFINE_PER_CPU(struct tasklet_head, tasklet_vec);
static DEFINE_PER_CPU(struct tasklet_head, tasklet_hi_vec);

// kernel/softirq.c

void __init softirq_init(void)
{
	int cpu;

	for_each_possible_cpu(cpu) {
		per_cpu(tasklet_vec, cpu).tail =
			&amp;per_cpu(tasklet_vec, cpu).head;
		per_cpu(tasklet_hi_vec, cpu).tail =
			&amp;per_cpu(tasklet_hi_vec, cpu).head;
	}

	// 设置 TASKLET_SOFTIRQ 和 HI_SOFTIRQ 对应的处理函数
	open_softirq(TASKLET_SOFTIRQ, tasklet_action);
	open_softirq(HI_SOFTIRQ, tasklet_hi_action);
}">
<svg aria-hidden="true" class="octicon octicon-copy js-clipboard-copy-icon" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path>
</svg>
<svg aria-hidden="true" class="octicon octicon-check js-clipboard-check-icon color-fg-success d-none" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"></path>
</svg>
</clipboard-copy>
</div></div>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto" tabindex="-1">中断处理</h3><a aria-label="Permalink: 中断处理" class="anchor" href="#中断处理-1" id="user-content-中断处理-1"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><code>do_irq -&gt; handle_riscv_irq -&gt; irq_exit_rcu -&gt; __irq_exit_rcu</code></p>
<div class="highlight highlight-source-c notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-c">// kernel/softirq.c</span>

<span class="pl-k">static</span> <span class="pl-k">inline</span> <span class="pl-smi">void</span> <span class="pl-en">__irq_exit_rcu</span>(<span class="pl-smi">void</span>)
{
<span class="pl-k">#ifndef</span> <span class="pl-s1">__ARCH_IRQ_EXIT_IRQS_DISABLED</span>
	<span class="pl-en">local_irq_disable</span>();
<span class="pl-k">#else</span>
	<span class="pl-en">lockdep_assert_irqs_disabled</span>();
<span class="pl-k">#endif</span>
	<span class="pl-en">account_hardirq_exit</span>(<span class="pl-s1">current</span>);
	<span class="pl-en">preempt_count_sub</span>(<span class="pl-c1">HARDIRQ_OFFSET</span>);
	<span class="pl-k">if</span> (!<span class="pl-en">in_interrupt</span>() <span class="pl-c1">&amp;&amp;</span> <span class="pl-en">local_softirq_pending</span>())
		<span class="pl-en">invoke_softirq</span>();

	<span class="pl-k">if</span> (<span class="pl-en">IS_ENABLED</span>(<span class="pl-c1">CONFIG_IRQ_FORCED_THREADING</span>) <span class="pl-c1">&amp;&amp;</span> <span class="pl-en">force_irqthreads</span>() <span class="pl-c1">&amp;&amp;</span>
	    <span class="pl-en">local_timers_pending_force_th</span>() <span class="pl-c1">&amp;&amp;</span> !(<span class="pl-en">in_nmi</span>() | <span class="pl-en">in_hardirq</span>()))
		<span class="pl-en">wake_timersd</span>();

	<span class="pl-en">tick_irq_exit</span>();
}</pre><div class="zeroclipboard-container">
<clipboard-copy aria-label="Copy" class="ClipboardButton btn btn-invisible js-clipboard-copy m-2 p-0 d-flex flex-justify-center flex-items-center" data-copy-feedback="Copied!" data-tooltip-direction="w" role="button" tabindex="0" value="// kernel/softirq.c

static inline void __irq_exit_rcu(void)
{
#ifndef __ARCH_IRQ_EXIT_IRQS_DISABLED
	local_irq_disable();
#else
	lockdep_assert_irqs_disabled();
#endif
	account_hardirq_exit(current);
	preempt_count_sub(HARDIRQ_OFFSET);
	if (!in_interrupt() &amp;&amp; local_softirq_pending())
		invoke_softirq();

	if (IS_ENABLED(CONFIG_IRQ_FORCED_THREADING) &amp;&amp; force_irqthreads() &amp;&amp;
	    local_timers_pending_force_th() &amp;&amp; !(in_nmi() | in_hardirq()))
		wake_timersd();

	tick_irq_exit();
}">
<svg aria-hidden="true" class="octicon octicon-copy js-clipboard-copy-icon" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path>
</svg>
<svg aria-hidden="true" class="octicon octicon-check js-clipboard-check-icon color-fg-success d-none" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"></path>
</svg>
</clipboard-copy>
</div></div>
<p dir="auto">函数 <code>invoke_softirq()</code> 负责执行数组 <code>softirq_vec[i]</code> 中设置的软中断服务函数。每个 CPU 都是通过执行这个函数来执行软中断服务的。</p>
<p dir="auto">由于同一个 CPU 上的软中断服务例程不允许嵌套，因此，在调用 <code>invoke_softirq()</code> 函数之前就用 <code>in_interrupt()</code> 检查当前 CPU 是否正处在中断服务中，如果是则不执行 <code>invoke_softirq()</code> 函数。</p>
<p dir="auto">举个例子，假设 CPU0 正在执行 <code>invoke_softirq()</code> 函数，执行过程产生了一个高优先级的硬件中断，于是 CPU0 转去执行这个高优先级中断所对应的中断服务程序。</p>
<p dir="auto">众所周知，所有的中断服务程序最后都要跳转到 <code>do_irq()</code> 函数并由它来依次执行中断服务队列中的 ISR，这里我们假定这个高优先级中断的 ISR 请求触发了一次软中断，<code>do_irq()</code> 函数在退出之前调用 <code>__irq_exit_rcu()</code> 函数来服务软中断请求。</p>
<p dir="auto">但是在这一次进入 <code>__irq_exit_rcu()</code> 函数时，它马上发现 CPU0 此前已经处在中断服务状态中了，因此这一次 <code>invoke_softirq</code> 函数不执行。</p>
<p dir="auto">于是，CPU0 结束这次高优先级的中断处理，回到最开始的 <code>invoke_softirq()</code> 函数继续执行（，并为高优先级中断的 ISR 所触发的软中断请求补上一次服务？？）。</p>
<div class="markdown-heading" dir="auto"><h4 class="heading-element" dir="auto" tabindex="-1">local_softirq_pending()</h4><a aria-label="Permalink: local_softirq_pending()" class="anchor" href="#local_softirq_pending" id="user-content-local_softirq_pending"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">上面已经讨论过。</p>
<div class="markdown-heading" dir="auto"><h4 class="heading-element" dir="auto" tabindex="-1">invoke_softirq()</h4><a aria-label="Permalink: invoke_softirq()" class="anchor" href="#invoke_softirq" id="user-content-invoke_softirq"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">在 <code>CONFIG_PREEMPT_RT</code> 开启的情况下，<code>invoke_softirq</code> 还有另外一种只使用 <code>wakeup_softirqd</code> 的实现，这里不讨论。</p>
<p dir="auto">首先，我们检查 <code>force_irqthreads() &amp;&amp; __this_cpu_read(ksoftirqd)</code>。<code>force_irqthreads()</code> 表示 is the kernel configured to force all interrupt handling into threads。This is an option for improving real-time characteristics without a full PREEMPT_RT patch. <code>__this_cpu_read(ksoftirqd)</code> 表示 is the <code>ksoftirqd</code> thread for this CPU running or available。</p>
<p dir="auto">只有当这两个条件都满足时，才调用 <code>wakeup_softirqd</code> 处理软中断。否则调用 <code>__do_softirq</code> 或者 <code>do_softirq_own_stack</code> 处理软中断。</p>
<div class="highlight highlight-source-c notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-c">// kernel/softirq.c</span>

<span class="pl-k">static</span> <span class="pl-k">inline</span> <span class="pl-smi">void</span> <span class="pl-en">invoke_softirq</span>(<span class="pl-smi">void</span>)
{
	<span class="pl-k">if</span> (!<span class="pl-en">force_irqthreads</span>() <span class="pl-c1">||</span> !<span class="pl-en">__this_cpu_read</span>(<span class="pl-s1">ksoftirqd</span>)) {
<span class="pl-k">#ifdef</span> <span class="pl-c1">CONFIG_HAVE_IRQ_EXIT_ON_IRQ_STACK</span>
		<span class="pl-c">/*</span>
<span class="pl-c">		 * We can safely execute softirq on the current stack if</span>
<span class="pl-c">		 * it is the irq stack, because it should be near empty</span>
<span class="pl-c">		 * at this stage.</span>
<span class="pl-c">		 */</span>
		<span class="pl-c">// 目前已经</span>
		<span class="pl-en">__do_softirq</span>();
<span class="pl-k">#else</span>
		<span class="pl-c">/*</span>
<span class="pl-c">		 * Otherwise, irq_exit() is called on the task stack that can</span>
<span class="pl-c">		 * be potentially deep already. So call softirq in its own stack</span>
<span class="pl-c">		 * to prevent from any overrun.</span>
<span class="pl-c">		 */</span>
		<span class="pl-c">// 使用 softirq stack</span>
		<span class="pl-en">do_softirq_own_stack</span>();
<span class="pl-k">#endif</span>
	} <span class="pl-k">else</span> {
		<span class="pl-en">wakeup_softirqd</span>();
	}
}

<span class="pl-c">// arch/riscv/kernel/irq.c</span>

<span class="pl-k">#ifdef</span> <span class="pl-c1">CONFIG_SOFTIRQ_ON_OWN_STACK</span>
<span class="pl-k">static</span> <span class="pl-smi">void</span> <span class="pl-en">___do_softirq</span>(<span class="pl-k">struct</span> <span class="pl-smi">pt_regs</span> <span class="pl-c1">*</span><span class="pl-s1">regs</span>)
{
	<span class="pl-en">__do_softirq</span>();
}

<span class="pl-smi">void</span> <span class="pl-en">do_softirq_own_stack</span>(<span class="pl-smi">void</span>)
{
	<span class="pl-k">if</span> (<span class="pl-en">on_thread_stack</span>())
		<span class="pl-en">call_on_irq_stack</span>(<span class="pl-c1">NULL</span>, <span class="pl-s1">___do_softirq</span>);
	<span class="pl-c">// If the kernel is not on a thread stack,</span>
	<span class="pl-c">// it implies it's already on the IRQ stack (for example,</span>
	<span class="pl-c">// if this code is being reached from a nested interrupt context).</span>
	<span class="pl-c">// In this case, it's already on a safe stack, so there's no need to</span>
	<span class="pl-c">// switch, and it can call __do_softirq() directly.</span>
	<span class="pl-k">else</span>
		<span class="pl-en">__do_softirq</span>();
}
<span class="pl-k">#endif</span> <span class="pl-c">/* CONFIG_SOFTIRQ_ON_OWN_STACK */</span></pre><div class="zeroclipboard-container">
<clipboard-copy aria-label="Copy" class="ClipboardButton btn btn-invisible js-clipboard-copy m-2 p-0 d-flex flex-justify-center flex-items-center" data-copy-feedback="Copied!" data-tooltip-direction="w" role="button" tabindex="0" value="// kernel/softirq.c

static inline void invoke_softirq(void)
{
	if (!force_irqthreads() || !__this_cpu_read(ksoftirqd)) {
#ifdef CONFIG_HAVE_IRQ_EXIT_ON_IRQ_STACK
		/*
		 * We can safely execute softirq on the current stack if
		 * it is the irq stack, because it should be near empty
		 * at this stage.
		 */
		// 目前已经
		__do_softirq();
#else
		/*
		 * Otherwise, irq_exit() is called on the task stack that can
		 * be potentially deep already. So call softirq in its own stack
		 * to prevent from any overrun.
		 */
		// 使用 softirq stack
		do_softirq_own_stack();
#endif
	} else {
		wakeup_softirqd();
	}
}

// arch/riscv/kernel/irq.c

#ifdef CONFIG_SOFTIRQ_ON_OWN_STACK
static void ___do_softirq(struct pt_regs *regs)
{
	__do_softirq();
}

void do_softirq_own_stack(void)
{
	if (on_thread_stack())
		call_on_irq_stack(NULL, ___do_softirq);
	// If the kernel is not on a thread stack,
	// it implies it's already on the IRQ stack (for example,
	// if this code is being reached from a nested interrupt context).
	// In this case, it's already on a safe stack, so there's no need to
	// switch, and it can call __do_softirq() directly.
	else
		__do_softirq();
}
#endif /* CONFIG_SOFTIRQ_ON_OWN_STACK */
">
<svg aria-hidden="true" class="octicon octicon-copy js-clipboard-copy-icon" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path>
</svg>
<svg aria-hidden="true" class="octicon octicon-check js-clipboard-check-icon color-fg-success d-none" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"></path>
</svg>
</clipboard-copy>
</div></div>
<p dir="auto">如果 <code>CONFIG_HAVE_IRQ_EXIT_ON_IRQ_STACK</code> 开启，表示 softirq 在 irq stack 上处理，irq stack 此时基本已经空了，可以安全执行。如果 <code>CONFIG_HAVE_IRQ_EXIT_ON_IRQ_STACK</code> 没开启，那么所有中断处理都是在 task kernel stack 上进行的</p>
<div class="markdown-heading" dir="auto"><h4 class="heading-element" dir="auto" tabindex="-1">__do_softirq()</h4><a aria-label="Permalink: __do_softirq()" class="anchor" href="#__do_softirq" id="user-content-__do_softirq"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto" tabindex="-1">下半部实现方式：tasklet</h2><a aria-label="Permalink: 下半部实现方式：tasklet" class="anchor" href="#下半部实现方式tasklet" id="user-content-下半部实现方式tasklet"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto" tabindex="-1">PLIC 初始化</h2><a aria-label="Permalink: PLIC 初始化" class="anchor" href="#plic-初始化" id="user-content-plic-初始化"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">PLIC 驱动实现文件为 <code>drivers/irqchip/irq-sifive-plic.c</code>。本来这个驱动的初始化函数是用 <code>IRQCHIP_DECLARE</code> 注册，在 <code>of_irq_init</code> 里被调用的，但是 commit 8ec99b033147 (irqchip/sifive-plic: Convert PLIC driver into a platform driver, 2024-02-22) 把 PLIC driver 变成了 platform driver。</p>
<p dir="auto"><code>builtin_platform_driver</code> 创建了一个 <code>plic_driver_init</code> 函数，并在其中调用 <code>platform_driver_register(&amp;plic_driver)</code>。</p>
<p dir="auto">当 <code>plic_driver_init</code> 被执行时，<code>platform_driver_register</code> 被调用。<code>plic_driver.of_match_table</code> 和 platform bus 上的所有 platform evice 进行比较。<code>plic_driver.of_match_table</code> 和每个 platform device 比较时，<code>of_match_table</code> 里所有 entry 会一个一个和 platform device 比较。</p>
<ul dir="auto">
<li>
<p dir="auto">对每个 platform device（假设为 plic）</p>
<ul dir="auto">
<li>
<p dir="auto">对 driver 的第一个 of_match_table entry <code>sifive,plic-1.0.0</code></p>
<ul dir="auto">
<li>
<p dir="auto">调用 __of_device_is_compatible 匹配 device 和 <code>sifive,plic-1.0.0</code></p>
<p dir="auto">如果当前 device 是 plic，那么 __of_device_is_compatible 返回的 score 要大</p>
</li>
</ul>
</li>
<li>
<p dir="auto">对 driver 的第二个 of_match_table entry <code>riscv,plic0</code></p>
<ul dir="auto">
<li>
<p dir="auto">调用 __of_device_is_compatible 匹配 device 和 <code>riscv,plic0</code></p>
<p dir="auto">如果当前 device 是 plic，那么 __of_device_is_compatible 返回的 score 小一点</p>
</li>
</ul>
</li>
<li>
<p dir="auto">最后返回的 match 是 of_match_table 第一个 entry</p>
</li>
</ul>
</li>
</ul>
<p dir="auto"><code>plic_driver</code> 匹配到 plic 节点以后，<code>plic_platform_probe</code> 被调用。</p>
<div class="highlight highlight-source-c notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-c">// drivers/irqchip/irq-sifive-plic.c</span>

<span class="pl-k">static</span> <span class="pl-k">const</span> <span class="pl-k">struct</span> <span class="pl-smi">of_device_id</span> <span class="pl-s1">plic_match</span>[] <span class="pl-c1">=</span> {
	{ .<span class="pl-c1">compatible</span> <span class="pl-c1">=</span> <span class="pl-s">"sifive,plic-1.0.0"</span> },
	{ .<span class="pl-c1">compatible</span> <span class="pl-c1">=</span> <span class="pl-s">"riscv,plic0"</span> },
	{ .<span class="pl-c1">compatible</span> <span class="pl-c1">=</span> <span class="pl-s">"andestech,nceplic100"</span>,
	  .<span class="pl-c1">data</span> <span class="pl-c1">=</span> (<span class="pl-k">const</span> <span class="pl-smi">void</span> <span class="pl-c1">*</span>)<span class="pl-en">BIT</span>(<span class="pl-c1">PLIC_QUIRK_EDGE_INTERRUPT</span>) },
	{ .<span class="pl-c1">compatible</span> <span class="pl-c1">=</span> <span class="pl-s">"thead,c900-plic"</span>,
	  .<span class="pl-c1">data</span> <span class="pl-c1">=</span> (<span class="pl-k">const</span> <span class="pl-smi">void</span> <span class="pl-c1">*</span>)<span class="pl-en">BIT</span>(<span class="pl-c1">PLIC_QUIRK_EDGE_INTERRUPT</span>) },
	{}
};

<span class="pl-k">static</span> <span class="pl-smi">int</span> <span class="pl-en">plic_platform_probe</span>(<span class="pl-k">struct</span> <span class="pl-smi">platform_device</span> <span class="pl-c1">*</span><span class="pl-s1">pdev</span>)
{
	<span class="pl-k">return</span> <span class="pl-en">plic_probe</span>(<span class="pl-s1">pdev</span><span class="pl-c1">-&gt;</span><span class="pl-c1">dev</span>.<span class="pl-c1">fwnode</span>);
}

<span class="pl-k">static</span> <span class="pl-k">struct</span> <span class="pl-smi">platform_driver</span> <span class="pl-s1">plic_driver</span> <span class="pl-c1">=</span> {
	.<span class="pl-c1">driver</span> <span class="pl-c1">=</span> {
		.<span class="pl-c1">name</span>		<span class="pl-c1">=</span> <span class="pl-s">"riscv-plic"</span>,
		.<span class="pl-c1">of_match_table</span>	<span class="pl-c1">=</span> <span class="pl-s1">plic_match</span>,
		.<span class="pl-c1">suppress_bind_attrs</span> <span class="pl-c1">=</span> true,
		.<span class="pl-c1">acpi_match_table</span> <span class="pl-c1">=</span> <span class="pl-en">ACPI_PTR</span>(<span class="pl-s1">plic_acpi_match</span>),
	},
	.<span class="pl-c1">probe</span> <span class="pl-c1">=</span> <span class="pl-s1">plic_platform_probe</span>,
};
<span class="pl-en">builtin_platform_driver</span>(<span class="pl-s1">plic_driver</span>);</pre><div class="zeroclipboard-container">
<clipboard-copy aria-label="Copy" class="ClipboardButton btn btn-invisible js-clipboard-copy m-2 p-0 d-flex flex-justify-center flex-items-center" data-copy-feedback="Copied!" data-tooltip-direction="w" role="button" tabindex="0" value='// drivers/irqchip/irq-sifive-plic.c

static const struct of_device_id plic_match[] = {
	{ .compatible = "sifive,plic-1.0.0" },
	{ .compatible = "riscv,plic0" },
	{ .compatible = "andestech,nceplic100",
	  .data = (const void *)BIT(PLIC_QUIRK_EDGE_INTERRUPT) },
	{ .compatible = "thead,c900-plic",
	  .data = (const void *)BIT(PLIC_QUIRK_EDGE_INTERRUPT) },
	{}
};

static int plic_platform_probe(struct platform_device *pdev)
{
	return plic_probe(pdev-&gt;dev.fwnode);
}

static struct platform_driver plic_driver = {
	.driver = {
		.name		= "riscv-plic",
		.of_match_table	= plic_match,
		.suppress_bind_attrs = true,
		.acpi_match_table = ACPI_PTR(plic_acpi_match),
	},
	.probe = plic_platform_probe,
};
builtin_platform_driver(plic_driver);'>
<svg aria-hidden="true" class="octicon octicon-copy js-clipboard-copy-icon" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path>
</svg>
<svg aria-hidden="true" class="octicon octicon-check js-clipboard-check-icon color-fg-success d-none" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"></path>
</svg>
</clipboard-copy>
</div></div>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto" tabindex="-1">plic_probe()</h3><a aria-label="Permalink: plic_probe()" class="anchor" href="#plic_probe" id="user-content-plic_probe"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
</article></div>

<div aria-atomic="true" aria-live="polite" class="sr-only mt-n1" id="js-global-screen-reader-notice"></div>
<div aria-atomic="true" aria-live="assertive" class="sr-only mt-n1" id="js-global-screen-reader-notice-assertive"></div>
<div aria-live="assertive" class="sr-only mt-n1" data-testid="screenReaderAnnouncement" id="screenReaderAnnouncementDiv" role="alert"> </div></body></html>