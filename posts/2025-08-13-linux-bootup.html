<!DOCTYPE html>
<html class="js-focus-visible" data-a11y-animated-images="system" data-a11y-link-underlines="true" data-color-mode="auto" data-dark-theme="dark" data-js-focus-visible="" data-light-theme="light" data-turbo-loaded="" lang="en"><head><style type="text/css">.turbo-progress-bar {
  position: fixed;
  display: block;
  top: 0;
  left: 0;
  height: 3px;
  background: #0076ff;
  z-index: 2147483647;
  transition:
    width 300ms ease-out,
    opacity 150ms 150ms ease-in;
  transform: translate3d(0, 0, 0);
}
</style>
<meta charset="utf-8"/>
<link href="https://github.githubassets.com" rel="dns-prefetch"/>
<link href="https://avatars.githubusercontent.com" rel="dns-prefetch"/>
<link href="https://github-cloud.s3.amazonaws.com" rel="dns-prefetch"/>
<link href="https://user-images.githubusercontent.com/" rel="dns-prefetch"/>
<link crossorigin="" href="https://github.githubassets.com" rel="preconnect"/>
<link href="https://avatars.githubusercontent.com" rel="preconnect"/>
<link crossorigin="anonymous" href="https://github.githubassets.com/assets/light-8e973f836952.css" media="all" rel="stylesheet"/><link crossorigin="anonymous" href="https://github.githubassets.com/assets/light_high_contrast-34b642d57214.css" media="all" rel="stylesheet"/><link crossorigin="anonymous" href="https://github.githubassets.com/assets/dark-4bce7af39e21.css" media="all" rel="stylesheet"/><link crossorigin="anonymous" href="https://github.githubassets.com/assets/dark_high_contrast-ad512d3e2f3b.css" media="all" rel="stylesheet"/><link crossorigin="anonymous" data-color-theme="light" data-href="https://github.githubassets.com/assets/light-8e973f836952.css" media="all" rel="stylesheet"/><link crossorigin="anonymous" data-color-theme="light_high_contrast" data-href="https://github.githubassets.com/assets/light_high_contrast-34b642d57214.css" media="all" rel="stylesheet"/><link crossorigin="anonymous" data-color-theme="light_colorblind" data-href="https://github.githubassets.com/assets/light_colorblind-54be93e666a7.css" media="all" rel="stylesheet"/><link crossorigin="anonymous" data-color-theme="light_colorblind_high_contrast" data-href="https://github.githubassets.com/assets/light_colorblind_high_contrast-8ae7edf5489c.css" media="all" rel="stylesheet"/><link crossorigin="anonymous" data-color-theme="light_tritanopia" data-href="https://github.githubassets.com/assets/light_tritanopia-84d50df427c0.css" media="all" rel="stylesheet"/><link crossorigin="anonymous" data-color-theme="light_tritanopia_high_contrast" data-href="https://github.githubassets.com/assets/light_tritanopia_high_contrast-a80873375146.css" media="all" rel="stylesheet"/><link crossorigin="anonymous" data-color-theme="dark" data-href="https://github.githubassets.com/assets/dark-4bce7af39e21.css" media="all" rel="stylesheet"/><link crossorigin="anonymous" data-color-theme="dark_high_contrast" data-href="https://github.githubassets.com/assets/dark_high_contrast-ad512d3e2f3b.css" media="all" rel="stylesheet"/><link crossorigin="anonymous" data-color-theme="dark_colorblind" data-href="https://github.githubassets.com/assets/dark_colorblind-d152d6cd6879.css" media="all" rel="stylesheet"/><link crossorigin="anonymous" data-color-theme="dark_colorblind_high_contrast" data-href="https://github.githubassets.com/assets/dark_colorblind_high_contrast-fa4060c1a9da.css" media="all" rel="stylesheet"/><link crossorigin="anonymous" data-color-theme="dark_tritanopia" data-href="https://github.githubassets.com/assets/dark_tritanopia-d7bad0fb00bb.css" media="all" rel="stylesheet"/><link crossorigin="anonymous" data-color-theme="dark_tritanopia_high_contrast" data-href="https://github.githubassets.com/assets/dark_tritanopia_high_contrast-4a0107c0f60c.css" media="all" rel="stylesheet"/><link crossorigin="anonymous" data-color-theme="dark_dimmed" data-href="https://github.githubassets.com/assets/dark_dimmed-045e6b6ac094.css" media="all" rel="stylesheet"/><link crossorigin="anonymous" data-color-theme="dark_dimmed_high_contrast" data-href="https://github.githubassets.com/assets/dark_dimmed_high_contrast-5de537db5e79.css" media="all" rel="stylesheet"/>
<style type="text/css">
    :root {
      --tab-size-preference: 4;
    }

    pre, code {
      tab-size: var(--tab-size-preference);
    }
  </style>
<link crossorigin="anonymous" href="https://github.githubassets.com/assets/primer-primitives-c37d781e2da5.css" media="all" rel="stylesheet"/>
<link crossorigin="anonymous" href="https://github.githubassets.com/assets/primer-efa08b71f947.css" media="all" rel="stylesheet"/>
<link crossorigin="anonymous" href="https://github.githubassets.com/assets/global-6dcb16809e76.css" media="all" rel="stylesheet"/>
<link crossorigin="anonymous" href="https://github.githubassets.com/assets/github-f86c648606b5.css" media="all" rel="stylesheet"/>
<link crossorigin="anonymous" href="https://github.githubassets.com/assets/repository-5d735668c600.css" media="all" rel="stylesheet"/>
<link crossorigin="anonymous" href="https://github.githubassets.com/assets/code-9c9b8dc61e74.css" media="all" rel="stylesheet"/>
<script id="client-env" type="application/json">{"locale":"en","featureFlags":["a11y_status_checks_ruleset","actions_custom_images_public_preview_visibility","actions_custom_images_storage_billing_ui_visibility","actions_enable_snapshot_keyword","actions_image_version_event","alternate_user_config_repo","api_insights_show_missing_data_banner","arianotify_comprehensive_migration","arianotify_partial_migration","client_version_header","codespaces_prebuild_region_target_update","contentful_lp_footnotes","copilot_agent_cli_public_preview","copilot_agent_task_list_v2","copilot_agent_tasks_btn_code_nav","copilot_agent_tasks_btn_code_view","copilot_agent_tasks_btn_code_view_lines","copilot_agent_tasks_btn_repo","copilot_api_agentic_issue_marshal_yaml","copilot_api_draft_issue_reference_with_project_id","copilot_api_draft_issues_with_dependencies","copilot_api_github_draft_update_issue_skill","copilot_chat_agents_empty_state","copilot_chat_attach_multiple_images","copilot_chat_file_redirect","copilot_chat_input_commands","copilot_chat_opening_thread_switch","copilot_chat_reduce_quota_checks","copilot_chat_search_bar_redirect","copilot_chat_selection_attachments","copilot_chat_vision_in_claude","copilot_chat_vision_preview_gate","copilot_coding_agent_task_response","copilot_custom_copilots","copilot_custom_copilots_feature_preview","copilot_dashboard_input_new_submit","copilot_duplicate_thread","copilot_extensions_hide_in_dotcom_chat","copilot_extensions_removal_on_marketplace","copilot_features_raycast_logo","copilot_file_block_ref_matching","copilot_ftp_hyperspace_upgrade_prompt","copilot_immersive_generate_thread_name_async","copilot_immersive_issues_readonly_viewer","copilot_immersive_issues_show_relationships","copilot_immersive_job_result_preview","copilot_immersive_structured_model_picker","copilot_immersive_task_hyperlinking","copilot_immersive_task_within_chat_thread","copilot_org_policy_page_focus_mode","copilot_security_alert_assignee_options","copilot_share_active_subthread","copilot_spaces_as_attachments","copilot_spaces_code_view","copilot_spaces_ga","copilot_spaces_individual_policies_ga","copilot_spaces_public_access_to_user_owned_spaces","copilot_spaces_read_access_to_user_owned_spaces","copilot_spaces_report_abuse","copilot_spark_empty_state","copilot_spark_loading_webgl","copilot_spark_progressive_error_handling","copilot_spark_use_billing_headers","copilot_stable_conversation_view","copilot_swe_agent_progress_commands","copilot_swe_agent_use_subagents","copilot_workbench_agent_seed_tool","copilot_workbench_agent_user_edit_awareness","copilot_workbench_cache","copilot_workbench_preview_analytics","copilot_workbench_use_single_prompt","dashboard_universe_2025_feedback_dialog","direct_to_salesforce","disable_turbo_visit","dom_node_counts","dotcom_chat_client_side_skills","enterprise_ai_controls","failbot_report_error_react_apps_on_page","fetch_graphql_improved_error_serialization","ghost_pilot_confidence_truncation_25","ghost_pilot_confidence_truncation_40","global_search_multi_orgs","hyperspace_2025_logged_out_batch_1","hyperspace_nudges_universe25","hyperspace_nudges_universe25_post_event","initial_per_page_pagination_updates","issue_fields_report_usage","issues_expanded_file_types","issues_lazy_load_comment_box_suggestions","issues_react_bots_timeline_pagination","issues_react_prohibit_title_fallback","issues_report_sidebar_interactions","issues_sticky_sidebar","issues_title_flex_header_fix","item_picker_assignee_tsq_migration","item_picker_project_tsq_migration","lifecycle_label_name_updates","link_contact_sales_swp_marketo","marketing_pages_search_explore_provider","mcp_registry_install","mcp_registry_oss_v0_1_api","memex_default_issue_create_repository","memex_grouped_by_edit_route","memex_mwl_filter_field_delimiter","mission_control_use_body_html","new_traffic_page_banner","open_agent_session_in_vscode_insiders","open_agent_session_in_vscode_stable","primer_react_segmented_control_tooltip","projects_assignee_max_limit","react_fetch_graphql_ignore_expected_errors","record_sso_banner_metrics","repos_insights_remove_new_url","ruleset_deletion_confirmation","sample_network_conn_type","scheduled_reminders_updated_limits","site_features_copilot_universe","site_homepage_collaborate_video","site_homepage_contentful","site_homepage_eyebrow_banner","site_homepage_universe_animations","site_msbuild_webgl_hero","spark_fix_rename","spark_force_push_after_checkout","spark_improve_image_upload","spark_kv_encocoded_keys","spark_show_data_access_on_publish","spark_sync_repository_after_iteration","spark_use_agent_status","swe_agent_member_requests","viewscreen_sandbox","webp_support","workbench_store_readonly"],"copilotApiOverrideUrl":"https://api.githubcopilot.com"}</script>
<script crossorigin="anonymous" src="https://github.githubassets.com/assets/high-contrast-cookie-1a011967750c.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/wp-runtime-fbf9f6d06073.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/913-ca2305638c53.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/6488-de87864e6818.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/environment-122ed792f7a3.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/11683-aa3d1ebe6648.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/43784-4652ae97a661.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/4712-6fc930a63a4b.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/81028-5b8c5e07a4fa.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/74911-6a311b93ee8e.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/91853-b5d2e5602241.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/78143-31968346cf4c.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/52430-c46e2de36eb2.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/github-elements-5b3e77949adb.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/element-registry-12c7106d20b1.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/28546-ee41c9313871.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/17688-a9e16fb5ed13.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/2869-a4ba8f17edb3.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/70191-5122bf27bf3e.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/7332-5ea4ccf72018.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/3561-d56ebea34f95.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/19037-69d630e73af8.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/51519-b4d929bb1e46.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/67310-00ed42590310.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/96384-750ef5263abe.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/19718-676a65610616.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/behaviors-108608b0bccd.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/48011-1f20a5c80dd7.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/notifications-global-eb21f5b0029d.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/31615-236504c8966f.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/code-menu-67717e88b7e6.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/primer-react-e4ebdadc89a4.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/react-lib-760965ba27bb.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/react-core-0f12feb3af13.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/octicons-react-a215e6ee021a.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/12979-6037a19d779b.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/48775-3cc79d2cd30e.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/42892-341e79a04903.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/23832-db66abd83e08.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/99418-9d4961969e0d.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/33915-05ba9b3edc31.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/96537-8e29101f7d81.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/51220-ec5733320b36.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/32219-236f5281aec8.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/59579-2ea999aac712.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/62029-a6360a734229.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/25407-0068d683d953.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/40771-0ffdf56b673a.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/66990-bcc3e84258a5.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/29665-96a2ad6dd82d.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/6623-ff0ff52cb37f.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/19976-d9a685a90a0d.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/3774-6fb5a6174da6.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/18406-fcf6a2af3f18.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/36584-61e8176018bd.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/29806-7c403c1af2af.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/react-code-view-062da6f9a292.js" type="application/javascript"></script>
<link crossorigin="anonymous" href="https://github.githubassets.com/assets/primer-react.11da412fd8d1812bb316.module.css" media="all" rel="stylesheet"/>
<link crossorigin="anonymous" href="https://github.githubassets.com/assets/react-code-view.5fabe269aba9949ea13c.module.css" media="all" rel="stylesheet"/>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/25873-19b3275e0432.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/notifications-subscriptions-menu-2c48be7f98a2.js" type="application/javascript"></script>
<link crossorigin="anonymous" href="https://github.githubassets.com/assets/primer-react.11da412fd8d1812bb316.module.css" media="all" rel="stylesheet"/>
<link crossorigin="anonymous" href="https://github.githubassets.com/assets/notifications-subscriptions-menu.933100a30c03fd4e8ae4.module.css" media="all" rel="stylesheet"/>
<title>2025-08-13-linux-bootup</title>
<meta content="/:user_id/:repository/blob/*name(/*path)" data-turbo-transient="" name="route-pattern"/>
<meta content="blob" data-turbo-transient="" name="route-controller"/>
<meta content="show" data-turbo-transient="" name="route-action"/>
<meta content="v2:8d2e7faf-05f3-607d-9308-8b6e8f1db0f0" name="fetch-nonce"/>
<meta content="f3abb0cc802f3d7b95fc8762b94bdcb13bf39634c40c357301c4aa1d67a256fb" name="current-catalog-service-hash"/>
<meta content="D800:A65D9:D4AF07:D73F12:6930BFBC" data-pjax-transient="true" name="request-id"/><meta content="d8d89d64caa0368c6774e90bd23a9df2d5419cddbcfaf6af1303732b84347742" data-pjax-transient="true" name="html-safe-nonce"/><meta content="eyJyZWZlcnJlciI6IiIsInJlcXVlc3RfaWQiOiJEODAwOkE2NUQ5OkQ0QUYwNzpENzNGMTI6NjkzMEJGQkMiLCJ2aXNpdG9yX2lkIjoiNDQzNzY4NDkzMzU0NzMxMTAyNCIsInJlZ2lvbl9lZGdlIjoic2VhIiwicmVnaW9uX3JlbmRlciI6InNlYSJ9" data-pjax-transient="true" name="visitor-payload"/><meta content="7bd57fe1ea0c5312c63ad51c54ac0760a1dba578d0b0311397d5519fc7ec5c22" data-pjax-transient="true" name="visitor-hmac"/>
<meta content="repository:952181622" data-turbo-transient="" name="hovercard-subject-tag"/>
<meta content="repository,source-code,file-tree,copilot" data-turbo-transient="true" name="github-keyboard-shortcuts"/>
<meta data-turbo-transient="" name="selected-link" value="repo_source"/>
<link href="https://github.githubassets.com/" rel="assets"/>
<meta content="Apib7-x98H0j5cPqHWwSMm6dNU4GmODRoqxLiDzdx9I" name="google-site-verification"/>
<meta content="https://collector.github.com/github/collect" name="octolytics-url"/>
<meta content="/&lt;user-name&gt;/&lt;repo-name&gt;/blob/show" data-turbo-transient="true" name="analytics-location"/>
<meta content="" name="user-login"/>
<meta content="width=device-width" name="viewport"/>
<meta content="Contribute to BigBrotherJu/bigbrotherju.github.io development by creating an account on GitHub." name="description"/>
<link href="/opensearch.xml" rel="search" title="GitHub" type="application/opensearchdescription+xml"/>
<link href="https://github.com/fluidicon.png" rel="fluid-icon" title="GitHub"/>
<meta content="1401488693436528" property="fb:app_id"/>

<meta content="https://opengraph.githubassets.com/1037081bcc56be21451918aa5af2c95dffca7ad325e40baf8340e9d3e8100d76/BigBrotherJu/bigbrotherju.github.io" name="twitter:image"/><meta content="@github" name="twitter:site"/><meta content="summary_large_image" name="twitter:card"/><meta content="bigbrotherju.github.io/posts/2025-08-13-linux-bootup.md at main · BigBrotherJu/bigbrotherju.github.io" name="twitter:title"/><meta content="Contribute to BigBrotherJu/bigbrotherju.github.io development by creating an account on GitHub." name="twitter:description"/>
<meta content="https://opengraph.githubassets.com/1037081bcc56be21451918aa5af2c95dffca7ad325e40baf8340e9d3e8100d76/BigBrotherJu/bigbrotherju.github.io" property="og:image"/><meta content="Contribute to BigBrotherJu/bigbrotherju.github.io development by creating an account on GitHub." property="og:image:alt"/><meta content="1200" property="og:image:width"/><meta content="600" property="og:image:height"/><meta content="GitHub" property="og:site_name"/><meta content="object" property="og:type"/><meta content="bigbrotherju.github.io/posts/2025-08-13-linux-bootup.md at main · BigBrotherJu/bigbrotherju.github.io" property="og:title"/><meta content="https://github.com/BigBrotherJu/bigbrotherju.github.io/blob/main/posts/2025-08-13-linux-bootup.md" property="og:url"/><meta content="Contribute to BigBrotherJu/bigbrotherju.github.io development by creating an account on GitHub." property="og:description"/>
<meta content="github.com" name="hostname"/>
<meta content="github.com" name="expected-hostname"/>
<meta content="341bb62f3b725f5e05c8e285899069b67e0356a6b179464a3c6225becb495f2a" data-turbo-track="reload" http-equiv="x-pjax-version"/>
<meta content="21a43568025709b66240454fc92d4f09335a96863f8ab1c46b4a07f6a5b67102" data-turbo-track="reload" http-equiv="x-pjax-csp-version"/>
<meta content="8487fec39c8c06b815832ce80ebd89387f6b3bac9b5498b820bc97b9a51ed30a" data-turbo-track="reload" http-equiv="x-pjax-css-version"/>
<meta content="88f02bc0017bfafc3b0733f6964a4230cc3403cff29da95e43aa834faee822ff" data-turbo-track="reload" http-equiv="x-pjax-js-version"/>
<meta content="no-preview" data-turbo-transient="" name="turbo-cache-control"/>
<meta content="no-cache" data-turbo-transient="" name="turbo-cache-control"/>
<meta data-hydrostats="publish"/>
<meta content="github.com/BigBrotherJu/bigbrotherju.github.io git https://github.com/BigBrotherJu/bigbrotherju.github.io.git" name="go-import"/>
<meta content="47515692" name="octolytics-dimension-user_id"/><meta content="BigBrotherJu" name="octolytics-dimension-user_login"/><meta content="952181622" name="octolytics-dimension-repository_id"/><meta content="BigBrotherJu/bigbrotherju.github.io" name="octolytics-dimension-repository_nwo"/><meta content="true" name="octolytics-dimension-repository_public"/><meta content="false" name="octolytics-dimension-repository_is_fork"/><meta content="952181622" name="octolytics-dimension-repository_network_root_id"/><meta content="BigBrotherJu/bigbrotherju.github.io" name="octolytics-dimension-repository_network_root_nwo"/>
<meta content="logged-out env-production page-responsive" name="turbo-body-classes"/>
<meta content="false" name="disable-turbo"/>
<meta content="https://api.github.com/_private/browser/stats" name="browser-stats-url"/>
<meta content="https://api.github.com/_private/browser/errors" name="browser-errors-url"/>
<meta content="94451c010f9f7136a11c3fc7b33762260d7e961f" name="release"/>
<meta content="full" name="ui-target"/>



<meta content="#1e2327" name="theme-color"/>
<meta content="light dark" name="color-scheme"/>

<link crossorigin="anonymous" href="https://github.githubassets.com/assets/14814.29aaeaafa90f007c6f61.module.css" rel="stylesheet" type="text/css"/><link crossorigin="anonymous" href="https://github.githubassets.com/assets/7275.8284bdfe1ee4804a58c1.module.css" rel="stylesheet" type="text/css"/><style data-styled="active" data-styled-version="5.3.11"></style><link crossorigin="anonymous" href="https://github.githubassets.com/assets/67216.753d458774a2f782559b.module.css" rel="stylesheet" type="text/css"/><style id="ms-consent-banner-main-styles">.w8hcgFksdo30C8w-bygqu{color:#000}.ydkKdaztSS0AeHWIeIHsQ a{color:#0067B8}.erL690_8JwUW-R4bJRcfl{background-color:#EBEBEB;border:none;color:#000}.erL690_8JwUW-R4bJRcfl:enabled:hover{color:#000;background-color:#DBDBDB;box-shadow:0px 4px 10px rgba(0,0,0,0.25);border:none}.erL690_8JwUW-R4bJRcfl:enabled:focus{background-color:#DBDBDB;box-shadow:0px 4px 10px rgba(0,0,0,0.25);border:2px solid #000}.erL690_8JwUW-R4bJRcfl:disabled{opacity:1;color:rgba(0,0,0,0.2);background-color:rgba(0,0,0,0.2);border:none}._1zNQOqxpBFSokeCLGi_hGr{border:none;background-color:#0067B8;color:#fff}._1zNQOqxpBFSokeCLGi_hGr:enabled:hover{color:#fff;background-color:#0067B8;box-shadow:0px 4px 10px rgba(0,0,0,0.25);border:none}._1zNQOqxpBFSokeCLGi_hGr:enabled:focus{background-color:#0067B8;box-shadow:0px 4px 10px rgba(0,0,0,0.25);border:2px solid #000}._1zNQOqxpBFSokeCLGi_hGr:disabled{opacity:1;color:rgba(0,0,0,0.2);background-color:rgba(0,120,215,0.2);border:none}._23tra1HsiiP6cT-Cka-ycB{position:relative;display:flex;z-index:9999;width:100%;background-color:#F2F2F2;justify-content:space-between;text-align:left}div[dir="rtl"]._23tra1HsiiP6cT-Cka-ycB{text-align:right}._1Upc2NjY8AlDn177YoVj0y{margin:0;padding-left:5%;padding-top:8px;padding-bottom:8px}div[dir="rtl"] ._1Upc2NjY8AlDn177YoVj0y{margin:0;padding:8px 5% 8px 0;float:none}._23tra1HsiiP6cT-Cka-ycB svg{fill:none;max-width:none;max-height:none}._1V_hlU-7jdtPiooHMu89BB{display:table-cell;padding:12px;width:24px;height:24px;font-family:Segoe UI, SegoeUI, Arial, sans-serif;font-style:normal;font-weight:normal;font-size:24px;line-height:0}.f6QKJD7fhSbnJLarTL-W-{display:table-cell;vertical-align:middle;padding:0;font-family:Segoe UI, SegoeUI, Arial, sans-serif;font-style:normal;font-weight:normal;font-size:13px;line-height:16px}.f6QKJD7fhSbnJLarTL-W- a{text-decoration:underline}._2j0fmugLb1FgYz6KPuB91w{display:inline-block;margin-left:5%;margin-right:5%;min-width:40%;min-width:calc((150px + 3 * 4px) * 2 + 150px);min-width:-webkit-fit-content;min-width:-moz-fit-content;min-width:fit-content;align-self:center;position:relative}._1XuCi2WhiqeWRUVp3pnFG3{margin:4px;padding:5px;min-width:150px;min-height:36px;vertical-align:top;cursor:pointer;font-family:Segoe UI, SegoeUI, Arial, sans-serif;font-style:normal;font-weight:normal;font-size:15px;line-height:20px;text-align:center}._1XuCi2WhiqeWRUVp3pnFG3:focus{box-sizing:border-box}._1XuCi2WhiqeWRUVp3pnFG3:disabled{cursor:not-allowed}._2bvsb3ubApyZ0UGoQA9O9T{display:block;position:fixed;z-index:10000;top:0;left:0;width:100%;height:100%;background-color:rgba(255,255,255,0.6);overflow:auto;text-align:left}div[dir="rtl"]._2bvsb3ubApyZ0UGoQA9O9T{text-align:right}div[dir="rtl"] ._2bvsb3ubApyZ0UGoQA9O9T{left:auto;right:0}.AFsJE948muYyzCMktdzuk{position:relative;top:8%;margin-bottom:40px;margin-left:auto;margin-right:auto;box-sizing:border-box;width:640px;background-color:#fff;border:1px solid #0067B8}._3kWyBRbW_dgnMiEyx06Fu4{float:right;z-index:1;margin:2px;padding:12px;border:none;cursor:pointer;font-family:Segoe UI, SegoeUI, Arial, sans-serif;font-style:normal;font-weight:normal;font-size:13px;line-height:13px;display:flex;align-items:center;text-align:center;color:#666;background-color:#fff}div[dir="rtl"] ._3kWyBRbW_dgnMiEyx06Fu4{margin:2px;padding:12px;float:left}.uCYvKvHXrhjNgflv1VqdD{position:static;margin-top:36px;margin-left:36px;margin-right:36px}._17pX1m9O_W--iZbDt3Ta5r{margin-top:0;margin-bottom:12px;font-family:Segoe UI, SegoeUI, Arial, sans-serif;font-style:normal;font-weight:600;font-size:20px;line-height:24px;text-transform:none}._1kBkHQ1V1wu3kl-YcLgUr6{height:446px;overflow:auto}._20_nXDf6uFs9Q6wxRXG-I-{margin-top:0;font-family:Segoe UI, SegoeUI, Arial, sans-serif;font-style:normal;font-weight:normal;font-size:15px;line-height:20px}._20_nXDf6uFs9Q6wxRXG-I- a{text-decoration:underline}dl._2a0NH_GDQEQe5Ynfo7suVH{margin-top:36px;margin-bottom:0;padding:0;list-style:none;text-transform:none}dt._3j_LCPv7fyXv3A8FIXVwZ4{margin-top:20px;float:none;font-family:Segoe UI, SegoeUI, Arial, sans-serif;font-style:normal;font-weight:600;font-size:18px;line-height:24px;list-style:none}.k-vxTGFbdq1aOZB2HHpjh{margin:0;padding:0;border:none}._2Bucyy75c_ogoU1g-liB5R{margin:0;padding:0;border-bottom:none;font-family:Segoe UI, SegoeUI, Arial, sans-serif;font-style:normal;font-weight:600;font-size:18px;line-height:24px;text-transform:none}._63gwfzV8dclrsl2cfd90r{display:inline-block;margin-top:0;margin-bottom:13px;font-family:Segoe UI, SegoeUI, Arial, sans-serif;font-style:normal;font-weight:normal;font-size:15px;line-height:20px}._1l8wM_4mRYGz3Iu7l3BZR7{display:block}._2UE03QS02aZGkslegN_F-i{display:inline-block;position:relative;left:5px;margin-bottom:13px;margin-right:34px;padding:3px}div[dir="rtl"] ._2UE03QS02aZGkslegN_F-i{margin:0 0 13px 34px;padding:3px;float:none}div[dir="rtl"] ._2UE03QS02aZGkslegN_F-i{left:auto;right:5px}._23tra1HsiiP6cT-Cka-ycB *::before,._2bvsb3ubApyZ0UGoQA9O9T *::before,._23tra1HsiiP6cT-Cka-ycB *::after,._2bvsb3ubApyZ0UGoQA9O9T *::after{box-sizing:inherit}._1HSFn0HzGo6w4ADApV8-c4{outline:2px solid rgba(0,0,0,0.8)}input[type="radio"]._1dp8Vp5m3HwAqGx8qBmFV2{display:inline-block;position:relative;margin-top:0;margin-left:0;margin-right:0;height:0;width:0;border-radius:0;cursor:pointer;outline:none;box-sizing:border-box;-webkit-appearance:none;-moz-appearance:none;appearance:none}input[type="radio"]._1dp8Vp5m3HwAqGx8qBmFV2+label::before{display:block;position:absolute;top:5px;left:3px;height:19px;width:19px;content:"";border-radius:50%;border:1px solid #000;background-color:#fff}div[dir="rtl"] input[type="radio"]._1dp8Vp5m3HwAqGx8qBmFV2+label::before{left:auto;right:3px}input[type="radio"]._1dp8Vp5m3HwAqGx8qBmFV2:not(:disabled)+label:hover::before{border:1px solid #0067B8}input[type="radio"]._1dp8Vp5m3HwAqGx8qBmFV2:not(:disabled)+label:hover::after{display:block;position:absolute;top:10px;left:8px;height:9px;width:9px;content:"";border-radius:50%;background-color:rgba(0,0,0,0.8)}div[dir="rtl"] input[type="radio"]._1dp8Vp5m3HwAqGx8qBmFV2:not(:disabled)+label:hover::after{left:auto;right:8px}input[type="radio"]._1dp8Vp5m3HwAqGx8qBmFV2:not(:disabled)+label:focus::before{border:1px solid #0067B8}input[type="radio"]._1dp8Vp5m3HwAqGx8qBmFV2:not(:disabled)+label:focus::after{display:block;position:absolute;top:10px;left:8px;height:9px;width:9px;content:"";border-radius:50%;background-color:#000}div[dir="rtl"] input[type="radio"]._1dp8Vp5m3HwAqGx8qBmFV2:not(:disabled)+label:focus::after{left:auto;right:8px}input[type="radio"]._1dp8Vp5m3HwAqGx8qBmFV2:checked+label::after{display:block;position:absolute;top:10px;left:8px;height:9px;width:9px;content:"";border-radius:50%;background-color:#000}div[dir="rtl"] input[type="radio"]._1dp8Vp5m3HwAqGx8qBmFV2:checked+label::after{left:auto;right:8px}input[type="radio"]._1dp8Vp5m3HwAqGx8qBmFV2:disabled+label{cursor:not-allowed}input[type="radio"]._1dp8Vp5m3HwAqGx8qBmFV2:disabled+label::before{border:1px solid rgba(0,0,0,0.2);background-color:rgba(0,0,0,0.2)}._3RJzeL3l9Rl_lAQEm6VwdX{display:block;position:static;float:right;margin-top:0;margin-bottom:0;margin-left:19px;margin-right:0;padding-top:0;padding-bottom:0;padding-left:8px;padding-right:0;width:80%;width:calc(100% - 19px);font-family:Segoe UI, SegoeUI, Arial, sans-serif;font-style:normal;font-weight:normal;font-size:15px;line-height:20px;text-transform:none;cursor:pointer;box-sizing:border-box}div[dir="rtl"] ._3RJzeL3l9Rl_lAQEm6VwdX{margin:0 19px 0 0;padding:0 8px 0 0;float:left}.nohp3sIG12ZBhzcMnPala{margin-top:20px;margin-bottom:48px}._2uhaEsmeotZ3P-M0AXo2kF{padding:0;width:278px;height:36px;cursor:pointer;font-family:Segoe UI, SegoeUI, Arial, sans-serif;font-style:normal;font-weight:normal;font-size:15px;line-height:20px;text-align:center}._2uhaEsmeotZ3P-M0AXo2kF:focus{box-sizing:border-box}._2uhaEsmeotZ3P-M0AXo2kF:disabled{cursor:not-allowed}._3tOu1FJ59c_xz_PmI1lKV5{float:right;padding:0;width:278px;height:36px;cursor:pointer;font-family:Segoe UI, SegoeUI, Arial, sans-serif;font-style:normal;font-weight:normal;font-size:15px;line-height:20px;text-align:center}._3tOu1FJ59c_xz_PmI1lKV5:focus{box-sizing:border-box}._3tOu1FJ59c_xz_PmI1lKV5:disabled{cursor:not-allowed}div[dir="rtl"] ._3tOu1FJ59c_xz_PmI1lKV5{margin:0;padding:0;float:left}@media only screen and (max-width: 768px){._2j0fmugLb1FgYz6KPuB91w,._1Upc2NjY8AlDn177YoVj0y{padding-top:8px;padding-bottom:12px;padding-left:3.75%;padding-right:3.75%;margin:0;width:92.5%}._23tra1HsiiP6cT-Cka-ycB{display:block}._1XuCi2WhiqeWRUVp3pnFG3{margin-bottom:8px;margin-left:0;margin-right:0;width:100%}._2bvsb3ubApyZ0UGoQA9O9T{overflow:hidden}.AFsJE948muYyzCMktdzuk{top:1.8%;width:93.33%;height:96.4%;overflow:hidden}.uCYvKvHXrhjNgflv1VqdD{margin-top:24px;margin-left:24px;margin-right:24px;height:100%}._1kBkHQ1V1wu3kl-YcLgUr6{height:62%;height:calc(100% - 188px);min-height:50%}._2uhaEsmeotZ3P-M0AXo2kF{width:100%}._3tOu1FJ59c_xz_PmI1lKV5{margin-bottom:12px;margin-left:0;width:100%}div[dir="rtl"] ._3tOu1FJ59c_xz_PmI1lKV5{margin:0 0 12px 0;padding:0;float:none}}@media only screen and (max-width: 768px) and (orientation: landscape), only screen and (max-height: 260px), only screen and (max-width: 340px){.AFsJE948muYyzCMktdzuk{overflow:auto}}@media only screen and (max-height: 260px), only screen and (max-width: 340px){._1XuCi2WhiqeWRUVp3pnFG3{min-width:0}._3kWyBRbW_dgnMiEyx06Fu4{padding:3%}.uCYvKvHXrhjNgflv1VqdD{margin-top:3%;margin-left:3%;margin-right:3%}._17pX1m9O_W--iZbDt3Ta5r{margin-bottom:3%}._1kBkHQ1V1wu3kl-YcLgUr6{height:calc(79% - 64px)}.nohp3sIG12ZBhzcMnPala{margin-top:5%;margin-bottom:10%}._3tOu1FJ59c_xz_PmI1lKV5{margin-bottom:3%}div[dir="rtl"] ._3tOu1FJ59c_xz_PmI1lKV5{margin:0 0 3% 0;padding:0;float:none}}
</style><style id="ms-consent-banner-theme-styles" type="text/css">._23tra1HsiiP6cT-Cka-ycB {
            background-color: #24292f !important;
        }.w8hcgFksdo30C8w-bygqu {
            color: #ffffff !important;
        }.ydkKdaztSS0AeHWIeIHsQ a {
            color: #d8b9ff !important;
        }._2bvsb3ubApyZ0UGoQA9O9T {
            background-color: rgba(23, 23, 23, 0.8) !important;
        }.AFsJE948muYyzCMktdzuk {
            background-color: #24292f !important;
            border: 1px solid #d8b9ff !important;
        }._3kWyBRbW_dgnMiEyx06Fu4 {
            color: #d8b9ff !important;
            background-color: #24292f !important;
        }._1zNQOqxpBFSokeCLGi_hGr {
            border: 1px solid #ffffff !important;
            background-color: #ffffff !important;
            color: #1f2328 !important;
        }._1zNQOqxpBFSokeCLGi_hGr:enabled:hover {
            color: #1f2328 !important;
            background-color: #d8b9ff !important;
            box-shadow: none !important;
            border: 1px solid transparent !important;
        }._1zNQOqxpBFSokeCLGi_hGr:enabled:focus {
            background-color: #d8b9ff !important;
            box-shadow: none !important;
            border: 2px solid #ffffff !important;
        }._1zNQOqxpBFSokeCLGi_hGr:disabled {
            opacity: 0.5 !important;
            color: #1f2328 !important;
            background-color: #ffffff !important;
            border: 1px solid transparent !important;
        }.erL690_8JwUW-R4bJRcfl {
            border: 1px solid #eaeef2 !important;
            background-color: #32383f !important;
            color: #ffffff !important;
        }.erL690_8JwUW-R4bJRcfl:enabled:hover {
            color: #ffffff !important;
            background-color: #24292f !important;
            box-shadow: none !important;
            border: 1px solid #ffffff !important;
        }.erL690_8JwUW-R4bJRcfl:enabled:focus {
            background-color: #24292f !important;
            box-shadow: none !important;
            border: 2px solid #6e7781 !important;
        }.erL690_8JwUW-R4bJRcfl:disabled {
            opacity: 0.5 !important;
            color: #ffffff !important;
            background-color: #424a53 !important;
            border: 1px solid #6e7781 !important;
        }input[type="radio"]._1dp8Vp5m3HwAqGx8qBmFV2 + label::before {
            border: 1px solid #d8b9ff !important;
            background-color: #24292f !important;
        }._1HSFn0HzGo6w4ADApV8-c4 {
            outline: 2px solid #ffffff !important;
        }input[type="radio"]._1dp8Vp5m3HwAqGx8qBmFV2:checked + label::after {
            background-color: #d8b9ff !important;
        }input[type="radio"]._1dp8Vp5m3HwAqGx8qBmFV2 + label:hover::before {
            border: 1px solid #ffffff !important;
        }input[type="radio"]._1dp8Vp5m3HwAqGx8qBmFV2 + label:hover::after {
            background-color: #ffffff !important;
        }input[type="radio"]._1dp8Vp5m3HwAqGx8qBmFV2 + label:focus::before {
            border: 1px solid #ffffff !important;
        }input[type="radio"]._1dp8Vp5m3HwAqGx8qBmFV2 + label:focus::after {
            background-color: #d8b9ff !important;
        }input[type="radio"]._1dp8Vp5m3HwAqGx8qBmFV2:disabled + label::before {
            border: 1px solid rgba(227, 227, 227, 0.2) !important;
            background-color: rgba(227, 227, 227, 0.2) !important;
        }</style></head>
<body class="logged-out env-production page-responsive" style="overflow-wrap: break-word; --dialog-scrollgutter: 0px;"><div class="Box-sc-62in7e-0 lhfNqO js-snippet-clipboard-copy-unpositioned undefined" data-hpc="true" style="padding: 32px"><article class="markdown-body entry-content container-lg" itemprop="text"><div class="markdown-heading" dir="auto"><h1 class="heading-element" dir="auto" tabindex="-1">RISC-V Linux 启动流程</h1><a aria-label="Permalink: RISC-V Linux 启动流程" class="anchor" href="#risc-v-linux-启动流程" id="user-content-risc-v-linux-启动流程"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">内核版本为 6.16-rc3，主要关注 stvec 设置、中断相关设置以及 SMP 设置。</p>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto" tabindex="-1">_start</h2><a aria-label="Permalink: _start" class="anchor" href="#_start" id="user-content-_start"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto"><pre class="notranslate"><code>ffffffff80000000 &lt;_start&gt;:
ffffffff80000000:       5a4d                    li      s4,-13
ffffffff80000002:       0d60106f                j       ffffffff800010d8 &lt;_start_kernel&gt;
ffffffff80000006:       0001                    nop
</code></pre><div class="zeroclipboard-container">
<clipboard-copy aria-label="Copy" class="ClipboardButton btn btn-invisible js-clipboard-copy m-2 p-0 d-flex flex-justify-center flex-items-center" data-copy-feedback="Copied!" data-tooltip-direction="w" role="button" tabindex="0" value="ffffffff80000000 &lt;_start&gt;:
ffffffff80000000:       5a4d                    li      s4,-13
ffffffff80000002:       0d60106f                j       ffffffff800010d8 &lt;_start_kernel&gt;
ffffffff80000006:       0001                    nop">
<svg aria-hidden="true" class="octicon octicon-copy js-clipboard-copy-icon" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path>
</svg>
<svg aria-hidden="true" class="octicon octicon-check js-clipboard-check-icon color-fg-success d-none" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"></path>
</svg>
</clipboard-copy>
</div></div>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto" tabindex="-1">config</h2><a aria-label="Permalink: config" class="anchor" href="#config" id="user-content-config"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto"><pre class="notranslate"><code># CONFIG_RISCV_M_MODE not set
# CONFIG_SHADOW_CALL_STACK not set
# CONFIG_RISCV_BOOT_SPINWAIT is not set
# CONFIG_XIP_KERNEL is not set
# CONFIG_BUILTIN_DTB is not set
CONFIG_MMU=y
# CONFIG_KASAN is not set
</code></pre><div class="zeroclipboard-container">
<clipboard-copy aria-label="Copy" class="ClipboardButton btn btn-invisible js-clipboard-copy m-2 p-0 d-flex flex-justify-center flex-items-center" data-copy-feedback="Copied!" data-tooltip-direction="w" role="button" tabindex="0" value="# CONFIG_RISCV_M_MODE not set
# CONFIG_SHADOW_CALL_STACK not set
# CONFIG_RISCV_BOOT_SPINWAIT is not set
# CONFIG_XIP_KERNEL is not set
# CONFIG_BUILTIN_DTB is not set
CONFIG_MMU=y
# CONFIG_KASAN is not set">
<svg aria-hidden="true" class="octicon octicon-copy js-clipboard-copy-icon" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path>
</svg>
<svg aria-hidden="true" class="octicon octicon-check js-clipboard-check-icon color-fg-success d-none" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"></path>
</svg>
</clipboard-copy>
</div></div>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto" tabindex="-1">_start_kernel</h2><a aria-label="Permalink: _start_kernel" class="anchor" href="#_start_kernel" id="user-content-_start_kernel"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">_start_kernel 在 call start_kernel 之前，把 stvec 设置为 <code>handle_exception</code>。</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto"><pre class="notranslate"><code>// arch/riscv/kernel/head.S

SYM_CODE_START(_start_kernel)
	/* Mask all interrupts */
	csrw CSR_IE, zero
	csrw CSR_IP, zero

	/* Enable time CSR */
	li t0, 0x2
	csrw CSR_SCOUNTEREN, t0

  	/* Load the global pointer */
	load_global_pointer		// 见下

	/*
	 * Disable FPU &amp; VECTOR to detect illegal usage of
	 * floating point or vector in kernel space
	 */
	li t0, SR_FS_VS
	csrc CSR_STATUS, t0

  	/* Clear BSS for flat non-ELF images */
	la a3, __bss_start
	la a4, __bss_stop
	ble a4, a3, .Lclear_bss_done
.Lclear_bss:
	REG_S zero, (a3)
	add a3, a3, RISCV_SZPTR
	blt a3, a4, .Lclear_bss
.Lclear_bss_done:

	la a2, boot_cpu_hartid
	XIP_FIXUP_OFFSET a2		// 见下
	REG_S a0, (a2)

	/* Initialize page tables and relocate to virtual addresses */
	la tp, init_task
	la sp, init_thread_union + THREAD_SIZE
	XIP_FIXUP_OFFSET sp		// 见下
	addi sp, sp, -PT_SIZE_ON_STACK
	scs_load_init_stack		// 见下

	mv a0, a1

	/* Set trap vector to spin forever to help debug */
	la a3, .Lsecondary_park		// 见下
	csrw CSR_TVEC, a3		// 重点关注，设置 stvec
	call setup_vm

  	la a0, early_pg_dir
	XIP_FIXUP_OFFSET a0		// 见下
	call relocate_enable_mmu

  	call .Lsetup_trap_vector	// 见下
	/* Restore C environment */
	la tp, init_task
	la sp, init_thread_union + THREAD_SIZE
	addi sp, sp, -PT_SIZE_ON_STACK
	scs_load_current		// 见下

  	/* Start the kernel */
	call soc_early_init
	tail start_kernel

SYM_CODE_END(_start_kernel)
</code></pre><div class="zeroclipboard-container">
<clipboard-copy aria-label="Copy" class="ClipboardButton btn btn-invisible js-clipboard-copy m-2 p-0 d-flex flex-justify-center flex-items-center" data-copy-feedback="Copied!" data-tooltip-direction="w" role="button" tabindex="0" value="// arch/riscv/kernel/head.S

SYM_CODE_START(_start_kernel)
	/* Mask all interrupts */
	csrw CSR_IE, zero
	csrw CSR_IP, zero

	/* Enable time CSR */
	li t0, 0x2
	csrw CSR_SCOUNTEREN, t0

  	/* Load the global pointer */
	load_global_pointer		// 见下

	/*
	 * Disable FPU &amp; VECTOR to detect illegal usage of
	 * floating point or vector in kernel space
	 */
	li t0, SR_FS_VS
	csrc CSR_STATUS, t0

  	/* Clear BSS for flat non-ELF images */
	la a3, __bss_start
	la a4, __bss_stop
	ble a4, a3, .Lclear_bss_done
.Lclear_bss:
	REG_S zero, (a3)
	add a3, a3, RISCV_SZPTR
	blt a3, a4, .Lclear_bss
.Lclear_bss_done:

	la a2, boot_cpu_hartid
	XIP_FIXUP_OFFSET a2		// 见下
	REG_S a0, (a2)

	/* Initialize page tables and relocate to virtual addresses */
	la tp, init_task
	la sp, init_thread_union + THREAD_SIZE
	XIP_FIXUP_OFFSET sp		// 见下
	addi sp, sp, -PT_SIZE_ON_STACK
	scs_load_init_stack		// 见下

	mv a0, a1

	/* Set trap vector to spin forever to help debug */
	la a3, .Lsecondary_park		// 见下
	csrw CSR_TVEC, a3		// 重点关注，设置 stvec
	call setup_vm

  	la a0, early_pg_dir
	XIP_FIXUP_OFFSET a0		// 见下
	call relocate_enable_mmu

  	call .Lsetup_trap_vector	// 见下
	/* Restore C environment */
	la tp, init_task
	la sp, init_thread_union + THREAD_SIZE
	addi sp, sp, -PT_SIZE_ON_STACK
	scs_load_current		// 见下

  	/* Start the kernel */
	call soc_early_init
	tail start_kernel

SYM_CODE_END(_start_kernel)">
<svg aria-hidden="true" class="octicon octicon-copy js-clipboard-copy-icon" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path>
</svg>
<svg aria-hidden="true" class="octicon octicon-check js-clipboard-check-icon color-fg-success d-none" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"></path>
</svg>
</clipboard-copy>
</div></div>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto" tabindex="-1">_start_kernel 辅助代码</h2><a aria-label="Permalink: _start_kernel 辅助代码" class="anchor" href="#_start_kernel-辅助代码" id="user-content-_start_kernel-辅助代码"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><code>load_global_pointer</code>：</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto"><pre class="notranslate"><code>// arch/riscv/include/asm/asm.h

#ifdef CONFIG_SHADOW_CALL_STACK
/* gp is used as the shadow call stack pointer instead */
.macro load_global_pointer
.endm
#else
/* load __global_pointer to gp */
.macro load_global_pointer
.option push
.option norelax
	la gp, __global_pointer$
.option pop
.endm
#endif /* CONFIG_SHADOW_CALL_STACK */
</code></pre><div class="zeroclipboard-container">
<clipboard-copy aria-label="Copy" class="ClipboardButton btn btn-invisible js-clipboard-copy m-2 p-0 d-flex flex-justify-center flex-items-center" data-copy-feedback="Copied!" data-tooltip-direction="w" role="button" tabindex="0" value="// arch/riscv/include/asm/asm.h

#ifdef CONFIG_SHADOW_CALL_STACK
/* gp is used as the shadow call stack pointer instead */
.macro load_global_pointer
.endm
#else
/* load __global_pointer to gp */
.macro load_global_pointer
.option push
.option norelax
	la gp, __global_pointer$
.option pop
.endm
#endif /* CONFIG_SHADOW_CALL_STACK */">
<svg aria-hidden="true" class="octicon octicon-copy js-clipboard-copy-icon" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path>
</svg>
<svg aria-hidden="true" class="octicon octicon-check js-clipboard-check-icon color-fg-success d-none" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"></path>
</svg>
</clipboard-copy>
</div></div>
<p dir="auto"><code>XIP_FIXUP_OFFSET</code>：</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto"><pre class="notranslate"><code>// arch/riscv/include/asm/xip_fixup.h

#ifdef CONFIG_XIP_KERNEL
.macro XIP_FIXUP_OFFSET reg
	/* Fix-up address in Flash into address in RAM early during boot before
	 * MMU is up. Because generated code "thinks" data is in Flash, but it
	 * is actually in RAM (actually data is also in Flash, but Flash is
	 * read-only, thus we need to use the data residing in RAM).
	 *
	 * The start of data in Flash is _sdata and the start of data in RAM is
	 * CONFIG_PHYS_RAM_BASE. So this fix-up essentially does this:
	 * reg += CONFIG_PHYS_RAM_BASE - _start
	 */
	li t0, CONFIG_PHYS_RAM_BASE
        add \reg, \reg, t0
	la t0, _sdata
	sub \reg, \reg, t0
.endm
#else
.macro XIP_FIXUP_OFFSET reg
.endm
#endif /* CONFIG_XIP_KERNEL */
</code></pre><div class="zeroclipboard-container">
<clipboard-copy aria-label="Copy" class="ClipboardButton btn btn-invisible js-clipboard-copy m-2 p-0 d-flex flex-justify-center flex-items-center" data-copy-feedback="Copied!" data-tooltip-direction="w" role="button" tabindex="0" value='// arch/riscv/include/asm/xip_fixup.h

#ifdef CONFIG_XIP_KERNEL
.macro XIP_FIXUP_OFFSET reg
	/* Fix-up address in Flash into address in RAM early during boot before
	 * MMU is up. Because generated code "thinks" data is in Flash, but it
	 * is actually in RAM (actually data is also in Flash, but Flash is
	 * read-only, thus we need to use the data residing in RAM).
	 *
	 * The start of data in Flash is _sdata and the start of data in RAM is
	 * CONFIG_PHYS_RAM_BASE. So this fix-up essentially does this:
	 * reg += CONFIG_PHYS_RAM_BASE - _start
	 */
	li t0, CONFIG_PHYS_RAM_BASE
        add \reg, \reg, t0
	la t0, _sdata
	sub \reg, \reg, t0
.endm
#else
.macro XIP_FIXUP_OFFSET reg
.endm
#endif /* CONFIG_XIP_KERNEL */'>
<svg aria-hidden="true" class="octicon octicon-copy js-clipboard-copy-icon" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path>
</svg>
<svg aria-hidden="true" class="octicon octicon-check js-clipboard-check-icon color-fg-success d-none" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"></path>
</svg>
</clipboard-copy>
</div></div>
<p dir="auto"><code>scs_load_init_stack</code> <code>scs_load_current</code>：</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto"><pre class="notranslate"><code>// arch/riscv/include/asm/scs.h

#ifdef CONFIG_SHADOW_CALL_STACK

/* Load init_shadow_call_stack to gp. */
.macro scs_load_init_stack
	la	gp, init_shadow_call_stack
	XIP_FIXUP_OFFSET gp
.endm

/* Load task_scs_sp(current) to gp. */
.macro scs_load_current
	REG_L	gp, TASK_TI_SCS_SP(tp)
.endm

#else /* CONFIG_SHADOW_CALL_STACK */

.macro scs_load_init_stack
.endm

.macro scs_load_current
.endm

#endif /* CONFIG_SHADOW_CALL_STACK */
</code></pre><div class="zeroclipboard-container">
<clipboard-copy aria-label="Copy" class="ClipboardButton btn btn-invisible js-clipboard-copy m-2 p-0 d-flex flex-justify-center flex-items-center" data-copy-feedback="Copied!" data-tooltip-direction="w" role="button" tabindex="0" value="// arch/riscv/include/asm/scs.h

#ifdef CONFIG_SHADOW_CALL_STACK

/* Load init_shadow_call_stack to gp. */
.macro scs_load_init_stack
	la	gp, init_shadow_call_stack
	XIP_FIXUP_OFFSET gp
.endm

/* Load task_scs_sp(current) to gp. */
.macro scs_load_current
	REG_L	gp, TASK_TI_SCS_SP(tp)
.endm

#else /* CONFIG_SHADOW_CALL_STACK */

.macro scs_load_init_stack
.endm

.macro scs_load_current
.endm

#endif /* CONFIG_SHADOW_CALL_STACK */">
<svg aria-hidden="true" class="octicon octicon-copy js-clipboard-copy-icon" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path>
</svg>
<svg aria-hidden="true" class="octicon octicon-check js-clipboard-check-icon color-fg-success d-none" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"></path>
</svg>
</clipboard-copy>
</div></div>
<p dir="auto"><code>.Lsecondary_park</code>：</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto"><pre class="notranslate"><code>// arch/riscv/kernel/head.S

.Lsecondary_park:
	/*
	 * Park this hart if we:
	 *  - have too many harts on CONFIG_RISCV_BOOT_SPINWAIT
	 *  - receive an early trap, before setup_trap_vector finished
	 *  - fail in smp_callin(), as a successful one wouldn't return
	 */
	wfi
	j .Lsecondary_park
</code></pre><div class="zeroclipboard-container">
<clipboard-copy aria-label="Copy" class="ClipboardButton btn btn-invisible js-clipboard-copy m-2 p-0 d-flex flex-justify-center flex-items-center" data-copy-feedback="Copied!" data-tooltip-direction="w" role="button" tabindex="0" value="// arch/riscv/kernel/head.S

.Lsecondary_park:
	/*
	 * Park this hart if we:
	 *  - have too many harts on CONFIG_RISCV_BOOT_SPINWAIT
	 *  - receive an early trap, before setup_trap_vector finished
	 *  - fail in smp_callin(), as a successful one wouldn't return
	 */
	wfi
	j .Lsecondary_park">
<svg aria-hidden="true" class="octicon octicon-copy js-clipboard-copy-icon" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path>
</svg>
<svg aria-hidden="true" class="octicon octicon-check js-clipboard-check-icon color-fg-success d-none" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"></path>
</svg>
</clipboard-copy>
</div></div>
<p dir="auto"><code>.Lsetup_trap_vector</code> 把 stvec 设置成 handle_exception。</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto"><pre class="notranslate"><code>// arch/riscv/kernel/head.S

.Lsetup_trap_vector:
	/* Set trap vector to exception handler */
	la a0, handle_exception
	csrw CSR_TVEC, a0

	/*
	 * Set sup0 scratch register to 0, indicating to exception vector that
	 * we are presently executing in kernel.
	 */
	csrw CSR_SCRATCH, zero
	ret
</code></pre><div class="zeroclipboard-container">
<clipboard-copy aria-label="Copy" class="ClipboardButton btn btn-invisible js-clipboard-copy m-2 p-0 d-flex flex-justify-center flex-items-center" data-copy-feedback="Copied!" data-tooltip-direction="w" role="button" tabindex="0" value="// arch/riscv/kernel/head.S

.Lsetup_trap_vector:
	/* Set trap vector to exception handler */
	la a0, handle_exception
	csrw CSR_TVEC, a0

	/*
	 * Set sup0 scratch register to 0, indicating to exception vector that
	 * we are presently executing in kernel.
	 */
	csrw CSR_SCRATCH, zero
	ret">
<svg aria-hidden="true" class="octicon octicon-copy js-clipboard-copy-icon" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path>
</svg>
<svg aria-hidden="true" class="octicon octicon-check js-clipboard-check-icon color-fg-success d-none" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"></path>
</svg>
</clipboard-copy>
</div></div>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto" tabindex="-1">start_kernel</h2><a aria-label="Permalink: start_kernel" class="anchor" href="#start_kernel" id="user-content-start_kernel"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<div class="highlight highlight-source-c notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-c">// init/main.c</span>

<span class="pl-smi">asmlinkage</span> <span class="pl-s1">__visible</span> <span class="pl-smi">__init</span> <span class="pl-s1">__no_sanitize_address</span> <span class="pl-smi">__noreturn</span> <span class="pl-s1">__no_stack_protector</span>
<span class="pl-smi">void</span> <span class="pl-en">start_kernel</span>(<span class="pl-smi">void</span>)
{
	...
	<span class="pl-en">setup_arch</span>(<span class="pl-c1">&amp;</span><span class="pl-s1">command_line</span>);
	<span class="pl-c">/* Static keys and static calls are needed by LSMs */</span>
	<span class="pl-en">jump_label_init</span>();
	<span class="pl-en">static_call_init</span>();
	...
	<span class="pl-en">trap_init</span>();
	...
	<span class="pl-c">/* init some links before init_ISA_irqs() */</span>
	<span class="pl-en">early_irq_init</span>();
	<span class="pl-en">init_IRQ</span>();
	<span class="pl-en">tick_init</span>();
	<span class="pl-en">rcu_init_nohz</span>();
	<span class="pl-en">timers_init</span>();
	<span class="pl-en">srcu_init</span>();
	<span class="pl-en">hrtimers_init</span>();
	<span class="pl-en">softirq_init</span>();
	<span class="pl-en">timekeeping_init</span>();
	<span class="pl-en">time_init</span>();
	...
	<span class="pl-en">arch_cpu_finalize_init</span>();
	...
	<span class="pl-en">rest_init</span>();
}</pre><div class="zeroclipboard-container">
<clipboard-copy aria-label="Copy" class="ClipboardButton btn btn-invisible js-clipboard-copy m-2 p-0 d-flex flex-justify-center flex-items-center" data-copy-feedback="Copied!" data-tooltip-direction="w" role="button" tabindex="0" value="// init/main.c

asmlinkage __visible __init __no_sanitize_address __noreturn __no_stack_protector
void start_kernel(void)
{
	...
	setup_arch(&amp;command_line);
	/* Static keys and static calls are needed by LSMs */
	jump_label_init();
	static_call_init();
	...
	trap_init();
	...
	/* init some links before init_ISA_irqs() */
	early_irq_init();
	init_IRQ();
	tick_init();
	rcu_init_nohz();
	timers_init();
	srcu_init();
	hrtimers_init();
	softirq_init();
	timekeeping_init();
	time_init();
	...
	arch_cpu_finalize_init();
	...
	rest_init();
}">
<svg aria-hidden="true" class="octicon octicon-copy js-clipboard-copy-icon" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path>
</svg>
<svg aria-hidden="true" class="octicon octicon-check js-clipboard-check-icon color-fg-success d-none" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"></path>
</svg>
</clipboard-copy>
</div></div>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto" tabindex="-1">start_kernel 辅助函数</h2><a aria-label="Permalink: start_kernel 辅助函数" class="anchor" href="#start_kernel-辅助函数" id="user-content-start_kernel-辅助函数"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto" tabindex="-1">setup_arch</h3><a aria-label="Permalink: setup_arch" class="anchor" href="#setup_arch" id="user-content-setup_arch"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<div class="markdown-heading" dir="auto"><h4 class="heading-element" dir="auto" tabindex="-1">setup_arch 函数</h4><a aria-label="Permalink: setup_arch 函数" class="anchor" href="#setup_arch-函数" id="user-content-setup_arch-函数"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<div class="highlight highlight-source-c notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-c">// arch/riscv/kernel/setup.c</span>

<span class="pl-smi">void</span> <span class="pl-s1">__init</span> <span class="pl-en">setup_arch</span>(<span class="pl-smi">char</span> <span class="pl-c1">*</span><span class="pl-c1">*</span><span class="pl-s1">cmdline_p</span>)
{
	<span class="pl-en">parse_dtb</span>();
	<span class="pl-en">setup_initial_init_mm</span>(<span class="pl-s1">_stext</span>, <span class="pl-s1">_etext</span>, <span class="pl-s1">_edata</span>, <span class="pl-s1">_end</span>);

	<span class="pl-c1">*</span><span class="pl-s1">cmdline_p</span> <span class="pl-c1">=</span> <span class="pl-s1">boot_command_line</span>;

	<span class="pl-en">early_ioremap_setup</span>();
	<span class="pl-en">sbi_init</span>();
	<span class="pl-en">jump_label_init</span>();
	<span class="pl-en">parse_early_param</span>();

	<span class="pl-en">efi_init</span>();
	<span class="pl-en">paging_init</span>();

	<span class="pl-c">/* Parse the ACPI tables for possible boot-time configuration */</span>
	<span class="pl-en">acpi_boot_table_init</span>();

<span class="pl-k">#if</span> <span class="pl-en">IS_ENABLED</span>(<span class="pl-c1">CONFIG_BUILTIN_DTB</span>)
	<span class="pl-en">unflatten_and_copy_device_tree</span>();
<span class="pl-k">#else</span>
	<span class="pl-en">unflatten_device_tree</span>();
<span class="pl-k">#endif</span>
	<span class="pl-en">misc_mem_init</span>();

	<span class="pl-en">init_resources</span>();

<span class="pl-k">#ifdef</span> <span class="pl-c1">CONFIG_KASAN</span>
	<span class="pl-en">kasan_init</span>();
<span class="pl-k">#endif</span>

<span class="pl-k">#ifdef</span> <span class="pl-c1">CONFIG_SMP</span>
	<span class="pl-en">setup_smp</span>();
<span class="pl-k">#endif</span>

	<span class="pl-k">if</span> (!<span class="pl-s1">acpi_disabled</span>) {
		<span class="pl-en">acpi_init_rintc_map</span>();
		<span class="pl-en">acpi_map_cpus_to_nodes</span>();
	}

	<span class="pl-en">riscv_init_cbo_blocksizes</span>();
	<span class="pl-en">riscv_fill_hwcap</span>();
	<span class="pl-en">apply_boot_alternatives</span>();
	<span class="pl-en">init_rt_signal_env</span>();

	<span class="pl-k">if</span> (<span class="pl-en">IS_ENABLED</span>(<span class="pl-c1">CONFIG_RISCV_ISA_ZICBOM</span>) <span class="pl-c1">&amp;&amp;</span>
	    <span class="pl-en">riscv_isa_extension_available</span>(<span class="pl-c1">NULL</span>, <span class="pl-c1">ZICBOM</span>))
		<span class="pl-en">riscv_noncoherent_supported</span>();
	<span class="pl-en">riscv_set_dma_cache_alignment</span>();

	<span class="pl-en">riscv_user_isa_enable</span>();
	<span class="pl-en">riscv_spinlock_init</span>();
}</pre><div class="zeroclipboard-container">
<clipboard-copy aria-label="Copy" class="ClipboardButton btn btn-invisible js-clipboard-copy m-2 p-0 d-flex flex-justify-center flex-items-center" data-copy-feedback="Copied!" data-tooltip-direction="w" role="button" tabindex="0" value="// arch/riscv/kernel/setup.c

void __init setup_arch(char **cmdline_p)
{
	parse_dtb();
	setup_initial_init_mm(_stext, _etext, _edata, _end);

	*cmdline_p = boot_command_line;

	early_ioremap_setup();
	sbi_init();
	jump_label_init();
	parse_early_param();

	efi_init();
	paging_init();

	/* Parse the ACPI tables for possible boot-time configuration */
	acpi_boot_table_init();

#if IS_ENABLED(CONFIG_BUILTIN_DTB)
	unflatten_and_copy_device_tree();
#else
	unflatten_device_tree();
#endif
	misc_mem_init();

	init_resources();

#ifdef CONFIG_KASAN
	kasan_init();
#endif

#ifdef CONFIG_SMP
	setup_smp();
#endif

	if (!acpi_disabled) {
		acpi_init_rintc_map();
		acpi_map_cpus_to_nodes();
	}

	riscv_init_cbo_blocksizes();
	riscv_fill_hwcap();
	apply_boot_alternatives();
	init_rt_signal_env();

	if (IS_ENABLED(CONFIG_RISCV_ISA_ZICBOM) &amp;&amp;
	    riscv_isa_extension_available(NULL, ZICBOM))
		riscv_noncoherent_supported();
	riscv_set_dma_cache_alignment();

	riscv_user_isa_enable();
	riscv_spinlock_init();
}">
<svg aria-hidden="true" class="octicon octicon-copy js-clipboard-copy-icon" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path>
</svg>
<svg aria-hidden="true" class="octicon octicon-check js-clipboard-check-icon color-fg-success d-none" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"></path>
</svg>
</clipboard-copy>
</div></div>
<div class="markdown-heading" dir="auto"><h4 class="heading-element" dir="auto" tabindex="-1">辅助函数 parse_dtb（设备树）</h4><a aria-label="Permalink: 辅助函数 parse_dtb（设备树）" class="anchor" href="#辅助函数-parse_dtb设备树" id="user-content-辅助函数-parse_dtb设备树"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><code>drivers/of/fdt.c:early_init_dt_scan</code> verifies the DTB header is valid and scans it for basic information like memory layout and the kernel command line. It returns true if a valid DTB was found and processed, and false otherwise.</p>
<p dir="auto"><code>drivers/of/fdt.c:of_flat_dt_get_machine_name()</code> read the machine's name from the DTB. It looks for the <code>model</code> or <code>compatible</code> property in the root node.</p>
<div class="highlight highlight-source-c notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-c">// arch/riscv/kernel/setup.c</span>

<span class="pl-k">static</span> <span class="pl-smi">void</span> <span class="pl-s1">__init</span> <span class="pl-en">parse_dtb</span>(<span class="pl-smi">void</span>)
{
	<span class="pl-c">/* Early scan of device tree from init memory */</span>
	<span class="pl-k">if</span> (<span class="pl-en">early_init_dt_scan</span>(<span class="pl-s1">dtb_early_va</span>, <span class="pl-s1">dtb_early_pa</span>)) {
		<span class="pl-k">const</span> <span class="pl-smi">char</span> <span class="pl-c1">*</span><span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-en">of_flat_dt_get_machine_name</span>();

		<span class="pl-k">if</span> (<span class="pl-s1">name</span>) {
			<span class="pl-en">pr_info</span>(<span class="pl-s">"Machine model: %s\n"</span>, <span class="pl-s1">name</span>);
			<span class="pl-en">dump_stack_set_arch_desc</span>(<span class="pl-s">"%s (DT)"</span>, <span class="pl-s1">name</span>);
		}
	} <span class="pl-k">else</span> {
		<span class="pl-en">pr_err</span>(<span class="pl-s">"No DTB passed to the kernel\n"</span>);
	}
}</pre><div class="zeroclipboard-container">
<clipboard-copy aria-label="Copy" class="ClipboardButton btn btn-invisible js-clipboard-copy m-2 p-0 d-flex flex-justify-center flex-items-center" data-copy-feedback="Copied!" data-tooltip-direction="w" role="button" tabindex="0" value='// arch/riscv/kernel/setup.c

static void __init parse_dtb(void)
{
	/* Early scan of device tree from init memory */
	if (early_init_dt_scan(dtb_early_va, dtb_early_pa)) {
		const char *name = of_flat_dt_get_machine_name();

		if (name) {
			pr_info("Machine model: %s\n", name);
			dump_stack_set_arch_desc("%s (DT)", name);
		}
	} else {
		pr_err("No DTB passed to the kernel\n");
	}
}'>
<svg aria-hidden="true" class="octicon octicon-copy js-clipboard-copy-icon" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path>
</svg>
<svg aria-hidden="true" class="octicon octicon-check js-clipboard-check-icon color-fg-success d-none" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"></path>
</svg>
</clipboard-copy>
</div></div>
<p dir="auto">输出：</p>
<p dir="auto"><code>[    0.000000] Machine model: riscv-virtio,qemu</code></p>
<div class="markdown-heading" dir="auto"><h4 class="heading-element" dir="auto" tabindex="-1">辅助函数 unflatten_device_tree（设备树）</h4><a aria-label="Permalink: 辅助函数 unflatten_device_tree（设备树）" class="anchor" href="#辅助函数-unflatten_device_tree设备树" id="user-content-辅助函数-unflatten_device_tree设备树"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><code>drivers/of/fdt.c:unflatten_device_tree</code> unflattens the device-tree passed by the firmware, creating the tree of <code>struct device_node</code>. It also fills the "name" and "type" pointers of the nodes so the normal device-tree walking functions can be used.</p>
<p dir="auto">这一步比较重要，把整个 dtb 转化为内核中的数据结构。</p>
<div class="markdown-heading" dir="auto"><h4 class="heading-element" dir="auto" tabindex="-1">辅助函数 setup_smp（SMP）</h4><a aria-label="Permalink: 辅助函数 setup_smp（SMP）" class="anchor" href="#辅助函数-setup_smpsmp" id="user-content-辅助函数-setup_smpsmp"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<div class="highlight highlight-source-c notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-c">// arch/riscv/kernel/smpboot.c</span>

<span class="pl-smi">void</span> <span class="pl-s1">__init</span> <span class="pl-en">setup_smp</span>(<span class="pl-smi">void</span>)
{
	<span class="pl-smi">int</span> <span class="pl-s1">cpuid</span>;

	<span class="pl-en">cpu_set_ops</span>();	<span class="pl-c">// 把 cpu_ops 设置为 cpu_ops_sbi</span>

	<span class="pl-k">if</span> (<span class="pl-s1">acpi_disabled</span>)
  		<span class="pl-c">// 主要在 physical hart id 和 cpuid 之间建立联系</span>
		<span class="pl-en">of_parse_and_init_cpus</span>();
	<span class="pl-k">else</span>
		<span class="pl-en">acpi_parse_and_init_cpus</span>();

        <span class="pl-c">// mark as "possible" targets for subsequent SMP boot-up sequence</span>
	<span class="pl-k">for</span> (<span class="pl-s1">cpuid</span> <span class="pl-c1">=</span> <span class="pl-c1">1</span>; <span class="pl-s1">cpuid</span> <span class="pl-c1">&lt;</span> <span class="pl-s1">nr_cpu_ids</span>; <span class="pl-s1">cpuid</span><span class="pl-c1">++</span>)
		<span class="pl-k">if</span> (<span class="pl-en">cpuid_to_hartid_map</span>(<span class="pl-s1">cpuid</span>) <span class="pl-c1">!=</span> <span class="pl-c1">INVALID_HARTID</span>)
			<span class="pl-en">set_cpu_possible</span>(<span class="pl-s1">cpuid</span>, true);
}

<span class="pl-c">// arch/riscv/kernel/cpu_ops_sbi.c</span>

<span class="pl-k">const</span> <span class="pl-k">struct</span> <span class="pl-smi">cpu_operations</span> <span class="pl-s1">cpu_ops_sbi</span> <span class="pl-c1">=</span> {
	.<span class="pl-c1">cpu_start</span>	<span class="pl-c1">=</span> <span class="pl-s1">sbi_cpu_start</span>,
<span class="pl-k">#ifdef</span> <span class="pl-c1">CONFIG_HOTPLUG_CPU</span>
	.<span class="pl-c1">cpu_stop</span>	<span class="pl-c1">=</span> <span class="pl-s1">sbi_cpu_stop</span>,
	.<span class="pl-c1">cpu_is_stopped</span>	<span class="pl-c1">=</span> <span class="pl-s1">sbi_cpu_is_stopped</span>,
<span class="pl-k">#endif</span>

<span class="pl-c">// arch/riscv/kernel/cpu_ops.c</span>

<span class="pl-smi">void</span> <span class="pl-s1">__init</span> <span class="pl-en">cpu_set_ops</span>(<span class="pl-s1">void</span>)
{
<span class="pl-k">#if</span> <span class="pl-en">IS_ENABLED</span>(<span class="pl-c1">CONFIG_RISCV_SBI</span>)
	<span class="pl-en">if</span> (<span class="pl-en">sbi_probe_extension</span>(<span class="pl-c1">SBI_EXT_HSM</span>)) {
		<span class="pl-en">pr_info</span>(<span class="pl-s">"SBI HSM extension detected\n"</span>);
		<span class="pl-s1">cpu_ops</span> <span class="pl-c1">=</span> <span class="pl-c1">&amp;</span><span class="pl-s1">cpu_ops_sbi</span>;
	}
<span class="pl-k">#endif</span>
}</pre><div class="zeroclipboard-container">
<clipboard-copy aria-label="Copy" class="ClipboardButton btn btn-invisible js-clipboard-copy m-2 p-0 d-flex flex-justify-center flex-items-center" data-copy-feedback="Copied!" data-tooltip-direction="w" role="button" tabindex="0" value='// arch/riscv/kernel/smpboot.c

void __init setup_smp(void)
{
	int cpuid;

	cpu_set_ops();	// 把 cpu_ops 设置为 cpu_ops_sbi

	if (acpi_disabled)
  		// 主要在 physical hart id 和 cpuid 之间建立联系
		of_parse_and_init_cpus();
	else
		acpi_parse_and_init_cpus();

        // mark as "possible" targets for subsequent SMP boot-up sequence
	for (cpuid = 1; cpuid &lt; nr_cpu_ids; cpuid++)
		if (cpuid_to_hartid_map(cpuid) != INVALID_HARTID)
			set_cpu_possible(cpuid, true);
}

// arch/riscv/kernel/cpu_ops_sbi.c

const struct cpu_operations cpu_ops_sbi = {
	.cpu_start	= sbi_cpu_start,
#ifdef CONFIG_HOTPLUG_CPU
	.cpu_stop	= sbi_cpu_stop,
	.cpu_is_stopped	= sbi_cpu_is_stopped,
#endif

// arch/riscv/kernel/cpu_ops.c

void __init cpu_set_ops(void)
{
#if IS_ENABLED(CONFIG_RISCV_SBI)
	if (sbi_probe_extension(SBI_EXT_HSM)) {
		pr_info("SBI HSM extension detected\n");
		cpu_ops = &amp;cpu_ops_sbi;
	}
#endif
}'>
<svg aria-hidden="true" class="octicon octicon-copy js-clipboard-copy-icon" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path>
</svg>
<svg aria-hidden="true" class="octicon octicon-check js-clipboard-check-icon color-fg-success d-none" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"></path>
</svg>
</clipboard-copy>
</div></div>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto" tabindex="-1">trap_init</h3><a aria-label="Permalink: trap_init" class="anchor" href="#trap_init" id="user-content-trap_init"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">RISC-V 没有实现 <code>trap_init</code>。</p>
<div class="highlight highlight-source-c notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-c">// init/main.c</span>

<span class="pl-smi">void</span> <span class="pl-s1">__init</span> <span class="pl-smi">__weak</span> <span class="pl-en">trap_init</span>(<span class="pl-smi">void</span>) { }</pre><div class="zeroclipboard-container">
<clipboard-copy aria-label="Copy" class="ClipboardButton btn btn-invisible js-clipboard-copy m-2 p-0 d-flex flex-justify-center flex-items-center" data-copy-feedback="Copied!" data-tooltip-direction="w" role="button" tabindex="0" value="// init/main.c

void __init __weak trap_init(void) { }">
<svg aria-hidden="true" class="octicon octicon-copy js-clipboard-copy-icon" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path>
</svg>
<svg aria-hidden="true" class="octicon octicon-check js-clipboard-check-icon color-fg-success d-none" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"></path>
</svg>
</clipboard-copy>
</div></div>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto" tabindex="-1">early_irq_init</h3><a aria-label="Permalink: early_irq_init" class="anchor" href="#early_irq_init" id="user-content-early_irq_init"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<div class="highlight highlight-source-c notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-c">// kernel/irq/irqdesc.c</span>

<span class="pl-smi">int</span> <span class="pl-s1">__init</span> <span class="pl-en">early_irq_init</span>(<span class="pl-smi">void</span>)
{
	<span class="pl-smi">int</span> <span class="pl-s1">i</span>, <span class="pl-s1">initcnt</span>, <span class="pl-s1">node</span> <span class="pl-c1">=</span> <span class="pl-s1">first_online_node</span>;
	<span class="pl-k">struct</span> <span class="pl-smi">irq_desc</span> <span class="pl-c1">*</span><span class="pl-s1">desc</span>;

	<span class="pl-en">init_irq_default_affinity</span>();	<span class="pl-c">// 默认每个 CPU 都可以处理中断</span>

	<span class="pl-c">/* Let arch update nr_irqs and return the nr of preallocated irqs */</span>
	<span class="pl-s1">initcnt</span> <span class="pl-c1">=</span> <span class="pl-en">arch_probe_nr_irqs</span>();	<span class="pl-c">// RISC-V 没有实现，默认实现返回 0</span>
	<span class="pl-en">printk</span>(<span class="pl-c1">KERN_INFO</span> <span class="pl-s">"NR_IRQS: %d, nr_irqs: %d, preallocated irqs: %d\n"</span>,
	       <span class="pl-c1">NR_IRQS</span>, <span class="pl-s1">nr_irqs</span>, <span class="pl-s1">initcnt</span>);

	<span class="pl-k">if</span> (<span class="pl-en">WARN_ON</span>(<span class="pl-s1">nr_irqs</span> <span class="pl-c1">&gt;</span> <span class="pl-c1">MAX_SPARSE_IRQS</span>))
		<span class="pl-s1">nr_irqs</span> <span class="pl-c1">=</span> <span class="pl-c1">MAX_SPARSE_IRQS</span>;

	<span class="pl-k">if</span> (<span class="pl-en">WARN_ON</span>(<span class="pl-s1">initcnt</span> <span class="pl-c1">&gt;</span> <span class="pl-c1">MAX_SPARSE_IRQS</span>))
		<span class="pl-s1">initcnt</span> <span class="pl-c1">=</span> <span class="pl-c1">MAX_SPARSE_IRQS</span>;

	<span class="pl-k">if</span> (<span class="pl-s1">initcnt</span> <span class="pl-c1">&gt;</span> <span class="pl-s1">nr_irqs</span>)
		<span class="pl-s1">nr_irqs</span> <span class="pl-c1">=</span> <span class="pl-s1">initcnt</span>;

	<span class="pl-k">for</span> (<span class="pl-s1">i</span> <span class="pl-c1">=</span> <span class="pl-c1">0</span>; <span class="pl-s1">i</span> <span class="pl-c1">&lt;</span> <span class="pl-s1">initcnt</span>; <span class="pl-s1">i</span><span class="pl-c1">++</span>) {
		<span class="pl-s1">desc</span> <span class="pl-c1">=</span> <span class="pl-en">alloc_desc</span>(<span class="pl-s1">i</span>, <span class="pl-s1">node</span>, <span class="pl-c1">0</span>, <span class="pl-c1">NULL</span>, <span class="pl-c1">NULL</span>);
		<span class="pl-en">irq_insert_desc</span>(<span class="pl-s1">i</span>, <span class="pl-s1">desc</span>);
	}
	<span class="pl-k">return</span> <span class="pl-en">arch_early_irq_init</span>();	<span class="pl-c">// RISC-V 没有实现，默认实现返回 0</span>
}</pre><div class="zeroclipboard-container">
<clipboard-copy aria-label="Copy" class="ClipboardButton btn btn-invisible js-clipboard-copy m-2 p-0 d-flex flex-justify-center flex-items-center" data-copy-feedback="Copied!" data-tooltip-direction="w" role="button" tabindex="0" value='// kernel/irq/irqdesc.c

int __init early_irq_init(void)
{
	int i, initcnt, node = first_online_node;
	struct irq_desc *desc;

	init_irq_default_affinity();	// 默认每个 CPU 都可以处理中断

	/* Let arch update nr_irqs and return the nr of preallocated irqs */
	initcnt = arch_probe_nr_irqs();	// RISC-V 没有实现，默认实现返回 0
	printk(KERN_INFO "NR_IRQS: %d, nr_irqs: %d, preallocated irqs: %d\n",
	       NR_IRQS, nr_irqs, initcnt);

	if (WARN_ON(nr_irqs &gt; MAX_SPARSE_IRQS))
		nr_irqs = MAX_SPARSE_IRQS;

	if (WARN_ON(initcnt &gt; MAX_SPARSE_IRQS))
		initcnt = MAX_SPARSE_IRQS;

	if (initcnt &gt; nr_irqs)
		nr_irqs = initcnt;

	for (i = 0; i &lt; initcnt; i++) {
		desc = alloc_desc(i, node, 0, NULL, NULL);
		irq_insert_desc(i, desc);
	}
	return arch_early_irq_init();	// RISC-V 没有实现，默认实现返回 0
}'>
<svg aria-hidden="true" class="octicon octicon-copy js-clipboard-copy-icon" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path>
</svg>
<svg aria-hidden="true" class="octicon octicon-check js-clipboard-check-icon color-fg-success d-none" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"></path>
</svg>
</clipboard-copy>
</div></div>
<p dir="auto">输出：<code>[    0.000000] NR_IRQS: 64, nr_irqs: 64, preallocated irqs: 0</code></p>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto" tabindex="-1">init_IRQ</h3><a aria-label="Permalink: init_IRQ" class="anchor" href="#init_irq" id="user-content-init_irq"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<div class="markdown-heading" dir="auto"><h4 class="heading-element" dir="auto" tabindex="-1">init_IRQ 函数</h4><a aria-label="Permalink: init_IRQ 函数" class="anchor" href="#init_irq-函数" id="user-content-init_irq-函数"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">注意 <code>handle_arch_irq</code> 这个变量和 <code>set_handle_irq</code> 这个函数。</p>
<div class="highlight highlight-source-c notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-c">// arch/riscv/kernel/irq.c</span>

<span class="pl-smi">void</span> <span class="pl-s1">__init</span> <span class="pl-en">init_IRQ</span>(<span class="pl-smi">void</span>)
{
	<span class="pl-en">init_irq_scs</span>();
	<span class="pl-en">init_irq_stacks</span>();
	<span class="pl-en">irqchip_init</span>(); <span class="pl-c">// irqchip_init 中会设置好 handle_arch_irq</span>
	<span class="pl-k">if</span> (!<span class="pl-s1">handle_arch_irq</span>)
		<span class="pl-en">panic</span>(<span class="pl-s">"No interrupt controller found."</span>);
	<span class="pl-en">sbi_ipi_init</span>();
}</pre><div class="zeroclipboard-container">
<clipboard-copy aria-label="Copy" class="ClipboardButton btn btn-invisible js-clipboard-copy m-2 p-0 d-flex flex-justify-center flex-items-center" data-copy-feedback="Copied!" data-tooltip-direction="w" role="button" tabindex="0" value='// arch/riscv/kernel/irq.c

void __init init_IRQ(void)
{
	init_irq_scs();
	init_irq_stacks();
	irqchip_init(); // irqchip_init 中会设置好 handle_arch_irq
	if (!handle_arch_irq)
		panic("No interrupt controller found.");
	sbi_ipi_init();
}'>
<svg aria-hidden="true" class="octicon octicon-copy js-clipboard-copy-icon" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path>
</svg>
<svg aria-hidden="true" class="octicon octicon-check js-clipboard-check-icon color-fg-success d-none" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"></path>
</svg>
</clipboard-copy>
</div></div>
<div class="markdown-heading" dir="auto"><h4 class="heading-element" dir="auto" tabindex="-1">辅助函数 irqchip_init/of_irq_init</h4><a aria-label="Permalink: 辅助函数 irqchip_init/of_irq_init" class="anchor" href="#辅助函数-irqchip_initof_irq_init" id="user-content-辅助函数-irqchip_initof_irq_init"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<div class="highlight highlight-source-c notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-c">// include/linux/mod_devicetable.h</span>

<span class="pl-c">/*</span>
<span class="pl-c"> * Struct used for matching a device</span>
<span class="pl-c"> */</span>
<span class="pl-k">struct</span> <span class="pl-smi">of_device_id</span> {
	<span class="pl-smi">char</span>	<span class="pl-c1">name</span>[<span class="pl-c1">32</span>];
	<span class="pl-smi">char</span>	<span class="pl-c1">type</span>[<span class="pl-c1">32</span>];
	<span class="pl-smi">char</span>	<span class="pl-c1">compatible</span>[<span class="pl-c1">128</span>];
	<span class="pl-k">const</span> <span class="pl-smi">void</span> <span class="pl-c1">*</span><span class="pl-c1">data</span>;
};

<span class="pl-c">// drivers/irqchip/irqchip.c</span>

<span class="pl-k">extern</span> <span class="pl-k">struct</span> <span class="pl-smi">of_device_id</span> <span class="pl-s1">__irqchip_of_table</span>[];

<span class="pl-smi">void</span> <span class="pl-s1">__init</span> <span class="pl-en">irqchip_init</span>(<span class="pl-smi">void</span>)
{
	<span class="pl-en">of_irq_init</span>(<span class="pl-s1">__irqchip_of_table</span>);  <span class="pl-c">// 只有这个函数起作用</span>
	<span class="pl-en">acpi_probe_device_table</span>(<span class="pl-s1">irqchip</span>);
}</pre><div class="zeroclipboard-container">
<clipboard-copy aria-label="Copy" class="ClipboardButton btn btn-invisible js-clipboard-copy m-2 p-0 d-flex flex-justify-center flex-items-center" data-copy-feedback="Copied!" data-tooltip-direction="w" role="button" tabindex="0" value="// include/linux/mod_devicetable.h

/*
 * Struct used for matching a device
 */
struct of_device_id {
	char	name[32];
	char	type[32];
	char	compatible[128];
	const void *data;
};

// drivers/irqchip/irqchip.c

extern struct of_device_id __irqchip_of_table[];

void __init irqchip_init(void)
{
	of_irq_init(__irqchip_of_table);  // 只有这个函数起作用
	acpi_probe_device_table(irqchip);
}">
<svg aria-hidden="true" class="octicon octicon-copy js-clipboard-copy-icon" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path>
</svg>
<svg aria-hidden="true" class="octicon octicon-check js-clipboard-check-icon color-fg-success d-none" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"></path>
</svg>
</clipboard-copy>
</div></div>
<p dir="auto">首先，和中断控制器有关的驱动源代码中使用 <code>IRQCHIP_DECLARE</code>，定义 <code>struct of_device_id</code> 变量，<code>struct of_device_id</code> 的 <code>data</code> 为初始化函数指针。如：</p>
<div class="highlight highlight-source-c notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-c">// drivers/irqchip/irq-riscv-intc.c</span>

<span class="pl-en">IRQCHIP_DECLARE</span>(<span class="pl-s1">riscv</span>, <span class="pl-s">"riscv,cpu-intc"</span>, <span class="pl-s1">riscv_intc_init</span>);

<span class="pl-k">static</span> <span class="pl-k">const</span> <span class="pl-k">struct</span> <span class="pl-smi">of_device_id</span> <span class="pl-s1">__of_table_riscv</span>
<span class="pl-en">__attribute__</span>(<span class="pl-s1">__used__</span>)
__attribute__(<span class="pl-s1">__section__</span>("<span class="pl-s1">__irqchip_of_table</span>"))
__attribute__((<span class="pl-en">__aligned__</span>(__alignof__(<span class="pl-k">struct</span> <span class="pl-smi">of_device_id</span>)))) <span class="pl-c1">=</span> {
    .<span class="pl-s1">compatible</span> <span class="pl-c1">=</span> <span class="pl-s">"riscv,cpu-intc"</span>,
    .<span class="pl-c1">data</span> <span class="pl-c1">=</span> <span class="pl-s1">riscv_intc_init</span>
}</pre><div class="zeroclipboard-container">
<clipboard-copy aria-label="Copy" class="ClipboardButton btn btn-invisible js-clipboard-copy m-2 p-0 d-flex flex-justify-center flex-items-center" data-copy-feedback="Copied!" data-tooltip-direction="w" role="button" tabindex="0" value='// drivers/irqchip/irq-riscv-intc.c

IRQCHIP_DECLARE(riscv, "riscv,cpu-intc", riscv_intc_init);

static const struct of_device_id __of_table_riscv
__attribute__(__used__)
__attribute__(__section__("__irqchip_of_table"))
__attribute__((__aligned__(__alignof__(struct of_device_id)))) = {
    .compatible = "riscv,cpu-intc",
    .data = riscv_intc_init
}'>
<svg aria-hidden="true" class="octicon octicon-copy js-clipboard-copy-icon" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path>
</svg>
<svg aria-hidden="true" class="octicon octicon-check js-clipboard-check-icon color-fg-success d-none" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"></path>
</svg>
</clipboard-copy>
</div></div>
<p dir="auto">通过 Kconfig 配置哪些驱动要进行编译。编译好以后的目标文件最后进行链接。我们 enable 的中断控制器驱动中定义的 <code>struct of_device_id</code> 最后都会被放到 section <code>__irqchip_of_table</code> 中。在链接脚本的帮助下，符号 <code>__irqchip_of_table</code> 指向这个 section 的开头。</p>
<p dir="auto">section <code>__irqchip_of_table</code> 会有以下内容：</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto"><pre class="notranslate"><code>[juhan@arch irqchip]$ pwd
/home/juhan/local/riscv-linux/linux-6.16-rc3/drivers/irqchip
[juhan@arch irqchip]$ ls *.o | sed 's/\.o$/.c/' | xargs grep IRQCHIP_DECLARE
irq-riscv-imsic-early.c:     IRQCHIP_DECLARE(riscv_imsic, "riscv,imsics", imsic_early_dt_init);
irq-riscv-intc.c:            IRQCHIP_DECLARE(riscv, "riscv,cpu-intc", riscv_intc_init);
irq-riscv-intc.c:            IRQCHIP_DECLARE(andes, "andestech,cpu-intc", riscv_intc_init);
irq-sifive-plic.c:           IRQCHIP_DECLARE(riscv, "allwinner,sun20i-d1-plic", plic_early_probe);
irq-thead-c900-aclint-sswi.c:IRQCHIP_DECLARE(thead_aclint_sswi, "thead,c900-aclint-sswi", thead_aclint_sswi_early_probe);
</code></pre><div class="zeroclipboard-container">
<clipboard-copy aria-label="Copy" class="ClipboardButton btn btn-invisible js-clipboard-copy m-2 p-0 d-flex flex-justify-center flex-items-center" data-copy-feedback="Copied!" data-tooltip-direction="w" role="button" tabindex="0" value="[juhan@arch irqchip]$ pwd
/home/juhan/local/riscv-linux/linux-6.16-rc3/drivers/irqchip
[juhan@arch irqchip]$ ls *.o | sed 's/\.o$/.c/' | xargs grep IRQCHIP_DECLARE
irq-riscv-imsic-early.c:     IRQCHIP_DECLARE(riscv_imsic, &quot;riscv,imsics&quot;, imsic_early_dt_init);
irq-riscv-intc.c:            IRQCHIP_DECLARE(riscv, &quot;riscv,cpu-intc&quot;, riscv_intc_init);
irq-riscv-intc.c:            IRQCHIP_DECLARE(andes, &quot;andestech,cpu-intc&quot;, riscv_intc_init);
irq-sifive-plic.c:           IRQCHIP_DECLARE(riscv, &quot;allwinner,sun20i-d1-plic&quot;, plic_early_probe);
irq-thead-c900-aclint-sswi.c:IRQCHIP_DECLARE(thead_aclint_sswi, &quot;thead,c900-aclint-sswi&quot;, thead_aclint_sswi_early_probe);">
<svg aria-hidden="true" class="octicon octicon-copy js-clipboard-copy-icon" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path>
</svg>
<svg aria-hidden="true" class="octicon octicon-check js-clipboard-check-icon color-fg-success d-none" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"></path>
</svg>
</clipboard-copy>
</div></div>
<p dir="auto"><code>of_irq_init</code> 首先用 <code>for_each_matching_node_and_match</code> 来遍历设备树里的所有 node。对每个 node，这个宏检查 node 的 compatible property 是否和 matches 数组（即 <code>__irqchip_of_table</code>）中任一 entry 一样。如果有匹配，执行循环体。QEMU virt machine 设备树中只有以下 node 能匹配上。</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto"><pre class="notranslate"><code>interrupt-controller {
        #interrupt-cells = &lt;0x01&gt;;
        interrupt-controller;
        compatible = "riscv,cpu-intc";
        phandle = &lt;0x02&gt;;
};
</code></pre><div class="zeroclipboard-container">
<clipboard-copy aria-label="Copy" class="ClipboardButton btn btn-invisible js-clipboard-copy m-2 p-0 d-flex flex-justify-center flex-items-center" data-copy-feedback="Copied!" data-tooltip-direction="w" role="button" tabindex="0" value='interrupt-controller {
        #interrupt-cells = &lt;0x01&gt;;
        interrupt-controller;
        compatible = "riscv,cpu-intc";
        phandle = &lt;0x02&gt;;
};'>
<svg aria-hidden="true" class="octicon octicon-copy js-clipboard-copy-icon" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path>
</svg>
<svg aria-hidden="true" class="octicon octicon-check js-clipboard-check-icon color-fg-success d-none" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"></path>
</svg>
</clipboard-copy>
</div></div>
<p dir="auto">循环体先进行一些 sanity check，然后处理 <code>struct of_intc_desc *desc</code>。先设置好 <code>desc-&gt;irq_init_cb</code> 和 <code>desc-&gt;dev</code>。然后处理 <code>desc-&gt;interrupt_parent</code>。先 looks for a property called "interrupts-extended" within the device's node with <code>of_parse_phandle</code>。如果失败，return NULL，然后再用 <code>of_irq_find_parent</code>。This function walks up the Device Tree, starting from the current device node (np), looking for the nearest ancestor node that has an "interrupt-controller" property。It's possible that the device node np itself has an "interrupt-controller" property, causing <code>of_irq_find_parent</code> to return a pointer to np itself. The pointer is then set to NULL to clearly signal that no valid interrupt parent was found.最后把 <code>desc</code> 加到 <code>intc_desc_list</code>。</p>
<p dir="auto">然后对 <code>intc_desc_list</code> 的每个 entry 进行处理，最重要的一步就是 call <code>desc-&gt;irq_init_cb</code>。</p>
<p dir="auto">总结起来，<code>of_irq_init</code> call 了 <code>irq-riscv-intc.c:riscv_intc_init</code>。</p>
<div class="markdown-heading" dir="auto"><h4 class="heading-element" dir="auto" tabindex="-1">辅助函数 riscv_intc_init</h4><a aria-label="Permalink: 辅助函数 riscv_intc_init" class="anchor" href="#辅助函数-riscv_intc_init" id="user-content-辅助函数-riscv_intc_init"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><code>kernel/irq/handle.c:set_handle_irq</code> 把 <code>handle_arch_irq</code> 函数指针设置为 <code>riscv_intc_irq</code>。</p>
<div class="highlight highlight-source-c notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-c">// drivers/irqchip/irq-riscv-intc.c</span>

<span class="pl-k">static</span> <span class="pl-smi">int</span> <span class="pl-s1">__init</span> <span class="pl-en">riscv_intc_init</span>(<span class="pl-k">struct</span> <span class="pl-smi">device_node</span> <span class="pl-c1">*</span><span class="pl-s1">node</span>,
				  <span class="pl-k">struct</span> <span class="pl-smi">device_node</span> <span class="pl-c1">*</span><span class="pl-s1">parent</span>)
{
	<span class="pl-k">struct</span> <span class="pl-smi">irq_chip</span> <span class="pl-c1">*</span><span class="pl-s1">chip</span> <span class="pl-c1">=</span> <span class="pl-c1">&amp;</span><span class="pl-s1">riscv_intc_chip</span>;
	<span class="pl-smi">unsigned long</span> <span class="pl-s1">hartid</span>;
	<span class="pl-smi">int</span> <span class="pl-s1">rc</span>;

	<span class="pl-c">// 找到中断控制器所属 hart</span>
	<span class="pl-s1">rc</span> <span class="pl-c1">=</span> <span class="pl-en">riscv_of_parent_hartid</span>(<span class="pl-s1">node</span>, <span class="pl-c1">&amp;</span><span class="pl-s1">hartid</span>);
	<span class="pl-k">if</span> (<span class="pl-s1">rc</span> <span class="pl-c1">&lt;</span> <span class="pl-c1">0</span>) {
		<span class="pl-en">pr_warn</span>(<span class="pl-s">"unable to find hart id for %pOF\n"</span>, <span class="pl-s1">node</span>);
		<span class="pl-k">return</span> <span class="pl-c1">0</span>;
	}

	<span class="pl-c">/*</span>
<span class="pl-c">	 * The DT will have one INTC DT node under each CPU (or HART)</span>
<span class="pl-c">	 * DT node so riscv_intc_init() function will be called once</span>
<span class="pl-c">	 * for each INTC DT node. We only need to do INTC initialization</span>
<span class="pl-c">	 * for the INTC DT node belonging to boot CPU (or boot HART).</span>
<span class="pl-c">	 */</span>
	<span class="pl-c">// smp_processor_id 返回当前 CPU id，当前 CPU 就是 boot hart</span>
	<span class="pl-k">if</span> (<span class="pl-en">riscv_hartid_to_cpuid</span>(<span class="pl-s1">hartid</span>) <span class="pl-c1">!=</span> <span class="pl-en">smp_processor_id</span>()) {
		<span class="pl-c">/*</span>
<span class="pl-c">		 * The INTC nodes of each CPU are suppliers for downstream</span>
<span class="pl-c">		 * interrupt controllers (such as PLIC, IMSIC and APLIC</span>
<span class="pl-c">		 * direct-mode) so we should mark an INTC node as initialized</span>
<span class="pl-c">		 * if we are not creating IRQ domain for it.</span>
<span class="pl-c">		 */</span>
		<span class="pl-en">fwnode_dev_initialized</span>(<span class="pl-en">of_fwnode_handle</span>(<span class="pl-s1">node</span>), true);
		<span class="pl-k">return</span> <span class="pl-c1">0</span>;
	}

	<span class="pl-c">// 处理 andestech</span>
	<span class="pl-k">if</span> (<span class="pl-en">of_device_is_compatible</span>(<span class="pl-s1">node</span>, <span class="pl-s">"andestech,cpu-intc"</span>)) {
		<span class="pl-s1">riscv_intc_custom_base</span> <span class="pl-c1">=</span> <span class="pl-c1">ANDES_SLI_CAUSE_BASE</span>;
		<span class="pl-s1">riscv_intc_custom_nr_irqs</span> <span class="pl-c1">=</span> <span class="pl-c1">ANDES_RV_IRQ_LAST</span>;
		<span class="pl-s1">chip</span> <span class="pl-c1">=</span> <span class="pl-c1">&amp;</span><span class="pl-s1">andes_intc_chip</span>;
	}

	<span class="pl-k">return</span> <span class="pl-en">riscv_intc_init_common</span>(<span class="pl-en">of_fwnode_handle</span>(<span class="pl-s1">node</span>), <span class="pl-s1">chip</span>);
}

<span class="pl-c">// drivers/irqchip/irq-riscv-intc.c</span>

<span class="pl-k">static</span> <span class="pl-smi">int</span> <span class="pl-s1">__init</span> <span class="pl-en">riscv_intc_init_common</span>(<span class="pl-k">struct</span> <span class="pl-smi">fwnode_handle</span> <span class="pl-c1">*</span><span class="pl-s1">fn</span>, <span class="pl-k">struct</span> <span class="pl-smi">irq_chip</span> <span class="pl-c1">*</span><span class="pl-s1">chip</span>)
{
	<span class="pl-smi">int</span> <span class="pl-s1">rc</span>;

	<span class="pl-s1">intc_domain</span> <span class="pl-c1">=</span> <span class="pl-en">irq_domain_create_tree</span>(<span class="pl-s1">fn</span>, <span class="pl-c1">&amp;</span><span class="pl-s1">riscv_intc_domain_ops</span>, <span class="pl-s1">chip</span>);
	<span class="pl-k">if</span> (!<span class="pl-s1">intc_domain</span>) {
		<span class="pl-en">pr_err</span>(<span class="pl-s">"unable to add IRQ domain\n"</span>);
		<span class="pl-k">return</span> <span class="pl-c1">-</span><span class="pl-c1">ENXIO</span>;
	}

	<span class="pl-k">if</span> (<span class="pl-en">riscv_isa_extension_available</span>(<span class="pl-c1">NULL</span>, <span class="pl-s1">SxAIA</span>)) {
		<span class="pl-s1">riscv_intc_nr_irqs</span> <span class="pl-c1">=</span> <span class="pl-c1">64</span>;
		<span class="pl-s1">rc</span> <span class="pl-c1">=</span> <span class="pl-en">set_handle_irq</span>(<span class="pl-c1">&amp;</span><span class="pl-s1">riscv_intc_aia_irq</span>);
	} <span class="pl-k">else</span> {
		<span class="pl-c">// 重点</span>
		<span class="pl-c">// This function hooks the interrupt controller's</span>
		<span class="pl-c">// main handler into the low-level CPU trap entry</span>
		<span class="pl-c">// code. When the CPU takes an interrupt,</span>
		<span class="pl-c">// the generic trap handler</span>
		<span class="pl-c">// will call the function registered here.</span>
		<span class="pl-s1">rc</span> <span class="pl-c1">=</span> <span class="pl-en">set_handle_irq</span>(<span class="pl-c1">&amp;</span><span class="pl-s1">riscv_intc_irq</span>);
	}
	<span class="pl-k">if</span> (<span class="pl-s1">rc</span>) {
		<span class="pl-en">pr_err</span>(<span class="pl-s">"failed to set irq handler\n"</span>);
		<span class="pl-k">return</span> <span class="pl-s1">rc</span>;
	}

	<span class="pl-en">riscv_set_intc_hwnode_fn</span>(<span class="pl-s1">riscv_intc_hwnode</span>);

	<span class="pl-en">pr_info</span>(<span class="pl-s">"%d local interrupts mapped%s\n"</span>,
		<span class="pl-s1">riscv_intc_nr_irqs</span>,
		<span class="pl-en">riscv_isa_extension_available</span>(<span class="pl-c1">NULL</span>, <span class="pl-s1">SxAIA</span>) ? <span class="pl-s">" using AIA"</span> : <span class="pl-s">""</span>);
	<span class="pl-k">if</span> (<span class="pl-s1">riscv_intc_custom_nr_irqs</span>)
		<span class="pl-en">pr_info</span>(<span class="pl-s">"%d custom local interrupts mapped\n"</span>, <span class="pl-s1">riscv_intc_custom_nr_irqs</span>);

	<span class="pl-k">return</span> <span class="pl-c1">0</span>;
}

<span class="pl-c">// drivers/irqchip/irq-riscv-intc.c</span>

<span class="pl-k">static</span> <span class="pl-smi">void</span> <span class="pl-en">riscv_intc_irq</span>(<span class="pl-k">struct</span> <span class="pl-smi">pt_regs</span> <span class="pl-c1">*</span><span class="pl-s1">regs</span>)
{
	<span class="pl-smi">unsigned long</span> <span class="pl-s1">cause</span> <span class="pl-c1">=</span> <span class="pl-s1">regs</span><span class="pl-c1">-&gt;</span><span class="pl-c1">cause</span> <span class="pl-c1">&amp;</span> ~<span class="pl-c1">CAUSE_IRQ_FLAG</span>;

	<span class="pl-k">if</span> (<span class="pl-en">generic_handle_domain_irq</span>(<span class="pl-s1">intc_domain</span>, <span class="pl-s1">cause</span>))
		<span class="pl-en">pr_warn_ratelimited</span>(<span class="pl-s">"Failed to handle interrupt (cause: %ld)\n"</span>, <span class="pl-s1">cause</span>);
}</pre><div class="zeroclipboard-container">
<clipboard-copy aria-label="Copy" class="ClipboardButton btn btn-invisible js-clipboard-copy m-2 p-0 d-flex flex-justify-center flex-items-center" data-copy-feedback="Copied!" data-tooltip-direction="w" role="button" tabindex="0" value="// drivers/irqchip/irq-riscv-intc.c

static int __init riscv_intc_init(struct device_node *node,
				  struct device_node *parent)
{
	struct irq_chip *chip = &amp;riscv_intc_chip;
	unsigned long hartid;
	int rc;

	// 找到中断控制器所属 hart
	rc = riscv_of_parent_hartid(node, &amp;hartid);
	if (rc &lt; 0) {
		pr_warn(&quot;unable to find hart id for %pOF\n&quot;, node);
		return 0;
	}

	/*
	 * The DT will have one INTC DT node under each CPU (or HART)
	 * DT node so riscv_intc_init() function will be called once
	 * for each INTC DT node. We only need to do INTC initialization
	 * for the INTC DT node belonging to boot CPU (or boot HART).
	 */
	// smp_processor_id 返回当前 CPU id，当前 CPU 就是 boot hart
	if (riscv_hartid_to_cpuid(hartid) != smp_processor_id()) {
		/*
		 * The INTC nodes of each CPU are suppliers for downstream
		 * interrupt controllers (such as PLIC, IMSIC and APLIC
		 * direct-mode) so we should mark an INTC node as initialized
		 * if we are not creating IRQ domain for it.
		 */
		fwnode_dev_initialized(of_fwnode_handle(node), true);
		return 0;
	}

	// 处理 andestech
	if (of_device_is_compatible(node, &quot;andestech,cpu-intc&quot;)) {
		riscv_intc_custom_base = ANDES_SLI_CAUSE_BASE;
		riscv_intc_custom_nr_irqs = ANDES_RV_IRQ_LAST;
		chip = &amp;andes_intc_chip;
	}

	return riscv_intc_init_common(of_fwnode_handle(node), chip);
}

// drivers/irqchip/irq-riscv-intc.c

static int __init riscv_intc_init_common(struct fwnode_handle *fn, struct irq_chip *chip)
{
	int rc;

	intc_domain = irq_domain_create_tree(fn, &amp;riscv_intc_domain_ops, chip);
	if (!intc_domain) {
		pr_err(&quot;unable to add IRQ domain\n&quot;);
		return -ENXIO;
	}

	if (riscv_isa_extension_available(NULL, SxAIA)) {
		riscv_intc_nr_irqs = 64;
		rc = set_handle_irq(&amp;riscv_intc_aia_irq);
	} else {
		// 重点
		// This function hooks the interrupt controller's
		// main handler into the low-level CPU trap entry
		// code. When the CPU takes an interrupt,
		// the generic trap handler
		// will call the function registered here.
		rc = set_handle_irq(&amp;riscv_intc_irq);
	}
	if (rc) {
		pr_err(&quot;failed to set irq handler\n&quot;);
		return rc;
	}

	riscv_set_intc_hwnode_fn(riscv_intc_hwnode);

	pr_info(&quot;%d local interrupts mapped%s\n&quot;,
		riscv_intc_nr_irqs,
		riscv_isa_extension_available(NULL, SxAIA) ? &quot; using AIA&quot; : &quot;&quot;);
	if (riscv_intc_custom_nr_irqs)
		pr_info(&quot;%d custom local interrupts mapped\n&quot;, riscv_intc_custom_nr_irqs);

	return 0;
}

// drivers/irqchip/irq-riscv-intc.c

static void riscv_intc_irq(struct pt_regs *regs)
{
	unsigned long cause = regs-&gt;cause &amp; ~CAUSE_IRQ_FLAG;

	if (generic_handle_domain_irq(intc_domain, cause))
		pr_warn_ratelimited(&quot;Failed to handle interrupt (cause: %ld)\n&quot;, cause);
}">
<svg aria-hidden="true" class="octicon octicon-copy js-clipboard-copy-icon" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path>
</svg>
<svg aria-hidden="true" class="octicon octicon-check js-clipboard-check-icon color-fg-success d-none" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"></path>
</svg>
</clipboard-copy>
</div></div>
<p dir="auto">输出：<code>[    0.000000] riscv-intc: 64 local interrupts mapped</code>。</p>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto" tabindex="-1">rest_init（SMP）</h3><a aria-label="Permalink: rest_init（SMP）" class="anchor" href="#rest_initsmp" id="user-content-rest_initsmp"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><code>init/main.c:rest_init</code> 创建用户线程 <code>user_mode_thread(kernel_init, NULL, CLONE_FS);</code>.</p>
<p dir="auto"><code>init/main.c:kernel_init</code> call <code>kernel_init_freeable</code>。</p>
<p dir="auto"><code>init/main.c:kernel_init_freeable</code> call <code>smp_init</code>。<code>smp_init</code> is called by boot processor to activate the rest.</p>
<p dir="auto"><code>kernel/smp.c:smp_init</code> call <code>bringup_nonboot_cpus</code>。</p>
<p dir="auto"><code>kernel/cpu.c:bringup_nonboot_cpus</code> call <code>cpuhp_bringup_mask</code>。</p>
<p dir="auto"><code>kernel/cpu.c:cpuhp_bringup_mask</code> call <code>cpu_up(cpu, CPUHP_ONLINE)</code>。</p>
<p dir="auto"><code>kernel/cpu.c:cup_up</code> call <code>_cpu_up(cpu, 0, CPUHP_ONLINE)</code>。</p>
<p dir="auto"><code>kernel/cpu.c:_cpu_up</code> call <code>ret = cpuhp_up_callbacks(cpu, st, target);</code>。</p>
<p dir="auto"><code>kernel/cpu.c:cpuhp_up_callbacks</code> call <code>cpuhp_invoke_callback_range(true, cpu, st, target);</code>。</p>
<p dir="auto"><code>kernel/cpu.c:cpuhp_invoke_callback_range</code> call <code>__cpuhp_invoke_callback_range(bringup, cpu, st, target, false)</code>。</p>
<p dir="auto">...</p>
<p dir="auto">最终 <code>kernel/cpu.c:bringup_cpu</code> 会被调用。</p>
<p dir="auto"><code>kernel/cpu.c:bringup_cpu</code> call <code>__cpu_up</code></p>
<p dir="auto"><code>arch/riscv/kernel/smpboot.c:__cpu_up</code> call <code>start_secondary_cpu</code>。</p>
<div class="highlight highlight-source-c notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-c">// arch/riscv/kernel/smpboot.c</span>

<span class="pl-k">static</span> <span class="pl-smi">int</span> <span class="pl-en">start_secondary_cpu</span>(<span class="pl-smi">int</span> <span class="pl-s1">cpu</span>, <span class="pl-k">struct</span> <span class="pl-smi">task_struct</span> <span class="pl-c1">*</span><span class="pl-s1">tidle</span>)
{
	<span class="pl-k">if</span> (<span class="pl-s1">cpu_ops</span><span class="pl-c1">-&gt;</span><span class="pl-c1">cpu_start</span>)
		<span class="pl-k">return</span> <span class="pl-s1">cpu_ops</span><span class="pl-c1">-&gt;</span><span class="pl-en">cpu_start</span>(<span class="pl-s1">cpu</span>, <span class="pl-s1">tidle</span>);

	<span class="pl-k">return</span> <span class="pl-c1">-</span><span class="pl-c1">EOPNOTSUPP</span>;
}</pre><div class="zeroclipboard-container">
<clipboard-copy aria-label="Copy" class="ClipboardButton btn btn-invisible js-clipboard-copy m-2 p-0 d-flex flex-justify-center flex-items-center" data-copy-feedback="Copied!" data-tooltip-direction="w" role="button" tabindex="0" value="// arch/riscv/kernel/smpboot.c

static int start_secondary_cpu(int cpu, struct task_struct *tidle)
{
	if (cpu_ops-&gt;cpu_start)
		return cpu_ops-&gt;cpu_start(cpu, tidle);

	return -EOPNOTSUPP;
}">
<svg aria-hidden="true" class="octicon octicon-copy js-clipboard-copy-icon" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path>
</svg>
<svg aria-hidden="true" class="octicon octicon-check js-clipboard-check-icon color-fg-success d-none" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"></path>
</svg>
</clipboard-copy>
</div></div>
<p dir="auto"><code>cpu_ops</code> 前面已经设置好了，<code>cpu_start</code> 是 <code>sbi_cpu_start</code>。call <code>sbi_cpu_start</code>。</p>
<div class="highlight highlight-source-c notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-c">// arch/riscv/kernel/cpu_ops_sbi.c</span>

<span class="pl-k">static</span> <span class="pl-smi">int</span> <span class="pl-en">sbi_cpu_start</span>(<span class="pl-smi">unsigned <span class="pl-smi">int</span></span> <span class="pl-s1">cpuid</span>, <span class="pl-k">struct</span> <span class="pl-smi">task_struct</span> <span class="pl-c1">*</span><span class="pl-s1">tidle</span>)
{
	<span class="pl-smi">unsigned long</span> <span class="pl-s1">boot_addr</span> <span class="pl-c1">=</span> <span class="pl-en">__pa_symbol</span>(<span class="pl-s1">secondary_start_sbi</span>);
	<span class="pl-smi">unsigned long</span> <span class="pl-s1">hartid</span> <span class="pl-c1">=</span> <span class="pl-en">cpuid_to_hartid_map</span>(<span class="pl-s1">cpuid</span>);
	<span class="pl-smi">unsigned long</span> <span class="pl-s1">hsm_data</span>;
	<span class="pl-k">struct</span> <span class="pl-smi">sbi_hart_boot_data</span> <span class="pl-c1">*</span><span class="pl-s1">bdata</span> <span class="pl-c1">=</span> <span class="pl-c1">&amp;</span><span class="pl-en">per_cpu</span>(<span class="pl-s1">boot_data</span>, <span class="pl-s1">cpuid</span>);

	<span class="pl-c">/* Make sure tidle is updated */</span>
	<span class="pl-en">smp_mb</span>();
	<span class="pl-s1">bdata</span><span class="pl-c1">-&gt;</span><span class="pl-c1">task_ptr</span> <span class="pl-c1">=</span> <span class="pl-s1">tidle</span>;
	<span class="pl-s1">bdata</span><span class="pl-c1">-&gt;</span><span class="pl-c1">stack_ptr</span> <span class="pl-c1">=</span> <span class="pl-en">task_pt_regs</span>(<span class="pl-s1">tidle</span>);
	<span class="pl-c">/* Make sure boot data is updated */</span>
	<span class="pl-en">smp_mb</span>();
	<span class="pl-s1">hsm_data</span> <span class="pl-c1">=</span> <span class="pl-en">__pa</span>(<span class="pl-s1">bdata</span>);
	<span class="pl-c">// 启动这个 CPU</span>
	<span class="pl-k">return</span> <span class="pl-en">sbi_hsm_hart_start</span>(<span class="pl-s1">hartid</span>, <span class="pl-s1">boot_addr</span>, <span class="pl-s1">hsm_data</span>);
}</pre><div class="zeroclipboard-container">
<clipboard-copy aria-label="Copy" class="ClipboardButton btn btn-invisible js-clipboard-copy m-2 p-0 d-flex flex-justify-center flex-items-center" data-copy-feedback="Copied!" data-tooltip-direction="w" role="button" tabindex="0" value="// arch/riscv/kernel/cpu_ops_sbi.c

static int sbi_cpu_start(unsigned int cpuid, struct task_struct *tidle)
{
	unsigned long boot_addr = __pa_symbol(secondary_start_sbi);
	unsigned long hartid = cpuid_to_hartid_map(cpuid);
	unsigned long hsm_data;
	struct sbi_hart_boot_data *bdata = &amp;per_cpu(boot_data, cpuid);

	/* Make sure tidle is updated */
	smp_mb();
	bdata-&gt;task_ptr = tidle;
	bdata-&gt;stack_ptr = task_pt_regs(tidle);
	/* Make sure boot data is updated */
	smp_mb();
	hsm_data = __pa(bdata);
	// 启动这个 CPU
	return sbi_hsm_hart_start(hartid, boot_addr, hsm_data);
}">
<svg aria-hidden="true" class="octicon octicon-copy js-clipboard-copy-icon" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path>
</svg>
<svg aria-hidden="true" class="octicon octicon-check js-clipboard-check-icon color-fg-success d-none" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"></path>
</svg>
</clipboard-copy>
</div></div>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto" tabindex="-1">其他 hart</h2><a aria-label="Permalink: 其他 hart" class="anchor" href="#其他-hart" id="user-content-其他-hart"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto" tabindex="-1">secondary_start_sbi</h3><a aria-label="Permalink: secondary_start_sbi" class="anchor" href="#secondary_start_sbi" id="user-content-secondary_start_sbi"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">前面 <code>sbi_cpu_start</code> 里设置其他 hart 从 <code>secondary_start_sbi</code> 开始运行。<code>secondary_start_sbi</code> 结构和 <code>_start_kernel</code> 类似。</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto"><pre class="notranslate"><code>// arch/riscv/kernel/head.S

#ifdef CONFIG_SMP
	.global secondary_start_sbi
secondary_start_sbi:
	/* Mask all interrupts */
	csrw CSR_IE, zero
	csrw CSR_IP, zero

#ifndef CONFIG_RISCV_M_MODE
	/* Enable time CSR */
	li t0, 0x2
	csrw CSR_SCOUNTEREN, t0
#endif

	/* Load the global pointer */
	load_global_pointer

	/*
	 * Disable FPU &amp; VECTOR to detect illegal usage of
	 * floating point or vector in kernel space
	 */
	li t0, SR_FS_VS
	csrc CSR_STATUS, t0

	/* Set trap vector to spin forever to help debug */
	la a3, .Lsecondary_park
	csrw CSR_TVEC, a3

	/* a0 contains the hartid &amp; a1 contains boot data */
	li a2, SBI_HART_BOOT_TASK_PTR_OFFSET
	XIP_FIXUP_OFFSET a2
	add a2, a2, a1
	REG_L tp, (a2)
	li a3, SBI_HART_BOOT_STACK_PTR_OFFSET
	XIP_FIXUP_OFFSET a3
	add a3, a3, a1
	REG_L sp, (a3)

.Lsecondary_start_common:

#ifdef CONFIG_MMU
	/* Enable virtual memory and relocate to virtual address */
	la a0, swapper_pg_dir
	XIP_FIXUP_OFFSET a0
	call relocate_enable_mmu
#endif
	call .Lsetup_trap_vector	// 见上，stvec 也被设置为 handle_exception
	scs_load_current		// 见上
	call smp_callin
#endif /* CONFIG_SMP */
</code></pre><div class="zeroclipboard-container">
<clipboard-copy aria-label="Copy" class="ClipboardButton btn btn-invisible js-clipboard-copy m-2 p-0 d-flex flex-justify-center flex-items-center" data-copy-feedback="Copied!" data-tooltip-direction="w" role="button" tabindex="0" value="// arch/riscv/kernel/head.S

#ifdef CONFIG_SMP
	.global secondary_start_sbi
secondary_start_sbi:
	/* Mask all interrupts */
	csrw CSR_IE, zero
	csrw CSR_IP, zero

#ifndef CONFIG_RISCV_M_MODE
	/* Enable time CSR */
	li t0, 0x2
	csrw CSR_SCOUNTEREN, t0
#endif

	/* Load the global pointer */
	load_global_pointer

	/*
	 * Disable FPU &amp; VECTOR to detect illegal usage of
	 * floating point or vector in kernel space
	 */
	li t0, SR_FS_VS
	csrc CSR_STATUS, t0

	/* Set trap vector to spin forever to help debug */
	la a3, .Lsecondary_park
	csrw CSR_TVEC, a3

	/* a0 contains the hartid &amp; a1 contains boot data */
	li a2, SBI_HART_BOOT_TASK_PTR_OFFSET
	XIP_FIXUP_OFFSET a2
	add a2, a2, a1
	REG_L tp, (a2)
	li a3, SBI_HART_BOOT_STACK_PTR_OFFSET
	XIP_FIXUP_OFFSET a3
	add a3, a3, a1
	REG_L sp, (a3)

.Lsecondary_start_common:

#ifdef CONFIG_MMU
	/* Enable virtual memory and relocate to virtual address */
	la a0, swapper_pg_dir
	XIP_FIXUP_OFFSET a0
	call relocate_enable_mmu
#endif
	call .Lsetup_trap_vector	// 见上，stvec 也被设置为 handle_exception
	scs_load_current		// 见上
	call smp_callin
#endif /* CONFIG_SMP */">
<svg aria-hidden="true" class="octicon octicon-copy js-clipboard-copy-icon" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path>
</svg>
<svg aria-hidden="true" class="octicon octicon-check js-clipboard-check-icon color-fg-success d-none" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"></path>
</svg>
</clipboard-copy>
</div></div>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto" tabindex="-1">smp_callin</h3><a aria-label="Permalink: smp_callin" class="anchor" href="#smp_callin" id="user-content-smp_callin"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<div class="highlight highlight-source-c notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-c">// arch/riscv/kernel/smpboot.c</span>

<span class="pl-c">/*</span>
<span class="pl-c"> * C entry point for a secondary processor.</span>
<span class="pl-c"> */</span>
<span class="pl-smi">asmlinkage</span> <span class="pl-s1">__visible</span> <span class="pl-smi">void</span> <span class="pl-en">smp_callin</span>(<span class="pl-smi">void</span>)
{
	<span class="pl-k">struct</span> <span class="pl-smi">mm_struct</span> <span class="pl-c1">*</span><span class="pl-s1">mm</span> <span class="pl-c1">=</span> <span class="pl-c1">&amp;</span><span class="pl-s1">init_mm</span>;
	<span class="pl-smi">unsigned <span class="pl-smi">int</span></span> <span class="pl-s1">curr_cpuid</span> <span class="pl-c1">=</span> <span class="pl-en">smp_processor_id</span>();

	<span class="pl-k">if</span> (<span class="pl-en">has_vector</span>()) {
		<span class="pl-c">/*</span>
<span class="pl-c">		 * Return as early as possible so the hart with a mismatching</span>
<span class="pl-c">		 * vlen won't boot.</span>
<span class="pl-c">		 */</span>
		<span class="pl-k">if</span> (<span class="pl-en">riscv_v_setup_vsize</span>())
			<span class="pl-k">return</span>;
	}

	<span class="pl-c">/* All kernel threads share the same mm context.  */</span>
	<span class="pl-en">mmgrab</span>(<span class="pl-s1">mm</span>);
	<span class="pl-s1">current</span><span class="pl-c1">-&gt;</span><span class="pl-c1">active_mm</span> <span class="pl-c1">=</span> <span class="pl-s1">mm</span>;

	<span class="pl-en">store_cpu_topology</span>(<span class="pl-s1">curr_cpuid</span>);
	<span class="pl-en">notify_cpu_starting</span>(<span class="pl-s1">curr_cpuid</span>);

	<span class="pl-en">riscv_ipi_enable</span>();

	<span class="pl-en">numa_add_cpu</span>(<span class="pl-s1">curr_cpuid</span>);

	<span class="pl-en">pr_debug</span>(<span class="pl-s">"CPU%u: Booted secondary hartid %lu\n"</span>, <span class="pl-s1">curr_cpuid</span>,
		<span class="pl-en">cpuid_to_hartid_map</span>(<span class="pl-s1">curr_cpuid</span>));

	<span class="pl-en">set_cpu_online</span>(<span class="pl-s1">curr_cpuid</span>, true);

	<span class="pl-c">/*</span>
<span class="pl-c">	 * Remote cache and TLB flushes are ignored while the CPU is offline,</span>
<span class="pl-c">	 * so flush them both right now just in case.</span>
<span class="pl-c">	 */</span>
	<span class="pl-en">local_flush_icache_all</span>();
	<span class="pl-en">local_flush_tlb_all</span>();
	<span class="pl-c">// The BSP, which was waiting in __cpu_up,</span>
	<span class="pl-c">// now sees that the core is running.</span>
	<span class="pl-en">complete</span>(<span class="pl-c1">&amp;</span><span class="pl-s1">cpu_running</span>);
	<span class="pl-c">/*</span>
<span class="pl-c">	 * Disable preemption before enabling interrupts, so we don't try to</span>
<span class="pl-c">	 * schedule a CPU that hasn't actually started yet.</span>
<span class="pl-c">	 */</span>
	<span class="pl-en">local_irq_enable</span>();
	<span class="pl-c">// marks the CPU as fully online and enters the idle loop.</span>
	<span class="pl-c">// The kernel scheduler is now free to assign tasks to this newly available core.</span>
	<span class="pl-en">cpu_startup_entry</span>(<span class="pl-c1">CPUHP_AP_ONLINE_IDLE</span>);
}</pre><div class="zeroclipboard-container">
<clipboard-copy aria-label="Copy" class="ClipboardButton btn btn-invisible js-clipboard-copy m-2 p-0 d-flex flex-justify-center flex-items-center" data-copy-feedback="Copied!" data-tooltip-direction="w" role="button" tabindex="0" value="// arch/riscv/kernel/smpboot.c

/*
 * C entry point for a secondary processor.
 */
asmlinkage __visible void smp_callin(void)
{
	struct mm_struct *mm = &amp;init_mm;
	unsigned int curr_cpuid = smp_processor_id();

	if (has_vector()) {
		/*
		 * Return as early as possible so the hart with a mismatching
		 * vlen won't boot.
		 */
		if (riscv_v_setup_vsize())
			return;
	}

	/* All kernel threads share the same mm context.  */
	mmgrab(mm);
	current-&gt;active_mm = mm;

	store_cpu_topology(curr_cpuid);
	notify_cpu_starting(curr_cpuid);

	riscv_ipi_enable();

	numa_add_cpu(curr_cpuid);

	pr_debug(&quot;CPU%u: Booted secondary hartid %lu\n&quot;, curr_cpuid,
		cpuid_to_hartid_map(curr_cpuid));

	set_cpu_online(curr_cpuid, true);

	/*
	 * Remote cache and TLB flushes are ignored while the CPU is offline,
	 * so flush them both right now just in case.
	 */
	local_flush_icache_all();
	local_flush_tlb_all();
	// The BSP, which was waiting in __cpu_up,
	// now sees that the core is running.
	complete(&amp;cpu_running);
	/*
	 * Disable preemption before enabling interrupts, so we don't try to
	 * schedule a CPU that hasn't actually started yet.
	 */
	local_irq_enable();
	// marks the CPU as fully online and enters the idle loop.
	// The kernel scheduler is now free to assign tasks to this newly available core.
	cpu_startup_entry(CPUHP_AP_ONLINE_IDLE);
}">
<svg aria-hidden="true" class="octicon octicon-copy js-clipboard-copy-icon" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path>
</svg>
<svg aria-hidden="true" class="octicon octicon-check js-clipboard-check-icon color-fg-success d-none" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"></path>
</svg>
</clipboard-copy>
</div></div>
</article></div>

<div aria-atomic="true" aria-live="polite" class="sr-only mt-n1" id="js-global-screen-reader-notice"></div>
<div aria-atomic="true" aria-live="assertive" class="sr-only mt-n1" id="js-global-screen-reader-notice-assertive"></div>
<div aria-live="assertive" class="sr-only mt-n1" data-testid="screenReaderAnnouncement" id="screenReaderAnnouncementDiv" role="alert"> </div></body></html>