<!DOCTYPE html>
<html class="js-focus-visible" data-a11y-animated-images="system" data-a11y-link-underlines="true" data-color-mode="auto" data-dark-theme="dark" data-js-focus-visible="" data-light-theme="light" data-turbo-loaded="" lang="en"><head><style type="text/css">.turbo-progress-bar {
  position: fixed;
  display: block;
  top: 0;
  left: 0;
  height: 3px;
  background: #0076ff;
  z-index: 2147483647;
  transition:
    width 300ms ease-out,
    opacity 150ms 150ms ease-in;
  transform: translate3d(0, 0, 0);
}
</style>
<meta charset="utf-8"/>
<link href="https://github.githubassets.com" rel="dns-prefetch"/>
<link href="https://avatars.githubusercontent.com" rel="dns-prefetch"/>
<link href="https://github-cloud.s3.amazonaws.com" rel="dns-prefetch"/>
<link href="https://user-images.githubusercontent.com/" rel="dns-prefetch"/>
<link crossorigin="" href="https://github.githubassets.com" rel="preconnect"/>
<link href="https://avatars.githubusercontent.com" rel="preconnect"/>
<link crossorigin="anonymous" href="https://github.githubassets.com/assets/light-8e973f836952.css" media="all" rel="stylesheet"/><link crossorigin="anonymous" href="https://github.githubassets.com/assets/light_high_contrast-34b642d57214.css" media="all" rel="stylesheet"/><link crossorigin="anonymous" href="https://github.githubassets.com/assets/dark-4bce7af39e21.css" media="all" rel="stylesheet"/><link crossorigin="anonymous" href="https://github.githubassets.com/assets/dark_high_contrast-ad512d3e2f3b.css" media="all" rel="stylesheet"/><link crossorigin="anonymous" data-color-theme="light" data-href="https://github.githubassets.com/assets/light-8e973f836952.css" media="all" rel="stylesheet"/><link crossorigin="anonymous" data-color-theme="light_high_contrast" data-href="https://github.githubassets.com/assets/light_high_contrast-34b642d57214.css" media="all" rel="stylesheet"/><link crossorigin="anonymous" data-color-theme="light_colorblind" data-href="https://github.githubassets.com/assets/light_colorblind-54be93e666a7.css" media="all" rel="stylesheet"/><link crossorigin="anonymous" data-color-theme="light_colorblind_high_contrast" data-href="https://github.githubassets.com/assets/light_colorblind_high_contrast-8ae7edf5489c.css" media="all" rel="stylesheet"/><link crossorigin="anonymous" data-color-theme="light_tritanopia" data-href="https://github.githubassets.com/assets/light_tritanopia-84d50df427c0.css" media="all" rel="stylesheet"/><link crossorigin="anonymous" data-color-theme="light_tritanopia_high_contrast" data-href="https://github.githubassets.com/assets/light_tritanopia_high_contrast-a80873375146.css" media="all" rel="stylesheet"/><link crossorigin="anonymous" data-color-theme="dark" data-href="https://github.githubassets.com/assets/dark-4bce7af39e21.css" media="all" rel="stylesheet"/><link crossorigin="anonymous" data-color-theme="dark_high_contrast" data-href="https://github.githubassets.com/assets/dark_high_contrast-ad512d3e2f3b.css" media="all" rel="stylesheet"/><link crossorigin="anonymous" data-color-theme="dark_colorblind" data-href="https://github.githubassets.com/assets/dark_colorblind-d152d6cd6879.css" media="all" rel="stylesheet"/><link crossorigin="anonymous" data-color-theme="dark_colorblind_high_contrast" data-href="https://github.githubassets.com/assets/dark_colorblind_high_contrast-fa4060c1a9da.css" media="all" rel="stylesheet"/><link crossorigin="anonymous" data-color-theme="dark_tritanopia" data-href="https://github.githubassets.com/assets/dark_tritanopia-d7bad0fb00bb.css" media="all" rel="stylesheet"/><link crossorigin="anonymous" data-color-theme="dark_tritanopia_high_contrast" data-href="https://github.githubassets.com/assets/dark_tritanopia_high_contrast-4a0107c0f60c.css" media="all" rel="stylesheet"/><link crossorigin="anonymous" data-color-theme="dark_dimmed" data-href="https://github.githubassets.com/assets/dark_dimmed-045e6b6ac094.css" media="all" rel="stylesheet"/><link crossorigin="anonymous" data-color-theme="dark_dimmed_high_contrast" data-href="https://github.githubassets.com/assets/dark_dimmed_high_contrast-5de537db5e79.css" media="all" rel="stylesheet"/>
<style type="text/css">
    :root {
      --tab-size-preference: 4;
    }

    pre, code {
      tab-size: var(--tab-size-preference);
    }
  </style>
<link crossorigin="anonymous" href="https://github.githubassets.com/assets/primer-primitives-c37d781e2da5.css" media="all" rel="stylesheet"/>
<link crossorigin="anonymous" href="https://github.githubassets.com/assets/primer-efa08b71f947.css" media="all" rel="stylesheet"/>
<link crossorigin="anonymous" href="https://github.githubassets.com/assets/global-6dcb16809e76.css" media="all" rel="stylesheet"/>
<link crossorigin="anonymous" href="https://github.githubassets.com/assets/github-f86c648606b5.css" media="all" rel="stylesheet"/>
<link crossorigin="anonymous" href="https://github.githubassets.com/assets/repository-5d735668c600.css" media="all" rel="stylesheet"/>
<link crossorigin="anonymous" href="https://github.githubassets.com/assets/code-9c9b8dc61e74.css" media="all" rel="stylesheet"/>
<script id="client-env" type="application/json">{"locale":"en","featureFlags":["a11y_status_checks_ruleset","actions_custom_images_public_preview_visibility","actions_custom_images_storage_billing_ui_visibility","actions_enable_snapshot_keyword","actions_image_version_event","alternate_user_config_repo","api_insights_show_missing_data_banner","arianotify_comprehensive_migration","arianotify_partial_migration","client_version_header","codespaces_prebuild_region_target_update","contentful_lp_footnotes","copilot_agent_cli_public_preview","copilot_agent_task_list_v2","copilot_agent_tasks_btn_code_nav","copilot_agent_tasks_btn_code_view","copilot_agent_tasks_btn_code_view_lines","copilot_agent_tasks_btn_repo","copilot_api_agentic_issue_marshal_yaml","copilot_api_draft_issue_reference_with_project_id","copilot_api_draft_issues_with_dependencies","copilot_api_github_draft_update_issue_skill","copilot_chat_agents_empty_state","copilot_chat_attach_multiple_images","copilot_chat_file_redirect","copilot_chat_input_commands","copilot_chat_opening_thread_switch","copilot_chat_reduce_quota_checks","copilot_chat_search_bar_redirect","copilot_chat_selection_attachments","copilot_chat_vision_in_claude","copilot_chat_vision_preview_gate","copilot_coding_agent_task_response","copilot_custom_copilots","copilot_custom_copilots_feature_preview","copilot_dashboard_input_new_submit","copilot_duplicate_thread","copilot_extensions_hide_in_dotcom_chat","copilot_extensions_removal_on_marketplace","copilot_features_raycast_logo","copilot_file_block_ref_matching","copilot_ftp_hyperspace_upgrade_prompt","copilot_immersive_generate_thread_name_async","copilot_immersive_issues_readonly_viewer","copilot_immersive_issues_show_relationships","copilot_immersive_job_result_preview","copilot_immersive_structured_model_picker","copilot_immersive_task_hyperlinking","copilot_immersive_task_within_chat_thread","copilot_org_policy_page_focus_mode","copilot_security_alert_assignee_options","copilot_share_active_subthread","copilot_spaces_as_attachments","copilot_spaces_code_view","copilot_spaces_ga","copilot_spaces_individual_policies_ga","copilot_spaces_public_access_to_user_owned_spaces","copilot_spaces_read_access_to_user_owned_spaces","copilot_spaces_report_abuse","copilot_spark_empty_state","copilot_spark_loading_webgl","copilot_spark_progressive_error_handling","copilot_spark_use_billing_headers","copilot_stable_conversation_view","copilot_swe_agent_progress_commands","copilot_swe_agent_use_subagents","copilot_workbench_agent_seed_tool","copilot_workbench_agent_user_edit_awareness","copilot_workbench_cache","copilot_workbench_preview_analytics","copilot_workbench_use_single_prompt","dashboard_universe_2025_feedback_dialog","direct_to_salesforce","disable_turbo_visit","dom_node_counts","dotcom_chat_client_side_skills","enterprise_ai_controls","failbot_report_error_react_apps_on_page","fetch_graphql_improved_error_serialization","ghost_pilot_confidence_truncation_25","ghost_pilot_confidence_truncation_40","global_search_multi_orgs","hyperspace_2025_logged_out_batch_1","hyperspace_nudges_universe25","hyperspace_nudges_universe25_post_event","initial_per_page_pagination_updates","issue_fields_report_usage","issues_expanded_file_types","issues_lazy_load_comment_box_suggestions","issues_react_bots_timeline_pagination","issues_react_prohibit_title_fallback","issues_report_sidebar_interactions","issues_sticky_sidebar","issues_title_flex_header_fix","item_picker_assignee_tsq_migration","item_picker_project_tsq_migration","lifecycle_label_name_updates","link_contact_sales_swp_marketo","marketing_pages_search_explore_provider","mcp_registry_install","mcp_registry_oss_v0_1_api","memex_default_issue_create_repository","memex_grouped_by_edit_route","memex_mwl_filter_field_delimiter","mission_control_use_body_html","new_traffic_page_banner","open_agent_session_in_vscode_insiders","open_agent_session_in_vscode_stable","primer_react_segmented_control_tooltip","projects_assignee_max_limit","react_fetch_graphql_ignore_expected_errors","record_sso_banner_metrics","report_hydro_web_vitals","repos_insights_remove_new_url","ruleset_deletion_confirmation","sample_network_conn_type","scheduled_reminders_updated_limits","site_features_copilot_universe","site_homepage_collaborate_video","site_homepage_contentful","site_homepage_eyebrow_banner","site_homepage_universe_animations","site_msbuild_webgl_hero","spark_fix_rename","spark_force_push_after_checkout","spark_improve_image_upload","spark_kv_encocoded_keys","spark_show_data_access_on_publish","spark_sync_repository_after_iteration","spark_use_agent_status","swe_agent_member_requests","viewscreen_sandbox","webp_support","workbench_store_readonly"],"copilotApiOverrideUrl":"https://api.githubcopilot.com"}</script>
<script crossorigin="anonymous" src="https://github.githubassets.com/assets/high-contrast-cookie-1a011967750c.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/wp-runtime-b339bcbca9fc.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/913-ca2305638c53.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/6488-de87864e6818.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/environment-122ed792f7a3.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/11683-aa3d1ebe6648.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/43784-4652ae97a661.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/4712-809eac2badf7.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/81028-5b8c5e07a4fa.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/74911-6a311b93ee8e.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/91853-b5d2e5602241.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/78143-31968346cf4c.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/52430-c46e2de36eb2.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/github-elements-5b3e77949adb.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/element-registry-095d461e0652.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/28546-ee41c9313871.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/17688-a9e16fb5ed13.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/2869-a4ba8f17edb3.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/70191-5122bf27bf3e.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/7332-5ea4ccf72018.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/3561-d56ebea34f95.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/19037-69d630e73af8.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/51519-b4d929bb1e46.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/67310-00ed42590310.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/96384-750ef5263abe.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/19718-676a65610616.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/behaviors-108608b0bccd.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/48011-1f20a5c80dd7.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/notifications-global-eb21f5b0029d.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/31615-236504c8966f.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/code-menu-67717e88b7e6.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/primer-react-e4ebdadc89a4.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/react-lib-760965ba27bb.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/react-core-0f12feb3af13.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/octicons-react-a215e6ee021a.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/12979-6037a19d779b.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/48775-3cc79d2cd30e.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/42892-341e79a04903.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/23832-db66abd83e08.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/99418-9d4961969e0d.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/33915-05ba9b3edc31.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/96537-8e29101f7d81.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/51220-ec5733320b36.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/32219-236f5281aec8.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/59579-2ea999aac712.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/62029-a6360a734229.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/25407-0068d683d953.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/40771-0ffdf56b673a.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/66990-bcc3e84258a5.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/29665-96a2ad6dd82d.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/6623-ff0ff52cb37f.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/19976-d9a685a90a0d.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/3774-6fb5a6174da6.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/18406-40fe466df0c6.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/36584-61e8176018bd.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/29806-7c403c1af2af.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/react-code-view-91799e320ffd.js" type="application/javascript"></script>
<link crossorigin="anonymous" href="https://github.githubassets.com/assets/primer-react.e4b5d4e7d539fcc3f287.module.css" media="all" rel="stylesheet"/>
<link crossorigin="anonymous" href="https://github.githubassets.com/assets/react-code-view.5fabe269aba9949ea13c.module.css" media="all" rel="stylesheet"/>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/25873-19b3275e0432.js" type="application/javascript"></script>
<script crossorigin="anonymous" defer="defer" src="https://github.githubassets.com/assets/notifications-subscriptions-menu-28d0ba308e99.js" type="application/javascript"></script>
<link crossorigin="anonymous" href="https://github.githubassets.com/assets/primer-react.e4b5d4e7d539fcc3f287.module.css" media="all" rel="stylesheet"/>
<link crossorigin="anonymous" href="https://github.githubassets.com/assets/notifications-subscriptions-menu.933100a30c03fd4e8ae4.module.css" media="all" rel="stylesheet"/>
<title>2025-08-16-linux-trap</title>
<meta content="/:user_id/:repository/blob/*name(/*path)" data-turbo-transient="" name="route-pattern"/>
<meta content="blob" data-turbo-transient="" name="route-controller"/>
<meta content="show" data-turbo-transient="" name="route-action"/>
<meta content="v2:39f4dcd3-4a0e-dde5-4e69-75290cc034c5" name="fetch-nonce"/>
<meta content="f3abb0cc802f3d7b95fc8762b94bdcb13bf39634c40c357301c4aa1d67a256fb" name="current-catalog-service-hash"/>
<meta content="F410:37F979:7554FE:A1E8C0:6930772E" data-pjax-transient="true" name="request-id"/><meta content="bbb3c6b9c4e8a1addbb547a28b268d5073c501a9a523868932e1783fc17111fe" data-pjax-transient="true" name="html-safe-nonce"/><meta content="eyJyZWZlcnJlciI6IiIsInJlcXVlc3RfaWQiOiJGNDEwOjM3Rjk3OTo3NTU0RkU6QTFFOEMwOjY5MzA3NzJFIiwidmlzaXRvcl9pZCI6IjUzNTUzNDg0MDYyMTk4NjM3OTEiLCJyZWdpb25fZWRnZSI6ImlhZCIsInJlZ2lvbl9yZW5kZXIiOiJpYWQifQ==" data-pjax-transient="true" name="visitor-payload"/><meta content="fcf6fe8c31ff785ae6fa13eefc9a2f01f701e06fe703eb15c5fdc0407a3a3e7f" data-pjax-transient="true" name="visitor-hmac"/>
<meta content="repository:952181622" data-turbo-transient="" name="hovercard-subject-tag"/>
<meta content="repository,source-code,file-tree,copilot" data-turbo-transient="true" name="github-keyboard-shortcuts"/>
<meta data-turbo-transient="" name="selected-link" value="repo_source"/>
<link href="https://github.githubassets.com/" rel="assets"/>
<meta content="Apib7-x98H0j5cPqHWwSMm6dNU4GmODRoqxLiDzdx9I" name="google-site-verification"/>
<meta content="https://collector.github.com/github/collect" name="octolytics-url"/>
<meta content="/&lt;user-name&gt;/&lt;repo-name&gt;/blob/show" data-turbo-transient="true" name="analytics-location"/>
<meta content="" name="user-login"/>
<meta content="width=device-width" name="viewport"/>
<meta content="Contribute to BigBrotherJu/bigbrotherju.github.io development by creating an account on GitHub." name="description"/>
<link href="/opensearch.xml" rel="search" title="GitHub" type="application/opensearchdescription+xml"/>
<link href="https://github.com/fluidicon.png" rel="fluid-icon" title="GitHub"/>
<meta content="1401488693436528" property="fb:app_id"/>
<meta content="app-id=1477376905, app-argument=https://github.com/BigBrotherJu/bigbrotherju.github.io/blob/main/posts/2025-08-16-linux-trap.md" name="apple-itunes-app"/>
<meta content="https://opengraph.githubassets.com/27ebd3a7d36e9d3514987bb62b9a64ee9f4ce008867e3c4ee9d3a4d6800dd751/BigBrotherJu/bigbrotherju.github.io" name="twitter:image"/><meta content="@github" name="twitter:site"/><meta content="summary_large_image" name="twitter:card"/><meta content="bigbrotherju.github.io/posts/2025-08-16-linux-trap.md at main · BigBrotherJu/bigbrotherju.github.io" name="twitter:title"/><meta content="Contribute to BigBrotherJu/bigbrotherju.github.io development by creating an account on GitHub." name="twitter:description"/>
<meta content="https://opengraph.githubassets.com/27ebd3a7d36e9d3514987bb62b9a64ee9f4ce008867e3c4ee9d3a4d6800dd751/BigBrotherJu/bigbrotherju.github.io" property="og:image"/><meta content="Contribute to BigBrotherJu/bigbrotherju.github.io development by creating an account on GitHub." property="og:image:alt"/><meta content="1200" property="og:image:width"/><meta content="600" property="og:image:height"/><meta content="GitHub" property="og:site_name"/><meta content="object" property="og:type"/><meta content="bigbrotherju.github.io/posts/2025-08-16-linux-trap.md at main · BigBrotherJu/bigbrotherju.github.io" property="og:title"/><meta content="https://github.com/BigBrotherJu/bigbrotherju.github.io/blob/main/posts/2025-08-16-linux-trap.md" property="og:url"/><meta content="Contribute to BigBrotherJu/bigbrotherju.github.io development by creating an account on GitHub." property="og:description"/>
<meta content="github.com" name="hostname"/>
<meta content="github.com" name="expected-hostname"/>
<meta content="b53b1badc252d5751c2d039eb29276d1b0752105d31a34719ccbbb7ff170a55e" data-turbo-track="reload" http-equiv="x-pjax-version"/>
<meta content="21a43568025709b66240454fc92d4f09335a96863f8ab1c46b4a07f6a5b67102" data-turbo-track="reload" http-equiv="x-pjax-csp-version"/>
<meta content="8487fec39c8c06b815832ce80ebd89387f6b3bac9b5498b820bc97b9a51ed30a" data-turbo-track="reload" http-equiv="x-pjax-css-version"/>
<meta content="f43e093a6eb7d6b272418967a62d9b857eb23afb8887f322756b2991a2274405" data-turbo-track="reload" http-equiv="x-pjax-js-version"/>
<meta content="no-preview" data-turbo-transient="" name="turbo-cache-control"/>
<meta content="no-cache" data-turbo-transient="" name="turbo-cache-control"/>
<meta data-hydrostats="publish"/>
<meta content="github.com/BigBrotherJu/bigbrotherju.github.io git https://github.com/BigBrotherJu/bigbrotherju.github.io.git" name="go-import"/>
<meta content="47515692" name="octolytics-dimension-user_id"/><meta content="BigBrotherJu" name="octolytics-dimension-user_login"/><meta content="952181622" name="octolytics-dimension-repository_id"/><meta content="BigBrotherJu/bigbrotherju.github.io" name="octolytics-dimension-repository_nwo"/><meta content="true" name="octolytics-dimension-repository_public"/><meta content="false" name="octolytics-dimension-repository_is_fork"/><meta content="952181622" name="octolytics-dimension-repository_network_root_id"/><meta content="BigBrotherJu/bigbrotherju.github.io" name="octolytics-dimension-repository_network_root_nwo"/>
<meta content="logged-out env-production page-responsive" name="turbo-body-classes"/>
<meta content="false" name="disable-turbo"/>
<meta content="https://api.github.com/_private/browser/stats" name="browser-stats-url"/>
<meta content="https://api.github.com/_private/browser/errors" name="browser-errors-url"/>
<meta content="df0b85a84cfd3e4845a949b5d5bb074fddcf9fe8" name="release"/>
<meta content="full" name="ui-target"/>
<link color="#000000" href="https://github.githubassets.com/assets/pinned-octocat-093da3e6fa40.svg" rel="mask-icon"/>
<link class="js-site-favicon" href="https://github.githubassets.com/favicons/favicon.png" rel="alternate icon" type="image/png"/>
<link class="js-site-favicon" data-base-href="https://github.githubassets.com/favicons/favicon" href="https://github.githubassets.com/favicons/favicon.svg" rel="icon" type="image/svg+xml"/>
<meta content="#1e2327" name="theme-color"/>
<meta content="light dark" name="color-scheme"/>
<link crossorigin="use-credentials" href="/manifest.json" rel="manifest"/>
<link crossorigin="anonymous" href="https://github.githubassets.com/assets/14814.29aaeaafa90f007c6f61.module.css" rel="stylesheet" type="text/css"/><link crossorigin="anonymous" href="https://github.githubassets.com/assets/7275.8284bdfe1ee4804a58c1.module.css" rel="stylesheet" type="text/css"/><style data-styled="active" data-styled-version="5.3.11"></style><link crossorigin="anonymous" href="https://github.githubassets.com/assets/67216.753d458774a2f782559b.module.css" rel="stylesheet" type="text/css"/><style id="ms-consent-banner-main-styles">.w8hcgFksdo30C8w-bygqu{color:#000}.ydkKdaztSS0AeHWIeIHsQ a{color:#0067B8}.erL690_8JwUW-R4bJRcfl{background-color:#EBEBEB;border:none;color:#000}.erL690_8JwUW-R4bJRcfl:enabled:hover{color:#000;background-color:#DBDBDB;box-shadow:0px 4px 10px rgba(0,0,0,0.25);border:none}.erL690_8JwUW-R4bJRcfl:enabled:focus{background-color:#DBDBDB;box-shadow:0px 4px 10px rgba(0,0,0,0.25);border:2px solid #000}.erL690_8JwUW-R4bJRcfl:disabled{opacity:1;color:rgba(0,0,0,0.2);background-color:rgba(0,0,0,0.2);border:none}._1zNQOqxpBFSokeCLGi_hGr{border:none;background-color:#0067B8;color:#fff}._1zNQOqxpBFSokeCLGi_hGr:enabled:hover{color:#fff;background-color:#0067B8;box-shadow:0px 4px 10px rgba(0,0,0,0.25);border:none}._1zNQOqxpBFSokeCLGi_hGr:enabled:focus{background-color:#0067B8;box-shadow:0px 4px 10px rgba(0,0,0,0.25);border:2px solid #000}._1zNQOqxpBFSokeCLGi_hGr:disabled{opacity:1;color:rgba(0,0,0,0.2);background-color:rgba(0,120,215,0.2);border:none}._23tra1HsiiP6cT-Cka-ycB{position:relative;display:flex;z-index:9999;width:100%;background-color:#F2F2F2;justify-content:space-between;text-align:left}div[dir="rtl"]._23tra1HsiiP6cT-Cka-ycB{text-align:right}._1Upc2NjY8AlDn177YoVj0y{margin:0;padding-left:5%;padding-top:8px;padding-bottom:8px}div[dir="rtl"] ._1Upc2NjY8AlDn177YoVj0y{margin:0;padding:8px 5% 8px 0;float:none}._23tra1HsiiP6cT-Cka-ycB svg{fill:none;max-width:none;max-height:none}._1V_hlU-7jdtPiooHMu89BB{display:table-cell;padding:12px;width:24px;height:24px;font-family:Segoe UI, SegoeUI, Arial, sans-serif;font-style:normal;font-weight:normal;font-size:24px;line-height:0}.f6QKJD7fhSbnJLarTL-W-{display:table-cell;vertical-align:middle;padding:0;font-family:Segoe UI, SegoeUI, Arial, sans-serif;font-style:normal;font-weight:normal;font-size:13px;line-height:16px}.f6QKJD7fhSbnJLarTL-W- a{text-decoration:underline}._2j0fmugLb1FgYz6KPuB91w{display:inline-block;margin-left:5%;margin-right:5%;min-width:40%;min-width:calc((150px + 3 * 4px) * 2 + 150px);min-width:-webkit-fit-content;min-width:-moz-fit-content;min-width:fit-content;align-self:center;position:relative}._1XuCi2WhiqeWRUVp3pnFG3{margin:4px;padding:5px;min-width:150px;min-height:36px;vertical-align:top;cursor:pointer;font-family:Segoe UI, SegoeUI, Arial, sans-serif;font-style:normal;font-weight:normal;font-size:15px;line-height:20px;text-align:center}._1XuCi2WhiqeWRUVp3pnFG3:focus{box-sizing:border-box}._1XuCi2WhiqeWRUVp3pnFG3:disabled{cursor:not-allowed}._2bvsb3ubApyZ0UGoQA9O9T{display:block;position:fixed;z-index:10000;top:0;left:0;width:100%;height:100%;background-color:rgba(255,255,255,0.6);overflow:auto;text-align:left}div[dir="rtl"]._2bvsb3ubApyZ0UGoQA9O9T{text-align:right}div[dir="rtl"] ._2bvsb3ubApyZ0UGoQA9O9T{left:auto;right:0}.AFsJE948muYyzCMktdzuk{position:relative;top:8%;margin-bottom:40px;margin-left:auto;margin-right:auto;box-sizing:border-box;width:640px;background-color:#fff;border:1px solid #0067B8}._3kWyBRbW_dgnMiEyx06Fu4{float:right;z-index:1;margin:2px;padding:12px;border:none;cursor:pointer;font-family:Segoe UI, SegoeUI, Arial, sans-serif;font-style:normal;font-weight:normal;font-size:13px;line-height:13px;display:flex;align-items:center;text-align:center;color:#666;background-color:#fff}div[dir="rtl"] ._3kWyBRbW_dgnMiEyx06Fu4{margin:2px;padding:12px;float:left}.uCYvKvHXrhjNgflv1VqdD{position:static;margin-top:36px;margin-left:36px;margin-right:36px}._17pX1m9O_W--iZbDt3Ta5r{margin-top:0;margin-bottom:12px;font-family:Segoe UI, SegoeUI, Arial, sans-serif;font-style:normal;font-weight:600;font-size:20px;line-height:24px;text-transform:none}._1kBkHQ1V1wu3kl-YcLgUr6{height:446px;overflow:auto}._20_nXDf6uFs9Q6wxRXG-I-{margin-top:0;font-family:Segoe UI, SegoeUI, Arial, sans-serif;font-style:normal;font-weight:normal;font-size:15px;line-height:20px}._20_nXDf6uFs9Q6wxRXG-I- a{text-decoration:underline}dl._2a0NH_GDQEQe5Ynfo7suVH{margin-top:36px;margin-bottom:0;padding:0;list-style:none;text-transform:none}dt._3j_LCPv7fyXv3A8FIXVwZ4{margin-top:20px;float:none;font-family:Segoe UI, SegoeUI, Arial, sans-serif;font-style:normal;font-weight:600;font-size:18px;line-height:24px;list-style:none}.k-vxTGFbdq1aOZB2HHpjh{margin:0;padding:0;border:none}._2Bucyy75c_ogoU1g-liB5R{margin:0;padding:0;border-bottom:none;font-family:Segoe UI, SegoeUI, Arial, sans-serif;font-style:normal;font-weight:600;font-size:18px;line-height:24px;text-transform:none}._63gwfzV8dclrsl2cfd90r{display:inline-block;margin-top:0;margin-bottom:13px;font-family:Segoe UI, SegoeUI, Arial, sans-serif;font-style:normal;font-weight:normal;font-size:15px;line-height:20px}._1l8wM_4mRYGz3Iu7l3BZR7{display:block}._2UE03QS02aZGkslegN_F-i{display:inline-block;position:relative;left:5px;margin-bottom:13px;margin-right:34px;padding:3px}div[dir="rtl"] ._2UE03QS02aZGkslegN_F-i{margin:0 0 13px 34px;padding:3px;float:none}div[dir="rtl"] ._2UE03QS02aZGkslegN_F-i{left:auto;right:5px}._23tra1HsiiP6cT-Cka-ycB *::before,._2bvsb3ubApyZ0UGoQA9O9T *::before,._23tra1HsiiP6cT-Cka-ycB *::after,._2bvsb3ubApyZ0UGoQA9O9T *::after{box-sizing:inherit}._1HSFn0HzGo6w4ADApV8-c4{outline:2px solid rgba(0,0,0,0.8)}input[type="radio"]._1dp8Vp5m3HwAqGx8qBmFV2{display:inline-block;position:relative;margin-top:0;margin-left:0;margin-right:0;height:0;width:0;border-radius:0;cursor:pointer;outline:none;box-sizing:border-box;-webkit-appearance:none;-moz-appearance:none;appearance:none}input[type="radio"]._1dp8Vp5m3HwAqGx8qBmFV2+label::before{display:block;position:absolute;top:5px;left:3px;height:19px;width:19px;content:"";border-radius:50%;border:1px solid #000;background-color:#fff}div[dir="rtl"] input[type="radio"]._1dp8Vp5m3HwAqGx8qBmFV2+label::before{left:auto;right:3px}input[type="radio"]._1dp8Vp5m3HwAqGx8qBmFV2:not(:disabled)+label:hover::before{border:1px solid #0067B8}input[type="radio"]._1dp8Vp5m3HwAqGx8qBmFV2:not(:disabled)+label:hover::after{display:block;position:absolute;top:10px;left:8px;height:9px;width:9px;content:"";border-radius:50%;background-color:rgba(0,0,0,0.8)}div[dir="rtl"] input[type="radio"]._1dp8Vp5m3HwAqGx8qBmFV2:not(:disabled)+label:hover::after{left:auto;right:8px}input[type="radio"]._1dp8Vp5m3HwAqGx8qBmFV2:not(:disabled)+label:focus::before{border:1px solid #0067B8}input[type="radio"]._1dp8Vp5m3HwAqGx8qBmFV2:not(:disabled)+label:focus::after{display:block;position:absolute;top:10px;left:8px;height:9px;width:9px;content:"";border-radius:50%;background-color:#000}div[dir="rtl"] input[type="radio"]._1dp8Vp5m3HwAqGx8qBmFV2:not(:disabled)+label:focus::after{left:auto;right:8px}input[type="radio"]._1dp8Vp5m3HwAqGx8qBmFV2:checked+label::after{display:block;position:absolute;top:10px;left:8px;height:9px;width:9px;content:"";border-radius:50%;background-color:#000}div[dir="rtl"] input[type="radio"]._1dp8Vp5m3HwAqGx8qBmFV2:checked+label::after{left:auto;right:8px}input[type="radio"]._1dp8Vp5m3HwAqGx8qBmFV2:disabled+label{cursor:not-allowed}input[type="radio"]._1dp8Vp5m3HwAqGx8qBmFV2:disabled+label::before{border:1px solid rgba(0,0,0,0.2);background-color:rgba(0,0,0,0.2)}._3RJzeL3l9Rl_lAQEm6VwdX{display:block;position:static;float:right;margin-top:0;margin-bottom:0;margin-left:19px;margin-right:0;padding-top:0;padding-bottom:0;padding-left:8px;padding-right:0;width:80%;width:calc(100% - 19px);font-family:Segoe UI, SegoeUI, Arial, sans-serif;font-style:normal;font-weight:normal;font-size:15px;line-height:20px;text-transform:none;cursor:pointer;box-sizing:border-box}div[dir="rtl"] ._3RJzeL3l9Rl_lAQEm6VwdX{margin:0 19px 0 0;padding:0 8px 0 0;float:left}.nohp3sIG12ZBhzcMnPala{margin-top:20px;margin-bottom:48px}._2uhaEsmeotZ3P-M0AXo2kF{padding:0;width:278px;height:36px;cursor:pointer;font-family:Segoe UI, SegoeUI, Arial, sans-serif;font-style:normal;font-weight:normal;font-size:15px;line-height:20px;text-align:center}._2uhaEsmeotZ3P-M0AXo2kF:focus{box-sizing:border-box}._2uhaEsmeotZ3P-M0AXo2kF:disabled{cursor:not-allowed}._3tOu1FJ59c_xz_PmI1lKV5{float:right;padding:0;width:278px;height:36px;cursor:pointer;font-family:Segoe UI, SegoeUI, Arial, sans-serif;font-style:normal;font-weight:normal;font-size:15px;line-height:20px;text-align:center}._3tOu1FJ59c_xz_PmI1lKV5:focus{box-sizing:border-box}._3tOu1FJ59c_xz_PmI1lKV5:disabled{cursor:not-allowed}div[dir="rtl"] ._3tOu1FJ59c_xz_PmI1lKV5{margin:0;padding:0;float:left}@media only screen and (max-width: 768px){._2j0fmugLb1FgYz6KPuB91w,._1Upc2NjY8AlDn177YoVj0y{padding-top:8px;padding-bottom:12px;padding-left:3.75%;padding-right:3.75%;margin:0;width:92.5%}._23tra1HsiiP6cT-Cka-ycB{display:block}._1XuCi2WhiqeWRUVp3pnFG3{margin-bottom:8px;margin-left:0;margin-right:0;width:100%}._2bvsb3ubApyZ0UGoQA9O9T{overflow:hidden}.AFsJE948muYyzCMktdzuk{top:1.8%;width:93.33%;height:96.4%;overflow:hidden}.uCYvKvHXrhjNgflv1VqdD{margin-top:24px;margin-left:24px;margin-right:24px;height:100%}._1kBkHQ1V1wu3kl-YcLgUr6{height:62%;height:calc(100% - 188px);min-height:50%}._2uhaEsmeotZ3P-M0AXo2kF{width:100%}._3tOu1FJ59c_xz_PmI1lKV5{margin-bottom:12px;margin-left:0;width:100%}div[dir="rtl"] ._3tOu1FJ59c_xz_PmI1lKV5{margin:0 0 12px 0;padding:0;float:none}}@media only screen and (max-width: 768px) and (orientation: landscape), only screen and (max-height: 260px), only screen and (max-width: 340px){.AFsJE948muYyzCMktdzuk{overflow:auto}}@media only screen and (max-height: 260px), only screen and (max-width: 340px){._1XuCi2WhiqeWRUVp3pnFG3{min-width:0}._3kWyBRbW_dgnMiEyx06Fu4{padding:3%}.uCYvKvHXrhjNgflv1VqdD{margin-top:3%;margin-left:3%;margin-right:3%}._17pX1m9O_W--iZbDt3Ta5r{margin-bottom:3%}._1kBkHQ1V1wu3kl-YcLgUr6{height:calc(79% - 64px)}.nohp3sIG12ZBhzcMnPala{margin-top:5%;margin-bottom:10%}._3tOu1FJ59c_xz_PmI1lKV5{margin-bottom:3%}div[dir="rtl"] ._3tOu1FJ59c_xz_PmI1lKV5{margin:0 0 3% 0;padding:0;float:none}}
</style><style id="ms-consent-banner-theme-styles" type="text/css">._23tra1HsiiP6cT-Cka-ycB {
            background-color: #24292f !important;
        }.w8hcgFksdo30C8w-bygqu {
            color: #ffffff !important;
        }.ydkKdaztSS0AeHWIeIHsQ a {
            color: #d8b9ff !important;
        }._2bvsb3ubApyZ0UGoQA9O9T {
            background-color: rgba(23, 23, 23, 0.8) !important;
        }.AFsJE948muYyzCMktdzuk {
            background-color: #24292f !important;
            border: 1px solid #d8b9ff !important;
        }._3kWyBRbW_dgnMiEyx06Fu4 {
            color: #d8b9ff !important;
            background-color: #24292f !important;
        }._1zNQOqxpBFSokeCLGi_hGr {
            border: 1px solid #ffffff !important;
            background-color: #ffffff !important;
            color: #1f2328 !important;
        }._1zNQOqxpBFSokeCLGi_hGr:enabled:hover {
            color: #1f2328 !important;
            background-color: #d8b9ff !important;
            box-shadow: none !important;
            border: 1px solid transparent !important;
        }._1zNQOqxpBFSokeCLGi_hGr:enabled:focus {
            background-color: #d8b9ff !important;
            box-shadow: none !important;
            border: 2px solid #ffffff !important;
        }._1zNQOqxpBFSokeCLGi_hGr:disabled {
            opacity: 0.5 !important;
            color: #1f2328 !important;
            background-color: #ffffff !important;
            border: 1px solid transparent !important;
        }.erL690_8JwUW-R4bJRcfl {
            border: 1px solid #eaeef2 !important;
            background-color: #32383f !important;
            color: #ffffff !important;
        }.erL690_8JwUW-R4bJRcfl:enabled:hover {
            color: #ffffff !important;
            background-color: #24292f !important;
            box-shadow: none !important;
            border: 1px solid #ffffff !important;
        }.erL690_8JwUW-R4bJRcfl:enabled:focus {
            background-color: #24292f !important;
            box-shadow: none !important;
            border: 2px solid #6e7781 !important;
        }.erL690_8JwUW-R4bJRcfl:disabled {
            opacity: 0.5 !important;
            color: #ffffff !important;
            background-color: #424a53 !important;
            border: 1px solid #6e7781 !important;
        }input[type="radio"]._1dp8Vp5m3HwAqGx8qBmFV2 + label::before {
            border: 1px solid #d8b9ff !important;
            background-color: #24292f !important;
        }._1HSFn0HzGo6w4ADApV8-c4 {
            outline: 2px solid #ffffff !important;
        }input[type="radio"]._1dp8Vp5m3HwAqGx8qBmFV2:checked + label::after {
            background-color: #d8b9ff !important;
        }input[type="radio"]._1dp8Vp5m3HwAqGx8qBmFV2 + label:hover::before {
            border: 1px solid #ffffff !important;
        }input[type="radio"]._1dp8Vp5m3HwAqGx8qBmFV2 + label:hover::after {
            background-color: #ffffff !important;
        }input[type="radio"]._1dp8Vp5m3HwAqGx8qBmFV2 + label:focus::before {
            border: 1px solid #ffffff !important;
        }input[type="radio"]._1dp8Vp5m3HwAqGx8qBmFV2 + label:focus::after {
            background-color: #d8b9ff !important;
        }input[type="radio"]._1dp8Vp5m3HwAqGx8qBmFV2:disabled + label::before {
            border: 1px solid rgba(227, 227, 227, 0.2) !important;
            background-color: rgba(227, 227, 227, 0.2) !important;
        }</style></head>
<body class="logged-out env-production page-responsive" style="overflow-wrap: break-word; --dialog-scrollgutter: 0px;"><div class="Box-sc-62in7e-0 lhfNqO js-snippet-clipboard-copy-unpositioned undefined" data-hpc="true" style="padding: 32px"><article class="markdown-body entry-content container-lg" itemprop="text"><div class="markdown-heading" dir="auto"><h1 class="heading-element" dir="auto" tabindex="-1">Traps in RISC-V Linux</h1><a aria-label="Permalink: Traps in RISC-V Linux" class="anchor" href="#traps-in-risc-v-linux" id="user-content-traps-in-risc-v-linux"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">主要关注中断路径。<code>CSR_TVEC</code> 被设置为 <code>handle_exception</code>。</p>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto" tabindex="-1">handle_exception</h2><a aria-label="Permalink: handle_exception" class="anchor" href="#handle_exception" id="user-content-handle_exception"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto" tabindex="-1">Enter from Userspace</h3><a aria-label="Permalink: Enter from Userspace" class="anchor" href="#enter-from-userspace" id="user-content-enter-from-userspace"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto"><pre class="notranslate"><code>// arch/riscv/kernel/entry.S

// 从 userspace 进入，CSR_SCRATCH 里是 kernel tp

SYM_CODE_START(handle_exception)
	/*
	 * If coming from userspace, preserve the user thread pointer and load
	 * the kernel thread pointer.  If we came from the kernel, the scratch
	 * register will contain 0, and we should continue on the current TP.
	 */

// tp = old CSR_SCRATCH
// CSR_SCRATCH = old tp
	csrrw tp, CSR_SCRATCH, tp

// 从 userspace 进入，tp 现在是 kernel tp，scratch 现在是 user tp

// tp 不是 0，即从 userspace 进入，跳转到 .Lsave_context
	bnez tp, .Lsave_context

...

// tp 现在是 kernel tp，kernel tp 指向 task_struct
.Lsave_context:
// 1. 先把寄存器保存在 kernel stack 最顶上的 pt_regs 中，不然下面没有寄存器可用

// sp 现在是 user sp，先存在 TASK_TI_USER_SP 中
	REG_S sp, TASK_TI_USER_SP(tp)
// sp 现在是 kernel stack
	REG_L sp, TASK_TI_KERNEL_SP(tp)
// 把除了 sp tp 的所有寄存器都存在 kernel stack 上的 pt_regs 中
// user sp 上面已经保存在 TASK_TI_USER_SP 中，现在还不好直接保存，下面再保存
// user tp 现在在 scratch 中，下面再保存
	addi sp, sp, -(PT_SIZE_ON_STACK)
	REG_S x1,  PT_RA(sp)
	REG_S x3,  PT_GP(sp)
	REG_S x5,  PT_T0(sp)
	save_from_x6_to_x31

// 2. 禁用一些功能
	/*
	 * Disable user-mode memory access as it should only be set in the
	 * actual user copy routines.
	 *
	 * Disable the FPU/Vector to detect illegal usage of floating point
	 * or vector in kernel space.
	 */
	li t0, SR_SUM | SR_FS_VS

// 3. 保存 pt_regs 需要的其他寄存器，特别注意 user sp 和 user tp

// user sp 被放在 s0 中
	REG_L s0, TASK_TI_USER_SP(tp)
// 原来的 status 被放在 s1 中，然后 status 中 SUM FS VS 被置 0
	csrrc s1, CSR_STATUS, t0
	csrr s2, CSR_EPC
	csrr s3, CSR_TVAL
	csrr s4, CSR_CAUSE
// user tp 被放在 s5 中
	csrr s5, CSR_SCRATCH
	REG_S s0, PT_SP(sp)
	REG_S s1, PT_STATUS(sp)
	REG_S s2, PT_EPC(sp)
	REG_S s3, PT_BADADDR(sp)
	REG_S s4, PT_CAUSE(sp)
	REG_S s5, PT_TP(sp)

// 到这里，user program 被打断时的所有寄存器状态都被保存了

	/*
	 * Set the scratch register to 0, so that if a recursive exception
	 * occurs, the exception vector knows it came from the kernel
	 */
	csrw CSR_SCRATCH, x0

	/* Load the global pointer */
	load_global_pointer

	/* Load the kernel shadow call stack pointer if coming from userspace */
	scs_load_current_if_task_changed s5

#ifdef CONFIG_RISCV_ISA_V_PREEMPTIVE
	move a0, sp
	call riscv_v_context_nesting_start
#endif
	move a0, sp /* pt_regs */

	/*
	 * MSB of cause differentiates between
	 * interrupts and exceptions
	 */
	bge s4, zero, 1f

	/* Handle interrupts */
	call do_irq
	j ret_from_exception
1:
	/* Handle other exceptions */
	slli t0, s4, RISCV_LGPTR
	la t1, excp_vect_table
	la t2, excp_vect_table_end
	add t0, t1, t0
	/* Check if exception code lies within bounds */
	bgeu t0, t2, 3f
	REG_L t1, 0(t0)
2:	jalr t1
	j ret_from_exception
3:

	la t1, do_trap_unknown
	j 2b
SYM_CODE_END(handle_exception)
ASM_NOKPROBE(handle_exception)
</code></pre><div class="zeroclipboard-container">
<clipboard-copy aria-label="Copy" class="ClipboardButton btn btn-invisible js-clipboard-copy m-2 p-0 d-flex flex-justify-center flex-items-center" data-copy-feedback="Copied!" data-tooltip-direction="w" role="button" tabindex="0" value="// arch/riscv/kernel/entry.S

// 从 userspace 进入，CSR_SCRATCH 里是 kernel tp

SYM_CODE_START(handle_exception)
	/*
	 * If coming from userspace, preserve the user thread pointer and load
	 * the kernel thread pointer.  If we came from the kernel, the scratch
	 * register will contain 0, and we should continue on the current TP.
	 */

// tp = old CSR_SCRATCH
// CSR_SCRATCH = old tp
	csrrw tp, CSR_SCRATCH, tp

// 从 userspace 进入，tp 现在是 kernel tp，scratch 现在是 user tp

// tp 不是 0，即从 userspace 进入，跳转到 .Lsave_context
	bnez tp, .Lsave_context

...

// tp 现在是 kernel tp，kernel tp 指向 task_struct
.Lsave_context:
// 1. 先把寄存器保存在 kernel stack 最顶上的 pt_regs 中，不然下面没有寄存器可用

// sp 现在是 user sp，先存在 TASK_TI_USER_SP 中
	REG_S sp, TASK_TI_USER_SP(tp)
// sp 现在是 kernel stack
	REG_L sp, TASK_TI_KERNEL_SP(tp)
// 把除了 sp tp 的所有寄存器都存在 kernel stack 上的 pt_regs 中
// user sp 上面已经保存在 TASK_TI_USER_SP 中，现在还不好直接保存，下面再保存
// user tp 现在在 scratch 中，下面再保存
	addi sp, sp, -(PT_SIZE_ON_STACK)
	REG_S x1,  PT_RA(sp)
	REG_S x3,  PT_GP(sp)
	REG_S x5,  PT_T0(sp)
	save_from_x6_to_x31

// 2. 禁用一些功能
	/*
	 * Disable user-mode memory access as it should only be set in the
	 * actual user copy routines.
	 *
	 * Disable the FPU/Vector to detect illegal usage of floating point
	 * or vector in kernel space.
	 */
	li t0, SR_SUM | SR_FS_VS

// 3. 保存 pt_regs 需要的其他寄存器，特别注意 user sp 和 user tp

// user sp 被放在 s0 中
	REG_L s0, TASK_TI_USER_SP(tp)
// 原来的 status 被放在 s1 中，然后 status 中 SUM FS VS 被置 0
	csrrc s1, CSR_STATUS, t0
	csrr s2, CSR_EPC
	csrr s3, CSR_TVAL
	csrr s4, CSR_CAUSE
// user tp 被放在 s5 中
	csrr s5, CSR_SCRATCH
	REG_S s0, PT_SP(sp)
	REG_S s1, PT_STATUS(sp)
	REG_S s2, PT_EPC(sp)
	REG_S s3, PT_BADADDR(sp)
	REG_S s4, PT_CAUSE(sp)
	REG_S s5, PT_TP(sp)

// 到这里，user program 被打断时的所有寄存器状态都被保存了

	/*
	 * Set the scratch register to 0, so that if a recursive exception
	 * occurs, the exception vector knows it came from the kernel
	 */
	csrw CSR_SCRATCH, x0

	/* Load the global pointer */
	load_global_pointer

	/* Load the kernel shadow call stack pointer if coming from userspace */
	scs_load_current_if_task_changed s5

#ifdef CONFIG_RISCV_ISA_V_PREEMPTIVE
	move a0, sp
	call riscv_v_context_nesting_start
#endif
	move a0, sp /* pt_regs */

	/*
	 * MSB of cause differentiates between
	 * interrupts and exceptions
	 */
	bge s4, zero, 1f

	/* Handle interrupts */
	call do_irq
	j ret_from_exception
1:
	/* Handle other exceptions */
	slli t0, s4, RISCV_LGPTR
	la t1, excp_vect_table
	la t2, excp_vect_table_end
	add t0, t1, t0
	/* Check if exception code lies within bounds */
	bgeu t0, t2, 3f
	REG_L t1, 0(t0)
2:	jalr t1
	j ret_from_exception
3:

	la t1, do_trap_unknown
	j 2b
SYM_CODE_END(handle_exception)
ASM_NOKPROBE(handle_exception)">
<svg aria-hidden="true" class="octicon octicon-copy js-clipboard-copy-icon" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path>
</svg>
<svg aria-hidden="true" class="octicon octicon-check js-clipboard-check-icon color-fg-success d-none" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"></path>
</svg>
</clipboard-copy>
</div></div>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto" tabindex="-1">Enter from Kernel</h3><a aria-label="Permalink: Enter from Kernel" class="anchor" href="#enter-from-kernel" id="user-content-enter-from-kernel"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto"><pre class="notranslate"><code>// arch/riscv/kernel/entry.S

// 从 kernel 进入，CSR_SCRATCH 里是 0

SYM_CODE_START(handle_exception)
	/*
	 * If coming from userspace, preserve the user thread pointer and load
	 * the kernel thread pointer.  If we came from the kernel, the scratch
	 * register will contain 0, and we should continue on the current TP.
	 */

// tp = old CSR_SCRATCH
// CSR_SCRATCH = old tp
	csrrw tp, CSR_SCRATCH, tp

// 从 kernel 进入，tp 现在是 0，scratch 现在是 kernel tp

// 不跳转
	bnez tp, .Lsave_context

.Lrestore_kernel_tpsp:
// tp 现在是 kernel tp
	csrr tp, CSR_SCRATCH

#ifdef CONFIG_64BIT
	/*
	 * The RISC-V kernel does not eagerly emit a sfence.vma after each
	 * new vmalloc mapping, which may result in exceptions:
	 * - if the uarch caches invalid entries, the new mapping would not be
	 *   observed by the page table walker and an invalidation is needed.
	 * - if the uarch does not cache invalid entries, a reordered access
	 *   could "miss" the new mapping and traps: in that case, we only need
	 *   to retry the access, no sfence.vma is required.
	 */
// 只有 RV64 实现了 lazy TLB flushing for vmalloc
// 直接在这里处理 vmalloc 引起的 exception
// 而不是在后面的 page fault handler 中处理
// 如果确实是 vmalloc 引起的 exception，直接处理并且 sret
	new_vmalloc_check
#endif

// 把被打断的 kernel sp 保存到 TASK_TI_KERNEL_SP
	REG_S sp, TASK_TI_KERNEL_SP(tp)

#ifdef CONFIG_VMAP_STACK
// 计算在栈上保存好 struct pt_regs 以后，sp 的值，看看有没有 overflow
	addi sp, sp, -(PT_SIZE_ON_STACK)
	srli sp, sp, THREAD_SHIFT
	andi sp, sp, 0x1
// 如果有 overflow，直接去 handle_kernel_stack_overflow 处理
	bnez sp, handle_kernel_stack_overflow
// 如果没有 overflow，复原原来的 kernel sp
	REG_L sp, TASK_TI_KERNEL_SP(tp)
#endif

.Lsave_context:
// 把被打断的 kernel sp 保存到 TASK_TI_USER_SP，下面再进行保存
	REG_S sp, TASK_TI_USER_SP(tp)
// sp 现在是 kernel stack
	REG_L sp, TASK_TI_KERNEL_SP(tp)
// 把除了 sp tp 的所有寄存器都存在 kernel stack 上的 pt_regs 中
// kernel sp 上面已经保存在 TASK_TI_USER_SP 中，现在还不好直接保存，下面再保存
// kernel tp 现在就在 tp 中
	addi sp, sp, -(PT_SIZE_ON_STACK)
	REG_S x1,  PT_RA(sp)
	REG_S x3,  PT_GP(sp)
	REG_S x5,  PT_T0(sp)
	save_from_x6_to_x31

// 2. 禁用一些功能
	/*
	 * Disable user-mode memory access as it should only be set in the
	 * actual user copy routines.
	 *
	 * Disable the FPU/Vector to detect illegal usage of floating point
	 * or vector in kernel space.
	 */
	li t0, SR_SUM | SR_FS_VS

// 3. 保存 pt_regs 需要的其他寄存器，特别注意 user sp 和 user tp

// 被打断的 kernel sp 被放在 s0 中
	REG_L s0, TASK_TI_USER_SP(tp)
// 原来的 status 被放在 s1 中，然后 status 中 SUM FS VS 被置 0
	csrrc s1, CSR_STATUS, t0
	csrr s2, CSR_EPC
	csrr s3, CSR_TVAL
	csrr s4, CSR_CAUSE
// 被打断的 kernel tp 被放在 s5 中
	csrr s5, CSR_SCRATCH
	REG_S s0, PT_SP(sp)
	REG_S s1, PT_STATUS(sp)
	REG_S s2, PT_EPC(sp)
	REG_S s3, PT_BADADDR(sp)
	REG_S s4, PT_CAUSE(sp)
	REG_S s5, PT_TP(sp)

	/*
	 * Set the scratch register to 0, so that if a recursive exception
	 * occurs, the exception vector knows it came from the kernel
	 */
	csrw CSR_SCRATCH, x0

	/* Load the global pointer */
	load_global_pointer

	/* Load the kernel shadow call stack pointer if coming from userspace */
	scs_load_current_if_task_changed s5

#ifdef CONFIG_RISCV_ISA_V_PREEMPTIVE
	move a0, sp
	call riscv_v_context_nesting_start
#endif
	move a0, sp /* pt_regs */

	/*
	 * MSB of cause differentiates between
	 * interrupts and exceptions
	 */
	bge s4, zero, 1f

	/* Handle interrupts */
	call do_irq
	j ret_from_exception
1:
	/* Handle other exceptions */
	slli t0, s4, RISCV_LGPTR
	la t1, excp_vect_table
	la t2, excp_vect_table_end
	add t0, t1, t0
	/* Check if exception code lies within bounds */
	bgeu t0, t2, 3f
	REG_L t1, 0(t0)
2:	jalr t1
	j ret_from_exception
3:

	la t1, do_trap_unknown
	j 2b
SYM_CODE_END(handle_exception)
ASM_NOKPROBE(handle_exception)
</code></pre><div class="zeroclipboard-container">
<clipboard-copy aria-label="Copy" class="ClipboardButton btn btn-invisible js-clipboard-copy m-2 p-0 d-flex flex-justify-center flex-items-center" data-copy-feedback="Copied!" data-tooltip-direction="w" role="button" tabindex="0" value='// arch/riscv/kernel/entry.S

// 从 kernel 进入，CSR_SCRATCH 里是 0

SYM_CODE_START(handle_exception)
	/*
	 * If coming from userspace, preserve the user thread pointer and load
	 * the kernel thread pointer.  If we came from the kernel, the scratch
	 * register will contain 0, and we should continue on the current TP.
	 */

// tp = old CSR_SCRATCH
// CSR_SCRATCH = old tp
	csrrw tp, CSR_SCRATCH, tp

// 从 kernel 进入，tp 现在是 0，scratch 现在是 kernel tp

// 不跳转
	bnez tp, .Lsave_context

.Lrestore_kernel_tpsp:
// tp 现在是 kernel tp
	csrr tp, CSR_SCRATCH

#ifdef CONFIG_64BIT
	/*
	 * The RISC-V kernel does not eagerly emit a sfence.vma after each
	 * new vmalloc mapping, which may result in exceptions:
	 * - if the uarch caches invalid entries, the new mapping would not be
	 *   observed by the page table walker and an invalidation is needed.
	 * - if the uarch does not cache invalid entries, a reordered access
	 *   could "miss" the new mapping and traps: in that case, we only need
	 *   to retry the access, no sfence.vma is required.
	 */
// 只有 RV64 实现了 lazy TLB flushing for vmalloc
// 直接在这里处理 vmalloc 引起的 exception
// 而不是在后面的 page fault handler 中处理
// 如果确实是 vmalloc 引起的 exception，直接处理并且 sret
	new_vmalloc_check
#endif

// 把被打断的 kernel sp 保存到 TASK_TI_KERNEL_SP
	REG_S sp, TASK_TI_KERNEL_SP(tp)

#ifdef CONFIG_VMAP_STACK
// 计算在栈上保存好 struct pt_regs 以后，sp 的值，看看有没有 overflow
	addi sp, sp, -(PT_SIZE_ON_STACK)
	srli sp, sp, THREAD_SHIFT
	andi sp, sp, 0x1
// 如果有 overflow，直接去 handle_kernel_stack_overflow 处理
	bnez sp, handle_kernel_stack_overflow
// 如果没有 overflow，复原原来的 kernel sp
	REG_L sp, TASK_TI_KERNEL_SP(tp)
#endif

.Lsave_context:
// 把被打断的 kernel sp 保存到 TASK_TI_USER_SP，下面再进行保存
	REG_S sp, TASK_TI_USER_SP(tp)
// sp 现在是 kernel stack
	REG_L sp, TASK_TI_KERNEL_SP(tp)
// 把除了 sp tp 的所有寄存器都存在 kernel stack 上的 pt_regs 中
// kernel sp 上面已经保存在 TASK_TI_USER_SP 中，现在还不好直接保存，下面再保存
// kernel tp 现在就在 tp 中
	addi sp, sp, -(PT_SIZE_ON_STACK)
	REG_S x1,  PT_RA(sp)
	REG_S x3,  PT_GP(sp)
	REG_S x5,  PT_T0(sp)
	save_from_x6_to_x31

// 2. 禁用一些功能
	/*
	 * Disable user-mode memory access as it should only be set in the
	 * actual user copy routines.
	 *
	 * Disable the FPU/Vector to detect illegal usage of floating point
	 * or vector in kernel space.
	 */
	li t0, SR_SUM | SR_FS_VS

// 3. 保存 pt_regs 需要的其他寄存器，特别注意 user sp 和 user tp

// 被打断的 kernel sp 被放在 s0 中
	REG_L s0, TASK_TI_USER_SP(tp)
// 原来的 status 被放在 s1 中，然后 status 中 SUM FS VS 被置 0
	csrrc s1, CSR_STATUS, t0
	csrr s2, CSR_EPC
	csrr s3, CSR_TVAL
	csrr s4, CSR_CAUSE
// 被打断的 kernel tp 被放在 s5 中
	csrr s5, CSR_SCRATCH
	REG_S s0, PT_SP(sp)
	REG_S s1, PT_STATUS(sp)
	REG_S s2, PT_EPC(sp)
	REG_S s3, PT_BADADDR(sp)
	REG_S s4, PT_CAUSE(sp)
	REG_S s5, PT_TP(sp)

	/*
	 * Set the scratch register to 0, so that if a recursive exception
	 * occurs, the exception vector knows it came from the kernel
	 */
	csrw CSR_SCRATCH, x0

	/* Load the global pointer */
	load_global_pointer

	/* Load the kernel shadow call stack pointer if coming from userspace */
	scs_load_current_if_task_changed s5

#ifdef CONFIG_RISCV_ISA_V_PREEMPTIVE
	move a0, sp
	call riscv_v_context_nesting_start
#endif
	move a0, sp /* pt_regs */

	/*
	 * MSB of cause differentiates between
	 * interrupts and exceptions
	 */
	bge s4, zero, 1f

	/* Handle interrupts */
	call do_irq
	j ret_from_exception
1:
	/* Handle other exceptions */
	slli t0, s4, RISCV_LGPTR
	la t1, excp_vect_table
	la t2, excp_vect_table_end
	add t0, t1, t0
	/* Check if exception code lies within bounds */
	bgeu t0, t2, 3f
	REG_L t1, 0(t0)
2:	jalr t1
	j ret_from_exception
3:

	la t1, do_trap_unknown
	j 2b
SYM_CODE_END(handle_exception)
ASM_NOKPROBE(handle_exception)'>
<svg aria-hidden="true" class="octicon octicon-copy js-clipboard-copy-icon" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path>
</svg>
<svg aria-hidden="true" class="octicon octicon-check js-clipboard-check-icon color-fg-success d-none" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"></path>
</svg>
</clipboard-copy>
</div></div>
<div class="markdown-heading" dir="auto"><h4 class="heading-element" dir="auto" tabindex="-1">嵌套问题</h4><a aria-label="Permalink: 嵌套问题" class="anchor" href="#嵌套问题" id="user-content-嵌套问题"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">// TODO</p>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto" tabindex="-1">asm-offsets</h3><a aria-label="Permalink: asm-offsets" class="anchor" href="#asm-offsets" id="user-content-asm-offsets"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">根据编译 log，主要有以下两步：</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto"><pre class="notranslate"><code># CC      arch/riscv/kernel/asm-offsets.s

set -e; mkdir -p include/generated/;
trap "rm -f include/generated/.tmp_asm-offsets.h" EXIT;
{ echo "#ifndef __ASM_OFFSETS_H__";
  echo "#define __ASM_OFFSETS_H__";
  echo "/*";
  echo " * DO NOT MODIFY.";
  echo " *";
  echo " * This file was generated by Kbuild";
  echo " */";
  echo "";
  sed -ne 's:^[[:space:]]*\.ascii[[:space:]]*"\(.*\)".*:\1:; /^-&gt;/{s:-&gt;#\(.*\):/* \1 */:; s:^-&gt;\([^ ]*\) [\$#]*\([^ ]*\) \(.*\):#define \1 \2 /* \3 */:; s:-&gt;::; p;}' &lt; arch/riscv/kernel/asm-offsets.s;
  echo "";
  echo "#endif";
} &gt; include/generated/.tmp_asm-offsets.h;
if [ ! -r include/generated/asm-offsets.h ] || ! cmp -s include/generated/asm-offsets.h include/generated/.tmp_asm-offsets.h;
    then:
        '  UPD     include/generated/asm-offsets.h';
        mv -f include/generated/.tmp_asm-offsets.h include/generated/asm-offsets.h;
fi
</code></pre><div class="zeroclipboard-container">
<clipboard-copy aria-label="Copy" class="ClipboardButton btn btn-invisible js-clipboard-copy m-2 p-0 d-flex flex-justify-center flex-items-center" data-copy-feedback="Copied!" data-tooltip-direction="w" role="button" tabindex="0" value="# CC      arch/riscv/kernel/asm-offsets.s

set -e; mkdir -p include/generated/;
trap &quot;rm -f include/generated/.tmp_asm-offsets.h&quot; EXIT;
{ echo &quot;#ifndef __ASM_OFFSETS_H__&quot;;
  echo &quot;#define __ASM_OFFSETS_H__&quot;;
  echo &quot;/*&quot;;
  echo &quot; * DO NOT MODIFY.&quot;;
  echo &quot; *&quot;;
  echo &quot; * This file was generated by Kbuild&quot;;
  echo &quot; */&quot;;
  echo &quot;&quot;;
  sed -ne 's:^[[:space:]]*\.ascii[[:space:]]*&quot;\(.*\)&quot;.*:\1:; /^-&gt;/{s:-&gt;#\(.*\):/* \1 */:; s:^-&gt;\([^ ]*\) [\$#]*\([^ ]*\) \(.*\):#define \1 \2 /* \3 */:; s:-&gt;::; p;}' &lt; arch/riscv/kernel/asm-offsets.s;
  echo &quot;&quot;;
  echo &quot;#endif&quot;;
} &gt; include/generated/.tmp_asm-offsets.h;
if [ ! -r include/generated/asm-offsets.h ] || ! cmp -s include/generated/asm-offsets.h include/generated/.tmp_asm-offsets.h;
    then:
        '  UPD     include/generated/asm-offsets.h';
        mv -f include/generated/.tmp_asm-offsets.h include/generated/asm-offsets.h;
fi">
<svg aria-hidden="true" class="octicon octicon-copy js-clipboard-copy-icon" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path>
</svg>
<svg aria-hidden="true" class="octicon octicon-check js-clipboard-check-icon color-fg-success d-none" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"></path>
</svg>
</clipboard-copy>
</div></div>
<p dir="auto">第一步、从 <code>asm-offsets.c</code> 生成 <code>asm-offsets.s</code>。</p>
<p dir="auto"><code>asm-offsets.c</code> 中只有一个函数 <code>void asm_offsets(void)</code>。其中使用宏 <code>OFFSET</code> <code>DEFINE</code>，比如：</p>
<div class="highlight highlight-source-c notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-c">// arch/riscv/kernel/asm-offsets.c</span>

<span class="pl-smi">void</span> <span class="pl-en">asm_offsets</span>(<span class="pl-smi">void</span>)
{
	<span class="pl-en">OFFSET</span>(<span class="pl-c1">TASK_THREAD_RA</span>, <span class="pl-s1">task_struct</span>, <span class="pl-s1">thread</span>.<span class="pl-c1">ra</span>);
	<span class="pl-en">OFFSET</span>(<span class="pl-c1">TASK_THREAD_SP</span>, <span class="pl-s1">task_struct</span>, <span class="pl-s1">thread</span>.<span class="pl-c1">sp</span>);
	<span class="pl-en">OFFSET</span>(<span class="pl-c1">TASK_THREAD_S0</span>, <span class="pl-s1">task_struct</span>, <span class="pl-s1">thread</span>.<span class="pl-c1">s</span>[<span class="pl-c1">0</span>]);
	<span class="pl-en">OFFSET</span>(<span class="pl-c1">TASK_THREAD_S1</span>, <span class="pl-s1">task_struct</span>, <span class="pl-s1">thread</span>.<span class="pl-c1">s</span>[<span class="pl-c1">1</span>]);
	<span class="pl-en">OFFSET</span>(<span class="pl-c1">TASK_THREAD_S2</span>, <span class="pl-s1">task_struct</span>, <span class="pl-s1">thread</span>.<span class="pl-c1">s</span>[<span class="pl-c1">2</span>]);
	<span class="pl-en">OFFSET</span>(<span class="pl-c1">TASK_THREAD_S3</span>, <span class="pl-s1">task_struct</span>, <span class="pl-s1">thread</span>.<span class="pl-c1">s</span>[<span class="pl-c1">3</span>]);
	<span class="pl-en">OFFSET</span>(<span class="pl-c1">TASK_THREAD_S4</span>, <span class="pl-s1">task_struct</span>, <span class="pl-s1">thread</span>.<span class="pl-c1">s</span>[<span class="pl-c1">4</span>]);
	<span class="pl-en">OFFSET</span>(<span class="pl-c1">TASK_THREAD_S5</span>, <span class="pl-s1">task_struct</span>, <span class="pl-s1">thread</span>.<span class="pl-c1">s</span>[<span class="pl-c1">5</span>]);
	<span class="pl-en">OFFSET</span>(<span class="pl-c1">TASK_THREAD_S6</span>, <span class="pl-s1">task_struct</span>, <span class="pl-s1">thread</span>.<span class="pl-c1">s</span>[<span class="pl-c1">6</span>]);
	<span class="pl-en">OFFSET</span>(<span class="pl-c1">TASK_THREAD_S7</span>, <span class="pl-s1">task_struct</span>, <span class="pl-s1">thread</span>.<span class="pl-c1">s</span>[<span class="pl-c1">7</span>]);
	<span class="pl-en">OFFSET</span>(<span class="pl-c1">TASK_THREAD_S8</span>, <span class="pl-s1">task_struct</span>, <span class="pl-s1">thread</span>.<span class="pl-c1">s</span>[<span class="pl-c1">8</span>]);
	<span class="pl-en">OFFSET</span>(<span class="pl-c1">TASK_THREAD_S9</span>, <span class="pl-s1">task_struct</span>, <span class="pl-s1">thread</span>.<span class="pl-c1">s</span>[<span class="pl-c1">9</span>]);
	<span class="pl-en">OFFSET</span>(<span class="pl-c1">TASK_THREAD_S10</span>, <span class="pl-s1">task_struct</span>, <span class="pl-s1">thread</span>.<span class="pl-c1">s</span>[<span class="pl-c1">10</span>]);
	<span class="pl-en">OFFSET</span>(<span class="pl-c1">TASK_THREAD_S11</span>, <span class="pl-s1">task_struct</span>, <span class="pl-s1">thread</span>.<span class="pl-c1">s</span>[<span class="pl-c1">11</span>]);
	<span class="pl-en">OFFSET</span>(<span class="pl-c1">TASK_THREAD_SUM</span>, <span class="pl-s1">task_struct</span>, <span class="pl-s1">thread</span>.<span class="pl-c1">sum</span>);
	...
	<span class="pl-en">DEFINE</span>(<span class="pl-c1">PT_SIZE</span>, <span class="pl-k">sizeof</span>(<span class="pl-k">struct</span> <span class="pl-smi">pt_regs</span>));
	...
}</pre><div class="zeroclipboard-container">
<clipboard-copy aria-label="Copy" class="ClipboardButton btn btn-invisible js-clipboard-copy m-2 p-0 d-flex flex-justify-center flex-items-center" data-copy-feedback="Copied!" data-tooltip-direction="w" role="button" tabindex="0" value="// arch/riscv/kernel/asm-offsets.c

void asm_offsets(void)
{
	OFFSET(TASK_THREAD_RA, task_struct, thread.ra);
	OFFSET(TASK_THREAD_SP, task_struct, thread.sp);
	OFFSET(TASK_THREAD_S0, task_struct, thread.s[0]);
	OFFSET(TASK_THREAD_S1, task_struct, thread.s[1]);
	OFFSET(TASK_THREAD_S2, task_struct, thread.s[2]);
	OFFSET(TASK_THREAD_S3, task_struct, thread.s[3]);
	OFFSET(TASK_THREAD_S4, task_struct, thread.s[4]);
	OFFSET(TASK_THREAD_S5, task_struct, thread.s[5]);
	OFFSET(TASK_THREAD_S6, task_struct, thread.s[6]);
	OFFSET(TASK_THREAD_S7, task_struct, thread.s[7]);
	OFFSET(TASK_THREAD_S8, task_struct, thread.s[8]);
	OFFSET(TASK_THREAD_S9, task_struct, thread.s[9]);
	OFFSET(TASK_THREAD_S10, task_struct, thread.s[10]);
	OFFSET(TASK_THREAD_S11, task_struct, thread.s[11]);
	OFFSET(TASK_THREAD_SUM, task_struct, thread.sum);
	...
	DEFINE(PT_SIZE, sizeof(struct pt_regs));
	...
}">
<svg aria-hidden="true" class="octicon octicon-copy js-clipboard-copy-icon" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path>
</svg>
<svg aria-hidden="true" class="octicon octicon-check js-clipboard-check-icon color-fg-success d-none" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"></path>
</svg>
</clipboard-copy>
</div></div>
<p dir="auto">这两个宏由 <code>include/linux/kbuild.h</code> 提供：</p>
<div class="highlight highlight-source-c notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-c">// include/linux/kbuild.h</span>

<span class="pl-c">/* SPDX-License-Identifier: GPL-2.0 */</span>
<span class="pl-k">#ifndef</span> <span class="pl-s1">__LINUX_KBUILD_H</span>
<span class="pl-k">#define</span> <span class="pl-s1">__LINUX_KBUILD_H</span>

<span class="pl-k">#define</span> <span class="pl-en">DEFINE</span>(<span class="pl-s1">sym</span>, <span class="pl-s1">val</span>) \
	asm volatile("\n.ascii \"-&gt;" #sym " %0 " #val "\"" : : "i" (val))

<span class="pl-k">#define</span> <span class="pl-en">BLANK</span>() asm volatile("\n.ascii \"-&gt;\"" : : )

<span class="pl-k">#define</span> <span class="pl-en">OFFSET</span>(<span class="pl-s1">sym</span>, <span class="pl-s1">str</span>, <span class="pl-s1">mem</span>) \
	DEFINE(sym, offsetof(struct str, mem))

<span class="pl-k">#define</span> <span class="pl-en">COMMENT</span>(<span class="pl-s1">x</span>) \
	asm volatile("\n.ascii \"-&gt;#" x "\"")

<span class="pl-k">#endif</span></pre><div class="zeroclipboard-container">
<clipboard-copy aria-label="Copy" class="ClipboardButton btn btn-invisible js-clipboard-copy m-2 p-0 d-flex flex-justify-center flex-items-center" data-copy-feedback="Copied!" data-tooltip-direction="w" role="button" tabindex="0" value='// include/linux/kbuild.h

/* SPDX-License-Identifier: GPL-2.0 */
#ifndef __LINUX_KBUILD_H
#define __LINUX_KBUILD_H

#define DEFINE(sym, val) \
	asm volatile("\n.ascii \"-&gt;" #sym " %0 " #val "\"" : : "i" (val))

#define BLANK() asm volatile("\n.ascii \"-&gt;\"" : : )

#define OFFSET(sym, str, mem) \
	DEFINE(sym, offsetof(struct str, mem))

#define COMMENT(x) \
	asm volatile("\n.ascii \"-&gt;#" x "\"")

#endif'>
<svg aria-hidden="true" class="octicon octicon-copy js-clipboard-copy-icon" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path>
</svg>
<svg aria-hidden="true" class="octicon octicon-check js-clipboard-check-icon color-fg-success d-none" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"></path>
</svg>
</clipboard-copy>
</div></div>
<p dir="auto">最后生成的 <code>asm-offsets.s</code> 如下：</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto"><pre class="notranslate"><code># arch/riscv/kernel/asm-offsets.s
	.file	"asm-offsets.c"
	.option nopic
	.text
	.align	2
	.globl	asm_offsets
	.type	asm_offsets, @function
asm_offsets:
	addi	sp,sp,-16	#,,
	sd	s0,0(sp)	#,
	sd	ra,8(sp)	#,
	addi	s0,sp,16	#,,

.ascii "-&gt;TASK_THREAD_RA 2480 offsetof(struct task_struct, thread.ra)"
.ascii "-&gt;TASK_THREAD_SP 2488 offsetof(struct task_struct, thread.sp)"
...
.ascii "-&gt;PT_SIZE 288 sizeof(struct pt_regs)"
...
	ld	ra,8(sp)		#,
	ld	s0,0(sp)		#,
	addi	sp,sp,16	#,,
	jr	ra		#
	.size	asm_offsets, .-asm_offsets
	.ident	"GCC: (GNU) 14.2.0"
	.section	.note.GNU-stack,"",@progbits
</code></pre><div class="zeroclipboard-container">
<clipboard-copy aria-label="Copy" class="ClipboardButton btn btn-invisible js-clipboard-copy m-2 p-0 d-flex flex-justify-center flex-items-center" data-copy-feedback="Copied!" data-tooltip-direction="w" role="button" tabindex="0" value='# arch/riscv/kernel/asm-offsets.s
	.file	"asm-offsets.c"
	.option nopic
	.text
	.align	2
	.globl	asm_offsets
	.type	asm_offsets, @function
asm_offsets:
	addi	sp,sp,-16	#,,
	sd	s0,0(sp)	#,
	sd	ra,8(sp)	#,
	addi	s0,sp,16	#,,

.ascii "-&gt;TASK_THREAD_RA 2480 offsetof(struct task_struct, thread.ra)"
.ascii "-&gt;TASK_THREAD_SP 2488 offsetof(struct task_struct, thread.sp)"
...
.ascii "-&gt;PT_SIZE 288 sizeof(struct pt_regs)"
...
	ld	ra,8(sp)		#,
	ld	s0,0(sp)		#,
	addi	sp,sp,16	#,,
	jr	ra		#
	.size	asm_offsets, .-asm_offsets
	.ident	"GCC: (GNU) 14.2.0"
	.section	.note.GNU-stack,"",@progbits'>
<svg aria-hidden="true" class="octicon octicon-copy js-clipboard-copy-icon" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path>
</svg>
<svg aria-hidden="true" class="octicon octicon-check js-clipboard-check-icon color-fg-success d-none" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"></path>
</svg>
</clipboard-copy>
</div></div>
<p dir="auto">第二步、根据 <code>arch/riscv/kernel/asm-offsets.s</code> 生成 <code>include/generated/asm-offsets.h</code>。</p>
<p dir="auto"><code>asm-offsets.h</code> 内容如下：</p>
<div class="highlight highlight-source-c notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-k">#ifndef</span> <span class="pl-s1">__ASM_OFFSETS_H__</span>
<span class="pl-k">#define</span> <span class="pl-s1">__ASM_OFFSETS_H__</span>
<span class="pl-c">/*</span>
<span class="pl-c"> * DO NOT MODIFY.</span>
<span class="pl-c"> *</span>
<span class="pl-c"> * This file was generated by Kbuild</span>
<span class="pl-c"> */</span>

<span class="pl-k">#define</span> <span class="pl-c1">TASK_THREAD_RA</span> 2480 <span class="pl-c">/* offsetof(struct task_struct, thread.ra) */</span>
<span class="pl-k">#define</span> <span class="pl-c1">TASK_THREAD_SP</span> 2488 <span class="pl-c">/* offsetof(struct task_struct, thread.sp) */</span>
...
<span class="pl-k">#define</span> <span class="pl-c1">PT_SIZE</span> 288 <span class="pl-c">/* sizeof(struct pt_regs) */</span>
...
<span class="pl-k">#endif</span></pre><div class="zeroclipboard-container">
<clipboard-copy aria-label="Copy" class="ClipboardButton btn btn-invisible js-clipboard-copy m-2 p-0 d-flex flex-justify-center flex-items-center" data-copy-feedback="Copied!" data-tooltip-direction="w" role="button" tabindex="0" value="#ifndef __ASM_OFFSETS_H__
#define __ASM_OFFSETS_H__
/*
 * DO NOT MODIFY.
 *
 * This file was generated by Kbuild
 */

#define TASK_THREAD_RA 2480 /* offsetof(struct task_struct, thread.ra) */
#define TASK_THREAD_SP 2488 /* offsetof(struct task_struct, thread.sp) */
...
#define PT_SIZE 288 /* sizeof(struct pt_regs) */
...
#endif">
<svg aria-hidden="true" class="octicon octicon-copy js-clipboard-copy-icon" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path>
</svg>
<svg aria-hidden="true" class="octicon octicon-check js-clipboard-check-icon color-fg-success d-none" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"></path>
</svg>
</clipboard-copy>
</div></div>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto" tabindex="-1">do_irq()</h2><a aria-label="Permalink: do_irq()" class="anchor" href="#do_irq" id="user-content-do_irq"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<div class="highlight highlight-source-c notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-c">// arch/riscv/kernel/traps.c</span>

<span class="pl-smi">asmlinkage</span> <span class="pl-s1">void</span> <span class="pl-smi">noinstr</span> <span class="pl-en">do_irq</span>(<span class="pl-k">struct</span> <span class="pl-smi">pt_regs</span> <span class="pl-c1">*</span><span class="pl-s1">regs</span>)
{
	<span class="pl-smi">irqentry_state_t</span> <span class="pl-s1">state</span> <span class="pl-c1">=</span> <span class="pl-en">irqentry_enter</span>(<span class="pl-s1">regs</span>);

	<span class="pl-k">if</span> (<span class="pl-en">IS_ENABLED</span>(<span class="pl-c1">CONFIG_IRQ_STACKS</span>) <span class="pl-c1">&amp;&amp;</span> <span class="pl-en">on_thread_stack</span>())
		<span class="pl-en">call_on_irq_stack</span>(<span class="pl-s1">regs</span>, <span class="pl-s1">handle_riscv_irq</span>);
	<span class="pl-k">else</span>
		<span class="pl-en">handle_riscv_irq</span>(<span class="pl-s1">regs</span>);

	<span class="pl-en">irqentry_exit</span>(<span class="pl-s1">regs</span>, <span class="pl-s1">state</span>);
}</pre><div class="zeroclipboard-container">
<clipboard-copy aria-label="Copy" class="ClipboardButton btn btn-invisible js-clipboard-copy m-2 p-0 d-flex flex-justify-center flex-items-center" data-copy-feedback="Copied!" data-tooltip-direction="w" role="button" tabindex="0" value="// arch/riscv/kernel/traps.c

asmlinkage void noinstr do_irq(struct pt_regs *regs)
{
	irqentry_state_t state = irqentry_enter(regs);

	if (IS_ENABLED(CONFIG_IRQ_STACKS) &amp;&amp; on_thread_stack())
		call_on_irq_stack(regs, handle_riscv_irq);
	else
		handle_riscv_irq(regs);

	irqentry_exit(regs, state);
}">
<svg aria-hidden="true" class="octicon octicon-copy js-clipboard-copy-icon" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path>
</svg>
<svg aria-hidden="true" class="octicon octicon-check js-clipboard-check-icon color-fg-success d-none" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"></path>
</svg>
</clipboard-copy>
</div></div>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto" tabindex="-1">辅助函数：irqentry_enter()</h3><a aria-label="Permalink: 辅助函数：irqentry_enter()" class="anchor" href="#辅助函数irqentry_enter" id="user-content-辅助函数irqentry_enter"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<div class="highlight highlight-source-c notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-c">// kernel/entry/common.c</span>

<span class="pl-smi">noinstr</span> <span class="pl-s1">irqentry_state_t</span> <span class="pl-en">irqentry_enter</span>(<span class="pl-k">struct</span> <span class="pl-smi">pt_regs</span> <span class="pl-c1">*</span><span class="pl-s1">regs</span>)
{
	<span class="pl-smi">irqentry_state_t</span> <span class="pl-s1">ret</span> <span class="pl-c1">=</span> {
		.<span class="pl-c1">exit_rcu</span> <span class="pl-c1">=</span> false,
	};

	<span class="pl-k">if</span> (<span class="pl-en">user_mode</span>(<span class="pl-s1">regs</span>)) {
		<span class="pl-en">irqentry_enter_from_user_mode</span>(<span class="pl-s1">regs</span>);
		<span class="pl-k">return</span> <span class="pl-s1">ret</span>;
	}

	<span class="pl-c">/*</span>
<span class="pl-c">	 * If this entry hit the idle task invoke ct_irq_enter() whether</span>
<span class="pl-c">	 * RCU is watching or not.</span>
<span class="pl-c">	 *</span>
<span class="pl-c">	 * Interrupts can nest when the first interrupt invokes softirq</span>
<span class="pl-c">	 * processing on return which enables interrupts.</span>
<span class="pl-c">	 *</span>
<span class="pl-c">	 * Scheduler ticks in the idle task can mark quiescent state and</span>
<span class="pl-c">	 * terminate a grace period, if and only if the timer interrupt is</span>
<span class="pl-c">	 * not nested into another interrupt.</span>
<span class="pl-c">	 *</span>
<span class="pl-c">	 * Checking for rcu_is_watching() here would prevent the nesting</span>
<span class="pl-c">	 * interrupt to invoke ct_irq_enter(). If that nested interrupt is</span>
<span class="pl-c">	 * the tick then rcu_flavor_sched_clock_irq() would wrongfully</span>
<span class="pl-c">	 * assume that it is the first interrupt and eventually claim</span>
<span class="pl-c">	 * quiescent state and end grace periods prematurely.</span>
<span class="pl-c">	 *</span>
<span class="pl-c">	 * Unconditionally invoke ct_irq_enter() so RCU state stays</span>
<span class="pl-c">	 * consistent.</span>
<span class="pl-c">	 *</span>
<span class="pl-c">	 * TINY_RCU does not support EQS, so let the compiler eliminate</span>
<span class="pl-c">	 * this part when enabled.</span>
<span class="pl-c">	 */</span>
	<span class="pl-k">if</span> (!<span class="pl-en">IS_ENABLED</span>(<span class="pl-c1">CONFIG_TINY_RCU</span>) <span class="pl-c1">&amp;&amp;</span> <span class="pl-en">is_idle_task</span>(<span class="pl-s1">current</span>)) {
		<span class="pl-c">/*</span>
<span class="pl-c">		 * If RCU is not watching then the same careful</span>
<span class="pl-c">		 * sequence vs. lockdep and tracing is required</span>
<span class="pl-c">		 * as in irqentry_enter_from_user_mode().</span>
<span class="pl-c">		 */</span>
		<span class="pl-en">lockdep_hardirqs_off</span>(<span class="pl-c1">CALLER_ADDR0</span>);
		<span class="pl-c">// inform RCU that current CPU is entering irq away from idle</span>
		<span class="pl-en">ct_irq_enter</span>();
		<span class="pl-en">instrumentation_begin</span>();
		<span class="pl-en">kmsan_unpoison_entry_regs</span>(<span class="pl-s1">regs</span>);
		<span class="pl-en">trace_hardirqs_off_finish</span>();
		<span class="pl-en">instrumentation_end</span>();

		<span class="pl-s1">ret</span>.<span class="pl-c1">exit_rcu</span> <span class="pl-c1">=</span> true;
		<span class="pl-k">return</span> <span class="pl-s1">ret</span>;
	}

	<span class="pl-c">/*</span>
<span class="pl-c">	 * If RCU is watching then RCU only wants to check whether it needs</span>
<span class="pl-c">	 * to restart the tick in NOHZ mode. rcu_irq_enter_check_tick()</span>
<span class="pl-c">	 * already contains a warning when RCU is not watching, so no point</span>
<span class="pl-c">	 * in having another one here.</span>
<span class="pl-c">	 */</span>
	<span class="pl-en">lockdep_hardirqs_off</span>(<span class="pl-c1">CALLER_ADDR0</span>);
	<span class="pl-en">instrumentation_begin</span>();
	<span class="pl-en">kmsan_unpoison_entry_regs</span>(<span class="pl-s1">regs</span>);
	<span class="pl-c">// RCU only wants to check whether it needs to restart</span>
	<span class="pl-c">// the tick in NOHZ mode</span>
	<span class="pl-en">rcu_irq_enter_check_tick</span>();
	<span class="pl-en">trace_hardirqs_off_finish</span>();
	<span class="pl-en">instrumentation_end</span>();

	<span class="pl-k">return</span> <span class="pl-s1">ret</span>;
}</pre><div class="zeroclipboard-container">
<clipboard-copy aria-label="Copy" class="ClipboardButton btn btn-invisible js-clipboard-copy m-2 p-0 d-flex flex-justify-center flex-items-center" data-copy-feedback="Copied!" data-tooltip-direction="w" role="button" tabindex="0" value="// kernel/entry/common.c

noinstr irqentry_state_t irqentry_enter(struct pt_regs *regs)
{
	irqentry_state_t ret = {
		.exit_rcu = false,
	};

	if (user_mode(regs)) {
		irqentry_enter_from_user_mode(regs);
		return ret;
	}

	/*
	 * If this entry hit the idle task invoke ct_irq_enter() whether
	 * RCU is watching or not.
	 *
	 * Interrupts can nest when the first interrupt invokes softirq
	 * processing on return which enables interrupts.
	 *
	 * Scheduler ticks in the idle task can mark quiescent state and
	 * terminate a grace period, if and only if the timer interrupt is
	 * not nested into another interrupt.
	 *
	 * Checking for rcu_is_watching() here would prevent the nesting
	 * interrupt to invoke ct_irq_enter(). If that nested interrupt is
	 * the tick then rcu_flavor_sched_clock_irq() would wrongfully
	 * assume that it is the first interrupt and eventually claim
	 * quiescent state and end grace periods prematurely.
	 *
	 * Unconditionally invoke ct_irq_enter() so RCU state stays
	 * consistent.
	 *
	 * TINY_RCU does not support EQS, so let the compiler eliminate
	 * this part when enabled.
	 */
	if (!IS_ENABLED(CONFIG_TINY_RCU) &amp;&amp; is_idle_task(current)) {
		/*
		 * If RCU is not watching then the same careful
		 * sequence vs. lockdep and tracing is required
		 * as in irqentry_enter_from_user_mode().
		 */
		lockdep_hardirqs_off(CALLER_ADDR0);
		// inform RCU that current CPU is entering irq away from idle
		ct_irq_enter();
		instrumentation_begin();
		kmsan_unpoison_entry_regs(regs);
		trace_hardirqs_off_finish();
		instrumentation_end();

		ret.exit_rcu = true;
		return ret;
	}

	/*
	 * If RCU is watching then RCU only wants to check whether it needs
	 * to restart the tick in NOHZ mode. rcu_irq_enter_check_tick()
	 * already contains a warning when RCU is not watching, so no point
	 * in having another one here.
	 */
	lockdep_hardirqs_off(CALLER_ADDR0);
	instrumentation_begin();
	kmsan_unpoison_entry_regs(regs);
	// RCU only wants to check whether it needs to restart
	// the tick in NOHZ mode
	rcu_irq_enter_check_tick();
	trace_hardirqs_off_finish();
	instrumentation_end();

	return ret;
}">
<svg aria-hidden="true" class="octicon octicon-copy js-clipboard-copy-icon" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path>
</svg>
<svg aria-hidden="true" class="octicon octicon-check js-clipboard-check-icon color-fg-success d-none" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"></path>
</svg>
</clipboard-copy>
</div></div>
<div class="markdown-heading" dir="auto"><h4 class="heading-element" dir="auto" tabindex="-1">辅助函数：irqentry_enter_from_user_mode()</h4><a aria-label="Permalink: 辅助函数：irqentry_enter_from_user_mode()" class="anchor" href="#辅助函数irqentry_enter_from_user_mode" id="user-content-辅助函数irqentry_enter_from_user_mode"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<div class="highlight highlight-source-c notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-c">// kernel/entry/common.c</span>

<span class="pl-smi">noinstr</span> <span class="pl-s1">void</span> <span class="pl-en">irqentry_enter_from_user_mode</span>(<span class="pl-k">struct</span> <span class="pl-smi">pt_regs</span> <span class="pl-c1">*</span><span class="pl-s1">regs</span>)
{
	<span class="pl-en">enter_from_user_mode</span>(<span class="pl-s1">regs</span>);
}

<span class="pl-c">// include/linux/entry-common.h</span>

<span class="pl-c">/**</span>
<span class="pl-c"> * enter_from_user_mode - Establish state when coming from user mode</span>
<span class="pl-c"> *</span>
<span class="pl-c"> * Syscall/interrupt entry disables interrupts, but user mode is traced as</span>
<span class="pl-c"> * interrupts enabled. Also with NO_HZ_FULL RCU might be idle.</span>
<span class="pl-c"> *</span>
<span class="pl-c"> * 1) Tell lockdep that interrupts are disabled</span>
<span class="pl-c"> * 2) Invoke context tracking if enabled to reactivate RCU</span>
<span class="pl-c"> * 3) Trace interrupts off state</span>
<span class="pl-c"> *</span>
<span class="pl-c"> * Invoked from architecture specific syscall entry code with interrupts</span>
<span class="pl-c"> * disabled. The calling code has to be non-instrumentable. When the</span>
<span class="pl-c"> * function returns all state is correct and interrupts are still</span>
<span class="pl-c"> * disabled. The subsequent functions can be instrumented.</span>
<span class="pl-c"> *</span>
<span class="pl-c"> * This is invoked when there is architecture specific functionality to be</span>
<span class="pl-c"> * done between establishing state and enabling interrupts. The caller must</span>
<span class="pl-c"> * enable interrupts before invoking syscall_enter_from_user_mode_work().</span>
<span class="pl-c"> */</span>
<span class="pl-c">// enter_from_user_mode is a critical, low-level helper function that</span>
<span class="pl-c">// performs the initial housekeeping and state setup required whenever</span>
<span class="pl-c">// the CPU transitions from user mode to kernel mode</span>
<span class="pl-c">// (due to a system call, page fault, or other exception).</span>
<span class="pl-k">static</span> <span class="pl-smi">__always_inline</span> <span class="pl-s1">void</span> <span class="pl-en">enter_from_user_mode</span>(<span class="pl-k">struct</span> <span class="pl-smi">pt_regs</span> <span class="pl-c1">*</span><span class="pl-s1">regs</span>)
{
	<span class="pl-c">// riscv 没实现，arch_enter_from_user_mode 是空的</span>
	<span class="pl-en">arch_enter_from_user_mode</span>(<span class="pl-s1">regs</span>);
	<span class="pl-c">// CONFIG_PROVE_LOCKING 为 0，lockdep_hardirqs_off 为空</span>
	<span class="pl-c">// CONFIG_PROVE_LOCKING 主要是从数学形式上证明锁的正确性，防止死锁</span>
	<span class="pl-c">// lockdep_hardirqs_off explicitly tells the lockdep debugging</span>
	<span class="pl-c">// system that hardware interrupts are now disabled.</span>
	<span class="pl-en">lockdep_hardirqs_off</span>(<span class="pl-c1">CALLER_ADDR0</span>);

	<span class="pl-c">// CONFIG_CONTEXT_TRACKING_USER 为 0，CT_WARN_ON user_exit_irqoff 为空</span>
	<span class="pl-c">// CONFIG_CONTEXT_TRACKING_USER tracks transitions between kernel</span>
	<span class="pl-c">// and user on behalf of RCU and tickless cputime accounting.</span>
	<span class="pl-c">// The former case relies on context tracking to enter/exit</span>
	<span class="pl-c">// RCU extended quiescent states.</span>
	<span class="pl-en">CT_WARN_ON</span>(<span class="pl-en">__ct_state</span>() <span class="pl-c1">!=</span> <span class="pl-c1">CT_STATE_USER</span>);
	<span class="pl-c">// This informs the context tracking system that the CPU is</span>
	<span class="pl-c">// no longer running user-space code.</span>
	<span class="pl-c">// This is particularly important for RCU</span>
	<span class="pl-en">user_exit_irqoff</span>();

	<span class="pl-c">// CONFIG_NOINSTR_VALIDATION 为 0，instrumentation_begin 为空</span>
	<span class="pl-en">instrumentation_begin</span>();
	<span class="pl-c">// When the kernel enters from user space</span>
	<span class="pl-c">// (e.g., via a system call), the data in the CPU registers</span>
	<span class="pl-c">// is coming from an external source.</span>
	<span class="pl-c">// KMSAN treats this data as initialized to prevent</span>
	<span class="pl-c">// false bug reports.</span>
	<span class="pl-en">kmsan_unpoison_entry_regs</span>(<span class="pl-s1">regs</span>);
	<span class="pl-c">// notifies the kernel's tracing infrastructure (ftrace, perf)</span>
	<span class="pl-c">// that the "interrupts off" event is complete.</span>
	<span class="pl-c">// This allows tracing tools to accurately measure the time</span>
	<span class="pl-c">// spent with interrupts disabled during kernel entry.</span>
	<span class="pl-en">trace_hardirqs_off_finish</span>();
	<span class="pl-c">// CONFIG_NOINSTR_VALIDATION 为 0，instrumentation_end 为空</span>
	<span class="pl-en">instrumentation_end</span>();
}</pre><div class="zeroclipboard-container">
<clipboard-copy aria-label="Copy" class="ClipboardButton btn btn-invisible js-clipboard-copy m-2 p-0 d-flex flex-justify-center flex-items-center" data-copy-feedback="Copied!" data-tooltip-direction="w" role="button" tabindex="0" value="// kernel/entry/common.c

noinstr void irqentry_enter_from_user_mode(struct pt_regs *regs)
{
	enter_from_user_mode(regs);
}

// include/linux/entry-common.h

/**
 * enter_from_user_mode - Establish state when coming from user mode
 *
 * Syscall/interrupt entry disables interrupts, but user mode is traced as
 * interrupts enabled. Also with NO_HZ_FULL RCU might be idle.
 *
 * 1) Tell lockdep that interrupts are disabled
 * 2) Invoke context tracking if enabled to reactivate RCU
 * 3) Trace interrupts off state
 *
 * Invoked from architecture specific syscall entry code with interrupts
 * disabled. The calling code has to be non-instrumentable. When the
 * function returns all state is correct and interrupts are still
 * disabled. The subsequent functions can be instrumented.
 *
 * This is invoked when there is architecture specific functionality to be
 * done between establishing state and enabling interrupts. The caller must
 * enable interrupts before invoking syscall_enter_from_user_mode_work().
 */
// enter_from_user_mode is a critical, low-level helper function that
// performs the initial housekeeping and state setup required whenever
// the CPU transitions from user mode to kernel mode
// (due to a system call, page fault, or other exception).
static __always_inline void enter_from_user_mode(struct pt_regs *regs)
{
	// riscv 没实现，arch_enter_from_user_mode 是空的
	arch_enter_from_user_mode(regs);
	// CONFIG_PROVE_LOCKING 为 0，lockdep_hardirqs_off 为空
	// CONFIG_PROVE_LOCKING 主要是从数学形式上证明锁的正确性，防止死锁
	// lockdep_hardirqs_off explicitly tells the lockdep debugging
	// system that hardware interrupts are now disabled.
	lockdep_hardirqs_off(CALLER_ADDR0);

	// CONFIG_CONTEXT_TRACKING_USER 为 0，CT_WARN_ON user_exit_irqoff 为空
	// CONFIG_CONTEXT_TRACKING_USER tracks transitions between kernel
	// and user on behalf of RCU and tickless cputime accounting.
	// The former case relies on context tracking to enter/exit
	// RCU extended quiescent states.
	CT_WARN_ON(__ct_state() != CT_STATE_USER);
	// This informs the context tracking system that the CPU is
	// no longer running user-space code.
	// This is particularly important for RCU
	user_exit_irqoff();

	// CONFIG_NOINSTR_VALIDATION 为 0，instrumentation_begin 为空
	instrumentation_begin();
	// When the kernel enters from user space
	// (e.g., via a system call), the data in the CPU registers
	// is coming from an external source.
	// KMSAN treats this data as initialized to prevent
	// false bug reports.
	kmsan_unpoison_entry_regs(regs);
	// notifies the kernel's tracing infrastructure (ftrace, perf)
	// that the &quot;interrupts off&quot; event is complete.
	// This allows tracing tools to accurately measure the time
	// spent with interrupts disabled during kernel entry.
	trace_hardirqs_off_finish();
	// CONFIG_NOINSTR_VALIDATION 为 0，instrumentation_end 为空
	instrumentation_end();
}">
<svg aria-hidden="true" class="octicon octicon-copy js-clipboard-copy-icon" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path>
</svg>
<svg aria-hidden="true" class="octicon octicon-check js-clipboard-check-icon color-fg-success d-none" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"></path>
</svg>
</clipboard-copy>
</div></div>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto" tabindex="-1">辅助函数：on_thread_stack()</h3><a aria-label="Permalink: 辅助函数：on_thread_stack()" class="anchor" href="#辅助函数on_thread_stack" id="user-content-辅助函数on_thread_stack"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Its primary purpose is to answer the question: "Is the current stack pointer (sp) located within the memory region allocated for the current process's kernel stack?"</p>
<p dir="auto">This is crucial in contexts like interrupt handling. If an interrupt occurs, the kernel needs to know if it's running on the regular task stack (which might be nearly full) or if it's already on a special-purpose stack (like an IRQ stack).</p>
<p dir="auto">原理：内核栈的大小是 16 KB，从上到下增长。假设当前 task 的 stack 基地址为 0xffff ffff 8100 4000，这个 stack 的范围一直到 0xffff ffff 8100 0000。只要当前 sp 在这个 stack 的范围中，sp 低 14 位可以随便变化，但是高 50 位一定是一样的。</p>
<p dir="auto">如果当前 sp 在这个 stack 的范围中，current-&gt;stack ^ current_stack_pointer 结果高 50 位一定为 0。<code>~(THREAD_SIZE - 1)</code> 高 50 位为 1，低 14 位为 0。两个结果 and，结果为 0。</p>
<p dir="auto">如果当前 sp 不在这个 stack 的范围中，current-&gt;stack ^ current_stack_pointer 结果高 50 位一定不为 0。<code>~(THREAD_SIZE - 1)</code> 高 50 位为 1，低 14 位为 0。两个结果 and，结果不为 0。</p>
<div class="highlight highlight-source-c notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-c">// arch/riscv/include/asm/stacktrace.h</span>

<span class="pl-k">static</span> <span class="pl-k">inline</span> <span class="pl-smi">bool</span> <span class="pl-en">on_thread_stack</span>(<span class="pl-smi">void</span>)
{
	<span class="pl-c">// current_stack_pointer is the value of sp</span>
	<span class="pl-c">// THREAD_SIZE is the total size of kernel stack</span>
	<span class="pl-k">return</span> !(((<span class="pl-smi">unsigned long</span>)(<span class="pl-s1">current</span><span class="pl-c1">-&gt;</span><span class="pl-c1">stack</span>) ^ <span class="pl-s1">current_stack_pointer</span>) <span class="pl-c1">&amp;</span> ~(<span class="pl-c1">THREAD_SIZE</span> <span class="pl-c1">-</span> <span class="pl-c1">1</span>));
}</pre><div class="zeroclipboard-container">
<clipboard-copy aria-label="Copy" class="ClipboardButton btn btn-invisible js-clipboard-copy m-2 p-0 d-flex flex-justify-center flex-items-center" data-copy-feedback="Copied!" data-tooltip-direction="w" role="button" tabindex="0" value="// arch/riscv/include/asm/stacktrace.h

static inline bool on_thread_stack(void)
{
	// current_stack_pointer is the value of sp
	// THREAD_SIZE is the total size of kernel stack
	return !(((unsigned long)(current-&gt;stack) ^ current_stack_pointer) &amp; ~(THREAD_SIZE - 1));
}">
<svg aria-hidden="true" class="octicon octicon-copy js-clipboard-copy-icon" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path>
</svg>
<svg aria-hidden="true" class="octicon octicon-check js-clipboard-check-icon color-fg-success d-none" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"></path>
</svg>
</clipboard-copy>
</div></div>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto" tabindex="-1">辅助函数：call_on_irq_stack()</h3><a aria-label="Permalink: 辅助函数：call_on_irq_stack()" class="anchor" href="#辅助函数call_on_irq_stack" id="user-content-辅助函数call_on_irq_stack"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto"><pre class="notranslate"><code>// arch/riscv/kernel/entry.S

#ifdef CONFIG_IRQ_STACKS
/*
 * void call_on_irq_stack(struct pt_regs *regs,
 * 		          void (*func)(struct pt_regs *));
 *
 * Calls func(regs) using the per-CPU IRQ stack.
 */
SYM_FUNC_START(call_on_irq_stack)
	/* Create a frame record to save ra and s0 (fp) */
	// 这时操作的还是 kernel stack
	addi	sp, sp, -STACKFRAME_SIZE_ON_STACK
	REG_S	ra, STACKFRAME_RA(sp)
	REG_S	s0, STACKFRAME_FP(sp)
	addi	s0, sp, STACKFRAME_SIZE_ON_STACK

	/* Switch to the per-CPU shadow call stack */
	scs_save_current
	scs_load_irq_stack t0

	/* Switch to the per-CPU IRQ stack and call the handler */
	load_per_cpu t0, irq_stack_ptr, t1 // t0 中最后的值是 irq stack 的基地址
	li	t1, IRQ_STACK_SIZE // irq stack size 也是 16 KB
	add	sp, t0, t1         // sp 现在是 irq stack 的顶层
	jalr	a1                 // 执行 handle_riscv_irq

	// 返回以后，sp 还是 irq stack 的顶层，s0 是执行 handle_riscv_irq 之前的 s0

	/* Switch back to the thread shadow call stack */
	scs_load_current

	/* Switch back to the thread stack and restore ra and s0 */
	addi	sp, s0, -STACKFRAME_SIZE_ON_STACK
	REG_L	ra, STACKFRAME_RA(sp)
	REG_L	s0, STACKFRAME_FP(sp)
	addi	sp, sp, STACKFRAME_SIZE_ON_STACK

	// sp 恢复到了 thread stack

	ret
SYM_FUNC_END(call_on_irq_stack)
#endif /* CONFIG_IRQ_STACKS */
</code></pre><div class="zeroclipboard-container">
<clipboard-copy aria-label="Copy" class="ClipboardButton btn btn-invisible js-clipboard-copy m-2 p-0 d-flex flex-justify-center flex-items-center" data-copy-feedback="Copied!" data-tooltip-direction="w" role="button" tabindex="0" value="// arch/riscv/kernel/entry.S

#ifdef CONFIG_IRQ_STACKS
/*
 * void call_on_irq_stack(struct pt_regs *regs,
 * 		          void (*func)(struct pt_regs *));
 *
 * Calls func(regs) using the per-CPU IRQ stack.
 */
SYM_FUNC_START(call_on_irq_stack)
	/* Create a frame record to save ra and s0 (fp) */
	// 这时操作的还是 kernel stack
	addi	sp, sp, -STACKFRAME_SIZE_ON_STACK
	REG_S	ra, STACKFRAME_RA(sp)
	REG_S	s0, STACKFRAME_FP(sp)
	addi	s0, sp, STACKFRAME_SIZE_ON_STACK

	/* Switch to the per-CPU shadow call stack */
	scs_save_current
	scs_load_irq_stack t0

	/* Switch to the per-CPU IRQ stack and call the handler */
	load_per_cpu t0, irq_stack_ptr, t1 // t0 中最后的值是 irq stack 的基地址
	li	t1, IRQ_STACK_SIZE // irq stack size 也是 16 KB
	add	sp, t0, t1         // sp 现在是 irq stack 的顶层
	jalr	a1                 // 执行 handle_riscv_irq

	// 返回以后，sp 还是 irq stack 的顶层，s0 是执行 handle_riscv_irq 之前的 s0

	/* Switch back to the thread shadow call stack */
	scs_load_current

	/* Switch back to the thread stack and restore ra and s0 */
	addi	sp, s0, -STACKFRAME_SIZE_ON_STACK
	REG_L	ra, STACKFRAME_RA(sp)
	REG_L	s0, STACKFRAME_FP(sp)
	addi	sp, sp, STACKFRAME_SIZE_ON_STACK

	// sp 恢复到了 thread stack

	ret
SYM_FUNC_END(call_on_irq_stack)
#endif /* CONFIG_IRQ_STACKS */">
<svg aria-hidden="true" class="octicon octicon-copy js-clipboard-copy-icon" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path>
</svg>
<svg aria-hidden="true" class="octicon octicon-check js-clipboard-check-icon color-fg-success d-none" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"></path>
</svg>
</clipboard-copy>
</div></div>
<div class="markdown-heading" dir="auto"><h4 class="heading-element" dir="auto" tabindex="-1">辅助函数：load_per_cpu</h4><a aria-label="Permalink: 辅助函数：load_per_cpu" class="anchor" href="#辅助函数load_per_cpu" id="user-content-辅助函数load_per_cpu"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto"><pre class="notranslate"><code>// arch/riscv/include/asm/asm.h

#ifdef CONFIG_SMP
#ifdef CONFIG_32BIT
#define PER_CPU_OFFSET_SHIFT 2
#else
#define PER_CPU_OFFSET_SHIFT 3
#endif

.macro asm_per_cpu dst sym tmp
	REG_L \tmp, TASK_TI_CPU_NUM(tp)
	slli  \tmp, \tmp, PER_CPU_OFFSET_SHIFT
	la    \dst, __per_cpu_offset
	add   \dst, \dst, \tmp
	REG_L \tmp, 0(\dst)
	la    \dst, \sym
	add   \dst, \dst, \tmp
.endm
#else /* CONFIG_SMP */
...
#endif /* CONFIG_SMP */

.macro load_per_cpu dst ptr tmp
	asm_per_cpu \dst \ptr \tmp
	REG_L \dst, 0(\dst)
.endm
</code></pre><div class="zeroclipboard-container">
<clipboard-copy aria-label="Copy" class="ClipboardButton btn btn-invisible js-clipboard-copy m-2 p-0 d-flex flex-justify-center flex-items-center" data-copy-feedback="Copied!" data-tooltip-direction="w" role="button" tabindex="0" value="// arch/riscv/include/asm/asm.h

#ifdef CONFIG_SMP
#ifdef CONFIG_32BIT
#define PER_CPU_OFFSET_SHIFT 2
#else
#define PER_CPU_OFFSET_SHIFT 3
#endif

.macro asm_per_cpu dst sym tmp
	REG_L \tmp, TASK_TI_CPU_NUM(tp)
	slli  \tmp, \tmp, PER_CPU_OFFSET_SHIFT
	la    \dst, __per_cpu_offset
	add   \dst, \dst, \tmp
	REG_L \tmp, 0(\dst)
	la    \dst, \sym
	add   \dst, \dst, \tmp
.endm
#else /* CONFIG_SMP */
...
#endif /* CONFIG_SMP */

.macro load_per_cpu dst ptr tmp
	asm_per_cpu \dst \ptr \tmp
	REG_L \dst, 0(\dst)
.endm">
<svg aria-hidden="true" class="octicon octicon-copy js-clipboard-copy-icon" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path>
</svg>
<svg aria-hidden="true" class="octicon octicon-check js-clipboard-check-icon color-fg-success d-none" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"></path>
</svg>
</clipboard-copy>
</div></div>
<p dir="auto"><code>load_per_cpu t0, irq_stack_ptr, t1</code> 展开以后就是：</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto"><pre class="notranslate"><code>REG_L t1, TASK_TI_CPU_NUM(tp)      // 获得 cpu 数值
slli  t1, t1, PER_CPU_OFFSET_SHIFT // 获得 cpu 数值 * 8（指针大小）
// This array holds the base memory addr for each CPU's private data area
la    t0, __per_cpu_offset
add   t0, t0, t1
REG_L t1, 0(t0) // 从 __per_cpu_offset 中读出当前 CPU 的 per-cpu data 地址
la    t0, irq_stack_ptr
// 现在 t0 是当前 CPU per-cpu data 中，存储 irq_stack_ptr 的 ulong * 的地址
add   t0, t0, t1

REG_L t0, 0(t0) // 获取 irq_stack_ptr 中的值
</code></pre><div class="zeroclipboard-container">
<clipboard-copy aria-label="Copy" class="ClipboardButton btn btn-invisible js-clipboard-copy m-2 p-0 d-flex flex-justify-center flex-items-center" data-copy-feedback="Copied!" data-tooltip-direction="w" role="button" tabindex="0" value="REG_L t1, TASK_TI_CPU_NUM(tp)      // 获得 cpu 数值
slli  t1, t1, PER_CPU_OFFSET_SHIFT // 获得 cpu 数值 * 8（指针大小）
// This array holds the base memory addr for each CPU's private data area
la    t0, __per_cpu_offset
add   t0, t0, t1
REG_L t1, 0(t0) // 从 __per_cpu_offset 中读出当前 CPU 的 per-cpu data 地址
la    t0, irq_stack_ptr
// 现在 t0 是当前 CPU per-cpu data 中，存储 irq_stack_ptr 的 ulong * 的地址
add   t0, t0, t1

REG_L t0, 0(t0) // 获取 irq_stack_ptr 中的值">
<svg aria-hidden="true" class="octicon octicon-copy js-clipboard-copy-icon" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path>
</svg>
<svg aria-hidden="true" class="octicon octicon-check js-clipboard-check-icon color-fg-success d-none" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"></path>
</svg>
</clipboard-copy>
</div></div>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto" tabindex="-1">辅助函数：handle_riscv_irq()</h3><a aria-label="Permalink: 辅助函数：handle_riscv_irq()" class="anchor" href="#辅助函数handle_riscv_irq" id="user-content-辅助函数handle_riscv_irq"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<div class="highlight highlight-source-c notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-c">// arch/riscv/kernel/traps.c</span>

<span class="pl-k">static</span> <span class="pl-smi">void</span> <span class="pl-s1">noinstr</span> <span class="pl-en">handle_riscv_irq</span>(<span class="pl-k">struct</span> <span class="pl-smi">pt_regs</span> <span class="pl-c1">*</span><span class="pl-s1">regs</span>)
{
	<span class="pl-k">struct</span> <span class="pl-smi">pt_regs</span> <span class="pl-c1">*</span><span class="pl-s1">old_regs</span>;

	<span class="pl-c">// irq_enter_rcu is the primary function for entering</span>
	<span class="pl-c">// a hard IRQ context. It disables preemption, notifies the RCU and</span>
	<span class="pl-c">// timekeeping systems, and updates kernel statistics.</span>
	<span class="pl-en">irq_enter_rcu</span>();
	<span class="pl-s1">old_regs</span> <span class="pl-c1">=</span> <span class="pl-en">set_irq_regs</span>(<span class="pl-s1">regs</span>);

	<span class="pl-c">// 现在 old_regs 的值为 __irq_regs 老的值，__irq_regs 更新为 regs</span>

	<span class="pl-en">handle_arch_irq</span>(<span class="pl-s1">regs</span>); <span class="pl-c">// 即 drivers/irqchip/irq-riscv-intc.c:riscv_intc_irq</span>
	<span class="pl-c">// 复原 __irq_regs</span>
	<span class="pl-en">set_irq_regs</span>(<span class="pl-s1">old_regs</span>);
	<span class="pl-en">irq_exit_rcu</span>();
}</pre><div class="zeroclipboard-container">
<clipboard-copy aria-label="Copy" class="ClipboardButton btn btn-invisible js-clipboard-copy m-2 p-0 d-flex flex-justify-center flex-items-center" data-copy-feedback="Copied!" data-tooltip-direction="w" role="button" tabindex="0" value="// arch/riscv/kernel/traps.c

static void noinstr handle_riscv_irq(struct pt_regs *regs)
{
	struct pt_regs *old_regs;

	// irq_enter_rcu is the primary function for entering
	// a hard IRQ context. It disables preemption, notifies the RCU and
	// timekeeping systems, and updates kernel statistics.
	irq_enter_rcu();
	old_regs = set_irq_regs(regs);

	// 现在 old_regs 的值为 __irq_regs 老的值，__irq_regs 更新为 regs

	handle_arch_irq(regs); // 即 drivers/irqchip/irq-riscv-intc.c:riscv_intc_irq
	// 复原 __irq_regs
	set_irq_regs(old_regs);
	irq_exit_rcu();
}">
<svg aria-hidden="true" class="octicon octicon-copy js-clipboard-copy-icon" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path>
</svg>
<svg aria-hidden="true" class="octicon octicon-check js-clipboard-check-icon color-fg-success d-none" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"></path>
</svg>
</clipboard-copy>
</div></div>
<div class="markdown-heading" dir="auto"><h4 class="heading-element" dir="auto" tabindex="-1">辅助函数：irq_enter_rcu()</h4><a aria-label="Permalink: 辅助函数：irq_enter_rcu()" class="anchor" href="#辅助函数irq_enter_rcu" id="user-content-辅助函数irq_enter_rcu"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<div class="highlight highlight-source-c notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-c">// kernel/softirq.c</span>

<span class="pl-c">/**</span>
<span class="pl-c"> * irq_enter_rcu - Enter an interrupt context with RCU watching</span>
<span class="pl-c"> */</span>
<span class="pl-smi">void</span> <span class="pl-en">irq_enter_rcu</span>(<span class="pl-smi">void</span>)
{
	<span class="pl-en">__irq_enter_raw</span>();

	<span class="pl-k">if</span> (<span class="pl-en">tick_nohz_full_cpu</span>(<span class="pl-en">smp_processor_id</span>()) <span class="pl-c1">||</span>
	    (<span class="pl-en">is_idle_task</span>(<span class="pl-s1">current</span>) <span class="pl-c1">&amp;&amp;</span> (<span class="pl-en">irq_count</span>() <span class="pl-c1">==</span> <span class="pl-c1">HARDIRQ_OFFSET</span>)))
		<span class="pl-en">tick_irq_enter</span>();

	<span class="pl-en">account_hardirq_enter</span>(<span class="pl-s1">current</span>);
}

<span class="pl-c">// include/linux/hardirq.h</span>

<span class="pl-k">#define</span> <span class="pl-en">__irq_enter_raw</span>()				\
	do {						\
		preempt_count_add(HARDIRQ_OFFSET);	\
		lockdep_hardirq_enter();		\
	} while (0)</pre><div class="zeroclipboard-container">
<clipboard-copy aria-label="Copy" class="ClipboardButton btn btn-invisible js-clipboard-copy m-2 p-0 d-flex flex-justify-center flex-items-center" data-copy-feedback="Copied!" data-tooltip-direction="w" role="button" tabindex="0" value="// kernel/softirq.c

/**
 * irq_enter_rcu - Enter an interrupt context with RCU watching
 */
void irq_enter_rcu(void)
{
	__irq_enter_raw();

	if (tick_nohz_full_cpu(smp_processor_id()) ||
	    (is_idle_task(current) &amp;&amp; (irq_count() == HARDIRQ_OFFSET)))
		tick_irq_enter();

	account_hardirq_enter(current);
}

// include/linux/hardirq.h

#define __irq_enter_raw()				\
	do {						\
		preempt_count_add(HARDIRQ_OFFSET);	\
		lockdep_hardirq_enter();		\
	} while (0)">
<svg aria-hidden="true" class="octicon octicon-copy js-clipboard-copy-icon" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path>
</svg>
<svg aria-hidden="true" class="octicon octicon-check js-clipboard-check-icon color-fg-success d-none" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"></path>
</svg>
</clipboard-copy>
</div></div>
<div class="markdown-heading" dir="auto"><h4 class="heading-element" dir="auto" tabindex="-1">辅助函数：set_irq_regs()</h4><a aria-label="Permalink: 辅助函数：set_irq_regs()" class="anchor" href="#辅助函数set_irq_regs" id="user-content-辅助函数set_irq_regs"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<div class="highlight highlight-source-c notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-c">// include/asm-generic/irq_regs.h</span>

<span class="pl-c1">DECLARE_PER_CPU</span>(<span class="pl-k">struct</span> <span class="pl-smi">pt_regs</span> <span class="pl-c1">*</span>, <span class="pl-s1">__irq_regs</span>);

<span class="pl-k">static</span> <span class="pl-k">inline</span> <span class="pl-k">struct</span> <span class="pl-smi">pt_regs</span> <span class="pl-c1">*</span><span class="pl-en">set_irq_regs</span>(<span class="pl-k">struct</span> <span class="pl-smi">pt_regs</span> <span class="pl-c1">*</span><span class="pl-s1">new_regs</span>)
{
	<span class="pl-k">struct</span> <span class="pl-smi">pt_regs</span> <span class="pl-c1">*</span><span class="pl-s1">old_regs</span>;

	<span class="pl-s1">old_regs</span> <span class="pl-c1">=</span> <span class="pl-en">__this_cpu_read</span>(<span class="pl-s1">__irq_regs</span>);
	<span class="pl-en">__this_cpu_write</span>(<span class="pl-s1">__irq_regs</span>, <span class="pl-s1">new_regs</span>);
	<span class="pl-k">return</span> <span class="pl-s1">old_regs</span>;
}</pre><div class="zeroclipboard-container">
<clipboard-copy aria-label="Copy" class="ClipboardButton btn btn-invisible js-clipboard-copy m-2 p-0 d-flex flex-justify-center flex-items-center" data-copy-feedback="Copied!" data-tooltip-direction="w" role="button" tabindex="0" value="// include/asm-generic/irq_regs.h

DECLARE_PER_CPU(struct pt_regs *, __irq_regs);

static inline struct pt_regs *set_irq_regs(struct pt_regs *new_regs)
{
	struct pt_regs *old_regs;

	old_regs = __this_cpu_read(__irq_regs);
	__this_cpu_write(__irq_regs, new_regs);
	return old_regs;
}">
<svg aria-hidden="true" class="octicon octicon-copy js-clipboard-copy-icon" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path>
</svg>
<svg aria-hidden="true" class="octicon octicon-check js-clipboard-check-icon color-fg-success d-none" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"></path>
</svg>
</clipboard-copy>
</div></div>
<div class="markdown-heading" dir="auto"><h4 class="heading-element" dir="auto" tabindex="-1">辅助函数：handle_arch_irq/riscv_intc_irq()</h4><a aria-label="Permalink: 辅助函数：handle_arch_irq/riscv_intc_irq()" class="anchor" href="#辅助函数handle_arch_irqriscv_intc_irq" id="user-content-辅助函数handle_arch_irqriscv_intc_irq"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">在启动的时候，<code>drivers/irqchip/irq-riscv-intc.c:riscv_intc_init_common</code> 调用 <code>set_handle_irq</code> 设置 <code>handle_arch_irq</code> 为 <code>drivers/irqchip/irq-riscv-intc.c:riscv_intc_irq</code>。</p>
<div class="highlight highlight-source-c notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-c">// kernel/irq/handle.c</span>

<span class="pl-k">#ifdef</span> <span class="pl-c1">CONFIG_GENERIC_IRQ_MULTI_HANDLER</span>

<span class="pl-smi">void</span> (<span class="pl-c1">*</span><span class="pl-s1">handle_arch_irq</span>)(<span class="pl-k">struct</span> <span class="pl-smi">pt_regs</span> <span class="pl-c1">*</span>) <span class="pl-s1">__ro_after_init</span>;

<span class="pl-smi">int</span> <span class="pl-s1">__init</span> <span class="pl-en">set_handle_irq</span>(<span class="pl-smi">void</span> (<span class="pl-c1">*</span><span class="pl-s1">handle_irq</span>)(<span class="pl-k">struct</span> <span class="pl-smi">pt_regs</span> <span class="pl-c1">*</span>))
{
	<span class="pl-k">if</span> (<span class="pl-s1">handle_arch_irq</span>)
		<span class="pl-k">return</span> <span class="pl-c1">-</span><span class="pl-c1">EBUSY</span>;

	<span class="pl-s1">handle_arch_irq</span> <span class="pl-c1">=</span> <span class="pl-s1">handle_irq</span>;
	<span class="pl-k">return</span> <span class="pl-c1">0</span>;
}

<span class="pl-k">#endif</span></pre><div class="zeroclipboard-container">
<clipboard-copy aria-label="Copy" class="ClipboardButton btn btn-invisible js-clipboard-copy m-2 p-0 d-flex flex-justify-center flex-items-center" data-copy-feedback="Copied!" data-tooltip-direction="w" role="button" tabindex="0" value="// kernel/irq/handle.c

#ifdef CONFIG_GENERIC_IRQ_MULTI_HANDLER

void (*handle_arch_irq)(struct pt_regs *) __ro_after_init;

int __init set_handle_irq(void (*handle_irq)(struct pt_regs *))
{
	if (handle_arch_irq)
		return -EBUSY;

	handle_arch_irq = handle_irq;
	return 0;
}

#endif">
<svg aria-hidden="true" class="octicon octicon-copy js-clipboard-copy-icon" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path>
</svg>
<svg aria-hidden="true" class="octicon octicon-check js-clipboard-check-icon color-fg-success d-none" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"></path>
</svg>
</clipboard-copy>
</div></div>
<div class="highlight highlight-source-c notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-c">// drivers/irqchip/irq-riscv-intc.c</span>

<span class="pl-k">static</span> <span class="pl-smi">void</span> <span class="pl-en">riscv_intc_irq</span>(<span class="pl-k">struct</span> <span class="pl-smi">pt_regs</span> <span class="pl-c1">*</span><span class="pl-s1">regs</span>)
{
	<span class="pl-smi">unsigned long</span> <span class="pl-s1">cause</span> <span class="pl-c1">=</span> <span class="pl-s1">regs</span><span class="pl-c1">-&gt;</span><span class="pl-c1">cause</span> <span class="pl-c1">&amp;</span> ~<span class="pl-c1">CAUSE_IRQ_FLAG</span>;

	<span class="pl-k">if</span> (<span class="pl-en">generic_handle_domain_irq</span>(<span class="pl-s1">intc_domain</span>, <span class="pl-s1">cause</span>))
		<span class="pl-en">pr_warn_ratelimited</span>(<span class="pl-s">"Failed to handle interrupt (cause: %ld)\n"</span>, <span class="pl-s1">cause</span>);
}</pre><div class="zeroclipboard-container">
<clipboard-copy aria-label="Copy" class="ClipboardButton btn btn-invisible js-clipboard-copy m-2 p-0 d-flex flex-justify-center flex-items-center" data-copy-feedback="Copied!" data-tooltip-direction="w" role="button" tabindex="0" value='// drivers/irqchip/irq-riscv-intc.c

static void riscv_intc_irq(struct pt_regs *regs)
{
	unsigned long cause = regs-&gt;cause &amp; ~CAUSE_IRQ_FLAG;

	if (generic_handle_domain_irq(intc_domain, cause))
		pr_warn_ratelimited("Failed to handle interrupt (cause: %ld)\n", cause);
}'>
<svg aria-hidden="true" class="octicon octicon-copy js-clipboard-copy-icon" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path>
</svg>
<svg aria-hidden="true" class="octicon octicon-check js-clipboard-check-icon color-fg-success d-none" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"></path>
</svg>
</clipboard-copy>
</div></div>
<p dir="auto">对 <code>riscv_intc_irq</code> 的具体讨论见下。</p>
<div class="markdown-heading" dir="auto"><h4 class="heading-element" dir="auto" tabindex="-1">辅助函数：irq_exit_rcu/__irq_exit_rcu()</h4><a aria-label="Permalink: 辅助函数：irq_exit_rcu/__irq_exit_rcu()" class="anchor" href="#辅助函数irq_exit_rcu__irq_exit_rcu" id="user-content-辅助函数irq_exit_rcu__irq_exit_rcu"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<div class="highlight highlight-source-c notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-c">// kernel/softirq.c</span>

<span class="pl-c">/**</span>
<span class="pl-c"> * irq_exit_rcu() - Exit an interrupt context without updating RCU</span>
<span class="pl-c"> *</span>
<span class="pl-c"> * Also processes softirqs if needed and possible.</span>
<span class="pl-c"> */</span>
<span class="pl-smi">void</span> <span class="pl-en">irq_exit_rcu</span>(<span class="pl-smi">void</span>)
{
	<span class="pl-en">__irq_exit_rcu</span>();
	 <span class="pl-c">/* must be last! */</span>
	<span class="pl-en">lockdep_hardirq_exit</span>(); <span class="pl-c">// 和上面的 lockdep_hardirq_enter 相对</span>
}

<span class="pl-k">static</span> <span class="pl-k">inline</span> <span class="pl-smi">void</span> <span class="pl-en">__irq_exit_rcu</span>(<span class="pl-smi">void</span>)
{
<span class="pl-k">#ifndef</span> <span class="pl-s1">__ARCH_IRQ_EXIT_IRQS_DISABLED</span>
	<span class="pl-en">local_irq_disable</span>(); <span class="pl-c">// 把 sstatus 的 IE 位置 0 TODO</span>
<span class="pl-k">#else</span>
	<span class="pl-en">lockdep_assert_irqs_disabled</span>();
<span class="pl-k">#endif</span>
	<span class="pl-en">account_hardirq_exit</span>(<span class="pl-s1">current</span>); <span class="pl-c">// 和上面的 account_hardirq_enter 相对</span>
	<span class="pl-en">preempt_count_sub</span>(<span class="pl-c1">HARDIRQ_OFFSET</span>); <span class="pl-c">// 和上面的 preempt_count_add 相对</span>
	<span class="pl-c">// in_interrupt 检查 preempt_count 的 NMI HARDIRQ SOFTIRQ 位</span>
	<span class="pl-c">// 为什么有 in_interrupt 检查？</span>
	<span class="pl-c">// 因为要检查是否退出了所有中断情况（NMI HARD SOFT)</span>
	<span class="pl-c">// 如果这些位都为 0，意味着我们会返回到一个正常的用户进程中</span>
	<span class="pl-c">// 假设现在 softirq 正在执行，preempt_count 的值为 SOFTIRQ_OFFSET</span>
	<span class="pl-c">// 硬件中断发生，执行 hardirq，preempt_count 的值加上 HARDIRQ_OFFSET</span>
	<span class="pl-c">// hardirq 执行到这一行，preempt_count 的值减去 HARDIRQ_OFFSET</span>
	<span class="pl-c">// 现在 preempt_count 的值非 0，所以 invoke_softirq 不执行</span>
	<span class="pl-c">// 即，如果 hardirq 嵌套在 softirq 中，在这个 hardirq 结束时，不处理 softirq</span>
	<span class="pl-k">if</span> (!<span class="pl-en">in_interrupt</span>() <span class="pl-c1">&amp;&amp;</span> <span class="pl-en">local_softirq_pending</span>())
		<span class="pl-en">invoke_softirq</span>();

	<span class="pl-k">if</span> (<span class="pl-en">IS_ENABLED</span>(<span class="pl-c1">CONFIG_IRQ_FORCED_THREADING</span>) <span class="pl-c1">&amp;&amp;</span> <span class="pl-en">force_irqthreads</span>() <span class="pl-c1">&amp;&amp;</span>
	    <span class="pl-en">local_timers_pending_force_th</span>() <span class="pl-c1">&amp;&amp;</span> !(<span class="pl-en">in_nmi</span>() | <span class="pl-en">in_hardirq</span>()))
		<span class="pl-en">wake_timersd</span>();

	<span class="pl-en">tick_irq_exit</span>(); <span class="pl-c">// 和上面的 tick_irq_enter 相对</span>
}</pre><div class="zeroclipboard-container">
<clipboard-copy aria-label="Copy" class="ClipboardButton btn btn-invisible js-clipboard-copy m-2 p-0 d-flex flex-justify-center flex-items-center" data-copy-feedback="Copied!" data-tooltip-direction="w" role="button" tabindex="0" value="// kernel/softirq.c

/**
 * irq_exit_rcu() - Exit an interrupt context without updating RCU
 *
 * Also processes softirqs if needed and possible.
 */
void irq_exit_rcu(void)
{
	__irq_exit_rcu();
	 /* must be last! */
	lockdep_hardirq_exit(); // 和上面的 lockdep_hardirq_enter 相对
}

static inline void __irq_exit_rcu(void)
{
#ifndef __ARCH_IRQ_EXIT_IRQS_DISABLED
	local_irq_disable(); // 把 sstatus 的 IE 位置 0 TODO
#else
	lockdep_assert_irqs_disabled();
#endif
	account_hardirq_exit(current); // 和上面的 account_hardirq_enter 相对
	preempt_count_sub(HARDIRQ_OFFSET); // 和上面的 preempt_count_add 相对
	// in_interrupt 检查 preempt_count 的 NMI HARDIRQ SOFTIRQ 位
	// 为什么有 in_interrupt 检查？
	// 因为要检查是否退出了所有中断情况（NMI HARD SOFT)
	// 如果这些位都为 0，意味着我们会返回到一个正常的用户进程中
	// 假设现在 softirq 正在执行，preempt_count 的值为 SOFTIRQ_OFFSET
	// 硬件中断发生，执行 hardirq，preempt_count 的值加上 HARDIRQ_OFFSET
	// hardirq 执行到这一行，preempt_count 的值减去 HARDIRQ_OFFSET
	// 现在 preempt_count 的值非 0，所以 invoke_softirq 不执行
	// 即，如果 hardirq 嵌套在 softirq 中，在这个 hardirq 结束时，不处理 softirq
	if (!in_interrupt() &amp;&amp; local_softirq_pending())
		invoke_softirq();

	if (IS_ENABLED(CONFIG_IRQ_FORCED_THREADING) &amp;&amp; force_irqthreads() &amp;&amp;
	    local_timers_pending_force_th() &amp;&amp; !(in_nmi() | in_hardirq()))
		wake_timersd();

	tick_irq_exit(); // 和上面的 tick_irq_enter 相对
}">
<svg aria-hidden="true" class="octicon octicon-copy js-clipboard-copy-icon" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path>
</svg>
<svg aria-hidden="true" class="octicon octicon-check js-clipboard-check-icon color-fg-success d-none" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"></path>
</svg>
</clipboard-copy>
</div></div>
<p dir="auto">对 <code>local_softirq_pending</code> 和 <code>invoke_softirq</code> 的讨论见另一篇文章。</p>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto" tabindex="-1">辅助函数：irqentry_exit()</h3><a aria-label="Permalink: 辅助函数：irqentry_exit()" class="anchor" href="#辅助函数irqentry_exit" id="user-content-辅助函数irqentry_exit"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<div class="highlight highlight-source-c notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-c">// kernel/entry/common.c</span>

<span class="pl-smi">noinstr</span> <span class="pl-s1">void</span> <span class="pl-en">irqentry_exit</span>(<span class="pl-k">struct</span> <span class="pl-smi">pt_regs</span> <span class="pl-c1">*</span><span class="pl-s1">regs</span>, <span class="pl-smi">irqentry_state_t</span> <span class="pl-s1">state</span>)
{
	<span class="pl-c">// This function does not disable interrupts.</span>
	<span class="pl-c">// It asserts that they are already disabled.</span>
	<span class="pl-c">// If interrupts happen to be enabled when this line is executed,</span>
	<span class="pl-c">// lockdep will print a loud warning and a stack trace,</span>
	<span class="pl-c">// effectively crashing the system to highlight a severe bug.</span>
	<span class="pl-en">lockdep_assert_irqs_disabled</span>();

	<span class="pl-c">/* Check whether this returns to user mode */</span>
	<span class="pl-k">if</span> (<span class="pl-en">user_mode</span>(<span class="pl-s1">regs</span>)) {
		<span class="pl-en">irqentry_exit_to_user_mode</span>(<span class="pl-s1">regs</span>);
	} <span class="pl-k">else</span> <span class="pl-k">if</span> (!<span class="pl-en">regs_irqs_disabled</span>(<span class="pl-s1">regs</span>)) {
		<span class="pl-c">// returns to kernel, interrupts are originally on</span>

		<span class="pl-c">/*</span>
<span class="pl-c">		 * If RCU was not watching on entry this needs to be done</span>
<span class="pl-c">		 * carefully and needs the same ordering of lockdep/tracing</span>
<span class="pl-c">		 * and RCU as the return to user mode path.</span>
<span class="pl-c">		 */</span>
		<span class="pl-k">if</span> (<span class="pl-s1">state</span>.<span class="pl-c1">exit_rcu</span>) {
			<span class="pl-en">instrumentation_begin</span>();
			<span class="pl-c">/* Tell the tracer that IRET will enable interrupts */</span>
			<span class="pl-en">trace_hardirqs_on_prepare</span>();
			<span class="pl-en">lockdep_hardirqs_on_prepare</span>();
			<span class="pl-en">instrumentation_end</span>();
			<span class="pl-en">ct_irq_exit</span>();
			<span class="pl-en">lockdep_hardirqs_on</span>(<span class="pl-c1">CALLER_ADDR0</span>);
			<span class="pl-k">return</span>;
		}

		<span class="pl-en">instrumentation_begin</span>();
		<span class="pl-k">if</span> (<span class="pl-en">IS_ENABLED</span>(<span class="pl-c1">CONFIG_PREEMPTION</span>))
			<span class="pl-en">irqentry_exit_cond_resched</span>();

		<span class="pl-c">/* Covers both tracing and lockdep */</span>
		<span class="pl-en">trace_hardirqs_on</span>();
		<span class="pl-en">instrumentation_end</span>();
	} <span class="pl-k">else</span> {
		<span class="pl-c">// returns to kernel, interrupts are originally off</span>

		<span class="pl-c">/*</span>
<span class="pl-c">		 * IRQ flags state is correct already. Just tell RCU if it</span>
<span class="pl-c">		 * was not watching on entry.</span>
<span class="pl-c">		 */</span>
		<span class="pl-k">if</span> (<span class="pl-s1">state</span>.<span class="pl-c1">exit_rcu</span>)
			<span class="pl-en">ct_irq_exit</span>();
	}
}</pre><div class="zeroclipboard-container">
<clipboard-copy aria-label="Copy" class="ClipboardButton btn btn-invisible js-clipboard-copy m-2 p-0 d-flex flex-justify-center flex-items-center" data-copy-feedback="Copied!" data-tooltip-direction="w" role="button" tabindex="0" value="// kernel/entry/common.c

noinstr void irqentry_exit(struct pt_regs *regs, irqentry_state_t state)
{
	// This function does not disable interrupts.
	// It asserts that they are already disabled.
	// If interrupts happen to be enabled when this line is executed,
	// lockdep will print a loud warning and a stack trace,
	// effectively crashing the system to highlight a severe bug.
	lockdep_assert_irqs_disabled();

	/* Check whether this returns to user mode */
	if (user_mode(regs)) {
		irqentry_exit_to_user_mode(regs);
	} else if (!regs_irqs_disabled(regs)) {
		// returns to kernel, interrupts are originally on

		/*
		 * If RCU was not watching on entry this needs to be done
		 * carefully and needs the same ordering of lockdep/tracing
		 * and RCU as the return to user mode path.
		 */
		if (state.exit_rcu) {
			instrumentation_begin();
			/* Tell the tracer that IRET will enable interrupts */
			trace_hardirqs_on_prepare();
			lockdep_hardirqs_on_prepare();
			instrumentation_end();
			ct_irq_exit();
			lockdep_hardirqs_on(CALLER_ADDR0);
			return;
		}

		instrumentation_begin();
		if (IS_ENABLED(CONFIG_PREEMPTION))
			irqentry_exit_cond_resched();

		/* Covers both tracing and lockdep */
		trace_hardirqs_on();
		instrumentation_end();
	} else {
		// returns to kernel, interrupts are originally off

		/*
		 * IRQ flags state is correct already. Just tell RCU if it
		 * was not watching on entry.
		 */
		if (state.exit_rcu)
			ct_irq_exit();
	}
}">
<svg aria-hidden="true" class="octicon octicon-copy js-clipboard-copy-icon" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path>
</svg>
<svg aria-hidden="true" class="octicon octicon-check js-clipboard-check-icon color-fg-success d-none" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"></path>
</svg>
</clipboard-copy>
</div></div>
<div class="markdown-heading" dir="auto"><h4 class="heading-element" dir="auto" tabindex="-1">辅助函数：irqentry_exit_to_user_mode()</h4><a aria-label="Permalink: 辅助函数：irqentry_exit_to_user_mode()" class="anchor" href="#辅助函数irqentry_exit_to_user_mode" id="user-content-辅助函数irqentry_exit_to_user_mode"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<div class="highlight highlight-source-c notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-c">// kernel/entry/common.c</span>

<span class="pl-smi">noinstr</span> <span class="pl-s1">void</span> <span class="pl-en">irqentry_exit_to_user_mode</span>(<span class="pl-k">struct</span> <span class="pl-smi">pt_regs</span> <span class="pl-c1">*</span><span class="pl-s1">regs</span>)
{
	<span class="pl-en">instrumentation_begin</span>();

	<span class="pl-c">// 1) check that interrupts are disabled</span>
	<span class="pl-c">// 2) call tick_nohz_user_enter_prepare()</span>
	<span class="pl-c">// 3) call exit_to_user_mode_loop() if any flags from</span>
	<span class="pl-c">//    EXIT_TO_USER_MODE_WORK are set</span>
	<span class="pl-c">// 4) check that interrupts are still disabled</span>
	<span class="pl-en">exit_to_user_mode_prepare</span>(<span class="pl-s1">regs</span>);
	<span class="pl-en">instrumentation_end</span>();
	<span class="pl-en">exit_to_user_mode</span>();
}

<span class="pl-c">// include/linux/entry-common.h</span>

<span class="pl-k">static</span> <span class="pl-smi">__always_inline</span> <span class="pl-s1">void</span> <span class="pl-en">exit_to_user_mode</span>(<span class="pl-smi">void</span>)
{
	<span class="pl-en">instrumentation_begin</span>();
	<span class="pl-en">trace_hardirqs_on_prepare</span>();
	<span class="pl-en">lockdep_hardirqs_on_prepare</span>();
	<span class="pl-en">instrumentation_end</span>();

	<span class="pl-c">// Invoke context tracking if enabled to adjust RCU state</span>
	<span class="pl-en">user_enter_irqoff</span>();
	<span class="pl-c">// Invoke architecture specific last minute exit code,</span>
	<span class="pl-c">// e.g. speculation mitigations, etc. RISC-V doesn't implement this</span>
	<span class="pl-en">arch_exit_to_user_mode</span>();
	<span class="pl-c">// Tell lockdep that interrupts are enabled</span>
	<span class="pl-en">lockdep_hardirqs_on</span>(<span class="pl-c1">CALLER_ADDR0</span>);
}</pre><div class="zeroclipboard-container">
<clipboard-copy aria-label="Copy" class="ClipboardButton btn btn-invisible js-clipboard-copy m-2 p-0 d-flex flex-justify-center flex-items-center" data-copy-feedback="Copied!" data-tooltip-direction="w" role="button" tabindex="0" value="// kernel/entry/common.c

noinstr void irqentry_exit_to_user_mode(struct pt_regs *regs)
{
	instrumentation_begin();

	// 1) check that interrupts are disabled
	// 2) call tick_nohz_user_enter_prepare()
	// 3) call exit_to_user_mode_loop() if any flags from
	//    EXIT_TO_USER_MODE_WORK are set
	// 4) check that interrupts are still disabled
	exit_to_user_mode_prepare(regs);
	instrumentation_end();
	exit_to_user_mode();
}

// include/linux/entry-common.h

static __always_inline void exit_to_user_mode(void)
{
	instrumentation_begin();
	trace_hardirqs_on_prepare();
	lockdep_hardirqs_on_prepare();
	instrumentation_end();

	// Invoke context tracking if enabled to adjust RCU state
	user_enter_irqoff();
	// Invoke architecture specific last minute exit code,
	// e.g. speculation mitigations, etc. RISC-V doesn't implement this
	arch_exit_to_user_mode();
	// Tell lockdep that interrupts are enabled
	lockdep_hardirqs_on(CALLER_ADDR0);
}">
<svg aria-hidden="true" class="octicon octicon-copy js-clipboard-copy-icon" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path>
</svg>
<svg aria-hidden="true" class="octicon octicon-check js-clipboard-check-icon color-fg-success d-none" data-view-component="true" height="16" version="1.1" viewbox="0 0 16 16" width="16">
<path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"></path>
</svg>
</clipboard-copy>
</div></div>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto" tabindex="-1">riscv_intc_irq()</h2><a aria-label="Permalink: riscv_intc_irq()" class="anchor" href="#riscv_intc_irq" id="user-content-riscv_intc_irq"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
</article></div>

<div aria-atomic="true" aria-live="polite" class="sr-only mt-n1" id="js-global-screen-reader-notice"></div>
<div aria-atomic="true" aria-live="assertive" class="sr-only mt-n1" id="js-global-screen-reader-notice-assertive"></div>
<div aria-live="assertive" class="sr-only mt-n1" data-testid="screenReaderAnnouncement" id="screenReaderAnnouncementDiv" role="alert"> </div></body></html>