name: Generate HTML for every Markdown

on:
  push:
    branches: [ main ]

  workflow_dispatch:

jobs:
  generate-pages:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get every Markdown files
        id: get_files
        run: |
          # 列出所有 md 文件，删除开头的 ./，# 开头的文件不处理
          FILES=$(find . -type f -name "*.md" ! -name "#*" | sed 's|^\./||')

          echo "files<<EOF" >> $GITHUB_OUTPUT  # 使用 EOF 块处理多行
          echo "$FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "markdown files:"
          echo "$FILES"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install playwright beautifulsoup4
          playwright install chromium

      - name: Process Markdown files
        if: steps.get_files.outputs.files != ''
        run: |
          mkdir -p output

          IFS=$'\n' files=(${{ steps.get_files.outputs.files }})

          ARGS=()
          for file in "${files[@]}"; do
            GITHUB_URL="https://github.com/${{ github.repository }}/blob/main/$file"

            if [ "$file" = "README.md" ]; then
              OUTPUT_PATH="output/index.html"
            else
              OUTPUT_PATH="output/${file%.md}.html"
              mkdir -p "$(dirname "$OUTPUT_PATH")"
            fi

            ARGS+=("$GITHUB_URL" "$OUTPUT_PATH")
          done

          echo "Processing ${#files[@]} files in batch..."
          python .github/workflows/clean-page.py "${ARGS[@]}"

      - name: Copy archive folder
        run: |
          if [ -d "archive" ]; then
            echo "Copying archive folder to output/archive"
            mkdir -p output/archive
            cp -r archive/* output/archive/
          else
            echo "Archive folder not found, skipping"
          fi

      - name: Deploy to branch
        if: steps.get_files.outputs.files != ''
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./output
          publish_branch: pages
          keep_files: false
          force_orphan: false
